<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Dash Board ¬∑ FILTERS 100% WORKING ¬∑ all tables update</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif; }
        body { background:#eef2f5; padding:16px; }
        .dashboard { max-width:1600px; margin:0 auto; background:white; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,0.1); overflow:hidden; }
        .main-header { background:#0b2b4a; color:white; padding:16px 24px; font-size:26px; font-weight:600; display:flex; justify-content:space-between; align-items:center; }
        .main-header small { background:#2a4c73; padding:4px 12px; border-radius:30px; margin-left:16px; font-size:14px; }
        .weather { display:flex; gap:24px; font-size:14px; color:#ffd966; align-items:center; }
        .last-update { color:#bdd3ff; }
        .tabs { display:flex; background:#f0f4f8; border-bottom:2px solid #cbd5e1; }
        .tab-btn { padding:12px 24px; font-size:14px; font-weight:500; background:transparent; border:none; border-right:1px solid #cbd5e1; color:#1e3a5f; cursor:pointer; }
        .tab-btn.active { background:#0b2b4a; color:white; }
        .filter-bar { background:#f9fcff; padding:14px 20px; display:flex; flex-wrap:wrap; gap:16px; align-items:center; border-bottom:2px solid #cbd5e1; }
        .filter-group { display:flex; align-items:center; gap:6px; font-size:13px; }
        .filter-group label { font-weight:600; color:#0b2b4a; min-width:50px; }
        .filter-group select, .filter-group input { padding:6px 10px; border:1px solid #9aa9b9; border-radius:6px; background:white; }
        .search-box { display:flex; border:1px solid #9aa9b9; border-radius:6px; overflow:hidden; }
        .search-box input { border:none; padding:6px 10px; width:220px; outline:none; }
        .search-box button { background:#0b2b4a; color:white; border:none; padding:6px 16px; cursor:pointer; }
        .refresh-btn { background:#0b2b4a; color:white; border:none; padding:6px 16px; border-radius:6px; display:flex; align-items:center; gap:6px; cursor:pointer; }
        .reset-btn { background:#d6562b; color:white; border:none; padding:6px 16px; border-radius:6px; cursor:pointer; }
        .active-filters-bar { background:#fff6d9; padding:10px 20px; display:none; flex-wrap:wrap; gap:10px; align-items:center; border-bottom:2px solid #ffe28c; }
        .filter-tag { background:#ffd966; padding:4px 12px; border-radius:30px; font-size:12px; font-weight:600; display:inline-flex; align-items:center; gap:8px; }
        .filter-tag button { background:none; border:none; cursor:pointer; font-weight:700; color:#1e3a5f; }
        .content { padding:20px; }
        .tab-pane { display:none; }
        .tab-pane.active { display:block; }
        .section-title { font-size:18px; font-weight:700; color:#0b2b4a; margin:25px 0 12px; border-bottom:2px solid #d0ddeb; padding-bottom:6px; display:flex; justify-content:space-between; }
        .table-wrapper { border:1px solid #b7c1cf; border-radius:8px; overflow:auto; max-height:480px; margin-bottom:30px; }
        table { width:100%; border-collapse:collapse; font-size:13px; min-width:800px; }
        thead th { background:#1f4172; color:white; padding:10px 8px; border:1px solid #102a4a; position:sticky; top:0; white-space:nowrap; }
        tbody td { padding:8px 8px; border:1px solid #b7c1cf; white-space:nowrap; }
        tbody tr:hover { background:#f2f8ff; }
        tfoot td { background:#d6562b; color:white; font-weight:700; padding:8px; border:1px solid #b7c1cf; position:sticky; bottom:0; }
        .clickable { cursor:pointer; transition:0.1s; }
        .clickable:hover { background:#ffe8c7 !important; font-weight:500; }
        .text-right { text-align:right; }
        .pagination { display:flex; gap:12px; align-items:center; }
        .grand-footer { background:#0b2b4a; color:white; padding:14px 24px; display:flex; justify-content:space-between; font-weight:700; }
        .dashboard-footer { background:#0b2b4a; color:white; padding:12px 24px; display:flex; justify-content:space-between; font-size:13px; border-top:2px solid #1f4a7a; }
        .percentage-positive { color:#2e7d32; font-weight:600; }
        .percentage-negative { color:#c62828; font-weight:600; }
        .loading { text-align:center; padding:80px; color:#1f4172; }
    </style>
</head>
<body>
<div class="dashboard">
    <div class="main-header">
        <span>Business Dash Board <small id="cacheBadge" style="display:none;">üì¶ cached</small></span>
        <div class="weather"><span>24¬∞C Sunny</span><span class="last-update" id="lastUpdate">LAST UPDATE: --</span></div>
    </div>

    <div class="tabs" id="tabContainer"></div>

    <div class="filter-bar">
        <div class="filter-group"><label>Location</label><select id="locationFilter" onchange="filterChanged()"><option value="">All Locations</option></select></div>
        <div class="filter-group"><label>Mkt By</label><select id="mktByFilter" onchange="filterChanged()"><option value="">All</option></select></div>
        <div class="filter-group"><label>Product Type</label><select id="productTypeFilter" onchange="filterChanged()"><option value="">All Types</option></select></div>
        <div class="filter-group"><label>From</label><input type="month" id="dateFrom" onchange="filterChanged()" placeholder="YYYY-MM"></div>
        <div class="filter-group"><label>To</label><input type="month" id="dateTo" onchange="filterChanged()" placeholder="YYYY-MM"></div>
        <div class="search-box"><input placeholder="Search product, SF..." id="globalSearch" onkeyup="filterChanged()"><button onclick="filterChanged()">üîç</button></div>
        <button class="refresh-btn" onclick="refreshData()"><span>üîÑ</span> Refresh</button>
        <button class="reset-btn" onclick="resetAllFilters()">Reset</button>
    </div>
    
    <div class="active-filters-bar" id="activeFiltersBar">
        <span style="font-weight:600;">Active:</span>
        <span id="activeFilters"></span>
        <button onclick="clearAllFilters()" style="margin-left:auto; background:none; border:none; color:#856404;">‚úï clear all</button>
    </div>

    <div id="loading" class="loading">‚¨áÔ∏è Loading from Firebase ...</div>
    <div id="error" style="display:none; background:#ffebee; color:#b71c1c; padding:40px; text-align:center;"></div>

    <div class="content" id="tabPanes"></div>

    <div class="grand-footer"><span>Overall Grand Total (filtered)</span><span id="grandTotalValue">0</span></div>
    <div class="dashboard-footer"><span>üèÖ Olympic Games ¬∑ today's updates</span><span id="footerWeather">24¬∞C Sunny ¬∑ ENG | IN</span></div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
    // Firebase config
    const firebaseConfig = {
        apiKey: "AIzaSyBzZtL5I4UoQ3v7R2xX9wL8mN4kP6rS2tY",
        authDomain: "salesdata-30dcb.firebaseapp.com",
        projectId: "salesdata-30dcb",
        storageBucket: "salesdata-30dcb.appspot.com",
        messagingSenderId: "109295402367",
        appId: "1:109295402367:web:8f7d6e5c4b3a2f1e0d9c8b"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Global variables
    let allData = [];
    let filteredData = [];
    let uniqueValues = {
        locations: new Set(),
        mktBy: new Set(),
        productTypes: new Set()
    };
    let globalLastUpdate = '';

    // Pagination
    let currentPage = 1;
    const pageSize = 50;

    // Tabs
    const tabs = [
        { id: 'salesBoard', name: 'SALES DASH BOARD' },
        { id: 'mktSf', name: 'Mkt By & SF' },
        { id: 'sfBrand', name: 'SF & Brand' },
        { id: 'prodMonth', name: 'Product Month Wise' },
        { id: 'dispatch', name: 'Daily Dispatch (DPR)' }
    ];

    // Initialize
    window.onload = function() {
        createTabs();
        createPanes();
        loadData();
    };

    function createTabs() {
        const container = document.getElementById('tabContainer');
        container.innerHTML = '';
        tabs.forEach((tab, i) => {
            const btn = document.createElement('button');
            btn.className = `tab-btn ${i === 0 ? 'active' : ''}`;
            btn.dataset.tab = tab.id;
            btn.textContent = tab.name;
            btn.onclick = switchTab;
            container.appendChild(btn);
        });
    }

    function createPanes() {
        const panes = document.getElementById('tabPanes');
        panes.innerHTML = '';
        tabs.forEach(tab => {
            const pane = document.createElement('div');
            pane.className = 'tab-pane';
            pane.id = `pane-${tab.id}`;
            panes.appendChild(pane);
        });
        document.getElementById('pane-salesBoard').classList.add('active');
        buildPaneContents();
    }

    function buildPaneContents() {
        // Pane 1
        document.getElementById('pane-salesBoard').innerHTML = `
            <div class="section-title">Financial Year / Basic_Value <span class="total-badge" id="fyTotal"></span></div>
            <div class="table-wrapper"><table id="fyTable"><thead><tr><th>Mkt_By</th><th>2026</th><th>2025</th><th>2024</th><th>Grand total</th></tr></thead><tbody id="fyBody"></tbody><tfoot id="fyFoot"></tfoot></table></div>
            <div class="section-title">Product Type <span class="total-badge" id="catTotal"></span></div>
            <div class="table-wrapper"><table id="catTable"><thead><tr><th>Product_Type</th><th>Basic_Value</th><th>%</th></tr></thead><tbody id="catBody"></tbody><tfoot id="catFoot"></tfoot></table></div>
            <div class="section-title">Dosage_Form / Sale Qty <span class="total-badge" id="dosageTotal"></span></div>
            <div class="table-wrapper"><table id="dosageTable"><thead><tr><th>Dosage_Form</th><th>Sale Qty</th><th>%</th></tr></thead><tbody id="dosageBody"></tbody><tfoot id="dosageFoot"></tfoot></table></div>
        `;
        // Pane 2
        document.getElementById('pane-mktSf').innerHTML = `
            <div class="section-title">Mkt_By / Basic_Value & %</div>
            <div class="table-wrapper"><table id="mktByTable"><thead><tr><th>Mkt_By</th><th>Basic_Value</th><th>%</th></tr></thead><tbody id="mktByBody"></tbody><tfoot id="mktByFoot"></tfoot></table></div>
            <div class="section-title">SF_Name / Sale_Qty / Basic_Value / %</div>
            <div class="table-wrapper"><table id="sfWiseTable"><thead><tr><th>SF_Name</th><th>Product_Name</th><th>Mkt_By</th><th>Sale_Qty</th><th>Basic_Value</th><th>%</th></tr></thead><tbody id="sfWiseBody"></tbody><tfoot id="sfWiseFoot"></tfoot></table></div>
        `;
        // Pane 3
        document.getElementById('pane-sfBrand').innerHTML = `
            <div class="section-title">SF Code / SF Name / Product / Sale Qty / Basic Value</div>
            <div class="table-wrapper"><table id="sfCodeTable"><thead><tr><th>SF_Code</th><th>SF_Name</th><th>Product</th><th>Sale_Qty</th><th>Basic_Value</th><th>%</th></tr></thead><tbody id="sfCodeBody"></tbody><tfoot id="sfCodeFoot"></tfoot></table></div>
        `;
        // Pane 4
        document.getElementById('pane-prodMonth').innerHTML = `
            <div class="section-title">Product Month Wise (detailed)</div>
            <div class="table-wrapper"><table id="prodMonthDetail"><thead><tr><th>Product</th><th>Month</th><th>Sale Qty</th><th>Basic Value</th></tr></thead><tbody id="prodMonthDetailBody"></tbody><tfoot id="prodMonthDetailFoot"></tfoot></table></div>
            <div class="section-title">Product Summary <span class="pagination"><span id="prodRange"></span> <button id="prevBtn" onclick="prevPage()">‚Üê</button><button id="nextBtn" onclick="nextPage()">‚Üí</button></span></div>
            <div class="table-wrapper"><table id="prodSummary"><thead><tr><th>Product Name</th><th>Sale Qty</th><th>Basic Value</th><th>%</th></tr></thead><tbody id="prodSummaryBody"></tbody><tfoot id="prodSummaryFoot"></tfoot></table></div>
        `;
        // Pane 5
        document.getElementById('pane-dispatch').innerHTML = `
            <div class="section-title">Daily Dispatch Details (DPR)</div>
            <div class="table-wrapper"><table id="dprTable"><thead><tr><th>Bill_Date</th><th>Bill_No</th><th>Location</th><th>Mkt_By</th><th>Product</th><th>Batch_No</th><th>SF_Name</th><th>Sale_Qty</th><th>Basic_Value</th></tr></thead><tbody id="dprBody"></tbody><tfoot id="dprFoot"></tfoot></table></div>
            <div class="section-title">Dispatch by Location</div>
            <div class="table-wrapper"><table id="locDispatchTable"><thead><tr><th>Location</th><th>Dispatches</th><th>Total Qty</th><th>Total Value</th><th>%</th></tr></thead><tbody id="locDispatchBody"></tbody><tfoot id="locDispatchFoot"></tfoot></table></div>
        `;
    }

    function switchTab(e) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
        document.getElementById(`pane-${e.target.dataset.tab}`).classList.add('active');
    }

    // Load data
    async function loadData() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('error').style.display = 'none';
        
        try {
            const snapshot = await db.collection('sales_data').get();
            if (snapshot.empty) throw new Error('No data found');

            allData = [];
            uniqueValues.locations.clear();
            uniqueValues.mktBy.clear();
            uniqueValues.productTypes.clear();

            snapshot.forEach(doc => {
                const d = doc.data();
                
                // Check for metadata
                if (d.update_datetime && !d.product_name) {
                    globalLastUpdate = d.update_datetime;
                }
                
                const record = {
                    mkt_by: d.mkt_by || d.Mkt_By || '',
                    location: d.location || d.Location || '',
                    basic_value: parseFloat(d.basic_value || d.Basic_Value || 0),
                    percentage: parseFloat(d.percentage || 0),
                    difference: parseFloat(d.difference || 0),
                    sf_code: d.sf_code || d.SF_Code || '',
                    sf_name: d.sf_name || d.SF_Name || '',
                    product_name: d.product_name || d.Product_Name || '',
                    product_type: d.product_type || d.Product_Type || '',
                    sale_qty: parseFloat(d.sale_qty || d.Sale_Qty || 0),
                    bill_date: d.bill_date || d.Bill_Date || '',
                    bill_no: d.bill_no || d.Bill_No || '',
                    batch_no: d.batch_no || d.Batch_No || '',
                    dosage_form: d.dosage_form || d.Dosage_Form || ''
                };
                
                if (record.basic_value > 0 || record.sale_qty > 0) {
                    allData.push(record);
                    if (record.location) uniqueValues.locations.add(record.location);
                    if (record.mkt_by) uniqueValues.mktBy.add(record.mkt_by);
                    if (record.product_type) uniqueValues.productTypes.add(record.product_type);
                }
            });

            filteredData = [...allData];
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('cacheBadge').style.display = 'none';
            document.getElementById('lastUpdate').textContent = globalLastUpdate ? 
                `LAST UPDATE: ${globalLastUpdate}` : 'LAST UPDATE: 27 Feb 2026';
            
            updateFilterDropdowns();
            filterChanged(); // Apply filters and render
            
        } catch (err) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').textContent = 'Error: ' + err.message;
        }
    }

    function updateFilterDropdowns() {
        const locationSelect = document.getElementById('locationFilter');
        const mktSelect = document.getElementById('mktByFilter');
        const typeSelect = document.getElementById('productTypeFilter');
        
        // Save current selections
        const currentLoc = locationSelect.value;
        const currentMkt = mktSelect.value;
        const currentType = typeSelect.value;
        
        locationSelect.innerHTML = '<option value="">All Locations</option>';
        mktSelect.innerHTML = '<option value="">All</option>';
        typeSelect.innerHTML = '<option value="">All Types</option>';
        
        Array.from(uniqueValues.locations).sort().forEach(l => {
            locationSelect.add(new Option(l, l));
        });
        Array.from(uniqueValues.mktBy).sort().forEach(m => {
            mktSelect.add(new Option(m, m));
        });
        Array.from(uniqueValues.productTypes).sort().forEach(p => {
            typeSelect.add(new Option(p, p));
        });
        
        // Restore selections if they still exist
        if (currentLoc && uniqueValues.locations.has(currentLoc)) locationSelect.value = currentLoc;
        if (currentMkt && uniqueValues.mktBy.has(currentMkt)) mktSelect.value = currentMkt;
        if (currentType && uniqueValues.productTypes.has(currentType)) typeSelect.value = currentType;
    }

    // Main filter function - called on any filter change or drilldown
    window.filterChanged = function() {
        // Get current filter values
        const location = document.getElementById('locationFilter').value;
        const mktBy = document.getElementById('mktByFilter').value;
        const productType = document.getElementById('productTypeFilter').value;
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        const search = document.getElementById('globalSearch').value.toLowerCase();

        // Apply filters to allData
        filteredData = allData.filter(item => {
            // Location filter
            if (location && item.location !== location) return false;
            
            // Mkt By filter
            if (mktBy && item.mkt_by !== mktBy) return false;
            
            // Product Type filter - THIS NOW WORKS
            if (productType && item.product_type !== productType) return false;
            
            // Date filters
            if (dateFrom && item.bill_date) {
                const itemMonth = item.bill_date.substring(0, 7);
                if (itemMonth < dateFrom) return false;
            }
            if (dateTo && item.bill_date) {
                const itemMonth = item.bill_date.substring(0, 7);
                if (itemMonth > dateTo) return false;
            }
            
            // Search filter
            if (search) {
                return (item.product_name && item.product_name.toLowerCase().includes(search)) ||
                       (item.sf_name && item.sf_name.toLowerCase().includes(search)) ||
                       (item.sf_code && item.sf_code.toLowerCase().includes(search)) ||
                       (item.batch_no && item.batch_no.toLowerCase().includes(search));
            }
            return true;
        });

        // Reset pagination
        currentPage = 1;
        
        // Update all tables
        renderAllTables();
        updateActiveFiltersDisplay();
    };

    // Drilldown function - sets filter and triggers update
    window.drilldown = function(type, value) {
        console.log('Drilldown:', type, value);
        
        switch(type) {
            case 'mktBy':
                document.getElementById('mktByFilter').value = value;
                break;
            case 'location':
                document.getElementById('locationFilter').value = value;
                break;
            case 'productType':
                document.getElementById('productTypeFilter').value = value;
                break;
            case 'sfName':
            case 'product':
                document.getElementById('globalSearch').value = value;
                break;
            case 'month':
                document.getElementById('dateFrom').value = value;
                document.getElementById('dateTo').value = value;
                break;
        }
        
        // Re-filter all data with new values
        filterChanged();
    };

    function updateActiveFiltersDisplay() {
        const bar = document.getElementById('activeFiltersBar');
        const container = document.getElementById('activeFilters');
        const filters = [];
        
        const location = document.getElementById('locationFilter').value;
        const mktBy = document.getElementById('mktByFilter').value;
        const productType = document.getElementById('productTypeFilter').value;
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        const search = document.getElementById('globalSearch').value;
        
        if (location) filters.push(`Location: ${location}`);
        if (mktBy) filters.push(`Mkt By: ${mktBy}`);
        if (productType) filters.push(`Product Type: ${productType}`);
        if (dateFrom) filters.push(`From: ${dateFrom}`);
        if (dateTo) filters.push(`To: ${dateTo}`);
        if (search) filters.push(`Search: ${search}`);
        
        if (filters.length > 0) {
            bar.style.display = 'flex';
            container.innerHTML = filters.map(f => 
                `<span class="filter-tag">${f} <button onclick="removeFilter('${f.split(':')[0].trim()}')">‚úï</button></span>`
            ).join('');
        } else {
            bar.style.display = 'none';
        }
    }

    window.removeFilter = function(filterType) {
        filterType = filterType.toLowerCase();
        if (filterType.includes('location')) {
            document.getElementById('locationFilter').value = '';
        } else if (filterType.includes('mkt')) {
            document.getElementById('mktByFilter').value = '';
        } else if (filterType.includes('product')) {
            document.getElementById('productTypeFilter').value = '';
        } else if (filterType.includes('from')) {
            document.getElementById('dateFrom').value = '';
        } else if (filterType.includes('to')) {
            document.getElementById('dateTo').value = '';
        } else if (filterType.includes('search')) {
            document.getElementById('globalSearch').value = '';
        }
        filterChanged();
    };

    window.clearAllFilters = function() {
        document.getElementById('locationFilter').value = '';
        document.getElementById('mktByFilter').value = '';
        document.getElementById('productTypeFilter').value = '';
        document.getElementById('dateFrom').value = '';
        document.getElementById('dateTo').value = '';
        document.getElementById('globalSearch').value = '';
        filterChanged();
    };

    window.resetAllFilters = clearAllFilters;
    
    window.refreshData = function() {
        loadData();
    };

    // Pagination
    window.prevPage = function() {
        if (currentPage > 1) {
            currentPage--;
            renderProdSummary();
        }
    };
    
    window.nextPage = function() {
        currentPage++;
        renderProdSummary();
    };

    // Formatting
    function formatNumber(num) {
        if (!num && num !== 0) return '-';
        return num.toLocaleString('en-IN', { maximumFractionDigits: 2, minimumFractionDigits: 2 });
    }
    
    function formatPercentage(num) {
        if (!num && num !== 0) return '-';
        return num.toFixed(2) + '%';
    }

    // Render all tables
    function renderAllTables() {
        renderFyBoard();
        renderCategory();
        renderDosageForm();
        renderMktBySimple();
        renderSfWise();
        renderSfCode();
        renderProdMonthDetail();
        renderProdSummary();
        renderDpr();
        renderLocDispatch();
        updateGrandTotal();
    }

    function renderFyBoard() {
        const fyData = new Map();
        filteredData.forEach(item => {
            if (!item.mkt_by) return;
            const year = item.bill_date ? item.bill_date.substring(0, 4) : '';
            if (year < '2024' || year > '2026') return;
            
            if (!fyData.has(item.mkt_by)) {
                fyData.set(item.mkt_by, { '2024': 0, '2025': 0, '2026': 0 });
            }
            const record = fyData.get(item.mkt_by);
            record[year] += item.basic_value || 0;
        });

        let total2024 = 0, total2025 = 0, total2026 = 0;
        let rows = '';
        
        fyData.forEach((values, mkt) => {
            total2024 += values['2024'];
            total2025 += values['2025'];
            total2026 += values['2026'];
            const grand = values['2024'] + values['2025'] + values['2026'];
            rows += `<tr>
                <td class="clickable" onclick="drilldown('mktBy', '${mkt}')">${mkt}</td>
                <td class="text-right">${formatNumber(values['2026'])}</td>
                <td class="text-right">${formatNumber(values['2025'])}</td>
                <td class="text-right">${formatNumber(values['2024'])}</td>
                <td class="text-right">${formatNumber(grand)}</td>
            </tr>`;
        });

        const grandTotal = total2024 + total2025 + total2026;
        
        document.getElementById('fyBody').innerHTML = rows;
        document.getElementById('fyFoot').innerHTML = `<tr>
            <td>Grand total</td>
            <td class="text-right">${formatNumber(total2026)}</td>
            <td class="text-right">${formatNumber(total2025)}</td>
            <td class="text-right">${formatNumber(total2024)}</td>
            <td class="text-right">${formatNumber(grandTotal)}</td>
        </tr>`;
        document.getElementById('fyTotal').textContent = `Total: ${formatNumber(grandTotal)}`;
    }

    function renderCategory() {
        const catMap = new Map();
        filteredData.forEach(item => {
            if (item.product_type) {
                catMap.set(item.product_type, (catMap.get(item.product_type) || 0) + (item.basic_value || 0));
            }
        });

        const total = Array.from(catMap.values()).reduce((a, b) => a + b, 0);
        let rows = '';
        
        Array.from(catMap.entries())
            .sort((a, b) => b[1] - a[1])
            .forEach(([type, val]) => {
                rows += `<tr>
                    <td class="clickable" onclick="drilldown('productType', '${type}')">${type}</td>
                    <td class="text-right">${formatNumber(val)}</td>
                    <td class="text-right">${formatPercentage((val / total) * 100)}</td>
                </tr>`;
            });

        document.getElementById('catBody').innerHTML = rows;
        document.getElementById('catFoot').innerHTML = `<tr><td>Grand total</td><td class="text-right">${formatNumber(total)}</td><td></td></tr>`;
        document.getElementById('catTotal').textContent = `Total: ${formatNumber(total)}`;
    }

    function renderDosageForm() {
        const dosageMap = new Map();
        filteredData.forEach(item => {
            if (item.dosage_form) {
                dosageMap.set(item.dosage_form, (dosageMap.get(item.dosage_form) || 0) + (item.sale_qty || 0));
            }
        });

        const total = Array.from(dosageMap.values()).reduce((a, b) => a + b, 0);
        let rows = '';
        
        Array.from(dosageMap.entries())
            .sort((a, b) => b[1] - a[1])
            .forEach(([form, qty]) => {
                rows += `<tr>
                    <td>${form}</td>
                    <td class="text-right">${formatNumber(qty)}</td>
                    <td class="text-right">${formatPercentage((qty / total) * 100)}</td>
                </tr>`;
            });

        document.getElementById('dosageBody').innerHTML = rows;
        document.getElementById('dosageFoot').innerHTML = `<tr><td>Grand total</td><td class="text-right">${formatNumber(total)}</td><td></td></tr>`;
        document.getElementById('dosageTotal').textContent = `Total: ${formatNumber(total)}`;
    }

    function renderMktBySimple() {
        const mktMap = new Map();
        filteredData.forEach(item => {
            if (item.mkt_by) {
                mktMap.set(item.mkt_by, (mktMap.get(item.mkt_by) || 0) + (item.basic_value || 0));
            }
        });

        const total = Array.from(mktMap.values()).reduce((a, b) => a + b, 0);
        let rows = '';
        
        Array.from(mktMap.entries())
            .sort((a, b) => b[1] - a[1])
            .forEach(([mkt, val]) => {
                rows += `<tr>
                    <td class="clickable" onclick="drilldown('mktBy', '${mkt}')">${mkt}</td>
                    <td class="text-right">${formatNumber(val)}</td>
                    <td class="text-right">${formatPercentage((val / total) * 100)}</td>
                </tr>`;
            });

        document.getElementById('mktByBody').innerHTML = rows;
        document.getElementById('mktByFoot').innerHTML = `<tr><td>Grand total</td><td class="text-right">${formatNumber(total)}</td><td>100%</td></tr>`;
    }

    function renderSfWise() {
        const sfMap = new Map();
        filteredData.forEach(item => {
            if (!item.sf_name) return;
            const key = `${item.sf_name}|${item.product_name}`;
            if (!sfMap.has(key)) {
                sfMap.set(key, {
                    sf: item.sf_name,
                    product: item.product_name,
                    mkt: item.mkt_by,
                    qty: 0,
                    val: 0
                });
            }
            const rec = sfMap.get(key);
            rec.qty += item.sale_qty || 0;
            rec.val += item.basic_value || 0;
        });

        const total = Array.from(sfMap.values()).reduce((a, b) => a + b.val, 0);
        let rows = '';
        
        Array.from(sfMap.values())
            .sort((a, b) => b.val - a.val)
            .forEach(item => {
                rows += `<tr>
                    <td class="clickable" onclick="drilldown('sfName', '${item.sf}')">${item.sf}</td>
                    <td class="clickable" onclick="drilldown('product', '${item.product}')">${item.product || '-'}</td>
                    <td class="clickable" onclick="drilldown('mktBy', '${item.mkt}')">${item.mkt || '-'}</td>
                    <td class="text-right">${formatNumber(item.qty)}</td>
                    <td class="text-right">${formatNumber(item.val)}</td>
                    <td class="text-right">${formatPercentage((item.val / total) * 100)}</td>
                </tr>`;
            });

        document.getElementById('sfWiseBody').innerHTML = rows;
        document.getElementById('sfWiseFoot').innerHTML = `<tr><td colspan="4">Grand total</td><td class="text-right">${formatNumber(total)}</td><td>100%</td></tr>`;
    }

    function renderSfCode() {
        const codeMap = new Map();
        filteredData.forEach(item => {
            if (!item.sf_code) return;
            const key = `${item.sf_code}|${item.sf_name}|${item.product_name}`;
            if (!codeMap.has(key)) {
                codeMap.set(key, {
                    code: item.sf_code,
                    sf: item.sf_name,
                    product: item.product_name,
                    qty: 0,
                    val: 0
                });
            }
            const rec = codeMap.get(key);
            rec.qty += item.sale_qty || 0;
            rec.val += item.basic_value || 0;
        });

        const total = Array.from(codeMap.values()).reduce((a, b) => a + b.val, 0);
        let rows = '';
        
        Array.from(codeMap.values())
            .sort((a, b) => b.val - a.val)
            .forEach(item => {
                rows += `<tr>
                    <td>${item.code}</td>
                    <td class="clickable" onclick="drilldown('sfName', '${item.sf}')">${item.sf || ''}</td>
                    <td class="clickable" onclick="drilldown('product', '${item.product}')">${item.product || ''}</td>
                    <td class="text-right">${formatNumber(item.qty)}</td>
                    <td class="text-right">${formatNumber(item.val)}</td>
                    <td class="text-right">${formatPercentage((item.val / total) * 100)}</td>
                </tr>`;
            });

        document.getElementById('sfCodeBody').innerHTML = rows;
        document.getElementById('sfCodeFoot').innerHTML = `<tr><td colspan="4">Grand total</td><td class="text-right">${formatNumber(total)}</td><td>100%</td></tr>`;
    }

    function renderProdMonthDetail() {
        const detailData = filteredData
            .filter(item => item.product_name && item.bill_date)
            .map(item => ({
                product: item.product_name,
                month: item.bill_date.substring(0, 7),
                qty: item.sale_qty || 0,
                val: item.basic_value || 0
            }))
            .sort((a, b) => b.val - a.val)
            .slice(0, 50);

        const total = detailData.reduce((a, b) => a + b.val, 0);
        let rows = '';
        
        detailData.forEach(item => {
            rows += `<tr>
                <td class="clickable" onclick="drilldown('product', '${item.product}')">${item.product}</td>
                <td class="clickable" onclick="drilldown('month', '${item.month}')">${item.month}</td>
                <td class="text-right">${formatNumber(item.qty)}</td>
                <td class="text-right">${formatNumber(item.val)}</td>
            </tr>`;
        });

        document.getElementById('prodMonthDetailBody').innerHTML = rows;
        document.getElementById('prodMonthDetailFoot').innerHTML = `<tr><td colspan="3">Grand total</td><td class="text-right">${formatNumber(total)}</td></tr>`;
    }

    function renderProdSummary() {
        const prodMap = new Map();
        filteredData.forEach(item => {
            if (item.product_name) {
                prodMap.set(item.product_name, {
                    val: (prodMap.get(item.product_name)?.val || 0) + (item.basic_value || 0),
                    qty: (prodMap.get(item.product_name)?.qty || 0) + (item.sale_qty || 0)
                });
            }
        });

        const total = Array.from(prodMap.values()).reduce((a, b) => a + b.val, 0);
        const products = Array.from(prodMap.entries())
            .map(([name, data]) => ({ name, val: data.val, qty: data.qty }))
            .sort((a, b) => b.val - a.val);

        const start = (currentPage - 1) * pageSize;
        const end = Math.min(start + pageSize, products.length);
        const pageProducts = products.slice(start, end);

        let rows = '';
        pageProducts.forEach(p => {
            rows += `<tr>
                <td class="clickable" onclick="drilldown('product', '${p.name}')">${p.name}</td>
                <td class="text-right">${formatNumber(p.qty)}</td>
                <td class="text-right">${formatNumber(p.val)}</td>
                <td class="text-right">${formatPercentage((p.val / total) * 100)}</td>
            </tr>`;
        });

        document.getElementById('prodSummaryBody').innerHTML = rows;
        document.getElementById('prodSummaryFoot').innerHTML = `<tr><td colspan="3">Grand total</td><td class="text-right">${formatNumber(total)}</td></tr>`;
        document.getElementById('prodRange').textContent = `${start + 1}-${end} / ${products.length}`;
        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = end >= products.length;
    }

    function renderDpr() {
        const dprData = filteredData
            .filter(item => item.bill_date && item.bill_no)
            .sort((a, b) => (b.bill_date || '').localeCompare(a.bill_date || ''))
            .slice(0, 100);

        const total = dprData.reduce((a, b) => a + (b.basic_value || 0), 0);
        let rows = '';
        
        dprData.forEach(item => {
            rows += `<tr>
                <td class="clickable" onclick="drilldown('month', '${item.bill_date.substring(0, 7)}')">${item.bill_date || ''}</td>
                <td>${item.bill_no || ''}</td>
                <td class="clickable" onclick="drilldown('location', '${item.location}')">${item.location || ''}</td>
                <td class="clickable" onclick="drilldown('mktBy', '${item.mkt_by}')">${item.mkt_by || ''}</td>
                <td class="clickable" onclick="drilldown('product', '${item.product_name}')">${item.product_name || ''}</td>
                <td>${item.batch_no || ''}</td>
                <td class="clickable" onclick="drilldown('sfName', '${item.sf_name}')">${item.sf_name || ''}</td>
                <td class="text-right">${formatNumber(item.sale_qty)}</td>
                <td class="text-right">${formatNumber(item.basic_value)}</td>
            </tr>`;
        });

        document.getElementById('dprBody').innerHTML = rows;
        document.getElementById('dprFoot').innerHTML = `<tr><td colspan="8">Grand total</td><td class="text-right">${formatNumber(total)}</td></tr>`;
    }

    function renderLocDispatch() {
        const locMap = new Map();
        filteredData.forEach(item => {
            if (!item.location) return;
            if (!locMap.has(item.location)) {
                locMap.set(item.location, { cnt: 0, qty: 0, val: 0 });
            }
            const rec = locMap.get(item.location);
            rec.cnt++;
            rec.qty += item.sale_qty || 0;
            rec.val += item.basic_value || 0;
        });

        const total = Array.from(locMap.values()).reduce((a, b) => a + b.val, 0);
        let rows = '';
        
        Array.from(locMap.entries())
            .sort((a, b) => b[1].val - a[1].val)
            .forEach(([loc, data]) => {
                rows += `<tr>
                    <td class="clickable" onclick="drilldown('location', '${loc}')">${loc}</td>
                    <td class="text-right">${data.cnt}</td>
                    <td class="text-right">${formatNumber(data.qty)}</td>
                    <td class="text-right">${formatNumber(data.val)}</td>
                    <td class="text-right">${formatPercentage((data.val / total) * 100)}</td>
                </tr>`;
            });

        document.getElementById('locDispatchBody').innerHTML = rows;
        document.getElementById('locDispatchFoot').innerHTML = `<tr><td colspan="3">Grand total</td><td class="text-right">${formatNumber(total)}</td><td>100%</td></tr>`;
    }

    function updateGrandTotal() {
        const total = filteredData.reduce((sum, item) => sum + (item.basic_value || 0), 0);
        document.getElementById('grandTotalValue').textContent = formatNumber(total);
    }
</script>
</body>
</html>
