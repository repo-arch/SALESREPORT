<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Dashboard ¬∑ Sheets + Firebase Combined</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif; }
        body { background:#eef2f5; padding:10px; }
        .dashboard { max-width:1300px; margin:0 auto; background:white; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.1); overflow:hidden; }

        .main-header { background:#0b2b4a; color:white; padding:12px 18px; font-size:20px; font-weight:600; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; }
        .main-header small { background:#2a4c73; padding:2px 10px; border-radius:30px; font-size:11px; margin-left:10px; }
        
        .source-stats {
            display:flex;
            gap:15px;
            font-size:12px;
        }
        .sheets-stat { color:#ffd966; }
        .firebase-stat { color:#4caf50; }
        .total-stat { color:white; font-weight:bold; }

        .tabs { display:flex; background:#f0f4f8; border-bottom:2px solid #cbd5e1; flex-wrap:wrap; }
        .tab-btn { padding:8px 16px; font-size:12px; font-weight:500; background:transparent; border:none; border-right:1px solid #cbd5e1; color:#1e3a5f; cursor:pointer; }
        .tab-btn.active { background:#0b2b4a; color:white; }

        .filter-bar { background:#f9fcff; padding:10px 14px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; border-bottom:2px solid #cbd5e1; font-size:12px; }
        .filter-group { display:flex; align-items:center; gap:4px; }
        .filter-group label { font-weight:600; color:#0b2b4a; min-width:40px; font-size:11px; }
        
        .multi-select-container { position:relative; display:inline-block; }
        .multi-select-box { 
            border:1px solid #9aa9b9; 
            border-radius:4px; 
            background:white; 
            min-width:160px; 
            max-width:180px;
            cursor:pointer;
            padding:4px 20px 4px 6px;
            font-size:11px;
            white-space:nowrap;
            overflow:hidden;
            text-overflow:ellipsis;
            background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12"><path d="M2 4 L6 8 L10 4" stroke="%23333" fill="none"/></svg>');
            background-repeat:no-repeat;
            background-position:right 4px center;
        }
        .multi-select-dropdown {
            display:none;
            position:absolute;
            top:100%;
            left:0;
            right:0;
            background:white;
            border:1px solid #9aa9b9;
            border-radius:4px;
            max-height:200px;
            overflow-y:auto;
            z-index:1000;
            box-shadow:0 2px 8px rgba(0,0,0,0.2);
        }
        .multi-select-dropdown.show { display:block; }
        .multi-select-search {
            width:100%;
            padding:6px;
            border:none;
            border-bottom:1px solid #ddd;
            font-size:11px;
            outline:none;
        }
        .multi-select-option {
            padding:5px 8px;
            cursor:pointer;
            font-size:11px;
        }
        .multi-select-option:hover { background:#f0f0f0; }
        .multi-select-option.selected { background:#e3f2fd; font-weight:500; }
        
        .filter-group input[type="month"] { padding:4px 6px; border:1px solid #9aa9b9; border-radius:4px; font-size:11px; width:120px; }
        
        .search-wrapper { display:flex; border:1px solid #9aa9b9; border-radius:4px; overflow:hidden; background:white; margin-left:5px; }
        .search-wrapper input { border:none; padding:5px 8px; width:160px; outline:none; font-size:11px; }
        .search-wrapper button { background:#0b2b4a; color:white; border:none; padding:5px 12px; cursor:pointer; font-size:11px; font-weight:500; }
        
        .action-btn { padding:4px 12px; border:none; border-radius:4px; font-weight:500; cursor:pointer; font-size:11px; }
        .refresh-btn { background:#0b2b4a; color:white; display:flex; align-items:center; gap:3px; }
        .reset-btn { background:#d6562b; color:white; }
        .export-btn { background:#2e7d32; color:white; display:flex; align-items:center; gap:3px; }

        .active-filters-bar { background:#fff6d9; padding:8px 14px; display:none; flex-wrap:wrap; gap:8px; align-items:center; border-bottom:2px solid #ffe28c; font-size:12px; }
        .filter-tag { background:#ffd966; padding:4px 10px; border-radius:30px; font-size:11px; font-weight:600; display:inline-flex; align-items:center; gap:6px; }
        .filter-tag button { 
            background:#b45f06; 
            color:white; 
            border:none; 
            border-radius:50%; 
            width:20px; 
            height:20px; 
            font-size:13px; 
            font-weight:bold; 
            cursor:pointer; 
            display:inline-flex; 
            align-items:center; 
            justify-content:center;
            line-height:1;
            padding:0;
        }
        .filter-tag button:hover { background:#8b4b04; }

        .modal {
            display:none;
            position:fixed;
            top:0;
            left:0;
            width:100%;
            height:100%;
            background:rgba(0,0,0,0.5);
            z-index:10000;
            align-items:center;
            justify-content:center;
        }
        .modal.show { display:flex; }
        .modal-content {
            background:white;
            padding:20px;
            border-radius:8px;
            max-width:400px;
            width:90%;
        }
        .modal h3 { margin-bottom:15px; color:#0b2b4a; }
        .modal input { width:100%; padding:8px; margin-bottom:15px; border:1px solid #9aa9b9; border-radius:4px; }
        .modal-buttons { display:flex; gap:10px; justify-content:flex-end; }
        .modal button { padding:6px 16px; border:none; border-radius:4px; cursor:pointer; }
        .modal-btn-primary { background:#0b2b4a; color:white; }
        .modal-btn-secondary { background:#ddd; }

        .content { padding:14px; }
        .tab-pane { display:none; }
        .tab-pane.active { display:block; }

        .section-title { font-size:15px; font-weight:700; color:#0b2b4a; margin:15px 0 8px; border-bottom:2px solid #d0ddeb; padding-bottom:4px; display:flex; justify-content:space-between; align-items:center; }
        .total-badge { font-size:11px; background:#e6f0ff; padding:2px 8px; border-radius:20px; }

        .table-wrapper { border:1px solid #b7c1cf; border-radius:5px; overflow:auto; max-height:350px; margin-bottom:18px; }
        table { width:100%; border-collapse:collapse; font-size:11px; min-width:600px; }
        thead th { background:#1f4172; color:white; padding:6px 4px; border:1px solid #102a4a; position:sticky; top:0; white-space:nowrap; cursor:pointer; user-select:none; }
        thead th.sort-asc::after { content:" ‚Üë"; margin-left:2px; color:#ffd966; font-weight:bold; }
        thead th.sort-desc::after { content:" ‚Üì"; margin-left:2px; color:#ffd966; font-weight:bold; }
        tbody td { padding:4px 4px; border:1px solid #b7c1cf; white-space:nowrap; }
        tbody tr:hover { background:#f2f8ff; }
        tfoot td { background:#d6562b; color:white; font-weight:600; padding:4px; border:1px solid #b7c1cf; position:sticky; bottom:0; }
        .clickable { cursor:pointer; transition:0.1s; }
        .clickable:hover { background:#ffe8c7 !important; font-weight:500; }
        .text-right { text-align:right; }
        .source-tag { 
            display:inline-block;
            padding:2px 6px;
            border-radius:12px;
            font-size:9px;
            font-weight:bold;
            margin-left:5px;
        }
        .source-sheets { background:#ffd966; color:#0b2b4a; }
        .source-firebase { background:#4caf50; color:white; }

        .pagination { display:flex; gap:8px; align-items:center; }
        .grand-footer { background:#0b2b4a; color:white; padding:10px 18px; display:flex; justify-content:space-between; font-weight:600; font-size:13px; }
        .dashboard-footer { background:#0b2b4a; color:white; padding:8px 18px; display:flex; justify-content:space-between; font-size:11px; border-top:2px solid #1f4a7a; }
        
        .data-source-badge { background:#ff9800; color:white; padding:2px 8px; border-radius:12px; font-size:10px; margin-left:5px; }
        .stats-badge { background:#4caf50; color:white; padding:2px 10px; border-radius:20px; font-size:11px; margin-left:10px; }
    </style>
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- FileSaver.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- Google API Client -->
    <script src="https://apis.google.com/js/api.js"></script>
    <!-- KJUR for JWT signing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/10.5.25/jsrsasign-all-min.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>
<!-- Password Modal -->
<div class="modal" id="passwordModal">
    <div class="modal-content">
        <h3>Enter Password for Export</h3>
        <input type="password" id="passwordInput" placeholder="Enter password">
        <div class="modal-buttons">
            <button class="modal-btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="modal-btn-primary" onclick="submitPassword()">Export</button>
        </div>
    </div>
</div>

<div class="dashboard">
    <div class="main-header">
        <span>Business Dashboard ¬∑ Combined Data 
            <span id="totalRecords" class="stats-badge">0 total</span>
        </span>
        <div class="source-stats">
            <span class="sheets-stat">üìä Sheets: <span id="sheetsCount">0</span></span>
            <span class="firebase-stat">üî• Firebase: <span id="firebaseCount">0</span></span>
        </div>
    </div>

    <div class="tabs" id="tabContainer"></div>

    <!-- FILTERS -->
    <div class="filter-bar">
        <div class="filter-group">
            <label>Location</label>
            <div class="multi-select-container" id="locationContainer">
                <div class="multi-select-box" onclick="toggleDropdown('location')">All Locations</div>
                <div class="multi-select-dropdown" id="locationDropdown">
                    <input type="text" class="multi-select-search" placeholder="Search..." onkeyup="filterDropdown('location', this.value)">
                    <div class="multi-select-options" id="locationOptions"></div>
                </div>
            </div>
        </div>
        
        <div class="filter-group">
            <label>Mkt By</label>
            <div class="multi-select-container" id="mktByContainer">
                <div class="multi-select-box" onclick="toggleDropdown('mktBy')">All</div>
                <div class="multi-select-dropdown" id="mktByDropdown">
                    <input type="text" class="multi-select-search" placeholder="Search..." onkeyup="filterDropdown('mktBy', this.value)">
                    <div class="multi-select-options" id="mktByOptions"></div>
                </div>
            </div>
        </div>
        
        <div class="filter-group">
            <label>Product Type</label>
            <div class="multi-select-container" id="productTypeContainer">
                <div class="multi-select-box" onclick="toggleDropdown('productType')">All Types</div>
                <div class="multi-select-dropdown" id="productTypeDropdown">
                    <input type="text" class="multi-select-search" placeholder="Search..." onkeyup="filterDropdown('productType', this.value)">
                    <div class="multi-select-options" id="productTypeOptions"></div>
                </div>
            </div>
        </div>
        
        <div class="filter-group">
            <label>Source</label>
            <select id="sourceFilter" onchange="filterChanged()" style="padding:4px; border:1px solid #9aa9b9; border-radius:4px; font-size:11px;">
                <option value="all">All Sources</option>
                <option value="sheets">Google Sheets Only</option>
                <option value="firebase">Firebase Only</option>
            </select>
        </div>
        
        <div class="filter-group"><label>From</label><input type="month" id="dateFrom" onchange="filterChanged()"></div>
        <div class="filter-group"><label>To</label><input type="month" id="dateTo" onchange="filterChanged()"></div>
        
        <div class="search-wrapper">
            <input type="text" id="globalSearch" placeholder="Search..." onkeyup="filterChanged()">
            <button onclick="filterChanged()">üîç</button>
        </div>
        
        <button class="action-btn refresh-btn" onclick="refreshAllData()"><span>üîÑ</span> Refresh All</button>
        <button class="action-btn reset-btn" onclick="clearAllFilters()">Reset</button>
        <button class="action-btn export-btn" onclick="showPasswordModal()"><span>üì•</span> Export Tab</button>
    </div>
    
    <div class="active-filters-bar" id="activeFiltersBar">
        <span style="font-weight:600;">Active:</span>
        <span id="activeFilters"></span>
        <button onclick="clearAllFilters()" style="margin-left:auto; background:none; border:none; color:#856404; font-size:11px; font-weight:bold;">‚úï CLEAR ALL</button>
    </div>

    <div id="loading" class="loading" style="display:none; text-align:center; padding:40px;">‚¨áÔ∏è Loading ...</div>
    <div id="error" style="display:none; background:#ffebee; padding:30px; text-align:center;"></div>

    <div class="content" id="tabPanes"></div>

    <div class="grand-footer">
        <span>Overall Grand Total (filtered) <span id="dataSource" class="data-source-badge">Combined</span></span>
        <span id="grandTotalValue">0</span>
    </div>
    <div class="dashboard-footer">
        <span>üèÖ Combined data from Google Sheets (32,660 rows) + Firebase</span>
        <span id="footerTime"></span>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
    // ==================== CONFIGURATION ====================
    
    // Firebase config
    const firebaseConfig = {
        apiKey: "AIzaSyBzZtL5I4UoQ3v7R2xX9wL8mN4kP6rS2tY",
        authDomain: "salesdata-30dcb.firebaseapp.com",
        projectId: "salesdata-30dcb",
        storageBucket: "salesdata-30dcb.appspot.com",
        messagingSenderId: "109295402367",
        appId: "1:109295402367:web:8f7d6e5c4b3a2f1e0d9c8b"
    };
    
    // Google Sheets Service Account Configuration
    const SERVICE_ACCOUNT = {
        type: "service_account",
        project_id: "salereport-488712",
        private_key_id: "d43b52c15d1bd8e0ddb35661f1ec469bf13f6469",
        private_key: `-----BEGIN PRIVATE KEY-----
MIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQCb7UVMq0RAmfMG
EUmFjEVQ/vb66iZ39uGARpzpR1bpVzrUBvTAxNW8sNi3EHNCWgOoDF5xo99eFotH
kVWeyvCOwuNbsnOsMzXdZpjB/7cbj3MGBmeHLz1JxWEu/UagU9HbveVqaWjp7dwJ
IpVFCtY61tmthY20XYBQ5g5ttCxNGMFTQRIOGvqoceSCNchuL7Mn6V3MTWBC0FPG
fEt0GM2KspPYbKSxqdpBBPQwBkVlZtY67Pb7a4KHRudMrKCqFMa7PQVULqgg/e/C
SNxAjz3je/acvjdXxFFpQ/nuN/De9YIW1NaAaSrRi1gsycpTXVRqv0VRhgqxJmJ1
1v/x28YtAgMBAAECggEABJstwOYOTho+I5+/HELYiVv+z8q6+DBC2Rc862dAGgSJ
qFnMQSWPatOOk1nZDcy67uvunkzI/G6ODr8sWFSGZrE7JipPYHbi0HeHa7OyJQ5H
x5XI2SV8GgHKrSiuPW48dNFXRZ13i/GK3no3DqMTUQmnxIh9dyaL89fX9UWtSVm2
DgCQfFfOob59foYZJkdYnzeAEt8tvCTTizm7J5mexFR6vOM8sr6AYjIw9bUNEGFb
U7szkvM1oWHEEt1yaELpymhQ80mbfnaVxqNtxhU0+mVBGoU/Qnvuq6Ypbe5QiZ0p
LUJb61wGJEgTTd5WbWd1SfojFmaOQR20H1aos+uTwQKBgQDLOa9tbs7ETMki+dDC
LqwHj6KDWYn/h/PpALm5T/Pvf8g+GLSGtl0INBOo3bntg9bdy55LeKl2BlKhjhzz
33JQaMDs/nXKm7W0FLrEgG1LqBLCLZeFQUimVVtnIu6rJ8yLhbiTfmV9NG6dwvyL
eWdCjQkzUdlx5Yrb+SI3O5pkDwKBgQDEazTAiQtKQIkfBL78Jg9zt/8DZA1Y4rh9
zpVMJaDaFRCKde/5OUpKjajxauROsznLVQ47n3sYlz+3YUTtn531nl8WzOvNpL4m
41id5dIz3xUsAEt8LEaffyuatziMmdgyi1qE5XW6RH0MI8Q286EV6F2ZVSSTjKvC
HjCMEsfGAwKBgAsFS9AhbDEVAOtWpM2C/m1CisuYtXUYCFAga/HytgXM5i0H5fJQ
PWdOe6pyq7yHo8VPX3w0ROxTl3OPY16ORYK6y4uOmRCttQLZBO/XDxZFPQ8urcLa
MXhjtJs5N7wsYllGnSXSeup5R25ivpNJuCHRyCfyTlpw2kDnl8VrBApdAoGASZ0s
TiSOmKuLOJbcxT+2dtY0ux6aaf++yVfNWJaZrGJMqrf80lkIYNyqvqAjJOPC+1PL
W8kvp024UZAg9zXlS5KpbLAsiAwAQC7gnXzuxQYMt0r8/3LQnSJaQ0f756YZAwh7
Smd9MexNOWmGNloku0M1ISxp4urLzJrn8vdu6+UCgYASl3o06Gz2Qp9JBz4Crg6g
Yyc2Uijh8pYFJv1sQtz7+EOFWLy+lVbTLodqzhtpGGKqgaz+2S9uRDzInPsfvwjs
IhVq/LZVNG3rXXWMpgIBMFA2u+3kZ3KDPIUdDkZDfe1m3XMMdCCxPL6mJnjhfG1Y
vChOh687LsxiQE7HP/2wYw==
-----END PRIVATE KEY-----`,
        client_email: "salereport@salereport-488712.iam.gserviceaccount.com",
        client_id: "103282691756205843073",
        auth_uri: "https://accounts.google.com/o/oauth2/auth",
        token_uri: "https://oauth2.googleapis.com/token"
    };
    
    const SHEETS_CONFIG = {
        spreadsheetId: '1_sdbm98rSJvOXPI4IciCSc-E8CArmwx5a_2bQXH4vEs',
        sheetName: 'Main',
        range: 'Main!A1:V'
    };

    // Field mapping for Google Sheets
    const SHEETS_FIELD_MAPPING = {
        'Location': 'location',
        'Bill_No.': 'bill_no',
        'Bill_Date': 'bill_date',
        'Product_Code': 'product_code',
        'Product_Name': 'product_name',
        'Product_Type': 'product_type',
        'Batch_No.': 'batch_no',
        'Sale Qty._NOS': 'sale_qty_nos',
        'Uom': 'uom',
        'Sale_Qty': 'sale_qty',
        'Rate': 'rate',
        'Basic_Value': 'basic_value',
        'SF_Code': 'sf_code',
        'SF_Name': 'sf_name',
        'Item_Type': 'item_type',
        'ORDERDT': 'orderdt',
        'Mkt._By.': 'mkt_by',
        'Dosage_Form': 'dosage_form',
        'PartyName': 'party_name',
        'CITY': 'city',
        'STATE': 'state',
        'COUNTRY': 'country'
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ==================== GLOBALS ====================
    let sheetsData = [];
    let firebaseData = [];
    let allData = []; // Combined data
    let filteredData = [];
    let uniqueValues = { locations: [], mktBy: [], productTypes: [] };
    let selectedFilters = { locations: [], mktBy: [], productTypes: [] };
    let availableYears = [];
    let activeDropdown = null;
    let accessToken = null;

    // Sorting state
    let sortState = {
        fy: { col: 0, dir: 'asc' },
        cat: { col: 1, dir: 'desc' },
        dosage: { col: 1, dir: 'desc' },
        mktSimple: { col: 1, dir: 'desc' },
        sfWise: { col: 4, dir: 'desc' },
        sfCode: { col: 4, dir: 'desc' },
        prodDetail: { col: 3, dir: 'desc' },
        prodSummary: { col: 2, dir: 'desc' },
        dpr: { col: 0, dir: 'desc' },
        locDispatch: { col: 3, dir: 'desc' }
    };

    // Pagination
    let currentPage = 1;
    const pageSize = 50;

    // Tabs
    const tabs = [
        { id: 'salesBoard', name: 'SALE DASH BOARD' },
        { id: 'mktSf', name: 'Mkt By & SF' },
        { id: 'sfBrand', name: 'SF & Brand' },
        { id: 'prodMonth', name: 'Product Month Wise' },
        { id: 'dispatch', name: 'Daily Dispatch (DPR)' }
    ];

    // ==================== SERVICE ACCOUNT AUTH ====================
    async function getAccessTokenWithServiceAccount() {
        try {
            const header = {
                alg: 'RS256',
                typ: 'JWT',
                kid: SERVICE_ACCOUNT.private_key_id
            };

            const now = Math.floor(Date.now() / 1000);
            const claim = {
                iss: SERVICE_ACCOUNT.client_email,
                scope: 'https://www.googleapis.com/auth/spreadsheets.readonly',
                aud: SERVICE_ACCOUNT.token_uri,
                exp: now + 3600,
                iat: now
            };

            const encodeBase64Url = (str) => {
                return btoa(str)
                    .replace(/=/g, '')
                    .replace(/\+/g, '-')
                    .replace(/\//g, '_');
            };

            const encodedHeader = encodeBase64Url(JSON.stringify(header));
            const encodedClaim = encodeBase64Url(JSON.stringify(claim));
            
            const signatureInput = `${encodedHeader}.${encodedClaim}`;

            const privateKey = SERVICE_ACCOUNT.private_key;
            
            const sig = new KJUR.crypto.Signature({"alg": "SHA256withRSA"});
            sig.init(privateKey);
            sig.updateString(signatureInput);
            const signatureHex = sig.sign();
            
            const signatureBase64 = btoa(
                signatureHex.match(/.{1,2}/g)
                    .map(byte => String.fromCharCode(parseInt(byte, 16)))
                    .join('')
            ).replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');

            const jwt = `${signatureInput}.${signatureBase64}`;

            const response = await fetch(SERVICE_ACCOUNT.token_uri, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    grant_type: 'urn:ietf:params:oauth:grant-type:jwt-bearer',
                    assertion: jwt
                })
            });

            const tokenData = await response.json();
            if (tokenData.error) {
                throw new Error(tokenData.error_description || tokenData.error);
            }

            accessToken = tokenData.access_token;
            return accessToken;
            
        } catch (error) {
            console.error('Error getting access token:', error);
            throw error;
        }
    }

    // ==================== DATA LOADING ====================
    window.onload = function() {
        createTabs();
        createPanes();
        loadAllData();
    };

    async function loadAllData() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('error').style.display = 'none';
        
        try {
            // Load both sources in parallel
            await Promise.all([
                loadSheetsData(),
                loadFirebaseData()
            ]);
            
            // Combine the data
            combineData();
            
            document.getElementById('loading').style.display = 'none';
            
        } catch (error) {
            console.error('Error loading data:', error);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').innerHTML = 'Error loading data: ' + error.message;
        }
    }

    async function loadSheetsData() {
        try {
            if (!accessToken) {
                await getAccessTokenWithServiceAccount();
            }

            const response = await fetch(
                `https://sheets.googleapis.com/v4/spreadsheets/${SHEETS_CONFIG.spreadsheetId}/values/${SHEETS_CONFIG.range}`,
                {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                }
            );

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            const rows = data.values;
            
            if (!rows || rows.length < 2) {
                sheetsData = [];
                return;
            }
            
            const headers = rows[0];
            console.log('Sheets Headers:', headers);
            
            sheetsData = rows.slice(1).map((row) => {
                const record = { 
                    _source: 'sheets',
                    _sourceColor: 'sheets-badge'
                };
                
                headers.forEach((header, index) => {
                    const field = getSheetsField(header);
                    if (field) {
                        let value = row[index] || '';
                        
                        // Parse numeric values
                        if (field === 'basic_value' || field === 'sale_qty') {
                            value = parseFloat(value) || 0;
                        }
                        
                        record[field] = value;
                    }
                });
                
                // Ensure consistent field names
                if (!record.mkt_by && record.mkt_by !== '') record.mkt_by = '';
                if (!record.location) record.location = '';
                if (!record.bill_date) record.bill_date = '';
                if (!record.product_type) record.product_type = '';
                if (!record.sf_name) record.sf_name = '';
                if (!record.product_name) record.product_name = '';
                
                return record;
            }).filter(record => record.bill_no || record.product_name);

            console.log(`Loaded ${sheetsData.length} records from Google Sheets`);
            document.getElementById('sheetsCount').textContent = sheetsData.length;
            
        } catch (error) {
            console.error('Error loading sheets:', error);
            sheetsData = [];
            document.getElementById('sheetsCount').textContent = '0';
        }
    }

    function getSheetsField(header) {
        if (!header) return null;
        
        // Direct match
        if (SHEETS_FIELD_MAPPING[header]) {
            return SHEETS_FIELD_MAPPING[header];
        }
        
        // Clean header for matching
        const cleanHeader = header.toString().trim().replace(/[._\s]/g, '').toLowerCase();
        
        // Common variations
        const variations = {
            'location': 'location',
            'billno': 'bill_no',
            'billdate': 'bill_date',
            'productcode': 'product_code',
            'productname': 'product_name',
            'producttype': 'product_type',
            'batchno': 'batch_no',
            'saleqtynos': 'sale_qty_nos',
            'uom': 'uom',
            'saleqty': 'sale_qty',
            'rate': 'rate',
            'basicvalue': 'basic_value',
            'sfcode': 'sf_code',
            'sfname': 'sf_name',
            'itemtype': 'item_type',
            'orderdt': 'orderdt',
            'mktby': 'mkt_by',
            'dosageform': 'dosage_form',
            'partyname': 'party_name',
            'city': 'city',
            'state': 'state',
            'country': 'country'
        };
        
        return variations[cleanHeader] || null;
    }

    async function loadFirebaseData() {
        try {
            const snapshot = await db.collection('sales_data').get();
            
            if (snapshot.empty) {
                firebaseData = [];
            } else {
                firebaseData = [];
                snapshot.forEach(doc => {
                    const d = doc.data();
                    firebaseData.push({
                        _source: 'firebase',
                        _sourceColor: 'firebase-badge',
                        mkt_by: d.mkt_by || '',
                        location: d.location || '',
                        basic_value: parseFloat(d.basic_value) || 0,
                        sf_code: d.sf_code || '',
                        sf_name: d.sf_name || '',
                        product_name: d.product_name || '',
                        product_type: d.product_type || '',
                        sale_qty: parseFloat(d.sale_qty) || 0,
                        bill_date: d.bill_date || '',
                        bill_no: d.bill_no || '',
                        batch_no: d.batch_no || '',
                        dosage_form: d.dosage_form || ''
                    });
                });
            }

            console.log(`Loaded ${firebaseData.length} records from Firebase`);
            document.getElementById('firebaseCount').textContent = firebaseData.length;
            
        } catch (err) {
            console.error('Error loading Firebase:', err);
            firebaseData = [];
            document.getElementById('firebaseCount').textContent = '0';
        }
    }

    function combineData() {
        // Simple concatenation of both datasets
        allData = [...sheetsData, ...firebaseData];
        
        console.log(`Combined total: ${allData.length} records`);
        document.getElementById('totalRecords').textContent = `${allData.length} total`;
        document.getElementById('footerTime').textContent = new Date().toLocaleString();
        
        updateUniqueValues();
        filterChanged();
    }

    // ==================== UI FUNCTIONS ====================
    function createTabs() {
        const container = document.getElementById('tabContainer');
        container.innerHTML = '';
        tabs.forEach((tab, i) => {
            const btn = document.createElement('button');
            btn.className = `tab-btn ${i === 0 ? 'active' : ''}`;
            btn.dataset.tab = tab.id;
            btn.textContent = tab.name;
            btn.onclick = switchTab;
            container.appendChild(btn);
        });
    }

    function createPanes() {
        const panes = document.getElementById('tabPanes');
        panes.innerHTML = '';
        tabs.forEach(tab => {
            const pane = document.createElement('div');
            pane.className = 'tab-pane';
            pane.id = `pane-${tab.id}`;
            panes.appendChild(pane);
        });
        document.getElementById('pane-salesBoard').classList.add('active');
    }

    function buildPaneContentsWithYears(years) {
        const sortedYears = years.sort((a,b) => b - a);
        const yearHeaders = sortedYears.map(y => `<th onclick="sortTable('fy',${sortedYears.indexOf(y)+1})">${y}</th>`).join('');
        
        document.getElementById('pane-salesBoard').innerHTML = `
            <div class="section-title">Financial Year / Basic_Value <span class="total-badge" id="fyTotal"></span></div>
            <div class="table-wrapper"><table id="fyTable"><thead><tr><th onclick="sortTable('fy',0)">Mkt_By</th>${yearHeaders}<th onclick="sortTable('fy',${sortedYears.length+1})">Grand total</th></tr></thead><tbody id="fyBody"></tbody><tfoot id="fyFoot"></tfoot></table></div>
            <div class="section-title">Product Type <span class="total-badge" id="catTotal"></span></div>
            <div class="table-wrapper"><table id="catTable"><thead><tr><th onclick="sortTable('cat',0)">Product_Type</th><th onclick="sortTable('cat',1)">Basic_Value</th><th onclick="sortTable('cat',2)">%</th></tr></thead><tbody id="catBody"></tbody><tfoot id="catFoot"></tfoot></table></div>
            <div class="section-title">Dosage_Form / Sale Qty <span class="total-badge" id="dosageTotal"></span></div>
            <div class="table-wrapper"><table id="dosageTable"><thead><tr><th onclick="sortTable('dosage',0)">Dosage_Form</th><th onclick="sortTable('dosage',1)">Sale Qty</th><th onclick="sortTable('dosage',2)">%</th></tr></thead><tbody id="dosageBody"></tbody><tfoot id="dosageFoot"></tfoot></table></div>
        `;
        
        document.getElementById('pane-mktSf').innerHTML = `
            <div class="section-title">Mkt_By / Basic_Value & %</div>
            <div class="table-wrapper"><table id="mktByTable"><thead><tr><th onclick="sortTable('mktSimple',0)">Mkt_By</th><th onclick="sortTable('mktSimple',1)">Basic_Value</th><th onclick="sortTable('mktSimple',2)">%</th></tr></thead><tbody id="mktByBody"></tbody><tfoot id="mktByFoot"></tfoot></table></div>
            <div class="section-title">SF_Name / Sale_Qty / Basic_Value / % <span class="source-indicator" style="margin-left:10px;">üìä Sheets ¬∑ üî• Firebase</span></div>
            <div class="table-wrapper"><table id="sfWiseTable"><thead><tr><th onclick="sortTable('sfWise',0)">SF_Name</th><th onclick="sortTable('sfWise',1)">Product_Name</th><th onclick="sortTable('sfWise',2)">Mkt_By</th><th onclick="sortTable('sfWise',3)">Sale_Qty</th><th onclick="sortTable('sfWise',4)">Basic_Value</th><th onclick="sortTable('sfWise',5)">%</th><th>Source</th></tr></thead><tbody id="sfWiseBody"></tbody><tfoot id="sfWiseFoot"></tfoot></table></div>
        `;
        
        document.getElementById('pane-sfBrand').innerHTML = `
            <div class="section-title">SF Code / SF Name / Product / Sale Qty / Basic Value</div>
            <div class="table-wrapper"><table id="sfCodeTable"><thead><tr><th onclick="sortTable('sfCode',0)">SF_Code</th><th onclick="sortTable('sfCode',1)">SF_Name</th><th onclick="sortTable('sfCode',2)">Product</th><th onclick="sortTable('sfCode',3)">Sale_Qty</th><th onclick="sortTable('sfCode',4)">Basic_Value</th><th onclick="sortTable('sfCode',5)">%</th><th>Source</th></tr></thead><tbody id="sfCodeBody"></tbody><tfoot id="sfCodeFoot"></tfoot></table></div>
        `;
        
        document.getElementById('pane-prodMonth').innerHTML = `
            <div class="section-title">Product Month Wise (detailed)</div>
            <div class="table-wrapper"><table id="prodMonthDetail"><thead><tr><th onclick="sortTable('prodDetail',0)">Product</th><th onclick="sortTable('prodDetail',1)">Month</th><th onclick="sortTable('prodDetail',2)">Sale Qty</th><th onclick="sortTable('prodDetail',3)">Basic Value</th><th>Source</th></tr></thead><tbody id="prodMonthDetailBody"></tbody><tfoot id="prodMonthDetailFoot"></tfoot></table></div>
            <div class="section-title">Product Summary <span class="pagination"><span id="prodRange"></span> <button id="prevBtn" onclick="prevPage()">‚Üê</button><button id="nextBtn" onclick="nextPage()">‚Üí</button></span></div>
            <div class="table-wrapper"><table id="prodSummary"><thead><tr><th onclick="sortTable('prodSummary',0)">Product Name</th><th onclick="sortTable('prodSummary',1)">Sale Qty</th><th onclick="sortTable('prodSummary',2)">Basic Value</th><th onclick="sortTable('prodSummary',3)">%</th></tr></thead><tbody id="prodSummaryBody"></tbody><tfoot id="prodSummaryFoot"></tfoot></table></div>
        `;
        
        document.getElementById('pane-dispatch').innerHTML = `
            <div class="section-title">Dispatch by Location</div>
            <div class="table-wrapper"><table id="locDispatchTable"><thead><tr><th onclick="sortTable('locDispatch',0)">Location</th><th onclick="sortTable('locDispatch',1)">Dispatches</th><th onclick="sortTable('locDispatch',2)">Total Qty</th><th onclick="sortTable('locDispatch',3)">Total Value</th><th onclick="sortTable('locDispatch',4)">%</th></tr></thead><tbody id="locDispatchBody"></tbody><tfoot id="locDispatchFoot"></tfoot></table></div>
            <div class="section-title">Daily Dispatch Details (DPR)</div>
            <div class="table-wrapper"><table id="dprTable"><thead><tr><th onclick="sortTable('dpr',0)">Bill_Date</th><th onclick="sortTable('dpr',1)">Bill_No</th><th onclick="sortTable('dpr',2)">Location</th><th onclick="sortTable('dpr',3)">Mkt_By</th><th onclick="sortTable('dpr',4)">Product</th><th onclick="sortTable('dpr',5)">Batch_No</th><th onclick="sortTable('dpr',6)">SF_Name</th><th onclick="sortTable('dpr',7)">Sale_Qty</th><th onclick="sortTable('dpr',8)">Basic_Value</th><th>Source</th></tr></thead><tbody id="dprBody"></tbody><tfoot id="dprFoot"></tfoot></table></div>
        `;
    }

    function switchTab(e) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
        document.getElementById(`pane-${e.target.dataset.tab}`).classList.add('active');
    }

    window.refreshAllData = function() {
        loadAllData();
    };

    // ==================== DROPDOWN FUNCTIONS ====================
    window.toggleDropdown = function(type) {
        const dropdown = document.getElementById(type + 'Dropdown');
        if (activeDropdown && activeDropdown !== dropdown) {
            activeDropdown.classList.remove('show');
        }
        dropdown.classList.toggle('show');
        activeDropdown = dropdown.classList.contains('show') ? dropdown : null;
        
        setTimeout(() => {
            const searchInput = dropdown.querySelector('.multi-select-search');
            if (searchInput) searchInput.focus();
        }, 100);
    };

    window.filterDropdown = function(type, searchText) {
        const optionsDiv = document.getElementById(type + 'Options');
        const values = uniqueValues[type === 'location' ? 'locations' : (type === 'mktBy' ? 'mktBy' : 'productTypes')];
        const selected = selectedFilters[type === 'location' ? 'locations' : (type === 'mktBy' ? 'mktBy' : 'productTypes')];
        
        const filtered = values.filter(v => v && v.toString().toLowerCase().includes(searchText.toLowerCase()));
        
        optionsDiv.innerHTML = filtered.map(v => `
            <div class="multi-select-option ${selected.includes(v) ? 'selected' : ''}" 
                 onclick="toggleOption('${type}', '${v.replace(/'/g, "\\'")}'); event.stopPropagation();">
                ${v} ${selected.includes(v) ? '‚úì' : ''}
            </div>
        `).join('');
    };

    window.toggleOption = function(type, value) {
        const filterType = type === 'location' ? 'locations' : (type === 'mktBy' ? 'mktBy' : 'productTypes');
        const index = selectedFilters[filterType].indexOf(value);
        if (index === -1) {
            selectedFilters[filterType].push(value);
        } else {
            selectedFilters[filterType].splice(index, 1);
        }
        
        const box = document.querySelector(`#${type}Container .multi-select-box`);
        if (selectedFilters[filterType].length === 0) {
            box.textContent = type === 'location' ? 'All Locations' : (type === 'mktBy' ? 'All' : 'All Types');
        } else if (selectedFilters[filterType].length <= 2) {
            box.textContent = selectedFilters[filterType].join(', ');
        } else {
            box.textContent = `${selectedFilters[filterType].length} selected`;
        }
        
        filterDropdown(type, document.querySelector(`#${type}Dropdown .multi-select-search`).value);
        filterChanged();
    };

    document.addEventListener('click', function(e) {
        if (!e.target.closest('.multi-select-container') && activeDropdown) {
            activeDropdown.classList.remove('show');
            activeDropdown = null;
        }
    });

    // ==================== FILTER FUNCTIONS ====================
    function updateUniqueValues() {
        const locSet = new Set();
        const mktSet = new Set();
        const typeSet = new Set();
        const yearSet = new Set();

        allData.forEach(rec => {
            if (rec.location) locSet.add(rec.location);
            if (rec.mkt_by) mktSet.add(rec.mkt_by);
            if (rec.product_type) typeSet.add(rec.product_type);
            
            // Extract year from bill_date - handle different formats
            if (rec.bill_date) {
                let year = null;
                if (typeof rec.bill_date === 'string') {
                    // Try to extract year from string
                    const match = rec.bill_date.match(/\d{4}/);
                    if (match) year = parseInt(match[0]);
                } else if (rec.bill_date instanceof Date) {
                    year = rec.bill_date.getFullYear();
                }
                
                if (year && year > 2000 && year < 2100) {
                    yearSet.add(year);
                }
            }
        });

        uniqueValues.locations = Array.from(locSet).sort();
        uniqueValues.mktBy = Array.from(mktSet).sort();
        uniqueValues.productTypes = Array.from(typeSet).sort();
        
        availableYears = Array.from(yearSet).sort((a,b) => b - a);
        if (availableYears.length === 0) {
            // Default years if none found
            availableYears = [2024, 2023, 2022];
        }
        
        buildPaneContentsWithYears(availableYears);
        populateDropdowns();
    }

    function populateDropdowns() {
        document.getElementById('locationOptions').innerHTML = uniqueValues.locations.map(v => 
            `<div class="multi-select-option" onclick="toggleOption('location', '${v.replace(/'/g, "\\'")}'); event.stopPropagation();">${v}</div>`
        ).join('');
        
        document.getElementById('mktByOptions').innerHTML = uniqueValues.mktBy.map(v => 
            `<div class="multi-select-option" onclick="toggleOption('mktBy', '${v.replace(/'/g, "\\'")}'); event.stopPropagation();">${v}</div>`
        ).join('');
        
        document.getElementById('productTypeOptions').innerHTML = uniqueValues.productTypes.map(v => 
            `<div class="multi-select-option" onclick="toggleOption('productType', '${v.replace(/'/g, "\\'")}'); event.stopPropagation();">${v}</div>`
        ).join('');
    }

    window.filterChanged = function() {
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        const search = document.getElementById('globalSearch').value.toLowerCase();
        const sourceFilter = document.getElementById('sourceFilter').value;

        filteredData = allData.filter(item => {
            // Source filter
            if (sourceFilter !== 'all' && item._source !== sourceFilter) return false;
            
            // Location filter
            if (selectedFilters.locations.length && !selectedFilters.locations.includes(item.location)) return false;
            
            // Mkt By filter
            if (selectedFilters.mktBy.length && !selectedFilters.mktBy.includes(item.mkt_by)) return false;
            
            // Product Type filter
            if (selectedFilters.productTypes.length && !selectedFilters.productTypes.includes(item.product_type)) return false;
            
            // Date range filter
            if (dateFrom || dateTo) {
                let itemDate = item.bill_date;
                if (itemDate) {
                    // Extract YYYY-MM from various formats
                    let itemMonth = '';
                    if (typeof itemDate === 'string') {
                        const match = itemDate.match(/(\d{4})[-/](\d{2})/);
                        if (match) itemMonth = `${match[1]}-${match[2]}`;
                    }
                    
                    if (dateFrom && itemMonth < dateFrom) return false;
                    if (dateTo && itemMonth > dateTo) return false;
                }
            }
            
            // Search filter
            if (search) {
                return (item.product_name && item.product_name.toLowerCase().includes(search)) ||
                       (item.sf_name && item.sf_name.toLowerCase().includes(search)) ||
                       (item.sf_code && item.sf_code.toLowerCase().includes(search)) ||
                       (item.batch_no && item.batch_no.toLowerCase().includes(search));
            }
            return true;
        });

        currentPage = 1;
        renderAllTables();
        updateActiveFilters();
    };

    function updateActiveFilters() {
        const tags = [];
        if (selectedFilters.locations.length) tags.push(`Location: ${selectedFilters.locations.join(', ')}`);
        if (selectedFilters.mktBy.length) tags.push(`Mkt: ${selectedFilters.mktBy.join(', ')}`);
        if (selectedFilters.productTypes.length) tags.push(`Type: ${selectedFilters.productTypes.join(', ')}`);
        if (document.getElementById('dateFrom').value) tags.push(`From: ${document.getElementById('dateFrom').value}`);
        if (document.getElementById('dateTo').value) tags.push(`To: ${document.getElementById('dateTo').value}`);
        if (document.getElementById('globalSearch').value) tags.push(`Search: ${document.getElementById('globalSearch').value}`);
        if (document.getElementById('sourceFilter').value !== 'all') {
            tags.push(`Source: ${document.getElementById('sourceFilter').value}`);
        }

        const bar = document.getElementById('activeFiltersBar');
        const container = document.getElementById('activeFilters');
        
        if (tags.length) {
            bar.style.display = 'flex';
            container.innerHTML = tags.map(t => 
                `<span class="filter-tag">${t} <button onclick="removeFilterTag('${t.split(':')[0].trim()}')">‚úï</button></span>`
            ).join(' ');
        } else {
            bar.style.display = 'none';
        }
    }

    window.removeFilterTag = function(type) {
        if (type === 'Location') {
            selectedFilters.locations = [];
            document.querySelector('#locationContainer .multi-select-box').textContent = 'All Locations';
        } else if (type === 'Mkt') {
            selectedFilters.mktBy = [];
            document.querySelector('#mktByContainer .multi-select-box').textContent = 'All';
        } else if (type === 'Type') {
            selectedFilters.productTypes = [];
            document.querySelector('#productTypeContainer .multi-select-box').textContent = 'All Types';
        } else if (type === 'From') {
            document.getElementById('dateFrom').value = '';
        } else if (type === 'To') {
            document.getElementById('dateTo').value = '';
        } else if (type === 'Search') {
            document.getElementById('globalSearch').value = '';
        } else if (type === 'Source') {
            document.getElementById('sourceFilter').value = 'all';
        }
        filterChanged();
    };

    window.clearAllFilters = function() {
        selectedFilters.locations = [];
        selectedFilters.mktBy = [];
        selectedFilters.productTypes = [];
        document.querySelector('#locationContainer .multi-select-box').textContent = 'All Locations';
        document.querySelector('#mktByContainer .multi-select-box').textContent = 'All';
        document.querySelector('#productTypeContainer .multi-select-box').textContent = 'All Types';
        document.getElementById('dateFrom').value = '';
        document.getElementById('dateTo').value = '';
        document.getElementById('globalSearch').value = '';
        document.getElementById('sourceFilter').value = 'all';
        filterChanged();
    };

    // ==================== DRILLDOWN ====================
    window.drilldown = function(type, value) {
        if (type === 'mktBy') {
            selectedFilters.mktBy = [value];
            document.querySelector('#mktByContainer .multi-select-box').textContent = value;
        } else if (type === 'location') {
            selectedFilters.locations = [value];
            document.querySelector('#locationContainer .multi-select-box').textContent = value;
        } else if (type === 'productType') {
            selectedFilters.productTypes = [value];
            document.querySelector('#productTypeContainer .multi-select-box').textContent = value;
        } else if (type === 'sfName' || type === 'product') {
            document.getElementById('globalSearch').value = value;
        } else if (type === 'month') {
            document.getElementById('dateFrom').value = value;
            document.getElementById('dateTo').value = value;
        }
        filterChanged();
    };

    // ==================== SORTING ====================
    window.sortTable = function(tableId, colIndex) {
        if (!sortState[tableId]) sortState[tableId] = { col: colIndex, dir: 'asc' };
        let state = sortState[tableId];
        if (state.col === colIndex) {
            state.dir = state.dir === 'asc' ? 'desc' : 'asc';
        } else {
            state.col = colIndex;
            state.dir = 'asc';
        }
        
        const headers = document.querySelectorAll(`#${tableId} thead th`);
        headers.forEach((th, idx) => {
            th.classList.remove('sort-asc', 'sort-desc');
            if (idx === state.col) th.classList.add(`sort-${state.dir}`);
        });
        
        renderAllTables();
    };

    // ==================== PAGINATION ====================
    window.prevPage = function() { if (currentPage > 1) { currentPage--; renderProdSummary(); } };
    window.nextPage = function() { currentPage++; renderProdSummary(); };

    // ==================== RENDER FUNCTIONS ====================
    function renderAllTables() {
        renderFyBoard();
        renderCategory();
        renderDosageForm();
        renderMktBySimple();
        renderSfWise();
        renderSfCode();
        renderProdMonthDetail();
        renderProdSummary();
        renderLocDispatch();
        renderDpr();
        updateGrandTotal();
    }

    function formatNumber(num) { return (num || 0).toLocaleString('en-IN', { maximumFractionDigits: 2, minimumFractionDigits: 2 }); }
    function formatPercentage(num) { return (num || 0).toFixed(2) + '%'; }

    function renderFyBoard() {
        let map = new Map();
        
        filteredData.forEach(r => {
            if (!r.mkt_by) return;
            
            // Extract year from bill_date
            let year = null;
            if (r.bill_date) {
                if (typeof r.bill_date === 'string') {
                    const match = r.bill_date.match(/\d{4}/);
                    if (match) year = match[0];
                } else if (r.bill_date instanceof Date) {
                    year = r.bill_date.getFullYear().toString();
                }
            }
            
            if (!year) return;
            
            if (!map.has(r.mkt_by)) map.set(r.mkt_by, new Map());
            const yearMap = map.get(r.mkt_by);
            yearMap.set(year, (yearMap.get(year) || 0) + r.basic_value);
        });

        let rows = [];
        const years = availableYears.map(y => y.toString());
        
        for (let [mkt, yearMap] of map.entries()) {
            let row = { mkt };
            let total = 0;
            years.forEach(y => {
                row[y] = yearMap.get(y) || 0;
                total += row[y];
            });
            row.total = total;
            rows.push(row);
        }

        // If no data, show message
        if (rows.length === 0) {
            document.getElementById('fyBody').innerHTML = '<tr><td colspan="' + (years.length + 2) + '" style="text-align:center; padding:20px;">No financial year data available</td></tr>';
            document.getElementById('fyFoot').innerHTML = '';
            document.getElementById('fyTotal').textContent = 'Total: 0';
            return;
        }

        const state = sortState.fy || { col: 0, dir: 'asc' };
        rows.sort((a, b) => {
            let fieldA, fieldB;
            if (state.col === 0) {
                fieldA = a.mkt;
                fieldB = b.mkt;
            } else if (state.col <= years.length) {
                const year = years[state.col - 1];
                fieldA = a[year] || 0;
                fieldB = b[year] || 0;
            } else {
                fieldA = a.total;
                fieldB = b.total;
            }
            
            if (typeof fieldA === 'string') {
                return state.dir === 'asc' ? fieldA.localeCompare(fieldB) : fieldB.localeCompare(fieldA);
            } else {
                return state.dir === 'asc' ? fieldA - fieldB : fieldB - fieldA;
            }
        });

        let yearTotals = {};
        years.forEach(y => yearTotals[y] = 0);
        let grandTotal = 0;
        
        let tbody = '';
        rows.forEach(row => {
            tbody += '<tr>';
            tbody += `<td class="clickable" onclick="drilldown('mktBy','${row.mkt}')">${row.mkt}</td>`;
            years.forEach(y => {
                const val = row[y] || 0;
                yearTotals[y] += val;
                grandTotal += val;
                tbody += `<td class="text-right clickable" onclick="drilldown('mktBy','${row.mkt}')">${formatNumber(val)}</td>`;
            });
            tbody += `<td class="text-right clickable" onclick="drilldown('mktBy','${row.mkt}')">${formatNumber(row.total)}</td>`;
            tbody += '</tr>';
        });

        document.getElementById('fyBody').innerHTML = tbody;
        
        let footer = '<tr><td>Grand total</td>';
        years.forEach(y => footer += `<td class="text-right">${formatNumber(yearTotals[y])}</td>`);
        footer += `<td class="text-right">${formatNumber(grandTotal)}</td></tr>`;
        document.getElementById('fyFoot').innerHTML = footer;
        document.getElementById('fyTotal').textContent = `Total: ${formatNumber(grandTotal)}`;
    }

    function renderCategory() {
        let map = new Map();
        filteredData.forEach(r => { if (r.product_type) map.set(r.product_type, (map.get(r.product_type)||0) + r.basic_value); });
        let total = Array.from(map.values()).reduce((a,b)=>a+b,0);
        let arr = Array.from(map.entries()).map(([type,val])=>({type,val}));
        
        if (arr.length === 0) {
            document.getElementById('catBody').innerHTML = '<tr><td colspan="3" style="text-align:center;">No product type data</td></tr>';
            document.getElementById('catFoot').innerHTML = '';
            document.getElementById('catTotal').innerText = 'Total: 0';
            return;
        }
        
        let state = sortState.cat || {col:1, dir:'desc'};
        arr.sort((a,b) => {
            if (state.col===0) return state.dir==='asc' ? a.type.localeCompare(b.type) : b.type.localeCompare(a.type);
            else return state.dir==='asc' ? a.val - b.val : b.val - a.val;
        });
        let rows = arr.map(i => `<tr><td class="clickable" onclick="drilldown('productType','${i.type}')">${i.type}</td><td class="text-right clickable" onclick="drilldown('productType','${i.type}')">${formatNumber(i.val)}</td><td class="text-right">${formatPercentage(i.val/total*100)}</td></tr>`).join('');
        document.getElementById('catBody').innerHTML = rows;
        document.getElementById('catFoot').innerHTML = `<tr><td>Grand total</td><td class="text-right">${formatNumber(total)}</td><td></td></tr>`;
        document.getElementById('catTotal').innerText = 'Total: '+formatNumber(total);
    }

    function renderDosageForm() {
        let map = new Map();
        filteredData.forEach(r => { if (r.dosage_form) map.set(r.dosage_form, (map.get(r.dosage_form)||0) + (r.sale_qty||0)); });
        let total = Array.from(map.values()).reduce((a,b)=>a+b,0);
        let arr = Array.from(map.entries()).map(([form,qty])=>({form,qty}));
        
        if (arr.length === 0) {
            document.getElementById('dosageBody').innerHTML = '<tr><td colspan="3" style="text-align:center;">No dosage form data</td></tr>';
            document.getElementById('dosageFoot').innerHTML = '';
            document.getElementById('dosageTotal').innerText = 'Total: 0';
            return;
        }
        
        let state = sortState.dosage || {col:1, dir:'desc'};
        arr.sort((a,b) => {
            if (state.col===0) return state.dir==='asc' ? a.form.localeCompare(b.form) : b.form.localeCompare(a.form);
            else return state.dir==='asc' ? a.qty - b.qty : b.qty - a.qty;
        });
        let rows = arr.map(i => `<tr><td>${i.form}</td><td class="text-right">${formatNumber(i.qty)}</td><td class="text-right">${formatPercentage(i.qty/total*100)}</td></tr>`).join('');
        document.getElementById('dosageBody').innerHTML = rows;
        document.getElementById('dosageFoot').innerHTML = `<tr><td>Grand total</td><td class="text-right">${formatNumber(total)}</td><td></td></tr>`;
        document.getElementById('dosageTotal').innerText = 'Total: '+formatNumber(total);
    }

    function renderMktBySimple() {
        let map = new Map();
        filteredData.forEach(r => { if (r.mkt_by) map.set(r.mkt_by, (map.get(r.mkt_by)||0) + r.basic_value); });
        let total = Array.from(map.values()).reduce((a,b)=>a+b,0);
        let arr = Array.from(map.entries()).map(([m,val])=>({m,val}));
        
        if (arr.length === 0) {
            document.getElementById('mktByBody').innerHTML = '<tr><td colspan="3" style="text-align:center;">No Mkt By data</td></tr>';
            document.getElementById('mktByFoot').innerHTML = '';
            return;
        }
        
        let state = sortState.mktSimple || {col:1, dir:'desc'};
        arr.sort((a,b) => {
            if (state.col===0) return state.dir==='asc' ? a.m.localeCompare(b.m) : b.m.localeCompare(a.m);
            else return state.dir==='asc' ? a.val - b.val : b.val - a.val;
        });
        let rows = arr.map(i => `<tr><td class="clickable" onclick="drilldown('mktBy','${i.m}')">${i.m}</td><td class="text-right clickable" onclick="drilldown('mktBy','${i.m}')">${formatNumber(i.val)}</td><td class="text-right">${formatPercentage(i.val/total*100)}</td></tr>`).join('');
        document.getElementById('mktByBody').innerHTML = rows;
        document.getElementById('mktByFoot').innerHTML = `<tr><td>Grand total</td><td class="text-right">${formatNumber(total)}</td><td>100%</td></tr>`;
    }

    function renderSfWise() {
        let map = new Map();
        filteredData.forEach(r => {
            if (!r.sf_name) return;
            let key = r.sf_name+'|'+r.product_name;
            let cur = map.get(key) || {sf:r.sf_name, prod:r.product_name, mkt:r.mkt_by, qty:0, val:0, source:r._source};
            cur.qty += r.sale_qty||0; cur.val += r.basic_value||0;
            map.set(key, cur);
        });
        let arr = Array.from(map.values());
        let total = arr.reduce((a,b)=>a+b.val,0);
        
        if (arr.length === 0) {
            document.getElementById('sfWiseBody').innerHTML = '<tr><td colspan="7" style="text-align:center;">No SF Wise data</td></tr>';
            document.getElementById('sfWiseFoot').innerHTML = '';
            return;
        }
        
        let state = sortState.sfWise || { col: 4, dir: 'desc' };
        
        arr.sort((a, b) => {
            let fieldsA = [a.sf || '', a.prod || '', a.mkt || '', a.qty || 0, a.val || 0, (a.val/total*100) || 0];
            let fieldsB = [b.sf || '', b.prod || '', b.mkt || '', b.qty || 0, b.val || 0, (b.val/total*100) || 0];
            
            let fa = fieldsA[state.col];
            let fb = fieldsB[state.col];
            
            if (typeof fa === 'string') {
                return state.dir === 'asc' ? fa.localeCompare(fb) : fb.localeCompare(fa);
            } else {
                return state.dir === 'asc' ? fa - fb : fb - fa;
            }
        });
        
        let rows = arr.map(i => `<tr>
            <td class="clickable" onclick="drilldown('sfName','${i.sf}')">${i.sf}</td>
            <td class="clickable" onclick="drilldown('product','${i.prod}')">${i.prod||'-'}</td>
            <td class="clickable" onclick="drilldown('mktBy','${i.mkt}')">${i.mkt||'-'}</td>
            <td class="text-right">${formatNumber(i.qty)}</td>
            <td class="text-right clickable" onclick="drilldown('sfName','${i.sf}')">${formatNumber(i.val)}</td>
            <td class="text-right">${formatPercentage(i.val/total*100)}</td>
            <td><span class="source-tag ${i.source === 'sheets' ? 'source-sheets' : 'source-firebase'}">${i.source}</span></td>
        </tr>`).join('');
        document.getElementById('sfWiseBody').innerHTML = rows;
        document.getElementById('sfWiseFoot').innerHTML = `<tr><td colspan="5">Grand total</td><td class="text-right">${formatNumber(total)}</td><td>100%</td><td></td></tr>`;
    }

    function renderSfCode() {
        let map = new Map();
        filteredData.forEach(r => {
            if (!r.sf_code) return;
            let key = r.sf_code+'|'+r.sf_name+'|'+r.product_name;
            let cur = map.get(key) || {code:r.sf_code, sf:r.sf_name, prod:r.product_name, qty:0, val:0, source:r._source};
            cur.qty += r.sale_qty||0; cur.val += r.basic_value||0;
            map.set(key, cur);
        });
        let arr = Array.from(map.values());
        let total = arr.reduce((a,b)=>a+b.val,0);
        
        if (arr.length === 0) {
            document.getElementById('sfCodeBody').innerHTML = '<tr><td colspan="7" style="text-align:center;">No SF Code data</td></tr>';
            document.getElementById('sfCodeFoot').innerHTML = '';
            return;
        }
        
        let state = sortState.sfCode || { col: 4, dir: 'desc' };
        
        arr.sort((a, b) => {
            let fieldsA = [a.code || '', a.sf || '', a.prod || '', a.qty || 0, a.val || 0, (a.val/total*100) || 0];
            let fieldsB = [b.code || '', b.sf || '', b.prod || '', b.qty || 0, b.val || 0, (b.val/total*100) || 0];
            
            let fa = fieldsA[state.col];
            let fb = fieldsB[state.col];
            
            if (typeof fa === 'string') {
                return state.dir === 'asc' ? fa.localeCompare(fb) : fb.localeCompare(fa);
            } else {
                return state.dir === 'asc' ? fa - fb : fb - fa;
            }
        });
        
        let rows = arr.map(i => `<tr>
            <td>${i.code}</td>
            <td class="clickable" onclick="drilldown('sfName','${i.sf}')">${i.sf||''}</td>
            <td class="clickable" onclick="drilldown('product','${i.prod}')">${i.prod||''}</td>
            <td class="text-right">${formatNumber(i.qty)}</td>
            <td class="text-right clickable" onclick="drilldown('sfName','${i.sf}')">${formatNumber(i.val)}</td>
            <td class="text-right">${formatPercentage(i.val/total*100)}</td>
            <td><span class="source-tag ${i.source === 'sheets' ? 'source-sheets' : 'source-firebase'}">${i.source}</span></td>
        </tr>`).join('');
        document.getElementById('sfCodeBody').innerHTML = rows;
        document.getElementById('sfCodeFoot').innerHTML = `<tr><td colspan="5">Grand total</td><td class="text-right">${formatNumber(total)}</td><td>100%</td><td></td></tr>`;
    }

    function renderProdMonthDetail() {
        let arr = filteredData.filter(r=>r.product_name && r.bill_date).map(r=>({
            prod:r.product_name, 
            month: r.bill_date ? r.bill_date.substring(0,7) : '', 
            qty:r.sale_qty||0, 
            val:r.basic_value||0,
            source:r._source
        }));
        
        if (arr.length === 0) {
            document.getElementById('prodMonthDetailBody').innerHTML = '<tr><td colspan="5" style="text-align:center;">No product month data</td></tr>';
            document.getElementById('prodMonthDetailFoot').innerHTML = '';
            return;
        }
        
        let state = sortState.prodDetail || {col:3, dir:'desc'};
        arr.sort((a,b) => {
            let fields = [a.prod, a.month, a.qty, a.val];
            let fa = fields[state.col], fb = fields[state.col];
            if (typeof fa === 'string') return state.dir==='asc' ? fa.localeCompare(fb) : fb.localeCompare(fa);
            else return state.dir==='asc' ? fa - fb : fb - fa;
        });
        let total = arr.reduce((a,b)=>a+b.val,0);
        let rows = arr.slice(0,50).map(i => `<tr>
            <td class="clickable" onclick="drilldown('product','${i.prod}')">${i.prod}</td>
            <td class="clickable" onclick="drilldown('month','${i.month}')">${i.month}</td>
            <td class="text-right">${formatNumber(i.qty)}</td>
            <td class="text-right clickable" onclick="drilldown('product','${i.prod}')">${formatNumber(i.val)}</td>
            <td><span class="source-tag ${i.source === 'sheets' ? 'source-sheets' : 'source-firebase'}">${i.source}</span></td>
        </tr>`).join('');
        document.getElementById('prodMonthDetailBody').innerHTML = rows;
        document.getElementById('prodMonthDetailFoot').innerHTML = `<tr><td colspan="4">Grand total</td><td class="text-right">${formatNumber(total)}</td><td></td></tr>`;
    }

    function renderProdSummary() {
        let map = new Map();
        filteredData.forEach(r => { 
            if (r.product_name) {
                let cur = map.get(r.product_name) || {val:0, qty:0};
                cur.val += r.basic_value || 0;
                cur.qty += r.sale_qty || 0;
                map.set(r.product_name, cur);
            }
        });
        let arr = Array.from(map.entries()).map(([name, d]) => ({ name, val: d.val, qty: d.qty }));
        let total = arr.reduce((a,b)=>a+b.val,0);
        
        if (arr.length === 0) {
            document.getElementById('prodSummaryBody').innerHTML = '<tr><td colspan="4" style="text-align:center;">No product summary data</td></tr>';
            document.getElementById('prodSummaryFoot').innerHTML = '';
            document.getElementById('prodRange').innerText = '0-0 / 0';
            return;
        }
        
        let state = sortState.prodSummary || {col:2, dir:'desc'};
        arr.sort((a,b) => {
            let fields = [a.name, a.qty, a.val, (a.val/total*100)];
            let fa = fields[state.col], fb = fields[state.col];
            if (typeof fa === 'string') return state.dir==='asc' ? fa.localeCompare(fb) : fb.localeCompare(fa);
            else return state.dir==='asc' ? fa - fb : fb - fa;
        });
        let start = (currentPage-1)*pageSize, end = Math.min(start+pageSize, arr.length);
        let page = arr.slice(start,end);
        let rows = page.map(i => `<tr><td class="clickable" onclick="drilldown('product','${i.name}')">${i.name}</td><td class="text-right">${formatNumber(i.qty)}</td><td class="text-right clickable" onclick="drilldown('product','${i.name}')">${formatNumber(i.val)}</td><td class="text-right">${formatPercentage(i.val/total*100)}</td></tr>`).join('');
        document.getElementById('prodSummaryBody').innerHTML = rows;
        document.getElementById('prodSummaryFoot').innerHTML = `<tr><td colspan="3">Grand total</td><td class="text-right">${formatNumber(total)}</td></tr>`;
        document.getElementById('prodRange').innerText = `${start+1}-${end} / ${arr.length}`;
        document.getElementById('prevBtn').disabled = currentPage===1;
        document.getElementById('nextBtn').disabled = end>=arr.length;
    }

    function renderLocDispatch() {
        let map = new Map();
        filteredData.forEach(r => {
            if (!r.location) return;
            let cur = map.get(r.location) || {loc:r.location, cnt:0, qty:0, val:0};
            cur.cnt++; cur.qty += r.sale_qty||0; cur.val += r.basic_value||0;
            map.set(r.location, cur);
        });
        let arr = Array.from(map.values());
        let total = arr.reduce((a,b)=>a+b.val,0);
        
        if (arr.length === 0) {
            document.getElementById('locDispatchBody').innerHTML = '<tr><td colspan="5" style="text-align:center;">No location dispatch data</td></tr>';
            document.getElementById('locDispatchFoot').innerHTML = '';
            return;
        }
        
        let state = sortState.locDispatch || {col:3, dir:'desc'};
        arr.sort((a,b) => {
            let fields = [a.loc, a.cnt, a.qty, a.val, (a.val/total*100)];
            let fa = fields[state.col], fb = fields[state.col];
            if (typeof fa === 'string') return state.dir==='asc' ? fa.localeCompare(fb) : fb.localeCompare(fa);
            else return state.dir==='asc' ? fa - fb : fb - fa;
        });
        let rows = arr.map(i => `<tr><td class="clickable" onclick="drilldown('location','${i.loc}')">${i.loc}</td><td class="text-right">${i.cnt}</td><td class="text-right">${formatNumber(i.qty)}</td><td class="text-right clickable" onclick="drilldown('location','${i.loc}')">${formatNumber(i.val)}</td><td class="text-right">${formatPercentage(i.val/total*100)}</td></tr>`).join('');
        document.getElementById('locDispatchBody').innerHTML = rows;
        document.getElementById('locDispatchFoot').innerHTML = `<tr><td colspan="3">Grand total</td><td class="text-right">${formatNumber(total)}</td><td>100%</td></tr>`;
    }

    function renderDpr() {
        let arr = filteredData.filter(r => r.bill_date && r.bill_no);
        
        if (arr.length === 0) {
            document.getElementById('dprBody').innerHTML = '<tr><td colspan="10" style="text-align:center;">No DPR data</td></tr>';
            document.getElementById('dprFoot').innerHTML = '';
            return;
        }
        
        let state = sortState.dpr || { col: 0, dir: 'desc' };
        
        arr.sort((a, b) => {
            let fieldsA = [
                a.bill_date || '', a.bill_no || '', a.location || '', a.mkt_by || '', 
                a.product_name || '', a.batch_no || '', a.sf_name || '', 
                a.sale_qty || 0, a.basic_value || 0
            ];
            let fieldsB = [
                b.bill_date || '', b.bill_no || '', b.location || '', b.mkt_by || '', 
                b.product_name || '', b.batch_no || '', b.sf_name || '', 
                b.sale_qty || 0, b.basic_value || 0
            ];
            
            let fa = fieldsA[state.col];
            let fb = fieldsB[state.col];
            
            if (state.col === 0 || state.col === 1 || state.col === 2 || state.col === 3 || state.col === 4 || state.col === 5 || state.col === 6) {
                return state.dir === 'asc' ? fa.localeCompare(fb) : fb.localeCompare(fa);
            } else {
                return state.dir === 'asc' ? fa - fb : fb - fa;
            }
        });
        
        let total = arr.reduce((a, b) => a + (b.basic_value || 0), 0);
        let rows = arr.slice(0, 100).map(r => {
            return `<tr>
                <td class="clickable" onclick="drilldown('month','${r.bill_date ? r.bill_date.substring(0,7) : ''}')">${r.bill_date || ''}</td>
                <td>${r.bill_no || ''}</td>
                <td class="clickable" onclick="drilldown('location','${r.location}')">${r.location || ''}</td>
                <td class="clickable" onclick="drilldown('mktBy','${r.mkt_by}')">${r.mkt_by || ''}</td>
                <td class="clickable" onclick="drilldown('product','${r.product_name}')">${r.product_name || ''}</td>
                <td>${r.batch_no || ''}</td>
                <td class="clickable" onclick="drilldown('sfName','${r.sf_name}')">${r.sf_name || ''}</td>
                <td class="text-right">${formatNumber(r.sale_qty)}</td>
                <td class="text-right clickable" onclick="drilldown('month','${r.bill_date ? r.bill_date.substring(0,7) : ''}')">${formatNumber(r.basic_value)}</td>
                <td><span class="source-tag ${r._source === 'sheets' ? 'source-sheets' : 'source-firebase'}">${r._source}</span></td>
            </tr>`;
        }).join('');
        
        document.getElementById('dprBody').innerHTML = rows;
        document.getElementById('dprFoot').innerHTML = `<tr><td colspan="8">Grand total</td><td class="text-right">${formatNumber(total)}</td><td></td><td></td></tr>`;
    }

    function updateGrandTotal() {
        let total = filteredData.reduce((s,r)=>s+(r.basic_value||0),0);
        document.getElementById('grandTotalValue').innerText = formatNumber(total);
    }

    // ==================== EXPORT ====================
    window.showPasswordModal = function() {
        document.getElementById('passwordModal').classList.add('show');
        document.getElementById('passwordInput').value = '';
        document.getElementById('passwordInput').focus();
    };

    window.closeModal = function() {
        document.getElementById('passwordModal').classList.remove('show');
    };

    window.submitPassword = function() {
        const password = document.getElementById('passwordInput').value;
        if (password !== 'criusexcel') {
            alert('Incorrect password');
            closeModal();
            return;
        }
        closeModal();
        performExport();
    };

    function performExport() {
        const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
        const wb = XLSX.utils.book_new();
        
        function addTableToWorkbook(tableId, sheetName) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const rows = [];
            // Headers
            const headerRow = [];
            table.querySelectorAll('thead th').forEach(th => headerRow.push(th.innerText));
            rows.push(headerRow);
            
            // Body
            table.querySelectorAll('tbody tr').forEach(tr => {
                const row = [];
                tr.querySelectorAll('td').forEach(td => row.push(td.innerText));
                rows.push(row);
            });
            
            // Footer
            const footerRow = [];
            table.querySelectorAll('tfoot td').forEach(td => footerRow.push(td.innerText));
            if (footerRow.length) rows.push(footerRow);
            
            const ws = XLSX.utils.aoa_to_sheet(rows);
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
        }
        
        switch(activeTab) {
            case 'salesBoard':
                addTableToWorkbook('fyTable', 'Financial Year');
                addTableToWorkbook('catTable', 'Product Type');
                addTableToWorkbook('dosageTable', 'Dosage Form');
                break;
            case 'mktSf':
                addTableToWorkbook('mktByTable', 'Mkt By');
                addTableToWorkbook('sfWiseTable', 'SF Wise');
                break;
            case 'sfBrand':
                addTableToWorkbook('sfCodeTable', 'SF Code');
                break;
            case 'prodMonth':
                addTableToWorkbook('prodMonthDetail', 'Product Month Detail');
                addTableToWorkbook('prodSummary', 'Product Summary');
                break;
            case 'dispatch':
                addTableToWorkbook('locDispatchTable', 'Dispatch Location');
                addTableToWorkbook('dprTable', 'DPR');
                break;
        }
        
        const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });
        const blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' });
        const fileName = `Business_Dashboard_Combined_${activeTab}_${new Date().toISOString().slice(0,10)}.xlsx`;
        saveAs(blob, fileName);
        
        alert('Export completed!');
    }
    
    function s2ab(s) {
        const buf = new ArrayBuffer(s.length);
        const view = new Uint8Array(buf);
        for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;
    }
</script>
</body>
</html>
