<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRIUS Business Dashboard - Optimized for 50K+ Records</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
        }

        body {
            background: #e9ecf1;
            padding: 20px;
        }

        .dashboard {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 4px;
            overflow: hidden;
        }

        .main-header {
            background: #1e3a5f;
            color: white;
            padding: 16px 24px;
            font-size: 26px;
            font-weight: 600;
            border-bottom: 3px solid #0f2a44;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .api-badge {
            background: #4a6fa5;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin-left: 15px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .weather-info {
            display: flex;
            align-items: center;
            gap: 20px;
            color: #ffd700;
            font-size: 14px;
        }

        .company-header {
            background: linear-gradient(135deg, #2c3e50, #1e3a5f);
            color: white;
            padding: 20px 24px;
            font-size: 28px;
            font-weight: 700;
            border-bottom: 3px solid #ffd700;
            text-align: center;
        }

        .company-subheader {
            color: #ffd700;
            font-size: 14px;
            margin-top: 8px;
            font-weight: normal;
        }

        .nav-menu {
            display: flex;
            background: #f0f2f5;
            padding: 10px 24px;
            gap: 25px;
            flex-wrap: wrap;
            border-bottom: 2px solid #ccd1d9;
        }

        .nav-menu a {
            color: #2c3e50;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            padding: 4px 8px;
        }

        .stats-bar {
            background: #e3f2fd;
            padding: 8px 24px;
            border-bottom: 2px solid #90caf9;
            display: flex;
            gap: 30px;
            font-size: 13px;
            font-weight: 600;
            color: #0d47a1;
        }

        .stats-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stats-value {
            background: #0d47a1;
            color: white;
            padding: 2px 10px;
            border-radius: 20px;
            font-size: 12px;
        }

        .connection-status-bar {
            background: #e8f0fe;
            padding: 10px 24px;
            border-bottom: 2px solid #b8d1f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-connected {
            background: #d4edda;
            color: #155724;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .progress-bar {
            width: 200px;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #4caf50;
            width: 0%;
            transition: width 0.3s ease;
        }

        .refresh-btn-small {
            background: #4a6fa5;
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
        }

        .nav-sidebar {
            display: flex;
            background: #f0f2f5;
            border-bottom: 2px solid #ccd1d9;
            overflow-x: auto;
            white-space: nowrap;
        }

        .nav-item {
            padding: 14px 28px;
            font-size: 14px;
            color: #2c3e50;
            border-right: 1px solid #ccd1d9;
            font-weight: 600;
            cursor: pointer;
        }

        .nav-item:hover {
            background: #e4e7eb;
        }

        .nav-item.active {
            background: #1e3a5f;
            color: white;
        }

        .filter-bar {
            background: #f8fafc;
            padding: 15px 24px;
            display: flex;
            gap: 15px;
            border-bottom: 2px solid #dee2e9;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .filter-group label {
            font-weight: 700;
            color: #1e3a5f;
            min-width: 70px;
        }

        .filter-group select, .filter-group input {
            padding: 8px 12px;
            border: 1px solid #9aa6b5;
            border-radius: 6px;
            min-width: 150px;
            background: white;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: white;
            border: 1px solid #9aa6b5;
            border-radius: 6px;
            padding: 4px 12px;
            min-width: 280px;
        }

        .search-box input {
            border: none;
            padding: 8px 0;
            width: 100%;
            outline: none;
        }

        .search-box button {
            background: #1e3a5f;
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }

        .content {
            padding: 24px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e3a5f;
            margin: 20px 0 10px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #d0d7e5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-wrapper {
            border: 1px solid #b7bfcc;
            border-radius: 8px;
            margin-bottom: 25px;
            overflow: auto;
            max-height: 500px;
            position: relative;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        thead th {
            background: #2b5797;
            color: white;
            padding: 10px 8px;
            font-weight: 600;
            border: 1px solid #1e3a5f;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
        }

        thead th:hover {
            background: #1e3a5f;
        }

        thead th.sort-asc::after {
            content: " ‚Üë";
            color: #ffd700;
        }

        thead th.sort-desc::after {
            content: " ‚Üì";
            color: #ffd700;
        }

        tbody td {
            padding: 8px;
            border: 1px solid #b7bfcc;
            white-space: nowrap;
        }

        tbody td.clickable {
            cursor: pointer;
            color: #1e3a5f;
            font-weight: 500;
            transition: all 0.2s;
        }

        tbody td.clickable:hover {
            background: #ffd700;
            color: #1e3a5f;
            font-weight: 700;
        }

        tbody tr:hover {
            background: #f5f7fa;
        }

        tfoot td {
            background: #d6562b;
            color: white;
            padding: 10px 8px;
            border: 1px solid #b13e1f;
            position: sticky;
            bottom: 0;
            z-index: 10;
            font-weight: 700;
        }

        .grand-footer {
            background: #1e3a5f;
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            font-weight: 700;
            border-top: 3px solid #ffd700;
        }

        .dashboard-footer {
            background: #1e3a5f;
            color: white;
            padding: 14px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .text-right {
            text-align: right;
        }

        .loading {
            text-align: center;
            padding: 60px;
            font-size: 16px;
            color: #1e3a5f;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #c00000;
            background: #ffebee;
            margin: 30px;
            border-radius: 8px;
        }

        .pagination {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .pagination button {
            padding: 6px 12px;
            background: white;
            border: 1px solid #9aa6b5;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            font-size: 12px;
            color: #666;
        }

        .config-data {
            display: none;
        }

        .record-count {
            background: #ffd700;
            color: #1e3a5f;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
        }

        .active-filters-bar {
            background: #fff3cd;
            padding: 12px 24px;
            display: none;
            align-items: center;
            gap: 15px;
            border-bottom: 2px solid #ffe69c;
            flex-wrap: wrap;
        }

        .filter-tag {
            background: #ffd700;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #1e3a5f;
        }

        .filter-tag button {
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 700;
            color: #1e3a5f;
            font-size: 14px;
        }

        .virtual-scroll-indicator {
            background: #e3f2fd;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 11px;
            color: #0d47a1;
        }

        .percentage-positive {
            color: #4caf50;
            font-weight: 700;
        }

        .percentage-negative {
            color: #f44336;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="main-header">
            <div>
                CRIUS Business Dashboard
                <span class="api-badge" id="apiBadge" style="display: none;">
                    <span>‚úÖ</span> Connected
                </span>
            </div>
            <div class="weather-info">
                <span>üå§Ô∏è 27¬∞C Sunny</span>
                <span class="last-update" id="lastUpdate"></span>
            </div>
        </div>

        <div class="company-header">
            CRIUS GROUP OF COMPANIES
            <div class="company-subheader">Enterprise Business Intelligence Dashboard</div>
        </div>

        <div class="nav-menu">
            <a href="#">Home</a>
            <a href="#">Ceoitbox</a>
            <a href="#">Training Videos</a>
            <a href="#">Management</a>
            <a href="#">Head Office</a>
            <a href="#">CRIUS</a>
            <a href="#">CHIROS/SIGNOVA</a>
            <a href="#">CHIMAK/SYSKEM/MARSK</a>
            <a href="#">WELZO</a>
            <a href="#">CRIUS HEALTHCARE</a>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar" id="statsBar" style="display: none;">
            <div class="stats-item">
                <span>üìä Total Records:</span>
                <span class="stats-value" id="totalRecords">0</span>
            </div>
            <div class="stats-item">
                <span>üí∞ Total Value:</span>
                <span class="stats-value" id="totalValue">0</span>
            </div>
            <div class="stats-item">
                <span>üì¶ Total Quantity:</span>
                <span class="stats-value" id="totalQty">0</span>
            </div>
            <div class="stats-item">
                <span>üè¢ Locations:</span>
                <span class="stats-value" id="totalLocations">0</span>
            </div>
        </div>

        <!-- Simple Status Bar -->
        <div class="connection-status-bar" id="statusBar" style="display: none;">
            <div id="connectionStatus" class="status-connected">
                <span>‚úÖ</span> Connected via CORS Anywhere
                <span class="record-count" id="recordCount">0 records</span>
            </div>
            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <button class="refresh-btn-small" onclick="refreshData()">
                <span>üîÑ</span> Refresh Data
            </button>
        </div>

        <!-- Hidden Configuration -->
        <div class="config-data">
            <input type="text" id="apiUsername" value="SOURAV">
            <input type="password" id="apiPassword" value="KUMAR@1308">
            <input type="text" id="reportId" value="r17d84895210.rpt">
            <input type="text" id="serverUrl" value="http://43.246.140.102:6060/smarten/">
            <input type="text" id="proxyUrl" value="https://cors-anywhere.herokuapp.com/">
        </div>

        <div class="nav-sidebar" id="tabNav"></div>

        <div class="filter-bar">
            <div class="filter-group">
                <label>Location:</label>
                <select id="locationFilter" onchange="applyFilters()">
                    <option value="all">All Locations</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Mkt By:</label>
                <select id="mktByFilter" onchange="applyFilters()">
                    <option value="all">All</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Product Type:</label>
                <select id="productTypeFilter" onchange="applyFilters()">
                    <option value="all">All Types</option>
                </select>
            </div>
            <div class="filter-group">
                <label>From:</label>
                <input type="month" id="dateFrom" onchange="applyFilters()">
            </div>
            <div class="filter-group">
                <label>To:</label>
                <input type="month" id="dateTo" onchange="applyFilters()">
            </div>
            <div class="search-box">
                <input type="text" placeholder="üîç Search products, SF names..." id="globalSearch" onkeyup="debounceApplyFilters()">
                <button onclick="applyFilters()">Search</button>
            </div>
            <button class="refresh-btn-small" onclick="resetFilters()" style="background: #d6562b;">Reset Filters</button>
        </div>

        <div class="active-filters-bar" id="activeFiltersBar">
            <span style="font-weight: 700;">Active Filters:</span>
            <div id="activeFilters"></div>
            <button onclick="clearAllFilters()" style="margin-left: auto; background: none; border: none; color: #856404; cursor: pointer; font-weight: 600;">Clear All ‚úï</button>
        </div>

        <div id="loading" class="loading">Initializing... Please wait.</div>
        <div id="error" class="error" style="display: none;"></div>

        <div id="tabContainers" style="display: none;"></div>

        <div class="grand-footer" style="display: none;" id="grandFooter">
            <span>üìä Overall Grand Total</span>
            <span id="grandTotalValue"></span>
        </div>

        <div class="dashboard-footer">
            <div class="footer-left">
                <span>¬© 2026 CRIUS Group</span>
            </div>
            <div class="footer-right">
                <span>üåê v3.0 | Optimized for 50K+ Records</span>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const CONFIG = {
            serverUrl: 'http://43.246.140.102:6060/smarten/',
            username: 'SOURAV',
            password: 'KUMAR@1308',
            reportId: 'r17d84895210.rpt',
            proxyUrl: 'https://cors-anywhere.herokuapp.com/'
        };

        // Optimized data structures
        let allData = [];
        let filteredData = [];
        let headers = [];
        
        // Pagination
        let currentPage = 1;
        const pageSize = 100; // Increased for better performance with 50K records
        
        // Filter state
        let activeFilters = {
            location: null,
            mktBy: null,
            productType: null,
            dateFrom: null,
            dateTo: null,
            search: null
        };

        // Sort state for each table
        let sortStates = {
            mktBy: { column: 'value', direction: 'desc' },
            location: { column: 'value', direction: 'desc' },
            productType: { column: 'value', direction: 'desc' },
            sfWise: { column: 'value', direction: 'desc' },
            sfCode: { column: 'value', direction: 'desc' },
            brandMonthly: { column: 'value', direction: 'desc' },
            brandSummary: { column: 'value', direction: 'desc' },
            productMonthDetail: { column: 'value', direction: 'desc' },
            productMonthSummary: { column: 'value', direction: 'desc' },
            dpr: { column: 'value', direction: 'desc' },
            dispatchLocation: { column: 'value', direction: 'desc' }
        };

        // Unique sets for filters
        let uniqueLocations = new Set();
        let uniqueMktBy = new Set();
        let uniqueProductTypes = new Set();

        // Tab definitions
        const tabs = [
            { id: 'mkt-by', name: 'üìä Mkt By Analysis' },
            { id: 'location', name: 'üìç Location Wise' },
            { id: 'product-type', name: 'üè∑Ô∏è Product Type' },
            { id: 'sf-wise', name: 'üë• SF Wise' },
            { id: 'sf-code', name: 'üî¢ SF Code' },
            { id: 'brand-monthly', name: 'üìÖ Brand Monthly' },
            { id: 'brand-summary', name: 'üìä Brand Summary' },
            { id: 'product-month-detail', name: 'üì¶ Product Month Detail' },
            { id: 'product-month-summary', name: 'üìä Product Summary' },
            { id: 'dpr', name: 'üìã DPR Details' },
            { id: 'dispatch-location', name: 'üìç Dispatch Location' }
        ];

        // Debounce timer
        let debounceTimer;

        // ==================== INITIALIZATION ====================
        window.onload = function() {
            initializeUI();
            // Auto-connect after delay
            setTimeout(autoConnect, 1000);
        };

        function initializeUI() {
            updateLastUpdateTime(new Date());
            createTabs();
            createTabContainers();
        }

        function updateLastUpdateTime(date) {
            const options = { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            document.getElementById('lastUpdate').textContent = 'LAST UPDATE: ' + date.toLocaleDateString('en-GB', options);
        }

        // ==================== AUTO CONNECT ====================
        async function autoConnect() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loading').textContent = 'Connecting to CORS Anywhere... Please wait.';
            document.getElementById('error').style.display = 'none';

            try {
                window.open('https://cors-anywhere.herokuapp.com/corsdemo', '_blank');
                document.getElementById('loading').textContent = 'Waiting for CORS Anywhere access... Click the button in the new tab.';
                
                await new Promise(resolve => setTimeout(resolve, 3000));
                await connectWithCorsAnywhere();
            } catch (error) {
                showError(error);
            }
        }

        // ==================== CONNECT WITH CORS ANYWHERE ====================
        async function connectWithCorsAnywhere() {
            showLoading('Fetching data via CORS Anywhere...');
            showProgressBar();
            
            try {
                const baseUrl = CONFIG.serverUrl.endsWith('/') ? CONFIG.serverUrl : CONFIG.serverUrl + '/';
                const proxyUrl = CONFIG.proxyUrl;

                // Get Token
                updateProgress(20);
                const token = await fetchToken(proxyUrl, baseUrl);
                
                // Get Data
                updateProgress(40);
                const responseText = await fetchData(proxyUrl, baseUrl, token);
                
                // Parse Data
                updateProgress(60);
                const reportData = await parseLargeData(responseText);
                
                if (!reportData || reportData.length === 0) {
                    throw new Error('No data found in response');
                }

                // Process Headers
                updateProgress(80);
                headers = reportData[0] || [];
                const dataRows = reportData.slice(1);
                
                // Transform Data (chunked for 50K records)
                allData = await transformDataChunked(dataRows, 1000);
                
                if (allData.length === 0) {
                    throw new Error('No valid data after transformation');
                }

                // Initialize filtered data
                filteredData = [...allData];
                
                // Build unique sets
                await buildUniqueSets();
                
                // Update UI
                updateProgress(100);
                setTimeout(() => hideProgressBar(), 500);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('tabContainers').style.display = 'block';
                document.getElementById('grandFooter').style.display = 'flex';
                document.getElementById('apiBadge').style.display = 'inline-block';
                document.getElementById('statusBar').style.display = 'flex';
                document.getElementById('statsBar').style.display = 'flex';
                
                updateLastUpdateTime(new Date());
                updateFilterOptions();
                updateStats();
                renderCurrentTab();

            } catch (error) {
                hideProgressBar();
                showError(error);
            }
        }

        async function fetchToken(proxyUrl, baseUrl) {
            const tokenUrl = proxyUrl + baseUrl + 'API/getToken';
            
            const response = await fetch(tokenUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Origin': window.location.origin,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: new URLSearchParams({
                    username: CONFIG.username,
                    password: CONFIG.password,
                    objectid: CONFIG.reportId,
                    type: 'data'
                })
            });

            if (!response.ok) {
                if (response.status === 403) {
                    throw new Error('CORS Anywhere needs temporary access. Please click the button in the new tab and try again.');
                }
                throw new Error(`Token fetch failed: ${response.status}`);
            }

            const token = await response.text();
            if (!token || token.trim() === '') {
                throw new Error('Empty token response');
            }
            
            return token;
        }

        async function fetchData(proxyUrl, baseUrl, token) {
            const dataUrl = proxyUrl + baseUrl + 'API/getObject?tokenid=' + encodeURIComponent(token);
            
            const response = await fetch(dataUrl, {
                headers: {
                    'Origin': window.location.origin,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (!response.ok) {
                throw new Error(`Data fetch failed: ${response.status}`);
            }

            return await response.text();
        }

        // ==================== OPTIMIZED PARSING FOR 50K RECORDS ====================
        async function parseLargeData(xmlString) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    try {
                        const data = [];
                        const rows = xmlString.split('</Row>');
                        let headerRow = null;
                        
                        for (let i = 0; i < rows.length; i++) {
                            const row = rows[i];
                            if (!row.includes('<Row>')) continue;
                            
                            const cols = row.match(/<Column[^>]*>(.*?)<\/Column>/g);
                            if (cols) {
                                const rowData = cols.map(col => {
                                    let value = col.replace(/<\/?Column[^>]*>/g, '');
                                    value = value.replace(/&amp;/g, '&')
                                               .replace(/&lt;/g, '<')
                                               .replace(/&gt;/g, '>')
                                               .replace(/&quot;/g, '"')
                                               .replace(/&#39;/g, "'");
                                    return value.trim();
                                });
                                
                                if (i === 0) {
                                    headerRow = rowData;
                                    data.push(headerRow);
                                } else {
                                    data.push(rowData);
                                }
                            }
                            
                            // Yield to event loop every 1000 rows
                            if (i % 1000 === 0) {
                                setTimeout(() => {}, 0);
                            }
                        }
                        
                        resolve(data);
                    } catch (e) {
                        console.error('Parse error:', e);
                        resolve([]);
                    }
                }, 0);
            });
        }

        async function transformDataChunked(rows, chunkSize) {
            const result = [];
            
            // Create header mapping
            const headerMap = createHeaderMap();
            
            for (let i = 0; i < rows.length; i += chunkSize) {
                const chunk = rows.slice(i, i + chunkSize);
                const transformed = chunk.map((row, idx) => transformRow(row, headerMap, i + idx));
                result.push(...transformed);
                
                // Update progress
                updateProgress(80 + Math.floor((i / rows.length) * 20));
                
                // Yield to event loop
                await new Promise(resolve => setTimeout(resolve, 0));
            }
            
            return result;
        }

        function createHeaderMap() {
            const map = {};
            headers.forEach((header, index) => {
                const headerStr = (header || '').toString().toLowerCase().trim();
                
                if (headerStr.includes('location') || headerStr.includes('godown')) map.location = index;
                else if (headerStr.includes('billno') || headerStr.includes('bill_no')) map.bill_no = index;
                else if (headerStr.includes('date') || headerStr.includes('txndocdt')) map.bill_date = index;
                else if (headerStr.includes('product') || headerStr.includes('itemname')) {
                    if (headerStr.includes('type')) map.product_type = index;
                    else map.product_name = index;
                }
                else if (headerStr.includes('batch')) map.batch_no = index;
                else if (headerStr.includes('qty') || headerStr.includes('saleqty')) map.sale_qty = index;
                else if (headerStr.includes('value') || headerStr.includes('basic')) map.basic_value = index;
                else if (headerStr.includes('sfcode')) map.sf_code = index;
                else if (headerStr.includes('sfname')) map.sf_name = index;
                else if (headerStr.includes('mktby')) map.mkt_by = index;
                else if (headerStr.includes('city')) map.city = index;
                else if (headerStr.includes('state')) map.state = index;
            });

            // Default mapping if needed
            if (Object.keys(map).length === 0) {
                map.location = 0;
                map.bill_no = 1;
                map.bill_date = 2;
                map.product_name = 3;
                map.product_type = 4;
                map.batch_no = 5;
                map.sale_qty = 6;
                map.basic_value = 7;
                map.sf_code = 8;
                map.sf_name = 9;
                map.mkt_by = 10;
                map.city = 11;
                map.state = 12;
            }
            
            return map;
        }

        function transformRow(row, map, index) {
            return {
                id: `row_${index}`,
                location: row[map.location] || '',
                bill_no: row[map.bill_no] || '',
                bill_date: row[map.bill_date] || '',
                product_name: row[map.product_name] || '',
                product_type: row[map.product_type] || '',
                batch_no: row[map.batch_no] || '',
                sale_qty: parseFloat((row[map.sale_qty] || '0').replace(/[^0-9.-]/g, '')) || 0,
                basic_value: parseFloat((row[map.basic_value] || '0').replace(/[^0-9.-]/g, '')) || 0,
                sf_code: row[map.sf_code] || '',
                sf_name: row[map.sf_name] || '',
                mkt_by: row[map.mkt_by] || '',
                city: row[map.city] || '',
                state: row[map.state] || ''
            };
        }

        async function buildUniqueSets() {
            uniqueLocations.clear();
            uniqueMktBy.clear();
            uniqueProductTypes.clear();
            
            const chunkSize = 5000;
            for (let i = 0; i < allData.length; i += chunkSize) {
                const chunk = allData.slice(i, i + chunkSize);
                chunk.forEach(item => {
                    if (item.location) uniqueLocations.add(item.location);
                    if (item.mkt_by) uniqueMktBy.add(item.mkt_by);
                    if (item.product_type) uniqueProductTypes.add(item.product_type);
                });
                await new Promise(resolve => setTimeout(resolve, 0));
            }
        }

        // ==================== UI UPDATES ====================
        function showLoading(message) {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loading').textContent = message;
        }

        function showProgressBar() {
            document.getElementById('progressBar').style.display = 'block';
            document.getElementById('progressFill').style.width = '0%';
        }

        function updateProgress(percent) {
            document.getElementById('progressFill').style.width = percent + '%';
        }

        function hideProgressBar() {
            document.getElementById('progressBar').style.display = 'none';
        }

        function showError(error) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').innerHTML = `
                <strong>Error:</strong><br>
                ${error.message}<br><br>
                <button onclick="autoConnect()" style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Try Again</button>
            `;
        }

        function updateStats() {
            const totalValue = filteredData.reduce((sum, item) => sum + (item.basic_value || 0), 0);
            const totalQty = filteredData.reduce((sum, item) => sum + (item.sale_qty || 0), 0);
            
            document.getElementById('totalRecords').textContent = filteredData.length.toLocaleString();
            document.getElementById('totalValue').textContent = '‚Çπ' + formatNumber(totalValue);
            document.getElementById('totalQty').textContent = formatNumber(totalQty);
            document.getElementById('totalLocations').textContent = uniqueLocations.size;
            document.getElementById('recordCount').textContent = filteredData.length.toLocaleString() + ' records';
            document.getElementById('grandTotalValue').textContent = '‚Çπ' + formatNumber(totalValue);
        }

        // ==================== TAB FUNCTIONS ====================
        function createTabs() {
            const tabNav = document.getElementById('tabNav');
            tabNav.innerHTML = '';
            
            tabs.forEach((tab, index) => {
                const tabElement = document.createElement('div');
                tabElement.className = `nav-item ${index === 0 ? 'active' : ''}`;
                tabElement.setAttribute('data-tab', tab.id);
                tabElement.textContent = tab.name;
                tabElement.onclick = () => switchTab(tab.id);
                tabNav.appendChild(tabElement);
            });
        }

        function createTabContainers() {
            const containers = document.getElementById('tabContainers');
            containers.innerHTML = '';
            
            tabs.forEach(tab => {
                const container = document.createElement('div');
                container.id = `tab-${tab.id}`;
                container.className = 'tab-content';
                container.innerHTML = getTabHTML(tab.id);
                containers.appendChild(container);
            });
        }

        function getTabHTML(tabId) {
            return `
                <div class="section-title">
                    ${getTabTitle(tabId)}
                    <span class="total-info" id="${tabId}Total"></span>
                </div>
                <div class="table-wrapper">
                    <table id="${tabId}Table">
                        <thead><tr id="${tabId}Header"></tr></thead>
                        <tbody id="${tabId}Body"></tbody>
                        <tfoot id="${tabId}Footer"></tfoot>
                    </table>
                </div>
            `;
        }

        function getTabTitle(tabId) {
            const titles = {
                'mkt-by': 'üìä Mkt By Analysis',
                'location': 'üìç Location Wise Analysis',
                'product-type': 'üè∑Ô∏è Product Type Analysis',
                'sf-wise': 'üë• SF Wise Product Details',
                'sf-code': 'üî¢ SF Code Details',
                'brand-monthly': 'üìÖ Brand Details by SF (Monthly)',
                'brand-summary': 'üìä Brand Details by SF (Summary)',
                'product-month-detail': 'üì¶ Product Month Wise (Detailed)',
                'product-month-summary': 'üìä Product Month Wise (Summary)',
                'dpr': 'üìã Daily Dispatch Details (DPR)',
                'dispatch-location': 'üìç Dispatch Summary by Location'
            };
            return titles[tabId] || tabId;
        }

        function switchTab(tabId) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-tab') === tabId) {
                    item.classList.add('active');
                }
            });
            
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`tab-${tabId}`).classList.add('active');
            
            renderTab(tabId);
        }

        function renderCurrentTab() {
            const activeTab = document.querySelector('.nav-item.active').getAttribute('data-tab');
            renderTab(activeTab);
        }

        function renderTab(tabId) {
            if (filteredData.length === 0) {
                document.getElementById(`${tabId}Body`).innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px;">No data available.</td></tr>';
                return;
            }

            switch(tabId) {
                case 'mkt-by':
                    renderMktByTable();
                    break;
                case 'location':
                    renderLocationTable();
                    break;
                case 'product-type':
                    renderProductTypeTable();
                    break;
                case 'sf-wise':
                    renderSfWiseTable();
                    break;
                case 'sf-code':
                    renderSfCodeTable();
                    break;
                case 'brand-monthly':
                    renderBrandMonthlyTable();
                    break;
                case 'brand-summary':
                    renderBrandSummaryTable();
                    break;
                case 'product-month-detail':
                    renderProductMonthDetailTable();
                    break;
                case 'product-month-summary':
                    renderProductMonthSummaryTable();
                    break;
                case 'dpr':
                    renderDprTable();
                    break;
                case 'dispatch-location':
                    renderDispatchLocationTable();
                    break;
            }
        }

        // ==================== SORT FUNCTION ====================
        function sortTable(tableId, column, dataType = 'string') {
            const state = sortStates[tableId];
            if (!state) return;
            
            // Update sort direction
            if (state.column === column) {
                state.direction = state.direction === 'asc' ? 'desc' : 'asc';
            } else {
                state.column = column;
                state.direction = 'desc';
            }

            // Update header indicators
            document.querySelectorAll(`#${tableId}Header th`).forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            const headerIndex = getHeaderIndex(tableId, column);
            const headerCell = document.querySelector(`#${tableId}Header th:nth-child(${headerIndex + 1})`);
            if (headerCell) {
                headerCell.classList.add(`sort-${state.direction}`);
            }

            // Re-render the tab
            renderTab(tableId);
        }

        function getHeaderIndex(tableId, column) {
            const headers = {
                'mkt-by': ['mkt_by', 'total', 'percentage'],
                'location': ['location', 'total', 'percentage'],
                'product-type': ['product_type', 'total', 'percentage'],
                'sf-wise': ['sf_name', 'sf_code', 'total', 'qty', 'percentage', 'locations', 'products'],
                'sf-code': ['sf_code', 'sf_name', 'total', 'percentage'],
                'brand-monthly': ['sf_name', 'sf_code', 'product', 'month', 'value', 'qty'],
                'brand-summary': ['sf_name', 'sf_code', 'product', 'total', 'qty', 'months'],
                'product-month-detail': ['product', 'product_type', 'month', 'value', 'qty', 'sf_count'],
                'product-month-summary': ['product', 'product_type', 'value', 'qty', 'months', 'sf_count'],
                'dpr': ['bill_date', 'bill_no', 'sf_name', 'product', 'batch_no', 'qty', 'value', 'location'],
                'dispatch-location': ['location', 'value', 'qty', 'entries', 'percentage']
            };
            
            const index = headers[tableId].indexOf(column);
            return index >= 0 ? index : 0;
        }

        // ==================== TABLE RENDERING FUNCTIONS ====================
        function renderMktByTable() {
            const data = aggregateData(filteredData, 'mkt_by', 'basic_value');
            const sortedData = sortAggregatedData(data, sortStates['mkt-by']);
            const total = sortedData.reduce((sum, item) => sum + item.total, 0);

            document.getElementById('mkt-byHeader').innerHTML = `
                <th onclick="sortTable('mkt-by', 'mkt_by')">Mkt By</th>
                <th class="text-right" onclick="sortTable('mkt-by', 'total')">Total Value</th>
                <th class="text-right" onclick="sortTable('mkt-by', 'percentage')">Percentage</th>
            `;

            document.getElementById('mkt-byBody').innerHTML = sortedData.map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('mkt_by', '${item.name}')">${item.name || '-'}</td>
                    <td class="text-right">${formatNumber(item.total)}</td>
                    <td class="text-right ${getPercentageClass((item.total/total)*100)}">${formatPercentage((item.total/total)*100)}</td>
                </tr>
            `).join('');

            document.getElementById('mkt-byFooter').innerHTML = `
                <td><strong>Total (${sortedData.length} items)</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td class="text-right"><strong>100%</strong></td>
            `;

            document.getElementById('mkt-byTotal').textContent = `Total: ${formatNumber(total)}`;
        }

        function renderLocationTable() {
            const data = aggregateData(filteredData, 'location', 'basic_value');
            const sortedData = sortAggregatedData(data, sortStates['location']);
            const total = sortedData.reduce((sum, item) => sum + item.total, 0);

            document.getElementById('locationHeader').innerHTML = `
                <th onclick="sortTable('location', 'location')">Location</th>
                <th class="text-right" onclick="sortTable('location', 'total')">Total Value</th>
                <th class="text-right" onclick="sortTable('location', 'percentage')">Percentage</th>
            `;

            document.getElementById('locationBody').innerHTML = sortedData.map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('location', '${item.name}')">${item.name || '-'}</td>
                    <td class="text-right">${formatNumber(item.total)}</td>
                    <td class="text-right ${getPercentageClass((item.total/total)*100)}">${formatPercentage((item.total/total)*100)}</td>
                </tr>
            `).join('');

            document.getElementById('locationFooter').innerHTML = `
                <td><strong>Total (${sortedData.length} locations)</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td class="text-right"><strong>100%</strong></td>
            `;

            document.getElementById('locationTotal').textContent = `Total: ${formatNumber(total)}`;
        }

        function renderProductTypeTable() {
            const data = aggregateData(filteredData, 'product_type', 'basic_value');
            const sortedData = sortAggregatedData(data, sortStates['product-type']);
            const total = sortedData.reduce((sum, item) => sum + item.total, 0);

            document.getElementById('product-typeHeader').innerHTML = `
                <th onclick="sortTable('product-type', 'product_type')">Product Type</th>
                <th class="text-right" onclick="sortTable('product-type', 'total')">Total Value</th>
                <th class="text-right" onclick="sortTable('product-type', 'percentage')">Percentage</th>
            `;

            document.getElementById('product-typeBody').innerHTML = sortedData.map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('product_type', '${item.name}')">${item.name || '-'}</td>
                    <td class="text-right">${formatNumber(item.total)}</td>
                    <td class="text-right ${getPercentageClass((item.total/total)*100)}">${formatPercentage((item.total/total)*100)}</td>
                </tr>
            `).join('');

            document.getElementById('product-typeFooter').innerHTML = `
                <td><strong>Total (${sortedData.length} types)</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td class="text-right"><strong>100%</strong></td>
            `;

            document.getElementById('product-typeTotal').textContent = `Total: ${formatNumber(total)}`;
        }

        function renderSfWiseTable() {
            const data = {};
            filteredData.forEach(item => {
                if (!item.sf_name) return;
                const key = item.sf_name;
                if (!data[key]) {
                    data[key] = {
                        sf_name: item.sf_name,
                        sf_code: item.sf_code,
                        total: 0,
                        qty: 0,
                        locations: new Set(),
                        products: new Set()
                    };
                }
                data[key].total += item.basic_value || 0;
                data[key].qty += item.sale_qty || 0;
                if (item.location) data[key].locations.add(item.location);
                if (item.product_name) data[key].products.add(item.product_name);
            });

            let sortedData = Object.values(data);
            const state = sortStates['sf-wise'];
            if (state) {
                sortedData.sort((a, b) => {
                    let aVal = a[state.column];
                    let bVal = b[state.column];
                    
                    if (state.column === 'total' || state.column === 'qty' || state.column === 'percentage') {
                        aVal = aVal || 0;
                        bVal = bVal || 0;
                    } else if (state.column === 'locations' || state.column === 'products') {
                        aVal = aVal.size || 0;
                        bVal = bVal.size || 0;
                    } else {
                        aVal = (aVal || '').toString().toLowerCase();
                        bVal = (bVal || '').toString().toLowerCase();
                    }
                    
                    if (aVal < bVal) return state.direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return state.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            const total = sortedData.reduce((sum, item) => sum + item.total, 0);

            document.getElementById('sf-wiseHeader').innerHTML = `
                <th onclick="sortTable('sf-wise', 'sf_name')">SF Name</th>
                <th onclick="sortTable('sf-wise', 'sf_code')">SF Code</th>
                <th class="text-right" onclick="sortTable('sf-wise', 'total')">Total Value</th>
                <th class="text-right" onclick="sortTable('sf-wise', 'qty')">Quantity</th>
                <th class="text-right" onclick="sortTable('sf-wise', 'percentage')">% of Total</th>
                <th class="text-right" onclick="sortTable('sf-wise', 'locations')">Locations</th>
                <th class="text-right" onclick="sortTable('sf-wise', 'products')">Products</th>
            `;

            document.getElementById('sf-wiseBody').innerHTML = sortedData.slice(0, 100).map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('sf_name', '${item.sf_name}')">${item.sf_name || '-'}</td>
                    <td class="clickable" onclick="applyDrilldown('sf_code', '${item.sf_code}')">${item.sf_code || '-'}</td>
                    <td class="text-right">${formatNumber(item.total)}</td>
                    <td class="text-right">${formatNumber(item.qty)}</td>
                    <td class="text-right ${getPercentageClass((item.total/total)*100)}">${formatPercentage((item.total/total)*100)}</td>
                    <td class="text-right">${item.locations.size}</td>
                    <td class="text-right">${item.products.size}</td>
                </tr>
            `).join('');

            document.getElementById('sf-wiseFooter').innerHTML = `
                <td colspan="2"><strong>Total (${sortedData.length} SFs)</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td class="text-right"><strong>${formatNumber(sortedData.reduce((sum, i) => sum + i.qty, 0))}</strong></td>
                <td class="text-right"><strong>100%</strong></td>
                <td colspan="2"></td>
            `;

            document.getElementById('sf-wiseTotal').textContent = `Total: ${formatNumber(total)}`;
        }

        function renderSfCodeTable() {
            const data = aggregateData(filteredData, 'sf_code', 'basic_value', 'sf_name');
            const sortedData = sortAggregatedData(data, sortStates['sf-code']);
            const total = sortedData.reduce((sum, item) => sum + item.total, 0);

            document.getElementById('sf-codeHeader').innerHTML = `
                <th onclick="sortTable('sf-code', 'sf_code')">SF Code</th>
                <th onclick="sortTable('sf-code', 'sf_name')">SF Name</th>
                <th class="text-right" onclick="sortTable('sf-code', 'total')">Total Value</th>
                <th class="text-right" onclick="sortTable('sf-code', 'percentage')">Percentage</th>
            `;

            document.getElementById('sf-codeBody').innerHTML = sortedData.map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('sf_code', '${item.name}')">${item.name || '-'}</td>
                    <td>${item.sf_name || '-'}</td>
                    <td class="text-right">${formatNumber(item.total)}</td>
                    <td class="text-right ${getPercentageClass((item.total/total)*100)}">${formatPercentage((item.total/total)*100)}</td>
                </tr>
            `).join('');

            document.getElementById('sf-codeFooter').innerHTML = `
                <td colspan="2"><strong>Total (${sortedData.length} codes)</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td class="text-right"><strong>100%</strong></td>
            `;

            document.getElementById('sf-codeTotal').textContent = `Total: ${formatNumber(total)}`;
        }

        function renderBrandMonthlyTable() {
            const data = {};
            filteredData.forEach(item => {
                if (!item.sf_name || !item.product_name || !item.bill_date) return;
                const month = item.bill_date.substring(0, 7);
                const key = `${item.sf_name}|${item.product_name}|${month}`;
                
                if (!data[key]) {
                    data[key] = {
                        sf_name: item.sf_name,
                        sf_code: item.sf_code,
                        product: item.product_name,
                        month: month,
                        total: 0,
                        qty: 0
                    };
                }
                data[key].total += item.basic_value || 0;
                data[key].qty += item.sale_qty || 0;
            });

            let sortedData = Object.values(data);
            const state = sortStates['brand-monthly'];
            if (state) {
                sortedData.sort((a, b) => {
                    let aVal = a[state.column];
                    let bVal = b[state.column];
                    
                    if (state.column === 'value' || state.column === 'qty') {
                        aVal = aVal || 0;
                        bVal = bVal || 0;
                    } else {
                        aVal = (aVal || '').toString().toLowerCase();
                        bVal = (bVal || '').toString().toLowerCase();
                    }
                    
                    if (aVal < bVal) return state.direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return state.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            const total = sortedData.reduce((sum, item) => sum + item.total, 0);

            document.getElementById('brand-monthlyHeader').innerHTML = `
                <th onclick="sortTable('brand-monthly', 'sf_name')">SF Name</th>
                <th onclick="sortTable('brand-monthly', 'sf_code')">SF Code</th>
                <th onclick="sortTable('brand-monthly', 'product')">Product</th>
                <th onclick="sortTable('brand-monthly', 'month')">Month</th>
                <th class="text-right" onclick="sortTable('brand-monthly', 'value')">Value</th>
                <th class="text-right" onclick="sortTable('brand-monthly', 'qty')">Quantity</th>
            `;

            document.getElementById('brand-monthlyBody').innerHTML = sortedData.slice(0, 100).map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('sf_name', '${item.sf_name}')">${item.sf_name}</td>
                    <td>${item.sf_code || '-'}</td>
                    <td class="clickable" onclick="applyDrilldown('product', '${item.product}')">${item.product}</td>
                    <td class="clickable" onclick="applyDrilldown('month', '${item.month}')">${item.month}</td>
                    <td class="text-right">${formatNumber(item.total)}</td>
                    <td class="text-right">${formatNumber(item.qty)}</td>
                </tr>
            `).join('');

            document.getElementById('brand-monthlyFooter').innerHTML = `
                <td colspan="4"><strong>Total (${sortedData.length} entries)</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td class="text-right"><strong>${formatNumber(sortedData.reduce((sum, i) => sum + i.qty, 0))}</strong></td>
            `;

            document.getElementById('brand-monthlyTotal').textContent = `Total: ${formatNumber(total)}`;
        }

        function renderBrandSummaryTable() {
            const data = {};
            filteredData.forEach(item => {
                if (!item.sf_name || !item.product_name) return;
                const key = `${item.sf_name}|${item.product_name}`;
                
                if (!data[key]) {
                    data[key] = {
                        sf_name: item.sf_name,
                        sf_code: item.sf_code,
                        product: item.product_name,
                        total: 0,
                        qty: 0,
                        months: new Set()
                    };
                }
                data[key].total += item.basic_value || 0;
                data[key].qty += item.sale_qty || 0;
                if (item.bill_date) data[key].months.add(item.bill_date.substring(0, 7));
            });

            let sortedData = Object.values(data);
            const state = sortStates['brand-summary'];
            if (state) {
                sortedData.sort((a, b) => {
                    let aVal = a[state.column];
                    let bVal = b[state.column];
                    
                    if (state.column === 'total' || state.column === 'qty') {
                        aVal = aVal || 0;
                        bVal = bVal || 0;
                    } else if (state.column === 'months') {
                        aVal = aVal.size || 0;
                        bVal = bVal.size || 0;
                    } else {
                        aVal = (aVal || '').toString().toLowerCase();
                        bVal = (bVal || '').toString().toLowerCase();
                    }
                    
                    if (aVal < bVal) return state.direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return state.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            const total = sortedData.reduce((sum, item) => sum + item.total, 0);

            document.getElementById('brand-summaryHeader').innerHTML = `
                <th onclick="sortTable('brand-summary', 'sf_name')">SF Name</th>
                <th onclick="sortTable('brand-summary', 'sf_code')">SF Code</th>
                <th onclick="sortTable('brand-summary', 'product')">Product</th>
                <th class="text-right" onclick="sortTable('brand-summary', 'total')">Total Value</th>
                <th class="text-right" onclick="sortTable('brand-summary', 'qty')">Total Qty</th>
                <th class="text-right" onclick="sortTable('brand-summary', 'months')">Months</th>
            `;

            document.getElementById('brand-summaryBody').innerHTML = sortedData.slice(0, 100).map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('sf_name', '${item.sf_name}')">${item.sf_name}</td>
                    <td>${item.sf_code || '-'}</td>
                    <td class="clickable" onclick="applyDrilldown('product', '${item.product}')">${item.product}</td>
                    <td class="text-right">${formatNumber(item.total)}</td>
                    <td class="text-right">${formatNumber(item.qty)}</td>
                    <td class="text-right">${item.months.size}</td>
                </tr>
            `).join('');

            document.getElementById('brand-summaryFooter').innerHTML = `
                <td colspan="3"><strong>Total (${sortedData.length} entries)</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td class="text-right"><strong>${formatNumber(sortedData.reduce((sum, i) => sum + i.qty, 0))}</strong></td>
                <td></td>
            `;

            document.getElementById('brand-summaryTotal').textContent = `Total: ${formatNumber(total)}`;
        }

        function renderProductMonthDetailTable() {
            const data = {};
            filteredData.forEach(item => {
                if (!item.product_name || !item.bill_date) return;
                const month = item.bill_date.substring(0, 7);
                const key = `${item.product_name}|${month}`;
                
                if (!data[key]) {
                    data[key] = {
                        product: item.product_name,
                        product_type: item.product_type,
                        month: month,
                        total: 0,
                        qty: 0,
                        sf_count: new Set()
                    };
                }
                data[key].total += item.basic_value || 0;
                data[key].qty += item.sale_qty || 0;
                if (item.sf_name) data[key].sf_count.add(item.sf_name);
            });

            let sortedData = Object.values(data);
            const state = sortStates['product-month-detail'];
            if (state) {
                sortedData.sort((a, b) => {
                    let aVal = a[state.column];
                    let bVal = b[state.column];
                    
                    if (state.column === 'value' || state.column === 'qty') {
                        aVal = aVal || 0;
                        bVal = bVal || 0;
                    } else if (state.column === 'sf_count') {
                        aVal = aVal.size || 0;
                        bVal = bVal.size || 0;
                    } else {
                        aVal = (aVal || '').toString().toLowerCase();
                        bVal = (bVal || '').toString().toLowerCase();
                    }
                    
                    if (aVal < bVal) return state.direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return state.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            const total = sortedData.reduce((sum, item) => sum + item.total, 0);

            document.getElementById('product-month-detailHeader').innerHTML = `
                <th onclick="sortTable('product-month-detail', 'product')">Product</th>
                <th onclick="sortTable('product-month-detail', 'product_type')">Product Type</th>
                <th onclick="sortTable('product-month-detail', 'month')">Month</th>
                <th class="text-right" onclick="sortTable('product-month-detail', 'value')">Total Value</th>
                <th class="text-right" onclick="sortTable('product-month-detail', 'qty')">Total Qty</th>
                <th class="text-right" onclick="sortTable('product-month-detail', 'sf_count')"># of SFs</th>
            `;

            document.getElementById('product-month-detailBody').innerHTML = sortedData.slice(0, 100).map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('product', '${item.product}')">${item.product}</td>
                    <td class="clickable" onclick="applyDrilldown('product_type', '${item.product_type}')">${item.product_type || '-'}</td>
                    <td class="clickable" onclick="applyDrilldown('month', '${item.month}')">${item.month}</td>
                    <td class="text-right">${formatNumber(item.total)}</td>
                    <td class="text-right">${formatNumber(item.qty)}</td>
                    <td class="text-right">${item.sf_count.size}</td>
                </tr>
            `).join('');

            document.getElementById('product-month-detailFooter').innerHTML = `
                <td colspan="3"><strong>Total (${sortedData.length} entries)</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td class="text-right"><strong>${formatNumber(sortedData.reduce((sum, i) => sum + i.qty, 0))}</strong></td>
                <td></td>
            `;

            document.getElementById('product-month-detailTotal').textContent = `Total: ${formatNumber(total)}`;
        }

        function renderProductMonthSummaryTable() {
            const data = {};
            filteredData.forEach(item => {
                if (!item.product_name) return;
                const key = item.product_name;
                
                if (!data[key]) {
                    data[key] = {
                        product: item.product_name,
                        product_type: item.product_type,
                        total: 0,
                        qty: 0,
                        months: new Set(),
                        sf_count: new Set()
                    };
                }
                data[key].total += item.basic_value || 0;
                data[key].qty += item.sale_qty || 0;
                if (item.bill_date) data[key].months.add(item.bill_date.substring(0, 7));
                if (item.sf_name) data[key].sf_count.add(item.sf_name);
            });

            let sortedData = Object.values(data);
            const state = sortStates['product-month-summary'];
            if (state) {
                sortedData.sort((a, b) => {
                    let aVal = a[state.column];
                    let bVal = b[state.column];
                    
                    if (state.column === 'value' || state.column === 'qty') {
                        aVal = aVal || 0;
                        bVal = bVal || 0;
                    } else if (state.column === 'months' || state.column === 'sf_count') {
                        aVal = aVal.size || 0;
                        bVal = bVal.size || 0;
                    } else {
                        aVal = (aVal || '').toString().toLowerCase();
                        bVal = (bVal || '').toString().toLowerCase();
                    }
                    
                    if (aVal < bVal) return state.direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return state.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            const total = sortedData.reduce((sum, item) => sum + item.total, 0);

            document.getElementById('product-month-summaryHeader').innerHTML = `
                <th onclick="sortTable('product-month-summary', 'product')">Product</th>
                <th onclick="sortTable('product-month-summary', 'product_type')">Product Type</th>
                <th class="text-right" onclick="sortTable('product-month-summary', 'value')">Total Value</th>
                <th class="text-right" onclick="sortTable('product-month-summary', 'qty')">Total Qty</th>
                <th class="text-right" onclick="sortTable('product-month-summary', 'months')"># of Months</th>
                <th class="text-right" onclick="sortTable('product-month-summary', 'sf_count')"># of SFs</th>
            `;

            document.getElementById('product-month-summaryBody').innerHTML = sortedData.slice(0, 100).map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('product', '${item.product}')">${item.product}</td>
                    <td class="clickable" onclick="applyDrilldown('product_type', '${item.product_type}')">${item.product_type || '-'}</td>
                    <td class="text-right">${formatNumber(item.total)}</td>
                    <td class="text-right">${formatNumber(item.qty)}</td>
                    <td class="text-right">${item.months.size}</td>
                    <td class="text-right">${item.sf_count.size}</td>
                </tr>
            `).join('');

            document.getElementById('product-month-summaryFooter').innerHTML = `
                <td colspan="2"><strong>Total (${sortedData.length} products)</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td class="text-right"><strong>${formatNumber(sortedData.reduce((sum, i) => sum + i.qty, 0))}</strong></td>
                <td colspan="2"></td>
            `;

            document.getElementById('product-month-summaryTotal').textContent = `Total: ${formatNumber(total)}`;
        }

        function renderDprTable() {
            let sortedData = [...filteredData];
            const state = sortStates['dpr'];
            if (state) {
                sortedData.sort((a, b) => {
                    let aVal = a[state.column];
                    let bVal = b[state.column];
                    
                    if (state.column === 'value' || state.column === 'qty') {
                        aVal = aVal || 0;
                        bVal = bVal || 0;
                    } else {
                        aVal = (aVal || '').toString().toLowerCase();
                        bVal = (bVal || '').toString().toLowerCase();
                    }
                    
                    if (aVal < bVal) return state.direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return state.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            const total = sortedData.reduce((sum, item) => sum + (item.basic_value || 0), 0);

            document.getElementById('dprHeader').innerHTML = `
                <th onclick="sortTable('dpr', 'bill_date')">Bill Date</th>
                <th onclick="sortTable('dpr', 'bill_no')">Bill No</th>
                <th onclick="sortTable('dpr', 'sf_name')">SF Name</th>
                <th onclick="sortTable('dpr', 'product')">Product</th>
                <th onclick="sortTable('dpr', 'batch_no')">Batch No</th>
                <th class="text-right" onclick="sortTable('dpr', 'qty')">Qty</th>
                <th class="text-right" onclick="sortTable('dpr', 'value')">Value</th>
                <th onclick="sortTable('dpr', 'location')">Location</th>
            `;

            document.getElementById('dprBody').innerHTML = sortedData.slice(0, 100).map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('date', '${item.bill_date}')">${item.bill_date || '-'}</td>
                    <td>${item.bill_no || '-'}</td>
                    <td class="clickable" onclick="applyDrilldown('sf_name', '${item.sf_name}')">${item.sf_name || '-'}</td>
                    <td class="clickable" onclick="applyDrilldown('product', '${item.product_name}')">${item.product_name || '-'}</td>
                    <td>${item.batch_no || '-'}</td>
                    <td class="text-right">${formatNumber(item.sale_qty)}</td>
                    <td class="text-right">${formatNumber(item.basic_value)}</td>
                    <td class="clickable" onclick="applyDrilldown('location', '${item.location}')">${item.location || '-'}</td>
                </tr>
            `).join('');

            document.getElementById('dprFooter').innerHTML = `
                <td colspan="5"><strong>Total (${sortedData.length} entries)</strong></td>
                <td class="text-right"><strong>${formatNumber(sortedData.reduce((sum, i) => sum + (i.sale_qty || 0), 0))}</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td></td>
            `;

            document.getElementById('dprTotal').textContent = `Total: ${formatNumber(total)}`;
        }

        function renderDispatchLocationTable() {
            const data = {};
            filteredData.forEach(item => {
                if (!item.location) return;
                if (!data[item.location]) {
                    data[item.location] = {
                        location: item.location,
                        total: 0,
                        qty: 0,
                        entries: 0
                    };
                }
                data[item.location].total += item.basic_value || 0;
                data[item.location].qty += item.sale_qty || 0;
                data[item.location].entries++;
            });

            let sortedData = Object.values(data);
            const state = sortStates['dispatch-location'];
            if (state) {
                sortedData.sort((a, b) => {
                    let aVal = a[state.column];
                    let bVal = b[state.column];
                    
                    if (state.column === 'value' || state.column === 'qty' || state.column === 'entries' || state.column === 'percentage') {
                        aVal = aVal || 0;
                        bVal = bVal || 0;
                    } else {
                        aVal = (aVal || '').toString().toLowerCase();
                        bVal = (bVal || '').toString().toLowerCase();
                    }
                    
                    if (aVal < bVal) return state.direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return state.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            const total = sortedData.reduce((sum, item) => sum + item.total, 0);

            document.getElementById('dispatch-locationHeader').innerHTML = `
                <th onclick="sortTable('dispatch-location', 'location')">Location</th>
                <th class="text-right" onclick="sortTable('dispatch-location', 'value')">Total Value</th>
                <th class="text-right" onclick="sortTable('dispatch-location', 'qty')">Total Qty</th>
                <th class="text-right" onclick="sortTable('dispatch-location', 'entries')"># of Entries</th>
                <th class="text-right" onclick="sortTable('dispatch-location', 'percentage')">Percentage</th>
            `;

            document.getElementById('dispatch-locationBody').innerHTML = sortedData.map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('location', '${item.location}')">${item.location}</td>
                    <td class="text-right">${formatNumber(item.total)}</td>
                    <td class="text-right">${formatNumber(item.qty)}</td>
                    <td class="text-right">${item.entries}</td>
                    <td class="text-right ${getPercentageClass((item.total/total)*100)}">${formatPercentage((item.total/total)*100)}</td>
                </tr>
            `).join('');

            document.getElementById('dispatch-locationFooter').innerHTML = `
                <td><strong>Total (${sortedData.length} locations)</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td class="text-right"><strong>${formatNumber(sortedData.reduce((sum, i) => sum + i.qty, 0))}</strong></td>
                <td class="text-right"><strong>${sortedData.reduce((sum, i) => sum + i.entries, 0)}</strong></td>
                <td class="text-right"><strong>100%</strong></td>
            `;

            document.getElementById('dispatch-locationTotal').textContent = `Total: ${formatNumber(total)}`;
        }

        // ==================== HELPER FUNCTIONS ====================
        function aggregateData(data, groupField, valueField, nameField = null) {
            const result = {};
            data.forEach(item => {
                const key = item[groupField];
                if (!key) return;
                
                if (!result[key]) {
                    result[key] = {
                        name: key,
                        total: 0
                    };
                    if (nameField) {
                        result[key][nameField] = item[nameField];
                    }
                }
                result[key].total += item[valueField] || 0;
            });
            return Object.values(result);
        }

        function sortAggregatedData(data, sortState) {
            if (!sortState) return data;
            
            return [...data].sort((a, b) => {
                let aVal = a[sortState.column];
                let bVal = b[sortState.column];
                
                if (sortState.column === 'total' || sortState.column === 'percentage') {
                    aVal = aVal || 0;
                    bVal = bVal || 0;
                } else {
                    aVal = (aVal || '').toString().toLowerCase();
                    bVal = (bVal || '').toString().toLowerCase();
                }
                
                if (aVal < bVal) return sortState.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortState.direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        // ==================== FILTER FUNCTIONS ====================
        function updateFilterOptions() {
            const locationSelect = document.getElementById('locationFilter');
            const mktBySelect = document.getElementById('mktByFilter');
            const productTypeSelect = document.getElementById('productTypeFilter');
            
            locationSelect.innerHTML = '<option value="all">All Locations</option>';
            mktBySelect.innerHTML = '<option value="all">All</option>';
            productTypeSelect.innerHTML = '<option value="all">All Types</option>';
            
            Array.from(uniqueLocations).sort().forEach(loc => {
                if (loc) {
                    const option = document.createElement('option');
                    option.value = loc;
                    option.textContent = loc;
                    locationSelect.appendChild(option);
                }
            });

            Array.from(uniqueMktBy).sort().forEach(mkt => {
                if (mkt) {
                    const option = document.createElement('option');
                    option.value = mkt;
                    option.textContent = mkt;
                    mktBySelect.appendChild(option);
                }
            });

            Array.from(uniqueProductTypes).sort().forEach(type => {
                if (type) {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    productTypeSelect.appendChild(option);
                }
            });
        }

        function applyFilters() {
            activeFilters.location = document.getElementById('locationFilter').value !== 'all' ? document.getElementById('locationFilter').value : null;
            activeFilters.mktBy = document.getElementById('mktByFilter').value !== 'all' ? document.getElementById('mktByFilter').value : null;
            activeFilters.productType = document.getElementById('productTypeFilter').value !== 'all' ? document.getElementById('productTypeFilter').value : null;
            activeFilters.dateFrom = document.getElementById('dateFrom').value || null;
            activeFilters.dateTo = document.getElementById('dateTo').value || null;
            activeFilters.search = document.getElementById('globalSearch').value || null;

            // Apply filters
            filteredData = allData.filter(item => {
                if (activeFilters.location && item.location !== activeFilters.location) return false;
                if (activeFilters.mktBy && item.mkt_by !== activeFilters.mktBy) return false;
                if (activeFilters.productType && item.product_type !== activeFilters.productType) return false;
                
                if (activeFilters.dateFrom && item.bill_date) {
                    const itemDate = item.bill_date.substring(0, 7);
                    if (itemDate < activeFilters.dateFrom) return false;
                }
                if (activeFilters.dateTo && item.bill_date) {
                    const itemDate = item.bill_date.substring(0, 7);
                    if (itemDate > activeFilters.dateTo) return false;
                }
                
                if (activeFilters.search) {
                    const searchTerm = activeFilters.search.toLowerCase();
                    const searchableFields = [
                        item.product_name,
                        item.sf_name,
                        item.mkt_by,
                        item.location,
                        item.batch_no,
                        item.sf_code,
                        item.product_type,
                        item.city,
                        item.state
                    ].map(f => (f || '').toLowerCase());
                    
                    if (!searchableFields.some(field => field.includes(searchTerm))) {
                        return false;
                    }
                }
                
                return true;
            });

            updateActiveFiltersDisplay();
            updateStats();
            renderCurrentTab();
        }

        function debounceApplyFilters() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(applyFilters, 300);
        }

        function updateActiveFiltersDisplay() {
            const bar = document.getElementById('activeFiltersBar');
            const container = document.getElementById('activeFilters');
            
            const activeFilterList = [];
            
            if (activeFilters.location) activeFilterList.push(`Location: ${activeFilters.location}`);
            if (activeFilters.mktBy) activeFilterList.push(`Mkt By: ${activeFilters.mktBy}`);
            if (activeFilters.productType) activeFilterList.push(`Product Type: ${activeFilters.productType}`);
            if (activeFilters.dateFrom) activeFilterList.push(`From: ${activeFilters.dateFrom}`);
            if (activeFilters.dateTo) activeFilterList.push(`To: ${activeFilters.dateTo}`);
            if (activeFilters.search) activeFilterList.push(`Search: "${activeFilters.search}"`);
            
            if (activeFilterList.length > 0) {
                bar.style.display = 'flex';
                container.innerHTML = activeFilterList.map(filter => 
                    `<span class="filter-tag">${filter} <button onclick="removeFilter('${filter.split(':')[0].trim().toLowerCase()}')">‚úï</button></span>`
                ).join(' ');
            } else {
                bar.style.display = 'none';
            }
        }

        function removeFilter(filterType) {
            switch(filterType) {
                case 'location':
                    document.getElementById('locationFilter').value = 'all';
                    activeFilters.location = null;
                    break;
                case 'mkt':
                    document.getElementById('mktByFilter').value = 'all';
                    activeFilters.mktBy = null;
                    break;
                case 'product':
                    document.getElementById('productTypeFilter').value = 'all';
                    activeFilters.productType = null;
                    break;
                case 'from':
                    document.getElementById('dateFrom').value = '';
                    activeFilters.dateFrom = null;
                    break;
                case 'to':
                    document.getElementById('dateTo').value = '';
                    activeFilters.dateTo = null;
                    break;
                case 'search':
                    document.getElementById('globalSearch').value = '';
                    activeFilters.search = null;
                    break;
            }
            applyFilters();
        }

        function clearAllFilters() {
            document.getElementById('locationFilter').value = 'all';
            document.getElementById('mktByFilter').value = 'all';
            document.getElementById('productTypeFilter').value = 'all';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('globalSearch').value = '';
            
            activeFilters = {
                location: null,
                mktBy: null,
                productType: null,
                dateFrom: null,
                dateTo: null,
                search: null
            };
            
            filteredData = [...allData];
            updateActiveFiltersDisplay();
            updateStats();
            renderCurrentTab();
        }

        function resetFilters() {
            clearAllFilters();
        }

        // ==================== DRILLDOWN FUNCTION ====================
        function applyDrilldown(type, value) {
            switch(type) {
                case 'location':
                    document.getElementById('locationFilter').value = value;
                    activeFilters.location = value;
                    break;
                case 'mkt_by':
                    document.getElementById('mktByFilter').value = value;
                    activeFilters.mktBy = value;
                    break;
                case 'product_type':
                    document.getElementById('productTypeFilter').value = value;
                    activeFilters.productType = value;
                    break;
                case 'sf_name':
                case 'sf_code':
                    document.getElementById('globalSearch').value = value;
                    activeFilters.search = value;
                    break;
                case 'product':
                    document.getElementById('globalSearch').value = value;
                    activeFilters.search = value;
                    break;
                case 'month':
                case 'date':
                    if (value && value.length >= 7) {
                        const yearMonth = value.substring(0, 7);
                        document.getElementById('dateFrom').value = yearMonth;
                        document.getElementById('dateTo').value = yearMonth;
                        activeFilters.dateFrom = yearMonth;
                        activeFilters.dateTo = yearMonth;
                    }
                    break;
            }
            applyFilters();
        }

        // ==================== UTILITY FUNCTIONS ====================
        function formatNumber(num) {
            if (!num || isNaN(num)) return '-';
            return num.toLocaleString('en-IN', {
                maximumFractionDigits: 2,
                minimumFractionDigits: 2
            });
        }

        function formatPercentage(num) {
            if (!num || isNaN(num)) return '-';
            return num.toFixed(2) + '%';
        }

        function getPercentageClass(value) {
            if (value > 0) return 'percentage-positive';
            if (value < 0) return 'percentage-negative';
            return '';
        }

        function refreshData() {
            connectWithCorsAnywhere();
        }

        // Expose functions to window
        window.applyFilters = applyFilters;
        window.sortTable = sortTable;
        window.resetFilters = resetFilters;
        window.clearAllFilters = clearAllFilters;
        window.removeFilter = removeFilter;
        window.applyDrilldown = applyDrilldown;
        window.refreshData = refreshData;
        window.autoConnect = autoConnect;
        window.debounceApplyFilters = debounceApplyFilters;
    </script>
</body>
</html>
