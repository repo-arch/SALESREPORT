<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>CRIUS Sales Dashboard - Auto Connect</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
        }

        body {
            background: #e9ecf1;
            padding: 20px;
        }

        .dashboard {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 4px;
            overflow: hidden;
        }

        .main-header {
            background: #1e3a5f;
            color: white;
            padding: 16px 24px;
            font-size: 26px;
            font-weight: 600;
            border-bottom: 3px solid #0f2a44;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .api-badge {
            background: #4a6fa5;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin-left: 15px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .weather-info {
            display: flex;
            align-items: center;
            gap: 20px;
            color: #ffd700;
            font-size: 14px;
        }

        .company-header {
            background: linear-gradient(135deg, #2c3e50, #1e3a5f);
            color: white;
            padding: 20px 24px;
            font-size: 28px;
            font-weight: 700;
            border-bottom: 3px solid #ffd700;
            text-align: center;
        }

        .company-subheader {
            color: #ffd700;
            font-size: 14px;
            margin-top: 8px;
            font-weight: normal;
        }

        .nav-menu {
            display: flex;
            background: #f0f2f5;
            padding: 10px 24px;
            gap: 25px;
            flex-wrap: wrap;
            border-bottom: 2px solid #ccd1d9;
        }

        .nav-menu a {
            color: #2c3e50;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            padding: 4px 8px;
        }

        .nav-menu a:hover {
            background: #1e3a5f;
            color: white;
            border-radius: 4px;
        }

        .api-config-panel {
            background: #e8f0fe;
            padding: 20px 24px;
            border-bottom: 2px solid #b8d1f0;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .server-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            background: white;
            padding: 5px 15px;
            border-radius: 8px;
            border: 1px solid #4a6fa5;
            min-width: 350px;
        }

        .server-selector select {
            padding: 8px;
            border: none;
            width: 100%;
            background: transparent;
            font-size: 14px;
        }

        .server-selector select:focus {
            outline: none;
        }

        .api-config-panel input, .api-config-panel select {
            padding: 8px 12px;
            border: 1px solid #9aa6b5;
            border-radius: 6px;
            min-width: 140px;
            font-size: 13px;
        }

        .api-config-panel button {
            background: #1e3a5f;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
        }

        .api-config-panel button:hover {
            background: #0f2a44;
            transform: translateY(-1px);
        }

        .api-config-panel button.test-btn {
            background: #4CAF50;
        }

        .api-config-panel button.test-btn:hover {
            background: #45a049;
        }

        .api-config-panel button.proxy-btn {
            background: #ff9800;
        }

        .connection-status {
            font-size: 13px;
            padding: 8px 16px;
            border-radius: 20px;
            background: #fff3cd;
            display: inline-block;
            font-weight: 500;
        }

        .nav-sidebar {
            display: flex;
            background: #f0f2f5;
            border-bottom: 2px solid #ccd1d9;
            overflow-x: auto;
            white-space: nowrap;
        }

        .nav-item {
            padding: 14px 28px;
            font-size: 14px;
            color: #2c3e50;
            border-right: 1px solid #ccd1d9;
            font-weight: 600;
            cursor: pointer;
        }

        .nav-item:hover {
            background: #e4e7eb;
            color: #1e3a5f;
        }

        .nav-item.active {
            background: #1e3a5f;
            color: white;
            font-weight: 700;
        }

        .filter-bar {
            background: #f8fafc;
            padding: 15px 24px;
            display: flex;
            gap: 20px;
            border-bottom: 2px solid #dee2e9;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .filter-group label {
            font-weight: 700;
            color: #1e3a5f;
            min-width: 70px;
        }

        .filter-group select, .filter-group input {
            padding: 8px 12px;
            border: 1px solid #9aa6b5;
            border-radius: 6px;
            min-width: 150px;
            background: white;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: white;
            border: 1px solid #9aa6b5;
            border-radius: 6px;
            padding: 4px 12px;
            min-width: 280px;
        }

        .search-box input {
            border: none;
            padding: 8px 0;
            width: 100%;
            outline: none;
        }

        .search-box button {
            background: #1e3a5f;
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }

        .refresh-btn {
            background: #4a6fa5;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .reset-btn {
            background: #d6562b;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

        .content {
            padding: 24px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e3a5f;
            margin: 25px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #d0d7e5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-wrapper {
            border: 1px solid #b7bfcc;
            border-radius: 8px;
            margin-bottom: 30px;
            overflow: auto;
            max-height: 500px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        thead th {
            background: #2b5797;
            color: white;
            padding: 12px;
            font-weight: 600;
            border: 1px solid #1e3a5f;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
        }

        thead th:hover {
            background: #1e3a5f;
        }

        thead th.sort-asc::after {
            content: " ‚Üë";
            color: #ffd700;
        }

        thead th.sort-desc::after {
            content: " ‚Üì";
            color: #ffd700;
        }

        tbody td {
            padding: 10px 12px;
            border: 1px solid #b7bfcc;
            white-space: nowrap;
        }

        tbody td.clickable {
            cursor: pointer;
            color: #1e3a5f;
            font-weight: 500;
        }

        tbody td.clickable:hover {
            background: #e3f2fd;
            font-weight: 700;
        }

        tbody tr:hover {
            background: #f5f7fa;
        }

        tfoot td {
            background: #d6562b;
            color: white;
            font-weight: 700;
            padding: 12px;
            border: 1px solid #b13e1f;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }

        .grand-footer {
            background: #1e3a5f;
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            font-weight: 700;
            font-size: 16px;
            border-top: 3px solid #ffd700;
        }

        .dashboard-footer {
            background: #1e3a5f;
            color: white;
            padding: 14px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            border-top: 2px solid #0f2a44;
        }

        .percentage-positive {
            color: #4caf50;
            font-weight: 700;
        }

        .percentage-negative {
            color: #f44336;
            font-weight: 700;
        }

        .text-right {
            text-align: right;
        }

        .loading {
            text-align: center;
            padding: 80px;
            font-size: 18px;
            color: #1e3a5f;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #c00000;
            background: #ffebee;
            margin: 30px;
            border-radius: 8px;
            white-space: pre-line;
        }

        .active-filters-bar {
            background: #fff3cd;
            padding: 12px 24px;
            display: none;
            align-items: center;
            gap: 15px;
            border-bottom: 2px solid #ffe69c;
        }

        .filter-tag {
            background: #ffd700;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #1e3a5f;
        }

        .filter-tag button {
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 700;
            color: #1e3a5f;
            font-size: 14px;
        }

        .pagination {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .pagination button {
            padding: 6px 12px;
            background: white;
            border: 1px solid #9aa6b5;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .proxy-panel {
            background: #f8f9fa;
            padding: 15px 24px;
            border-bottom: 2px solid #dee2e9;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .proxy-panel select {
            padding: 8px 12px;
            border: 1px solid #9aa6b5;
            border-radius: 6px;
            min-width: 250px;
        }

        .proxy-panel button {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .proxy-panel button:hover {
            background: #138496;
        }

        .proxy-status {
            font-size: 13px;
            color: #1e3a5f;
            font-weight: 500;
        }

        .working-proxy-note {
            background: #d4edda;
            padding: 10px 24px;
            border-left: 4px solid #28a745;
            font-size: 13px;
            display: none;
            align-items: center;
            gap: 15px;
        }
        
        .working-proxy-note button {
            background: #28a745;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }

        .sales-kpi-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px 24px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            color: white;
        }

        .kpi-card {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .kpi-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .kpi-card .value {
            font-size: 24px;
            font-weight: 700;
        }

        .kpi-card .trend {
            font-size: 12px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="main-header">
            <div>
                CRIUS Sales Dashboard - Auto Connect
                <span class="api-badge" id="apiBadge" style="display: none;">
                    <span>‚úÖ</span> Connected
                </span>
            </div>
            <div class="weather-info">
                <span>üå§Ô∏è 27¬∞C Sunny</span>
                <span class="last-update" id="lastUpdate"></span>
            </div>
        </div>

        <div class="company-header">
            CRIUS GROUP OF COMPANIES - SALES ANALYTICS
            <div class="company-subheader">Real-time Sales Intelligence Dashboard</div>
        </div>

        <!-- Sales KPI Panel -->
        <div class="sales-kpi-panel" id="kpiPanel" style="display: none;">
            <div class="kpi-card">
                <h3>Total Sales Value</h3>
                <div class="value" id="totalSalesValue">‚Çπ 0</div>
                <div class="trend" id="salesTrend">‚Üë 0% vs last period</div>
            </div>
            <div class="kpi-card">
                <h3>Total Quantity</h3>
                <div class="value" id="totalQuantity">0</div>
                <div class="trend" id="qtyTrend">Avg. 0 per transaction</div>
            </div>
            <div class="kpi-card">
                <h3>Unique Products</h3>
                <div class="value" id="uniqueProducts">0</div>
                <div class="trend" id="productTrend">Across all locations</div>
            </div>
            <div class="kpi-card">
                <h3>Active SFs</h3>
                <div class="value" id="activeSFs">0</div>
                <div class="trend" id="sfTrend">Sales Force</div>
            </div>
        </div>

        <div class="nav-menu">
            <a href="#">Sales Overview</a>
            <a href="#">Product Performance</a>
            <a href="#">SF Performance</a>
            <a href="#">Regional Sales</a>
            <a href="#">Monthly Trends</a>
            <a href="#">Top Products</a>
            <a href="#">Sales Targets</a>
            <a href="#">Growth Analysis</a>
            <a href="#">Market Share</a>
        </div>

        <!-- Working Proxy Found Note (initially hidden) -->
        <div class="working-proxy-note" id="workingProxyNote">
            <span>‚úÖ <strong>Working Proxy Found! Auto-connecting...</strong></span>
            <button onclick="useWorkingProxy()">Connect Now</button>
            <span id="workingProxyUrl" style="font-weight: bold; color: #155724;"></span>
        </div>

        <!-- Server Selection -->
        <div class="api-config-panel">
            <div class="server-selector">
                <select id="serverSelect" onchange="onServerChange()">
                    <option value="http://43.246.140.102:6060/smarten/">üåê Primary Sales Server</option>
                    <option value="http://103.54.103.91:6060/smarten/">üåç Secondary Sales Server</option>
                    <option value="custom">‚úèÔ∏è Custom URL</option>
                </select>
            </div>
            
            <div class="filter-group" id="customUrlGroup" style="display: none;">
                <input type="text" id="customUrl" placeholder="http://your-server:6060/smarten" style="width: 250px;">
            </div>

            <input type="text" id="apiUsername" value="SOURAV" placeholder="Username">
            <input type="password" id="apiPassword" value="KUMAR@1308" placeholder="Password">
            <input type="text" id="reportId" value="r17d84895210.rpt" placeholder="Report ID">
            
            <button onclick="saveConfig()" class="proxy-btn">üíæ Save Config</button>
            <span id="connectionStatus" class="connection-status">Ready</span>
        </div>

        <!-- Proxy Selection Panel with Working Proxies -->
        <div class="proxy-panel">
            <span style="font-weight: 700; color: #1e3a5f;">üåê Auto-Connect Proxies:</span>
            <select id="proxySelect">
                <option value="https://cors-anywhere.herokuapp.com/" selected>CORS Anywhere (Auto-connect)</option>
                <option value="https://api.allorigins.win/raw?url=">AllOrigins.win</option>
                <option value="https://cors-proxy.spaceinbox.workers.dev/?url=">CORS Proxy Worker</option>
                <option value="https://thingproxy.freeboard.io/fetch/">ThingProxy</option>
                <option value="https://corsproxy.io/?">CORSProxy.io</option>
            </select>
            <button onclick="testSelectedProxy()" class="test-btn">‚úì Test Selected</button>
            <button onclick="findWorkingProxy()" class="proxy-btn">üîç Find Working Proxy</button>
            <button onclick="connectWithProxy()" class="refresh-btn">üöÄ Connect via Proxy</button>
            <span id="proxyTestResult" class="proxy-status"></span>
        </div>

        <!-- Action Buttons -->
        <div style="padding: 10px 24px; display: flex; gap: 15px; background: #f8f9fa; border-bottom: 2px solid #dee2e9; flex-wrap: wrap;">
            <button onclick="testDirectConnection()" class="test-btn">Test Direct Connection</button>
            <button onclick="loadSavedConfig()" class="proxy-btn">Load Saved Config</button>
            <span id="globalConnectionStatus" class="connection-status">Ready - Auto-connecting...</span>
        </div>

        <div class="nav-sidebar" id="tabNav"></div>

        <div class="filter-bar">
            <div class="filter-group">
                <label>Location:</label>
                <select id="locationFilter" onchange="applyFilters()">
                    <option value="all">All Locations</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Sales By:</label>
                <select id="mktByFilter" onchange="applyFilters()">
                    <option value="all">All Sales Reps</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Product Type:</label>
                <select id="productTypeFilter" onchange="applyFilters()">
                    <option value="all">All Types</option>
                </select>
            </div>
            <div class="filter-group">
                <label>From:</label>
                <input type="month" id="dateFrom" onchange="applyFilters()" value="2025-02">
            </div>
            <div class="filter-group">
                <label>To:</label>
                <input type="month" id="dateTo" onchange="applyFilters()" value="2026-02">
            </div>
            <div class="search-box">
                <input type="text" placeholder="üîç Search products, SF names..." id="globalSearch" onkeyup="applyFilters()">
                <button onclick="applyFilters()">Search</button>
            </div>
            <button class="refresh-btn" onclick="refreshData()">
                <span>üîÑ</span> Refresh
            </button>
            <button class="reset-btn" onclick="resetFilters()">Reset</button>
        </div>

        <div class="active-filters-bar" id="activeFiltersBar">
            <span style="font-weight: 700;">Active Filters:</span>
            <div id="activeFilters"></div>
            <button onclick="clearAllFilters()" style="margin-left: auto; background: none; border: none; color: #856404; cursor: pointer; font-weight: 600;">Clear All ‚úï</button>
        </div>

        <div id="loading" class="loading">Initializing Sales Dashboard... Auto-connecting to server...</div>
        <div id="error" class="error" style="display: none;"></div>

        <div id="tabContainers" style="display: none;"></div>

        <div class="grand-footer" style="display: none;" id="grandFooter">
            <span>üìä Total Sales Value</span>
            <span id="grandTotalValue"></span>
        </div>

        <div class="dashboard-footer">
            <div class="footer-left">
                <span>¬© 2026 CRIUS Group - Sales Analytics Dashboard</span>
            </div>
            <div class="footer-right">
                <span>üìà Auto-Connect Enabled | v2.0</span>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        let CONFIG = {
            serverUrl: 'http://43.246.140.102:6060/smarten/',
            username: 'SOURAV',
            password: 'KUMAR@1308',
            reportId: 'r17d84895210.rpt'
        };

        const PROXIES = [
            { name: 'CORS Anywhere (Auto-connect)', url: 'https://cors-anywhere.herokuapp.com/' },
            { name: 'AllOrigins', url: 'https://api.allorigins.win/raw?url=' },
            { name: 'CORS Proxy Worker', url: 'https://cors-proxy.spaceinbox.workers.dev/?url=' },
            { name: 'ThingProxy', url: 'https://thingproxy.freeboard.io/fetch/' },
            { name: 'CORSProxy.io', url: 'https://corsproxy.io/?' }
        ];

        let workingProxyUrl = null;
        let allData = [];
        let filteredData = [];
        let headers = [];
        let currentPage = 1;
        const pageSize = 50;
        
        let activeFilters = {
            location: null,
            mktBy: null,
            productType: null,
            dateFrom: '2025-02',
            dateTo: '2026-02',
            search: null
        };

        let sortStates = {
            salesByRep: { column: 1, direction: 'desc' },
            locationSales: { column: 1, direction: 'desc' },
            productSales: { column: 2, direction: 'desc' },
            sfSales: { column: 2, direction: 'desc' },
            monthlySales: { column: 3, direction: 'desc' },
            dailySales: { column: 6, direction: 'desc' }
        };

        let uniqueLocations = new Set();
        let uniqueSalesReps = new Set();
        let uniqueProductTypes = new Set();

        const tabs = [
            { id: 'sales-summary', name: 'üìä Sales Summary' },
            { id: 'sales-by-rep', name: 'üë• Sales by Rep' },
            { id: 'product-sales', name: 'üì¶ Product Sales' },
            { id: 'regional-sales', name: 'üìç Regional Sales' },
            { id: 'monthly-trends', name: 'üìà Monthly Trends' },
            { id: 'daily-sales', name: 'üìã Daily Sales' }
        ];

        // ==================== AUTO-CONNECT ON PAGE LOAD ====================
        window.onload = function() {
            initializeUI();
            loadSavedConfig();
            
            // Auto-connect using CORS Anywhere after a short delay
            setTimeout(() => {
                console.log('Auto-connecting to sales data...');
                document.getElementById('globalConnectionStatus').textContent = 'Auto-connecting...';
                document.getElementById('globalConnectionStatus').style.background = '#fff3cd';
                
                // Try to auto-connect with CORS Anywhere
                autoConnectWithCORSAnywhere();
            }, 1500);
        };

        async function autoConnectWithCORSAnywhere() {
            try {
                // First, try to request CORS Anywhere demo access
                const demoWindow = window.open('https://cors-anywhere.herokuapp.com/corsdemo', '_blank');
                
                // Wait a bit for the demo page to open
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // Now try to connect
                document.getElementById('proxySelect').value = 'https://cors-anywhere.herokuapp.com/';
                await connectWithProxy('https://cors-anywhere.herokuapp.com/');
                
            } catch (error) {
                console.log('Auto-connect failed, trying fallback proxy...');
                // Try fallback proxy
                document.getElementById('proxySelect').value = 'https://cors-proxy.spaceinbox.workers.dev/?url=';
                await connectWithProxy('https://cors-proxy.spaceinbox.workers.dev/?url=');
            }
        }

        function onServerChange() {
            const serverSelect = document.getElementById('serverSelect');
            const customGroup = document.getElementById('customUrlGroup');
            customGroup.style.display = serverSelect.value === 'custom' ? 'flex' : 'none';
        }

        function initializeUI() {
            updateLastUpdateTime(new Date());
            createTabs();
            createTabContainers();
        }

        function saveConfig() {
            const config = {
                serverUrl: getServerUrl(),
                username: document.getElementById('apiUsername').value,
                password: document.getElementById('apiPassword').value,
                reportId: document.getElementById('reportId').value
            };
            localStorage.setItem('smartenConfig', JSON.stringify(config));
            showStatus('‚úÖ Configuration saved!', '#d4edda');
        }

        function loadSavedConfig() {
            const saved = localStorage.getItem('smartenConfig');
            if (saved) {
                try {
                    CONFIG = JSON.parse(saved);
                    document.getElementById('apiUsername').value = CONFIG.username;
                    document.getElementById('apiPassword').value = CONFIG.password;
                    document.getElementById('reportId').value = CONFIG.reportId;
                    
                    const serverSelect = document.getElementById('serverSelect');
                    const options = Array.from(serverSelect.options).map(opt => opt.value);
                    
                    if (options.includes(CONFIG.serverUrl)) {
                        serverSelect.value = CONFIG.serverUrl;
                    } else {
                        serverSelect.value = 'custom';
                        document.getElementById('customUrlGroup').style.display = 'flex';
                        document.getElementById('customUrl').value = CONFIG.serverUrl;
                    }
                    
                    showStatus('‚úÖ Config loaded', '#d4edda');
                } catch (e) {
                    console.log('Error loading config');
                }
            }
        }

        function getServerUrl() {
            const serverSelect = document.getElementById('serverSelect');
            if (serverSelect.value === 'custom') {
                return document.getElementById('customUrl').value;
            }
            return serverSelect.value;
        }

        function showStatus(message, color) {
            const statusEl = document.getElementById('globalConnectionStatus');
            statusEl.textContent = message;
            statusEl.style.background = color;
        }

        function updateLastUpdateTime(date) {
            const options = { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            document.getElementById('lastUpdate').textContent = 'LAST UPDATE: ' + date.toLocaleDateString('en-GB', options);
        }

        // ==================== PROXY FUNCTIONS ====================
        async function requestCorsAnywhereAccess() {
            try {
                window.open('https://cors-anywhere.herokuapp.com/corsdemo', '_blank');
                alert('Please click the button to request temporary access, then click Connect.');
            } catch (error) {
                console.error('Error opening demo page:', error);
            }
        }

        async function testDirectConnection() {
            const statusEl = document.getElementById('globalConnectionStatus');
            statusEl.textContent = 'Testing direct connection...';
            statusEl.style.background = '#fff3cd';
            
            try {
                const serverUrl = getServerUrl();
                const username = document.getElementById('apiUsername').value;
                const password = document.getElementById('apiPassword').value;
                const reportId = document.getElementById('reportId').value;

                const response = await fetch(serverUrl + 'API/getToken', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        username: username,
                        password: password,
                        objectid: reportId,
                        type: 'data'
                    })
                });

                if (response.ok) {
                    const token = await response.text();
                    console.log('Token received:', token);
                    
                    if (token && !token.includes('error')) {
                        statusEl.textContent = '‚úÖ Direct connection works!';
                        statusEl.style.background = '#d4edda';
                    } else {
                        statusEl.textContent = '‚ùå Token invalid: ' + token.substring(0, 50);
                        statusEl.style.background = '#f8d7da';
                    }
                } else {
                    statusEl.textContent = '‚ùå Direct connection failed - ' + response.status;
                    statusEl.style.background = '#f8d7da';
                }
            } catch (error) {
                statusEl.textContent = '‚ùå Direct connection failed - Need proxy';
                statusEl.style.background = '#f8d7da';
            }
        }

        async function testProxy(proxyUrl) {
            const serverUrl = getServerUrl();
            const username = document.getElementById('apiUsername').value;
            const password = document.getElementById('apiPassword').value;
            const reportId = document.getElementById('reportId').value;

            const baseUrl = serverUrl.endsWith('/') ? serverUrl : serverUrl + '/';
            
            let testUrl;
            if (proxyUrl.includes('allorigins') || proxyUrl.includes('corsproxy.io')) {
                testUrl = proxyUrl + encodeURIComponent(baseUrl + 'API/getToken');
            } else if (proxyUrl.includes('thingproxy')) {
                testUrl = proxyUrl + baseUrl + 'API/getToken';
            } else {
                testUrl = proxyUrl + baseUrl + 'API/getToken';
            }

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);

                const response = await fetch(testUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Origin': window.location.origin,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: new URLSearchParams({
                        username: username,
                        password: password,
                        objectid: reportId,
                        type: 'data'
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (response.ok) {
                    return { success: true, url: proxyUrl };
                } else {
                    return { success: false, url: proxyUrl, status: response.status };
                }
            } catch (error) {
                return { success: false, url: proxyUrl, error: error.message };
            }
        }

        async function testSelectedProxy() {
            const proxySelect = document.getElementById('proxySelect');
            const selectedProxy = proxySelect.value;
            const resultEl = document.getElementById('proxyTestResult');
            const proxyName = proxySelect.options[proxySelect.selectedIndex].text;
            
            if (selectedProxy.includes('cors-anywhere.herokuapp.com')) {
                resultEl.innerHTML = '‚ö†Ô∏è <a href="#" onclick="requestCorsAnywhereAccess(); return false;">CORS Anywhere needs temporary access - Click here to request</a>';
                resultEl.style.color = '#ff9800';
                return;
            }
            
            resultEl.textContent = 'Testing...';
            resultEl.style.color = '#666';
            
            const result = await testProxy(selectedProxy);
            
            if (result.success) {
                resultEl.textContent = '‚úÖ Proxy working! Click Connect';
                resultEl.style.color = '#4CAF50';
                workingProxyUrl = selectedProxy;
                
                document.getElementById('workingProxyNote').style.display = 'flex';
                document.getElementById('workingProxyUrl').textContent = proxyName + ' - ' + selectedProxy;
            } else {
                resultEl.textContent = '‚ùå Proxy failed, try another';
                resultEl.style.color = '#f44336';
            }
        }

        async function findWorkingProxy() {
            const statusEl = document.getElementById('globalConnectionStatus');
            const proxyResultEl = document.getElementById('proxyTestResult');
            
            statusEl.textContent = 'Testing all proxies...';
            statusEl.style.background = '#fff3cd';
            proxyResultEl.textContent = 'Working...';

            const proxiesToTest = PROXIES.filter(p => !p.url.includes('cors-anywhere.herokuapp.com'));
            
            for (const proxy of proxiesToTest) {
                statusEl.textContent = `Testing ${proxy.name}...`;
                proxyResultEl.textContent = `Testing ${proxy.name}...`;
                
                const result = await testProxy(proxy.url);
                
                if (result.success) {
                    statusEl.textContent = `‚úÖ Found working proxy: ${proxy.name}`;
                    statusEl.style.background = '#d4edda';
                    proxyResultEl.textContent = `‚úÖ ${proxy.name} works!`;
                    proxyResultEl.style.color = '#4CAF50';
                    
                    workingProxyUrl = proxy.url;
                    
                    const select = document.getElementById('proxySelect');
                    for (let i = 0; i < select.options.length; i++) {
                        if (select.options[i].value === proxy.url) {
                            select.selectedIndex = i;
                            break;
                        }
                    }
                    
                    document.getElementById('workingProxyNote').style.display = 'flex';
                    document.getElementById('workingProxyUrl').textContent = proxy.name + ' - ' + proxy.url;
                    
                    return;
                }
            }

            statusEl.textContent = '‚ùå No working proxies found. Try CORS Anywhere with temporary access.';
            statusEl.style.background = '#f8d7da';
            proxyResultEl.innerHTML = '‚ùå All proxies failed. <a href="#" onclick="requestCorsAnywhereAccess(); return false;">Click here to request CORS Anywhere access</a>';
            proxyResultEl.style.color = '#f44336';
        }

        function useWorkingProxy() {
            if (workingProxyUrl) {
                connectWithProxy(workingProxyUrl);
            }
        }

        // ==================== ENHANCED XML PARSING ====================
        function parseXmlData(xmlString) {
            if (!xmlString || xmlString.trim() === '') {
                console.error('XML data is null or empty');
                return [];
            }

            console.log('Parsing sales data...');

            // Try to detect the actual format
            const trimmed = xmlString.trim();
            
            // Check if it's JSON
            if (trimmed.startsWith('{') || trimmed.startsWith('[')) {
                try {
                    const jsonData = JSON.parse(trimmed);
                    console.log('Response is JSON');
                    return extractDataFromJson(jsonData);
                } catch (e) {
                    console.log('Not valid JSON');
                }
            }

            // Check if it's CSV
            if (trimmed.includes(',') && trimmed.includes('\n')) {
                console.log('Response appears to be CSV format');
                return parseCSV(trimmed);
            }

            // Check if it's HTML
            if (trimmed.toLowerCase().includes('<html') || trimmed.toLowerCase().includes('<!doctype')) {
                console.error('Response is HTML');
                throw new Error('Received HTML instead of XML');
            }

            // Try XML parsing
            return parseXMLWithMultipleStrategies(xmlString);
        }

        function extractDataFromJson(jsonData) {
            const data = [];
            
            if (Array.isArray(jsonData)) {
                return jsonData.map(row => {
                    if (Array.isArray(row)) {
                        return row;
                    } else if (typeof row === 'object') {
                        return Object.values(row).map(val => val?.toString() || '');
                    }
                    return [row?.toString() || ''];
                });
            } else if (jsonData.data && Array.isArray(jsonData.data)) {
                return jsonData.data.map(row => {
                    if (Array.isArray(row)) return row;
                    return Object.values(row).map(val => val?.toString() || '');
                });
            } else if (jsonData.rows && Array.isArray(jsonData.rows)) {
                return jsonData.rows;
            }
            
            return [];
        }

        function parseCSV(csvString) {
            const lines = csvString.split('\n').filter(line => line.trim());
            const data = [];
            
            for (const line of lines) {
                const values = [];
                let inQuote = false;
                let currentValue = '';
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuote = !inQuote;
                    } else if (char === ',' && !inQuote) {
                        values.push(currentValue.trim());
                        currentValue = '';
                    } else {
                        currentValue += char;
                    }
                }
                
                if (currentValue) {
                    values.push(currentValue.trim());
                }
                
                if (values.length > 0) {
                    data.push(values);
                }
            }
            
            return data;
        }

        function parseXMLWithMultipleStrategies(xmlString) {
            // Strategy 1: Standard DOMParser
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlString, 'text/xml');
                
                const parseError = xmlDoc.getElementsByTagName('parsererror');
                if (parseError.length === 0) {
                    const data = extractFromXMLDoc(xmlDoc);
                    if (data.length > 0) {
                        return data;
                    }
                }
            } catch (e) {
                console.log('Strategy 1 failed:', e.message);
            }
            
            // Strategy 2: Regex extraction
            return extractWithRegex(xmlString);
        }

        function extractFromXMLDoc(xmlDoc) {
            const data = [];
            
            const rowTags = ['Row', 'row', 'record', 'item', 'tr', 'data', 'entry'];
            
            for (const tag of rowTags) {
                const rows = xmlDoc.getElementsByTagName(tag);
                if (rows.length > 0) {
                    for (let i = 0; i < rows.length; i++) {
                        const row = rows[i];
                        
                        const colTags = ['Column', 'column', 'field', 'cell', 'td', 'value', 'col'];
                        let columns = [];
                        
                        for (const colTag of colTags) {
                            const cols = row.getElementsByTagName(colTag);
                            if (cols.length > 0) {
                                columns = cols;
                                break;
                            }
                        }
                        
                        if (columns.length === 0) {
                            columns = row.children;
                        }
                        
                        const rowData = [];
                        for (let j = 0; j < columns.length; j++) {
                            const col = columns[j];
                            let value = col.textContent || col.innerHTML || '';
                            
                            value = value
                                .replace(/<[^>]*>/g, '')
                                .replace(/"/g, '')
                                .replace(/\s+/g, ' ')
                                .trim();
                            
                            rowData.push(value);
                        }
                        
                        if (rowData.length > 0) {
                            data.push(rowData);
                        }
                    }
                    
                    if (data.length > 0) break;
                }
            }
            
            return data;
        }

        function extractWithRegex(xmlString) {
            const data = [];
            
            const rowPatterns = [
                /<Row[^>]*>([\s\S]*?)<\/Row>/gi,
                /<row[^>]*>([\s\S]*?)<\/row>/gi,
                /<record[^>]*>([\s\S]*?)<\/record>/gi,
                /<item[^>]*>([\s\S]*?)<\/item>/gi
            ];
            
            let allMatches = [];
            for (const pattern of rowPatterns) {
                const matches = [...xmlString.matchAll(pattern)];
                if (matches.length > 0) {
                    allMatches = matches;
                    break;
                }
            }
            
            if (allMatches.length === 0) {
                return extractTabularData(xmlString);
            }
            
            for (const match of allMatches) {
                const rowContent = match[1];
                
                const colPatterns = [
                    /<Column[^>]*>([\s\S]*?)<\/Column>/gi,
                    /<column[^>]*>([\s\S]*?)<\/column>/gi,
                    /<field[^>]*>([\s\S]*?)<\/field>/gi,
                    /<cell[^>]*>([\s\S]*?)<\/cell>/gi
                ];
                
                let colMatches = [];
                for (const pattern of colPatterns) {
                    const matches = [...rowContent.matchAll(pattern)];
                    if (matches.length > 0) {
                        colMatches = matches;
                        break;
                    }
                }
                
                if (colMatches.length > 0) {
                    const rowData = colMatches.map(col => {
                        let val = col[1].replace(/<[^>]*>/g, '').trim();
                        val = val.replace(/&amp;/g, '&')
                                .replace(/&lt;/g, '<')
                                .replace(/&gt;/g, '>')
                                .replace(/&quot;/g, '"')
                                .replace(/&#39;/g, "'");
                        return val;
                    });
                    data.push(rowData);
                }
            }
            
            if (data.length > 0) {
                return data;
            }
            
            return extractTabularData(xmlString);
        }

        function extractTabularData(xmlString) {
            const data = [];
            
            const text = xmlString.replace(/<[^>]*>/g, '\n').replace(/\n+/g, '\n').trim();
            const lines = text.split('\n').filter(line => line.trim());
            
            for (const line of lines) {
                const parts = line.split(/[\t,|;]/).map(p => p.trim()).filter(p => p);
                if (parts.length > 1) {
                    data.push(parts);
                }
            }
            
            return data;
        }

        // ==================== DATA FETCHING VIA PROXY ====================
        async function connectWithProxy(proxyUrl = null) {
            try {
                const selectedProxy = proxyUrl || document.getElementById('proxySelect').value;
                
                if (!selectedProxy) {
                    alert('Please select or find a working proxy first');
                    return;
                }

                if (selectedProxy.includes('cors-anywhere.herokuapp.com')) {
                    const useAnyway = confirm('CORS Anywhere needs temporary access. Have you requested it from https://cors-anywhere.herokuapp.com/corsdemo ? Click OK if you have, Cancel to request access.');
                    if (!useAnyway) {
                        requestCorsAnywhereAccess();
                        return;
                    }
                }

                document.getElementById('loading').style.display = 'block';
                document.getElementById('loading').textContent = 'Fetching sales data...';
                document.getElementById('error').style.display = 'none';
                document.getElementById('tabContainers').style.display = 'none';
                document.getElementById('grandFooter').style.display = 'none';
                document.getElementById('kpiPanel').style.display = 'none';
                document.getElementById('apiBadge').style.display = 'none';

                const serverUrl = getServerUrl();
                const username = document.getElementById('apiUsername').value;
                const password = document.getElementById('apiPassword').value;
                const reportId = document.getElementById('reportId').value;

                const baseUrl = serverUrl.endsWith('/') ? serverUrl : serverUrl + '/';

                // Step 1: Get Token via Proxy
                let tokenUrl;
                if (selectedProxy.includes('allorigins') || selectedProxy.includes('corsproxy.io')) {
                    tokenUrl = selectedProxy + encodeURIComponent(baseUrl + 'API/getToken');
                } else {
                    tokenUrl = selectedProxy + baseUrl + 'API/getToken';
                }

                console.log('Fetching token from:', tokenUrl);

                const tokenResponse = await fetch(tokenUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Origin': window.location.origin,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: new URLSearchParams({
                        username: username,
                        password: password,
                        objectid: reportId,
                        type: 'data'
                    })
                });

                if (!tokenResponse.ok) {
                    const errorText = await tokenResponse.text();
                    throw new Error(`Failed to fetch token. Status: ${tokenResponse.status}`);
                }

                const token = await tokenResponse.text();

                if (!token || token.trim() === '') {
                    throw new Error('Empty token response');
                }

                // Step 2: Get Data via Proxy
                let dataUrl;
                if (selectedProxy.includes('allorigins') || selectedProxy.includes('corsproxy.io')) {
                    dataUrl = selectedProxy + encodeURIComponent(baseUrl + 'API/getObject?tokenid=' + encodeURIComponent(token));
                } else {
                    dataUrl = selectedProxy + baseUrl + 'API/getObject?tokenid=' + encodeURIComponent(token);
                }

                console.log('Fetching sales data from:', dataUrl);

                const dataResponse = await fetch(dataUrl, {
                    headers: {
                        'Origin': window.location.origin,
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (!dataResponse.ok) {
                    throw new Error(`Failed to fetch data. Status: ${dataResponse.status}`);
                }

                const responseText = await dataResponse.text();

                // Parse data
                let reportData = parseXmlData(responseText);
                
                if (reportData.length === 0) {
                    throw new Error('No sales data found in response');
                }

                // Store headers and remove header row
                headers = reportData[0];
                reportData = reportData.slice(1);
                
                // Transform data
                allData = transformData(reportData);

                if (allData.length === 0) {
                    throw new Error('No valid sales data found after transformation');
                }

                filteredData = [...allData];
                
                rebuildUniqueSets();
                
                // Update UI
                document.getElementById('loading').style.display = 'none';
                document.getElementById('tabContainers').style.display = 'block';
                document.getElementById('grandFooter').style.display = 'flex';
                document.getElementById('kpiPanel').style.display = 'grid';
                document.getElementById('apiBadge').style.display = 'inline-block';
                
                updateLastUpdateTime(new Date());
                updateFilterOptions();
                updateKPIs();
                renderAllTables();

                document.getElementById('globalConnectionStatus').textContent = '‚úÖ Connected - Sales Data Loaded';
                document.getElementById('globalConnectionStatus').style.background = '#d4edda';

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').innerHTML = `
                    <strong>Error loading sales data:</strong><br>
                    ${error.message}<br><br>
                    <strong>Troubleshooting:</strong><br>
                    1. Click "Request Access" for CORS Anywhere<br>
                    2. Try a different proxy from the list<br>
                    3. Check your credentials<br><br>
                    <button onclick="requestCorsAnywhereAccess()" style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Request CORS Access</button>
                    <button onclick="findWorkingProxy()" style="background: #ff9800; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Find Working Proxy</button>
                `;
            }
        }

        function transformData(rows) {
            if (rows.length === 0) return [];
            
            const headerMap = {};
            headers.forEach((header, index) => {
                const headerStr = (header || '').toString().trim().toLowerCase();
                
                if (headerStr.includes('location') || headerStr.includes('godown')) headerMap.location = index;
                else if (headerStr.includes('billno') || headerStr.includes('invoice')) headerMap.bill_no = index;
                else if (headerStr.includes('txndocdt') || headerStr.includes('date')) headerMap.bill_date = index;
                else if (headerStr.includes('itemname') || headerStr.includes('product')) headerMap.product_name = index;
                else if (headerStr.includes('producttype') || headerStr.includes('type')) headerMap.product_type = index;
                else if (headerStr.includes('batchno') || headerStr.includes('batch')) headerMap.batch_no = index;
                else if (headerStr.includes('saleqty') || headerStr.includes('qty')) headerMap.sale_qty = index;
                else if (headerStr.includes('basic') || headerStr.includes('value') || headerStr.includes('amount')) headerMap.basic_value = index;
                else if (headerStr.includes('sfcode') || headerStr.includes('sf_code')) headerMap.sf_code = index;
                else if (headerStr.includes('sfname') || headerStr.includes('sf_name')) headerMap.sf_name = index;
                else if (headerStr.includes('mktby') || headerStr.includes('mkt') || headerStr.includes('salesrep')) headerMap.mkt_by = index;
                else if (headerStr.includes('city')) headerMap.city = index;
                else if (headerStr.includes('state')) headerMap.state = index;
            });

            const objects = [];
            
            rows.forEach((row, rowIndex) => {
                const obj = {
                    id: `row_${rowIndex + 1}`,
                    mkt_by: row[headerMap.mkt_by] || '',
                    location: row[headerMap.location] || '',
                    basic_value: parseFloat((row[headerMap.basic_value] || '0').replace(/,/g, '')) || 0,
                    sf_code: row[headerMap.sf_code] || '',
                    sf_name: row[headerMap.sf_name] || '',
                    product_name: row[headerMap.product_name] || '',
                    product_type: row[headerMap.product_type] || '',
                    sale_qty: parseFloat((row[headerMap.sale_qty] || '0').replace(/,/g, '')) || 0,
                    bill_date: row[headerMap.bill_date] || '',
                    bill_no: row[headerMap.bill_no] || '',
                    batch_no: row[headerMap.batch_no] || '',
                    city: row[headerMap.city] || '',
                    state: row[headerMap.state] || ''
                };
                
                if (obj.basic_value > 0 || obj.sale_qty > 0) {
                    objects.push(obj);
                }
            });
            
            return objects;
        }

        function rebuildUniqueSets() {
            uniqueLocations.clear();
            uniqueSalesReps.clear();
            uniqueProductTypes.clear();
            
            allData.forEach(item => {
                if (item.location) uniqueLocations.add(item.location);
                if (item.mkt_by) uniqueSalesReps.add(item.mkt_by);
                if (item.product_type) uniqueProductTypes.add(item.product_type);
            });
        }

        function updateKPIs() {
            const totalSales = filteredData.reduce((sum, item) => sum + (item.basic_value || 0), 0);
            const totalQty = filteredData.reduce((sum, item) => sum + (item.sale_qty || 0), 0);
            const uniqueProductsSet = new Set(filteredData.map(item => item.product_name).filter(Boolean));
            const uniqueSFsSet = new Set(filteredData.map(item => item.sf_name).filter(Boolean));

            document.getElementById('totalSalesValue').textContent = '‚Çπ ' + formatNumber(totalSales);
            document.getElementById('totalQuantity').textContent = formatNumber(totalQty);
            document.getElementById('uniqueProducts').textContent = uniqueProductsSet.size;
            document.getElementById('activeSFs').textContent = uniqueSFsSet.size;

            // Calculate trends (dummy data for now)
            document.getElementById('salesTrend').innerHTML = `‚Üë 15% vs last period`;
            document.getElementById('qtyTrend').innerHTML = `Avg. ${Math.round(totalQty / filteredData.length)} per transaction`;
            document.getElementById('productTrend').innerHTML = `Across ${uniqueLocations.size} locations`;
            document.getElementById('sfTrend').innerHTML = `${uniqueSFsSet.size} active sales force`;
        }

        function refreshData() {
            if (workingProxyUrl) {
                connectWithProxy(workingProxyUrl);
            } else {
                autoConnectWithCORSAnywhere();
            }
        }

        // ==================== TAB FUNCTIONS ====================
        function createTabs() {
            const tabNav = document.getElementById('tabNav');
            tabNav.innerHTML = '';
            
            tabs.forEach((tab, index) => {
                const tabElement = document.createElement('div');
                tabElement.className = `nav-item ${index === 0 ? 'active' : ''}`;
                tabElement.setAttribute('data-tab', tab.id);
                tabElement.textContent = tab.name;
                tabElement.onclick = () => switchTab(tab.id);
                tabNav.appendChild(tabElement);
            });
        }

        function createTabContainers() {
            const containers = document.getElementById('tabContainers');
            containers.innerHTML = '';
            
            tabs.forEach((tab, index) => {
                const container = document.createElement('div');
                container.id = `tab-${tab.id}`;
                container.className = `tab-content ${index === 0 ? 'active' : ''}`;
                container.innerHTML = getTabHTML(tab.id);
                containers.appendChild(container);
            });
        }

        function getTabHTML(tabId) {
            switch(tabId) {
                case 'sales-summary':
                    return `
                        <div class="section-title">
                            üìà Sales by Representative
                            <span class="total-info" id="salesByRepTotal"></span>
                        </div>
                        <div class="table-wrapper">
                            <table id="salesByRepTable">
                                <thead><tr id="salesByRepHeader"></tr></thead>
                                <tbody id="salesByRepBody"></tbody>
                                <tfoot id="salesByRepFooter"></tfoot>
                            </table>
                        </div>

                        <div class="section-title">
                            üìç Location-wise Sales
                            <span class="total-info" id="locationSalesTotal"></span>
                        </div>
                        <div class="table-wrapper">
                            <table id="locationSalesTable">
                                <thead><tr id="locationSalesHeader"></tr></thead>
                                <tbody id="locationSalesBody"></tbody>
                                <tfoot id="locationSalesFooter"></tfoot>
                            </table>
                        </div>

                        <div class="section-title">
                            üè∑Ô∏è Product Type Sales
                            <span class="total-info" id="productTypeSalesTotal"></span>
                        </div>
                        <div class="table-wrapper">
                            <table id="productTypeSalesTable">
                                <thead><tr id="productTypeSalesHeader"></tr></thead>
                                <tbody id="productTypeSalesBody"></tbody>
                                <tfoot id="productTypeSalesFooter"></tfoot>
                            </table>
                        </div>
                    `;
                case 'sales-by-rep':
                    return `
                        <div class="section-title">
                            üë• Sales Force Performance
                            <span class="total-info" id="sfSalesTotal"></span>
                        </div>
                        <div class="table-wrapper">
                            <table id="sfSalesTable">
                                <thead><tr id="sfSalesHeader"></tr></thead>
                                <tbody id="sfSalesBody"></tbody>
                                <tfoot id="sfSalesFooter"></tfoot>
                            </table>
                        </div>

                        <div class="section-title">
                            üî¢ Sales Force Code Details
                            <span class="total-info" id="sfCodeSalesTotal"></span>
                        </div>
                        <div class="table-wrapper">
                            <table id="sfCodeSalesTable">
                                <thead><tr id="sfCodeSalesHeader"></tr></thead>
                                <tbody id="sfCodeSalesBody"></tbody>
                                <tfoot id="sfCodeSalesFooter"></tfoot>
                            </table>
                        </div>
                    `;
                case 'product-sales':
                    return `
                        <div class="section-title">
                            üì¶ Product-wise Sales (Monthly)
                            <span class="total-info" id="productMonthlySalesTotal"></span>
                        </div>
                        <div class="table-wrapper">
                            <table id="productMonthlySalesTable">
                                <thead><tr id="productMonthlySalesHeader"></tr></thead>
                                <tbody id="productMonthlySalesBody"></tbody>
                                <tfoot id="productMonthlySalesFooter"></tfoot>
                            </table>
                        </div>

                        <div class="section-title">
                            üìä Product Sales Summary
                            <div class="pagination">
                                <span id="productRange">1-50</span>
                                <span>/ <span id="totalProducts">0</span></span>
                                <button onclick="prevPage()" id="prevBtn" disabled>‚Üê</button>
                                <button onclick="nextPage()" id="nextBtn">‚Üí</button>
                            </div>
                        </div>
                        <div class="table-wrapper">
                            <table id="productSalesSummaryTable">
                                <thead><tr id="productSalesSummaryHeader"></tr></thead>
                                <tbody id="productSalesSummaryBody"></tbody>
                                <tfoot id="productSalesSummaryFooter"></tfoot>
                            </table>
                        </div>
                    `;
                case 'regional-sales':
                    return `
                        <div class="section-title">
                            üìç Regional Sales Analysis
                            <span class="total-info" id="regionalSalesTotal"></span>
                        </div>
                        <div class="table-wrapper">
                            <table id="regionalSalesTable">
                                <thead><tr id="regionalSalesHeader"></tr></thead>
                                <tbody id="regionalSalesBody"></tbody>
                                <tfoot id="regionalSalesFooter"></tfoot>
                            </table>
                        </div>

                        <div class="section-title">
                            üèôÔ∏è City-wise Sales
                            <span class="total-info" id="citySalesTotal"></span>
                        </div>
                        <div class="table-wrapper">
                            <table id="citySalesTable">
                                <thead><tr id="citySalesHeader"></tr></thead>
                                <tbody id="citySalesBody"></tbody>
                                <tfoot id="citySalesFooter"></tfoot>
                            </table>
                        </div>
                    `;
                case 'monthly-trends':
                    return `
                        <div class="section-title">
                            üìà Monthly Sales Trends
                            <span class="total-info" id="monthlyTrendsTotal"></span>
                        </div>
                        <div class="table-wrapper">
                            <table id="monthlyTrendsTable">
                                <thead><tr id="monthlyTrendsHeader"></tr></thead>
                                <tbody id="monthlyTrendsBody"></tbody>
                                <tfoot id="monthlyTrendsFooter"></tfoot>
                            </table>
                        </div>

                        <div class="section-title">
                            üìä Growth Analysis
                            <span class="total-info" id="growthAnalysisTotal"></span>
                        </div>
                        <div class="table-wrapper">
                            <table id="growthAnalysisTable">
                                <thead><tr id="growthAnalysisHeader"></tr></thead>
                                <tbody id="growthAnalysisBody"></tbody>
                                <tfoot id="growthAnalysisFooter"></tfoot>
                            </table>
                        </div>
                    `;
                case 'daily-sales':
                    return `
                        <div class="section-title">
                            üìã Daily Sales Details
                            <span class="total-info" id="dailySalesTotal"></span>
                        </div>
                        <div class="table-wrapper">
                            <table id="dailySalesTable">
                                <thead><tr id="dailySalesHeader"></tr></thead>
                                <tbody id="dailySalesBody"></tbody>
                                <tfoot id="dailySalesFooter"></tfoot>
                            </table>
                        </div>

                        <div class="section-title">
                            üìç Daily Sales by Location
                            <span class="total-info" id="dailyLocationSalesTotal"></span>
                        </div>
                        <div class="table-wrapper">
                            <table id="dailyLocationSalesTable">
                                <thead><tr id="dailyLocationSalesHeader"></tr></thead>
                                <tbody id="dailyLocationSalesBody"></tbody>
                                <tfoot id="dailyLocationSalesFooter"></tfoot>
                            </table>
                        </div>
                    `;
                default:
                    return '';
            }
        }

        function switchTab(tabId) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if(item.getAttribute('data-tab') === tabId) {
                    item.classList.add('active');
                }
            });
            
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        // ==================== FILTER FUNCTIONS ====================
        function updateFilterOptions() {
            const locationSelect = document.getElementById('locationFilter');
            const mktBySelect = document.getElementById('mktByFilter');
            const productTypeSelect = document.getElementById('productTypeFilter');
            
            locationSelect.innerHTML = '<option value="all">All Locations</option>';
            mktBySelect.innerHTML = '<option value="all">All Sales Reps</option>';
            productTypeSelect.innerHTML = '<option value="all">All Types</option>';
            
            Array.from(uniqueLocations).sort().forEach(loc => {
                if (loc) {
                    const option = document.createElement('option');
                    option.value = loc;
                    option.textContent = loc;
                    locationSelect.appendChild(option);
                }
            });

            Array.from(uniqueSalesReps).sort().forEach(rep => {
                if (rep) {
                    const option = document.createElement('option');
                    option.value = rep;
                    option.textContent = rep;
                    mktBySelect.appendChild(option);
                }
            });

            Array.from(uniqueProductTypes).sort().forEach(type => {
                if (type) {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    productTypeSelect.appendChild(option);
                }
            });
        }

        function applyFilters() {
            activeFilters.location = document.getElementById('locationFilter').value !== 'all' ? document.getElementById('locationFilter').value : null;
            activeFilters.mktBy = document.getElementById('mktByFilter').value !== 'all' ? document.getElementById('mktByFilter').value : null;
            activeFilters.productType = document.getElementById('productTypeFilter').value !== 'all' ? document.getElementById('productTypeFilter').value : null;
            activeFilters.dateFrom = document.getElementById('dateFrom').value;
            activeFilters.dateTo = document.getElementById('dateTo').value;
            activeFilters.search = document.getElementById('globalSearch').value || null;

            filteredData = allData.filter(item => {
                if (activeFilters.location && item.location !== activeFilters.location) return false;
                if (activeFilters.mktBy && item.mkt_by !== activeFilters.mktBy) return false;
                if (activeFilters.productType && item.product_type !== activeFilters.productType) return false;
                
                if (activeFilters.dateFrom && item.bill_date) {
                    const itemDate = item.bill_date.substring(0, 7);
                    if (itemDate < activeFilters.dateFrom) return false;
                }
                if (activeFilters.dateTo && item.bill_date) {
                    const itemDate = item.bill_date.substring(0, 7);
                    if (itemDate > activeFilters.dateTo) return false;
                }
                
                if (activeFilters.search) {
                    const searchTerm = activeFilters.search.toLowerCase();
                    const searchableFields = [
                        item.product_name,
                        item.sf_name,
                        item.mkt_by,
                        item.location,
                        item.batch_no,
                        item.sf_code
                    ].map(f => (f || '').toLowerCase());
                    
                    if (!searchableFields.some(field => field.includes(searchTerm))) {
                        return false;
                    }
                }
                
                return true;
            });

            updateActiveFiltersDisplay();
            currentPage = 1;
            updateKPIs();
            renderAllTables();
        }

        function updateActiveFiltersDisplay() {
            const bar = document.getElementById('activeFiltersBar');
            const container = document.getElementById('activeFilters');
            
            const activeFilterList = [];
            
            if (activeFilters.location) activeFilterList.push(`Location: ${activeFilters.location}`);
            if (activeFilters.mktBy) activeFilterList.push(`Sales Rep: ${activeFilters.mktBy}`);
            if (activeFilters.productType) activeFilterList.push(`Product Type: ${activeFilters.productType}`);
            if (activeFilters.dateFrom) activeFilterList.push(`From: ${activeFilters.dateFrom}`);
            if (activeFilters.dateTo) activeFilterList.push(`To: ${activeFilters.dateTo}`);
            if (activeFilters.search) activeFilterList.push(`Search: "${activeFilters.search}"`);
            
            if (activeFilterList.length > 0) {
                bar.style.display = 'flex';
                container.innerHTML = activeFilterList.map(filter => 
                    `<span class="filter-tag">${filter} <button onclick="removeFilter('${filter.split(':')[0].trim().toLowerCase()}')">‚úï</button></span>`
                ).join(' ');
            } else {
                bar.style.display = 'none';
            }
        }

        function removeFilter(filterType) {
            switch(filterType) {
                case 'location':
                    document.getElementById('locationFilter').value = 'all';
                    activeFilters.location = null;
                    break;
                case 'sales':
                case 'rep':
                    document.getElementById('mktByFilter').value = 'all';
                    activeFilters.mktBy = null;
                    break;
                case 'product':
                    document.getElementById('productTypeFilter').value = 'all';
                    activeFilters.productType = null;
                    break;
                case 'from':
                    document.getElementById('dateFrom').value = '';
                    activeFilters.dateFrom = null;
                    break;
                case 'to':
                    document.getElementById('dateTo').value = '';
                    activeFilters.dateTo = null;
                    break;
                case 'search':
                    document.getElementById('globalSearch').value = '';
                    activeFilters.search = null;
                    break;
            }
            applyFilters();
        }

        function clearAllFilters() {
            document.getElementById('locationFilter').value = 'all';
            document.getElementById('mktByFilter').value = 'all';
            document.getElementById('productTypeFilter').value = 'all';
            document.getElementById('dateFrom').value = '2025-02';
            document.getElementById('dateTo').value = '2026-02';
            document.getElementById('globalSearch').value = '';
            
            activeFilters = {
                location: null,
                mktBy: null,
                productType: null,
                dateFrom: '2025-02',
                dateTo: '2026-02',
                search: null
            };
            
            filteredData = [...allData];
            updateActiveFiltersDisplay();
            updateKPIs();
            renderAllTables();
        }

        function resetFilters() {
            clearAllFilters();
        }

        // ==================== SORT FUNCTIONS ====================
        function sortTable(tableType, columnIndex) {
            const state = sortStates[tableType];
            if (!state) return;
            
            if (state.column === columnIndex) {
                state.direction = state.direction === 'asc' ? 'desc' : 'asc';
            } else {
                state.column = columnIndex;
                state.direction = 'desc';
            }

            document.querySelectorAll(`#${tableType}Header th`).forEach((th, idx) => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            const headerCell = document.querySelector(`#${tableType}Header th:nth-child(${columnIndex + 1})`);
            if (headerCell) {
                headerCell.classList.add(`sort-${state.direction}`);
            }

            renderAllTables();
        }

        // ==================== PAGINATION FUNCTIONS ====================
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderAllTables();
            }
        }

        function nextPage() {
            currentPage++;
            renderAllTables();
        }

        // ==================== UTILITY FUNCTIONS ====================
        function formatNumber(num) {
            if (!num || isNaN(num)) return '-';
            return num.toLocaleString('en-IN', {
                maximumFractionDigits: 2,
                minimumFractionDigits: 2
            });
        }

        function formatPercentage(num) {
            if (!num || isNaN(num)) return '-';
            return num.toFixed(2) + '%';
        }

        function getPercentageClass(value) {
            if (value > 0) return 'percentage-positive';
            if (value < 0) return 'percentage-negative';
            return '';
        }

        // ==================== TABLE RENDERING FUNCTIONS ====================
        function renderAllTables() {
            if (filteredData.length === 0) {
                document.querySelectorAll('tbody').forEach(body => {
                    body.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px;">No sales data available. Please connect to server.</td></tr>';
                });
                return;
            }

            renderSalesByRepTable();
            renderLocationSalesTable();
            renderProductTypeSalesTable();
            renderSfSalesTable();
            renderSfCodeSalesTable();
            renderProductMonthlySalesTable();
            renderProductSalesSummaryTable();
            renderRegionalSalesTable();
            renderCitySalesTable();
            renderMonthlyTrendsTable();
            renderGrowthAnalysisTable();
            renderDailySalesTable();
            renderDailyLocationSalesTable();
            updateGrandTotal();
        }

        function renderSalesByRepTable() {
            const data = filteredData.reduce((acc, item) => {
                if (!item.mkt_by) return acc;
                if (!acc[item.mkt_by]) {
                    acc[item.mkt_by] = { name: item.mkt_by, total: 0, qty: 0 };
                }
                acc[item.mkt_by].total += item.basic_value || 0;
                acc[item.mkt_by].qty += item.sale_qty || 0;
                return acc;
            }, {});

            const sortedData = Object.values(data).sort((a, b) => b.total - a.total);
            const total = sortedData.reduce((sum, item) => sum + item.total, 0);

            document.getElementById('salesByRepHeader').innerHTML = `
                <th onclick="sortTable('salesByRep', 0)">Sales Representative</th>
                <th onclick="sortTable('salesByRep', 1)" class="text-right">Total Sales Value</th>
                <th onclick="sortTable('salesByRep', 2)" class="text-right">Total Quantity</th>
                <th onclick="sortTable('salesByRep', 3)" class="text-right">% of Total</th>
            `;

            document.getElementById('salesByRepBody').innerHTML = sortedData.map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('mktBy', '${item.name}')">${item.name}</td>
                    <td class="text-right">${formatNumber(item.total)}</td>
                    <td class="text-right">${formatNumber(item.qty)}</td>
                    <td class="text-right ${getPercentageClass((item.total/total)*100)}">${formatPercentage((item.total/total)*100)}</td>
                </tr>
            `).join('');

            document.getElementById('salesByRepFooter').innerHTML = `
                <td><strong>Total (${sortedData.length} reps)</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td class="text-right"><strong>${formatNumber(sortedData.reduce((sum, i) => sum + i.qty, 0))}</strong></td>
                <td class="text-right"><strong>100%</strong></td>
            `;

            document.getElementById('salesByRepTotal').textContent = `Total: ${formatNumber(total)}`;
        }

        function renderLocationSalesTable() {
            const data = filteredData.reduce((acc, item) => {
                if (!item.location) return acc;
                if (!acc[item.location]) {
                    acc[item.location] = { name: item.location, total: 0, qty: 0 };
                }
                acc[item.location].total += item.basic_value || 0;
                acc[item.location].qty += item.sale_qty || 0;
                return acc;
            }, {});

            const sortedData = Object.values(data).sort((a, b) => b.total - a.total);
            const total = sortedData.reduce((sum, item) => sum + item.total, 0);

            document.getElementById('locationSalesHeader').innerHTML = `
                <th onclick="sortTable('locationSales', 0)">Location</th>
                <th onclick="sortTable('locationSales', 1)" class="text-right">Total Sales Value</th>
                <th onclick="sortTable('locationSales', 2)" class="text-right">Total Quantity</th>
                <th onclick="sortTable('locationSales', 3)" class="text-right">% of Total</th>
            `;

            document.getElementById('locationSalesBody').innerHTML = sortedData.map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('location', '${item.name}')">${item.name}</td>
                    <td class="text-right">${formatNumber(item.total)}</td>
                    <td class="text-right">${formatNumber(item.qty)}</td>
                    <td class="text-right ${getPercentageClass((item.total/total)*100)}">${formatPercentage((item.total/total)*100)}</td>
                </tr>
            `).join('');

            document.getElementById('locationSalesFooter').innerHTML = `
                <td><strong>Total (${sortedData.length} locations)</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td class="text-right"><strong>${formatNumber(sortedData.reduce((sum, i) => sum + i.qty, 0))}</strong></td>
                <td class="text-right"><strong>100%</strong></td>
            `;

            document.getElementById('locationSalesTotal').textContent = `Total: ${formatNumber(total)}`;
        }

        function renderProductTypeSalesTable() {
            const data = filteredData.reduce((acc, item) => {
                if (!item.product_type) return acc;
                if (!acc[item.product_type]) {
                    acc[item.product_type] = { name: item.product_type, total: 0, qty: 0 };
                }
                acc[item.product_type].total += item.basic_value || 0;
                acc[item.product_type].qty += item.sale_qty || 0;
                return acc;
            }, {});

            const sortedData = Object.values(data).sort((a, b) => b.total - a.total);
            const total = sortedData.reduce((sum, item) => sum + item.total, 0);

            document.getElementById('productTypeSalesHeader').innerHTML = `
                <th onclick="sortTable('productTypeSales', 0)">Product Type</th>
                <th onclick="sortTable('productTypeSales', 1)" class="text-right">Total Sales Value</th>
                <th onclick="sortTable('productTypeSales', 2)" class="text-right">Total Quantity</th>
                <th onclick="sortTable('productTypeSales', 3)" class="text-right">% of Total</th>
            `;

            document.getElementById('productTypeSalesBody').innerHTML = sortedData.map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('productType', '${item.name}')">${item.name}</td>
                    <td class="text-right">${formatNumber(item.total)}</td>
                    <td class="text-right">${formatNumber(item.qty)}</td>
                    <td class="text-right ${getPercentageClass((item.total/total)*100)}">${formatPercentage((item.total/total)*100)}</td>
                </tr>
            `).join('');

            document.getElementById('productTypeSalesFooter').innerHTML = `
                <td><strong>Total (${sortedData.length} types)</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td class="text-right"><strong>${formatNumber(sortedData.reduce((sum, i) => sum + i.qty, 0))}</strong></td>
                <td class="text-right"><strong>100%</strong></td>
            `;

            document.getElementById('productTypeSalesTotal').textContent = `Total: ${formatNumber(total)}`;
        }

        function renderSfSalesTable() {
            const data = filteredData.reduce((acc, item) => {
                if (!item.sf_name) return acc;
                const key = item.sf_name;
                if (!acc[key]) {
                    acc[key] = { 
                        sf_name: item.sf_name,
                        sf_code: item.sf_code,
                        total: 0,
                        qty: 0,
                        locations: new Set(),
                        products: new Set()
                    };
                }
                acc[key].total += item.basic_value || 0;
                acc[key].qty += item.sale_qty || 0;
                if (item.location) acc[key].locations.add(item.location);
                if (item.product_name) acc[key].products.add(item.product_name);
                return acc;
            }, {});

            const sortedData = Object.values(data).sort((a, b) => b.total - a.total);
            const total = sortedData.reduce((sum, item) => sum + item.total, 0);

            document.getElementById('sfSalesHeader').innerHTML = `
                <th onclick="sortTable('sfSales', 0)">SF Name</th>
                <th onclick="sortTable('sfSales', 1)">SF Code</th>
                <th onclick="sortTable('sfSales', 2)" class="text-right">Total Sales</th>
                <th onclick="sortTable('sfSales', 3)" class="text-right">Quantity</th>
                <th onclick="sortTable('sfSales', 4)" class="text-right">% of Total</th>
                <th>Locations</th>
                <th>Products</th>
            `;

            document.getElementById('sfSalesBody').innerHTML = sortedData.map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('sfName', '${item.sf_name}')">${item.sf_name || '-'}</td>
                    <td class="clickable" onclick="applyDrilldown('sfCode', '${item.sf_code}')">${item.sf_code || '-'}</td>
                    <td class="text-right">${formatNumber(item.total)}</td>
                    <td class="text-right">${formatNumber(item.qty)}</td>
                    <td class="text-right ${getPercentageClass((item.total/total)*100)}">${formatPercentage((item.total/total)*100)}</td>
                    <td>${item.locations.size}</td>
                    <td>${item.products.size}</td>
                </tr>
            `).join('');

            document.getElementById('sfSalesFooter').innerHTML = `
                <td colspan="2"><strong>Total (${sortedData.length} SFs)</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td class="text-right"><strong>${formatNumber(sortedData.reduce((sum, i) => sum + i.qty, 0))}</strong></td>
                <td class="text-right"><strong>100%</strong></td>
                <td colspan="2"></td>
            `;

            document.getElementById('sfSalesTotal').textContent = `Total: ${formatNumber(total)}`;
        }

        function renderSfCodeSalesTable() {
            const data = filteredData.reduce((acc, item) => {
                if (!item.sf_code) return acc;
                const key = item.sf_code;
                if (!acc[key]) {
                    acc[key] = { 
                        sf_code: item.sf_code,
                        sf_name: item.sf_name,
                        total: 0,
                        qty: 0
                    };
                }
                acc[key].total += item.basic_value || 0;
                acc[key].qty += item.sale_qty || 0;
                return acc;
            }, {});

            const sortedData = Object.values(data).sort((a, b) => b.total - a.total);
            const total = sortedData.reduce((sum, item) => sum + item.total, 0);

            document.getElementById('sfCodeSalesHeader').innerHTML = `
                <th onclick="sortTable('sfCodeSales', 0)">SF Code</th>
                <th onclick="sortTable('sfCodeSales', 1)">SF Name</th>
                <th onclick="sortTable('sfCodeSales', 2)" class="text-right">Total Sales</th>
                <th onclick="sortTable('sfCodeSales', 3)" class="text-right">Quantity</th>
                <th onclick="sortTable('sfCodeSales', 4)" class="text-right">Percentage</th>
            `;

            document.getElementById('sfCodeSalesBody').innerHTML = sortedData.map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('sfCode', '${item.sf_code}')">${item.sf_code}</td>
                    <td>${item.sf_name || '-'}</td>
                    <td class="text-right">${formatNumber(item.total)}</td>
                    <td class="text-right">${formatNumber(item.qty)}</td>
                    <td class="text-right ${getPercentageClass((item.total/total)*100)}">${formatPercentage((item.total/total)*100)}</td>
                </tr>
            `).join('');

            document.getElementById('sfCodeSalesFooter').innerHTML = `
                <td colspan="2"><strong>Total (${sortedData.length} codes)</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td class="text-right"><strong>${formatNumber(sortedData.reduce((sum, i) => sum + i.qty, 0))}</strong></td>
                <td class="text-right"><strong>100%</strong></td>
            `;

            document.getElementById('sfCodeSalesTotal').textContent = `Total: ${formatNumber(total)}`;
        }

        function renderProductMonthlySalesTable() {
            const data = filteredData.reduce((acc, item) => {
                if (!item.product_name || !item.bill_date) return acc;
                const month = item.bill_date.substring(0, 7);
                const key = `${item.product_name}|${month}`;
                
                if (!acc[key]) {
                    acc[key] = {
                        product: item.product_name,
                        product_type: item.product_type,
                        month: month,
                        total: 0,
                        qty: 0,
                        sf_count: new Set()
                    };
                }
                acc[key].total += item.basic_value || 0;
                acc[key].qty += item.sale_qty || 0;
                if (item.sf_name) acc[key].sf_count.add(item.sf_name);
                return acc;
            }, {});

            const sortedData = Object.values(data).sort((a, b) => b.total - a.total);
            const total = sortedData.reduce((sum, item) => sum + item.total, 0);

            document.getElementById('productMonthlySalesHeader').innerHTML = `
                <th onclick="sortTable('productMonthlySales', 0)">Product</th>
                <th onclick="sortTable('productMonthlySales', 1)">Product Type</th>
                <th onclick="sortTable('productMonthlySales', 2)">Month</th>
                <th onclick="sortTable('productMonthlySales', 3)" class="text-right">Sales Value</th>
                <th onclick="sortTable('productMonthlySales', 4)" class="text-right">Quantity</th>
                <th onclick="sortTable('productMonthlySales', 5)" class="text-right"># of SFs</th>
            `;

            document.getElementById('productMonthlySalesBody').innerHTML = sortedData.slice(0, 100).map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('product', '${item.product}')">${item.product}</td>
                    <td>${item.product_type || '-'}</td>
                    <td class="clickable" onclick="applyDrilldown('month', '${item.month}')">${item.month}</td>
                    <td class="text-right">${formatNumber(item.total)}</td>
                    <td class="text-right">${formatNumber(item.qty)}</td>
                    <td class="text-right">${item.sf_count.size}</td>
                </tr>
            `).join('');

            document.getElementById('productMonthlySalesFooter').innerHTML = `
                <td colspan="3"><strong>Total (${sortedData.length} entries)</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td class="text-right"><strong>${formatNumber(sortedData.reduce((sum, i) => sum + i.qty, 0))}</strong></td>
                <td></td>
            `;

            document.getElementById('productMonthlySalesTotal').textContent = `Total: ${formatNumber(total)}`;
        }

        function renderProductSalesSummaryTable() {
            const data = filteredData.reduce((acc, item) => {
                if (!item.product_name) return acc;
                const key = item.product_name;
                
                if (!acc[key]) {
                    acc[key] = {
                        product: item.product_name,
                        product_type: item.product_type,
                        total: 0,
                        qty: 0,
                        months: new Set(),
                        sf_count: new Set()
                    };
                }
                acc[key].total += item.basic_value || 0;
                acc[key].qty += item.sale_qty || 0;
                if (item.bill_date) acc[key].months.add(item.bill_date.substring(0, 7));
                if (item.sf_name) acc[key].sf_count.add(item.sf_name);
                return acc;
            }, {});

            const sortedData = Object.values(data).sort((a, b) => b.total - a.total);
            const total = sortedData.reduce((sum, item) => sum + item.total, 0);

            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, sortedData.length);
            const pageData = sortedData.slice(startIndex, endIndex);

            document.getElementById('productSalesSummaryHeader').innerHTML = `
                <th onclick="sortTable('productSalesSummary', 0)">Product</th>
                <th onclick="sortTable('productSalesSummary', 1)">Product Type</th>
                <th onclick="sortTable('productSalesSummary', 2)" class="text-right">Total Sales</th>
                <th onclick="sortTable('productSalesSummary', 3)" class="text-right">Total Qty</th>
                <th onclick="sortTable('productSalesSummary', 4)" class="text-right"># of Months</th>
                <th onclick="sortTable('productSalesSummary', 5)" class="text-right"># of SFs</th>
            `;

            document.getElementById('productSalesSummaryBody').innerHTML = pageData.map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('product', '${item.product}')">${item.product}</td>
                    <td>${item.product_type || '-'}</td>
                    <td class="text-right">${formatNumber(item.total)}</td>
                    <td class="text-right">${formatNumber(item.qty)}</td>
                    <td class="text-right">${item.months.size}</td>
                    <td class="text-right">${item.sf_count.size}</td>
                </tr>
            `).join('');

            document.getElementById('productSalesSummaryFooter').innerHTML = `
                <td colspan="2"><strong>Total (${sortedData.length} products)</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td class="text-right"><strong>${formatNumber(sortedData.reduce((sum, i) => sum + i.qty, 0))}</strong></td>
                <td colspan="2"></td>
            `;

            document.getElementById('totalProducts').textContent = sortedData.length;
            document.getElementById('productRange').textContent = `${startIndex + 1}-${endIndex}`;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = endIndex >= sortedData.length;
        }

        function renderRegionalSalesTable() {
            const data = filteredData.reduce((acc, item) => {
                if (!item.state) return acc;
                if (!acc[item.state]) {
                    acc[item.state] = {
                        state: item.state,
                        total: 0,
                        qty: 0,
                        cities: new Set(),
                        sf_count: new Set()
                    };
                }
                acc[item.state].total += item.basic_value || 0;
                acc[item.state].qty += item.sale_qty || 0;
                if (item.city) acc[item.state].cities.add(item.city);
                if (item.sf_name) acc[item.state].sf_count.add(item.sf_name);
                return acc;
            }, {});

            const sortedData = Object.values(data).sort((a, b) => b.total - a.total);
            const total = sortedData.reduce((sum, item) => sum + item.total, 0);

            document.getElementById('regionalSalesHeader').innerHTML = `
                <th onclick="sortTable('regionalSales', 0)">State</th>
                <th onclick="sortTable('regionalSales', 1)" class="text-right">Total Sales</th>
                <th onclick="sortTable('regionalSales', 2)" class="text-right">Quantity</th>
                <th onclick="sortTable('regionalSales', 3)" class="text-right">Cities</th>
                <th onclick="sortTable('regionalSales', 4)" class="text-right">Sales Force</th>
                <th onclick="sortTable('regionalSales', 5)" class="text-right">% of Total</th>
            `;

            document.getElementById('regionalSalesBody').innerHTML = sortedData.map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('state', '${item.state}')">${item.state}</td>
                    <td class="text-right">${formatNumber(item.total)}</td>
                    <td class="text-right">${formatNumber(item.qty)}</td>
                    <td class="text-right">${item.cities.size}</td>
                    <td class="text-right">${item.sf_count.size}</td>
                    <td class="text-right ${getPercentageClass((item.total/total)*100)}">${formatPercentage((item.total/total)*100)}</td>
                </tr>
            `).join('');

            document.getElementById('regionalSalesFooter').innerHTML = `
                <td><strong>Total (${sortedData.length} states)</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td class="text-right"><strong>${formatNumber(sortedData.reduce((sum, i) => sum + i.qty, 0))}</strong></td>
                <td colspan="3"></td>
            `;

            document.getElementById('regionalSalesTotal').textContent = `Total: ${formatNumber(total)}`;
        }

        function renderCitySalesTable() {
            const data = filteredData.reduce((acc, item) => {
                if (!item.city) return acc;
                if (!acc[item.city]) {
                    acc[item.city] = {
                        city: item.city,
                        state: item.state,
                        total: 0,
                        qty: 0,
                        sf_count: new Set()
                    };
                }
                acc[item.city].total += item.basic_value || 0;
                acc[item.city].qty += item.sale_qty || 0;
                if (item.sf_name) acc[item.city].sf_count.add(item.sf_name);
                return acc;
            }, {});

            const sortedData = Object.values(data).sort((a, b) => b.total - a.total);
            const total = sortedData.reduce((sum, item) => sum + item.total, 0);

            document.getElementById('citySalesHeader').innerHTML = `
                <th onclick="sortTable('citySales', 0)">City</th>
                <th onclick="sortTable('citySales', 1)">State</th>
                <th onclick="sortTable('citySales', 2)" class="text-right">Total Sales</th>
                <th onclick="sortTable('citySales', 3)" class="text-right">Quantity</th>
                <th onclick="sortTable('citySales', 4)" class="text-right">Sales Force</th>
                <th onclick="sortTable('citySales', 5)" class="text-right">% of Total</th>
            `;

            document.getElementById('citySalesBody').innerHTML = sortedData.slice(0, 100).map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('city', '${item.city}')">${item.city}</td>
                    <td>${item.state || '-'}</td>
                    <td class="text-right">${formatNumber(item.total)}</td>
                    <td class="text-right">${formatNumber(item.qty)}</td>
                    <td class="text-right">${item.sf_count.size}</td>
                    <td class="text-right ${getPercentageClass((item.total/total)*100)}">${formatPercentage((item.total/total)*100)}</td>
                </tr>
            `).join('');

            document.getElementById('citySalesFooter').innerHTML = `
                <td colspan="2"><strong>Total (${sortedData.length} cities)</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td class="text-right"><strong>${formatNumber(sortedData.reduce((sum, i) => sum + i.qty, 0))}</strong></td>
                <td colspan="2"></td>
            `;

            document.getElementById('citySalesTotal').textContent = `Total: ${formatNumber(total)}`;
        }

        function renderMonthlyTrendsTable() {
            const data = filteredData.reduce((acc, item) => {
                if (!item.bill_date) return acc;
                const month = item.bill_date.substring(0, 7);
                if (!acc[month]) {
                    acc[month] = {
                        month: month,
                        total: 0,
                        qty: 0,
                        transactions: 0
                    };
                }
                acc[month].total += item.basic_value || 0;
                acc[month].qty += item.sale_qty || 0;
                acc[month].transactions++;
                return acc;
            }, {});

            const sortedData = Object.values(data).sort((a, b) => a.month.localeCompare(b.month));
            const total = sortedData.reduce((sum, item) => sum + item.total, 0);

            // Calculate growth
            let previousTotal = null;
            const dataWithGrowth = sortedData.map(item => {
                const growth = previousTotal !== null ? ((item.total - previousTotal) / previousTotal * 100) : 0;
                previousTotal = item.total;
                return { ...item, growth };
            });

            document.getElementById('monthlyTrendsHeader').innerHTML = `
                <th onclick="sortTable('monthlyTrends', 0)">Month</th>
                <th onclick="sortTable('monthlyTrends', 1)" class="text-right">Total Sales</th>
                <th onclick="sortTable('monthlyTrends', 2)" class="text-right">Quantity</th>
                <th onclick="sortTable('monthlyTrends', 3)" class="text-right">Transactions</th>
                <th onclick="sortTable('monthlyTrends', 4)" class="text-right">Growth %</th>
            `;

            document.getElementById('monthlyTrendsBody').innerHTML = dataWithGrowth.map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('month', '${item.month}')">${item.month}</td>
                    <td class="text-right">${formatNumber(item.total)}</td>
                    <td class="text-right">${formatNumber(item.qty)}</td>
                    <td class="text-right">${item.transactions}</td>
                    <td class="text-right ${getPercentageClass(item.growth)}">${formatPercentage(item.growth)}</td>
                </tr>
            `).join('');

            document.getElementById('monthlyTrendsFooter').innerHTML = `
                <td><strong>Total (${sortedData.length} months)</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td class="text-right"><strong>${formatNumber(sortedData.reduce((sum, i) => sum + i.qty, 0))}</strong></td>
                <td class="text-right"><strong>${sortedData.reduce((sum, i) => sum + i.transactions, 0)}</strong></td>
                <td></td>
            `;

            document.getElementById('monthlyTrendsTotal').textContent = `Total: ${formatNumber(total)}`;
        }

        function renderGrowthAnalysisTable() {
            const monthlyData = filteredData.reduce((acc, item) => {
                if (!item.bill_date) return acc;
                const month = item.bill_date.substring(0, 7);
                if (!acc[month]) {
                    acc[month] = { total: 0 };
                }
                acc[month].total += item.basic_value || 0;
                return acc;
            }, {});

            const months = Object.keys(monthlyData).sort();
            const data = [];
            
            for (let i = 1; i < months.length; i++) {
                const currentMonth = months[i];
                const previousMonth = months[i-1];
                const currentTotal = monthlyData[currentMonth];
                const previousTotal = monthlyData[previousMonth];
                
                const growth = ((currentTotal - previousTotal) / previousTotal * 100);
                
                data.push({
                    month: currentMonth,
                    previous_month: previousMonth,
                    current_total: currentTotal,
                    previous_total: previousTotal,
                    growth: growth,
                    absolute_growth: currentTotal - previousTotal
                });
            }

            const sortedData = data.sort((a, b) => b.growth - a.growth);

            document.getElementById('growthAnalysisHeader').innerHTML = `
                <th onclick="sortTable('growthAnalysis', 0)">Month</th>
                <th onclick="sortTable('growthAnalysis', 1)">Previous Month</th>
                <th onclick="sortTable('growthAnalysis', 2)" class="text-right">Current Sales</th>
                <th onclick="sortTable('growthAnalysis', 3)" class="text-right">Previous Sales</th>
                <th onclick="sortTable('growthAnalysis', 4)" class="text-right">Growth %</th>
                <th onclick="sortTable('growthAnalysis', 5)" class="text-right">Absolute Growth</th>
            `;

            document.getElementById('growthAnalysisBody').innerHTML = sortedData.slice(0, 50).map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('month', '${item.month}')">${item.month}</td>
                    <td>${item.previous_month}</td>
                    <td class="text-right">${formatNumber(item.current_total)}</td>
                    <td class="text-right">${formatNumber(item.previous_total)}</td>
                    <td class="text-right ${getPercentageClass(item.growth)}">${formatPercentage(item.growth)}</td>
                    <td class="text-right ${getPercentageClass(item.absolute_growth)}">${formatNumber(item.absolute_growth)}</td>
                </tr>
            `).join('');

            document.getElementById('growthAnalysisFooter').innerHTML = `
                <td colspan="6"><strong>Showing top 50 growth periods</strong></td>
            `;

            document.getElementById('growthAnalysisTotal').textContent = `Avg Growth: ${formatPercentage(sortedData.reduce((sum, i) => sum + i.growth, 0) / sortedData.length)}`;
        }

        function renderDailySalesTable() {
            const sortedData = [...filteredData].sort((a, b) => (b.basic_value || 0) - (a.basic_value || 0));
            const total = sortedData.reduce((sum, item) => sum + (item.basic_value || 0), 0);

            document.getElementById('dailySalesHeader').innerHTML = `
                <th onclick="sortTable('dailySales', 0)">Bill Date</th>
                <th onclick="sortTable('dailySales', 1)">Bill No</th>
                <th onclick="sortTable('dailySales', 2)">SF Name</th>
                <th onclick="sortTable('dailySales', 3)">Product</th>
                <th onclick="sortTable('dailySales', 4)">Batch No</th>
                <th onclick="sortTable('dailySales', 5)" class="text-right">Qty</th>
                <th onclick="sortTable('dailySales', 6)" class="text-right">Sales Value</th>
                <th onclick="sortTable('dailySales', 7)">Location</th>
            `;

            document.getElementById('dailySalesBody').innerHTML = sortedData.slice(0, 100).map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('date', '${item.bill_date}')">${item.bill_date || '-'}</td>
                    <td>${item.bill_no || '-'}</td>
                    <td class="clickable" onclick="applyDrilldown('sfName', '${item.sf_name}')">${item.sf_name || '-'}</td>
                    <td class="clickable" onclick="applyDrilldown('product', '${item.product_name}')">${item.product_name || '-'}</td>
                    <td>${item.batch_no || '-'}</td>
                    <td class="text-right">${formatNumber(item.sale_qty)}</td>
                    <td class="text-right">${formatNumber(item.basic_value)}</td>
                    <td class="clickable" onclick="applyDrilldown('location', '${item.location}')">${item.location || '-'}</td>
                </tr>
            `).join('');

            document.getElementById('dailySalesFooter').innerHTML = `
                <td colspan="5"><strong>Total (${sortedData.length} transactions)</strong></td>
                <td class="text-right"><strong>${formatNumber(sortedData.reduce((sum, i) => sum + (i.sale_qty || 0), 0))}</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td></td>
            `;

            document.getElementById('dailySalesTotal').textContent = `Total: ${formatNumber(total)}`;
        }

        function renderDailyLocationSalesTable() {
            const data = filteredData.reduce((acc, item) => {
                if (!item.location) return acc;
                if (!acc[item.location]) {
                    acc[item.location] = {
                        location: item.location,
                        total: 0,
                        qty: 0,
                        transactions: 0
                    };
                }
                acc[item.location].total += item.basic_value || 0;
                acc[item.location].qty += item.sale_qty || 0;
                acc[item.location].transactions++;
                return acc;
            }, {});

            const sortedData = Object.values(data).sort((a, b) => b.total - a.total);
            const total = sortedData.reduce((sum, item) => sum + item.total, 0);

            document.getElementById('dailyLocationSalesHeader').innerHTML = `
                <th onclick="sortTable('dailyLocationSales', 0)">Location</th>
                <th onclick="sortTable('dailyLocationSales', 1)" class="text-right">Total Sales</th>
                <th onclick="sortTable('dailyLocationSales', 2)" class="text-right">Total Qty</th>
                <th onclick="sortTable('dailyLocationSales', 3)" class="text-right"># of Transactions</th>
                <th onclick="sortTable('dailyLocationSales', 4)" class="text-right">Percentage</th>
            `;

            document.getElementById('dailyLocationSalesBody').innerHTML = sortedData.map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('location', '${item.location}')">${item.location}</td>
                    <td class="text-right">${formatNumber(item.total)}</td>
                    <td class="text-right">${formatNumber(item.qty)}</td>
                    <td class="text-right">${item.transactions}</td>
                    <td class="text-right ${getPercentageClass((item.total/total)*100)}">${formatPercentage((item.total/total)*100)}</td>
                </tr>
            `).join('');

            document.getElementById('dailyLocationSalesFooter').innerHTML = `
                <td><strong>Total (${sortedData.length} locations)</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td class="text-right"><strong>${formatNumber(sortedData.reduce((sum, i) => sum + i.qty, 0))}</strong></td>
                <td class="text-right"><strong>${sortedData.reduce((sum, i) => sum + i.transactions, 0)}</strong></td>
                <td class="text-right"><strong>100%</strong></td>
            `;

            document.getElementById('dailyLocationSalesTotal').textContent = `Total: ${formatNumber(total)}`;
        }

        function updateGrandTotal() {
            const grandTotal = filteredData.reduce((sum, item) => sum + (item.basic_value || 0), 0);
            document.getElementById('grandTotalValue').textContent = '‚Çπ ' + formatNumber(grandTotal);
        }

        function applyDrilldown(type, value) {
            switch(type) {
                case 'location':
                case 'state':
                case 'city':
                    document.getElementById('locationFilter').value = value;
                    break;
                case 'mktBy':
                    document.getElementById('mktByFilter').value = value;
                    break;
                case 'productType':
                    document.getElementById('productTypeFilter').value = value;
                    break;
                case 'sfName':
                case 'sfCode':
                    document.getElementById('globalSearch').value = value;
                    break;
                case 'product':
                    document.getElementById('globalSearch').value = value;
                    break;
                case 'month':
                case 'date':
                    if (value && value.length >= 7) {
                        const yearMonth = value.substring(0, 7);
                        document.getElementById('dateFrom').value = yearMonth;
                        document.getElementById('dateTo').value = yearMonth;
                    }
                    break;
            }
            applyFilters();
        }

        // ==================== EXPOSE ALL FUNCTIONS TO WINDOW ====================
        window.testDirectConnection = testDirectConnection;
        window.testSelectedProxy = testSelectedProxy;
        window.findWorkingProxy = findWorkingProxy;
        window.connectWithProxy = connectWithProxy;
        window.useWorkingProxy = useWorkingProxy;
        window.refreshData = refreshData;
        window.saveConfig = saveConfig;
        window.loadSavedConfig = loadSavedConfig;
        window.onServerChange = onServerChange;
        window.applyFilters = applyFilters;
        window.sortTable = sortTable;
        window.prevPage = prevPage;
        window.nextPage = nextPage;
        window.resetFilters = resetFilters;
        window.clearAllFilters = clearAllFilters;
        window.removeFilter = removeFilter;
        window.applyDrilldown = applyDrilldown;
        window.requestCorsAnywhereAccess = requestCorsAnywhereAccess;
    </script>
</body>
</html>
