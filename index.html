<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Dash Board ¬∑ Search inside filters ¬∑ Prominent X ¬∑ Tab Export</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif; }
        body { background:#eef2f5; padding:10px; }
        .dashboard { max-width:1300px; margin:0 auto; background:white; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.1); overflow:hidden; }

        .main-header { background:#0b2b4a; color:white; padding:12px 18px; font-size:20px; font-weight:600; display:flex; justify-content:space-between; align-items:center; }
        .main-header small { background:#2a4c73; padding:2px 10px; border-radius:30px; font-size:11px; margin-left:10px; }
        .weather { display:flex; gap:20px; font-size:12px; color:#ffd966; align-items:center; }

        .tabs { display:flex; background:#f0f4f8; border-bottom:2px solid #cbd5e1; flex-wrap:wrap; }
        .tab-btn { padding:8px 16px; font-size:12px; font-weight:500; background:transparent; border:none; border-right:1px solid #cbd5e1; color:#1e3a5f; cursor:pointer; }
        .tab-btn.active { background:#0b2b4a; color:white; }

        .filter-bar { background:#f9fcff; padding:10px 14px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; border-bottom:2px solid #cbd5e1; font-size:12px; }
        .filter-group { display:flex; align-items:center; gap:4px; }
        .filter-group label { font-weight:600; color:#0b2b4a; min-width:40px; font-size:11px; }
        
        /* Enhanced multi-select with search */
        .multi-select-container { position:relative; display:inline-block; }
        .multi-select-box { 
            border:1px solid #9aa9b9; 
            border-radius:4px; 
            background:white; 
            min-width:160px; 
            max-width:180px;
            cursor:pointer;
            padding:4px 20px 4px 6px;
            font-size:11px;
            white-space:nowrap;
            overflow:hidden;
            text-overflow:ellipsis;
            background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12"><path d="M2 4 L6 8 L10 4" stroke="%23333" fill="none"/></svg>');
            background-repeat:no-repeat;
            background-position:right 4px center;
        }
        .multi-select-dropdown {
            display:none;
            position:absolute;
            top:100%;
            left:0;
            right:0;
            background:white;
            border:1px solid #9aa9b9;
            border-radius:4px;
            max-height:200px;
            overflow-y:auto;
            z-index:1000;
            box-shadow:0 2px 8px rgba(0,0,0,0.2);
        }
        .multi-select-dropdown.show { display:block; }
        .multi-select-search {
            width:100%;
            padding:6px;
            border:none;
            border-bottom:1px solid #ddd;
            font-size:11px;
            outline:none;
        }
        .multi-select-option {
            padding:5px 8px;
            cursor:pointer;
            font-size:11px;
        }
        .multi-select-option:hover { background:#f0f0f0; }
        .multi-select-option.selected { background:#e3f2fd; font-weight:500; }
        
        .filter-group input[type="month"] { padding:4px 6px; border:1px solid #9aa9b9; border-radius:4px; font-size:11px; width:120px; }
        
        .search-wrapper { display:flex; border:1px solid #9aa9b9; border-radius:4px; overflow:hidden; background:white; margin-left:5px; }
        .search-wrapper input { border:none; padding:5px 8px; width:160px; outline:none; font-size:11px; }
        .search-wrapper button { background:#0b2b4a; color:white; border:none; padding:5px 12px; cursor:pointer; font-size:11px; font-weight:500; }
        
        .action-btn { padding:4px 12px; border:none; border-radius:4px; font-weight:500; cursor:pointer; font-size:11px; }
        .refresh-btn { background:#0b2b4a; color:white; display:flex; align-items:center; gap:3px; }
        .reset-btn { background:#d6562b; color:white; }
        .export-btn { background:#2e7d32; color:white; display:flex; align-items:center; gap:3px; }

        /* Prominent X button */
        .active-filters-bar { background:#fff6d9; padding:8px 14px; display:none; flex-wrap:wrap; gap:8px; align-items:center; border-bottom:2px solid #ffe28c; font-size:12px; }
        .filter-tag { background:#ffd966; padding:4px 10px; border-radius:30px; font-size:11px; font-weight:600; display:inline-flex; align-items:center; gap:6px; }
        .filter-tag button { 
            background:#b45f06; 
            color:white; 
            border:none; 
            border-radius:50%; 
            width:20px; 
            height:20px; 
            font-size:13px; 
            font-weight:bold; 
            cursor:pointer; 
            display:inline-flex; 
            align-items:center; 
            justify-content:center;
            line-height:1;
            padding:0;
        }
        .filter-tag button:hover { background:#8b4b04; }

        .content { padding:14px; }
        .tab-pane { display:none; }
        .tab-pane.active { display:block; }

        .section-title { font-size:15px; font-weight:700; color:#0b2b4a; margin:15px 0 8px; border-bottom:2px solid #d0ddeb; padding-bottom:4px; display:flex; justify-content:space-between; align-items:center; }
        .total-badge { font-size:11px; background:#e6f0ff; padding:2px 8px; border-radius:20px; }

        .table-wrapper { border:1px solid #b7c1cf; border-radius:5px; overflow:auto; max-height:350px; margin-bottom:18px; }
        table { width:100%; border-collapse:collapse; font-size:11px; min-width:600px; }
        thead th { background:#1f4172; color:white; padding:6px 4px; border:1px solid #102a4a; position:sticky; top:0; white-space:nowrap; cursor:pointer; user-select:none; }
        thead th.sort-asc::after { content:" ‚Üë"; margin-left:2px; color:#ffd966; font-weight:bold; }
        thead th.sort-desc::after { content:" ‚Üì"; margin-left:2px; color:#ffd966; font-weight:bold; }
        tbody td { padding:4px 4px; border:1px solid #b7c1cf; white-space:nowrap; }
        tbody tr:hover { background:#f2f8ff; }
        tfoot td { background:#d6562b; color:white; font-weight:600; padding:4px; border:1px solid #b7c1cf; position:sticky; bottom:0; }
        .clickable { cursor:pointer; transition:0.1s; }
        .clickable:hover { background:#ffe8c7 !important; font-weight:500; }
        .text-right { text-align:right; }

        .pagination { display:flex; gap:8px; align-items:center; }
        .grand-footer { background:#0b2b4a; color:white; padding:10px 18px; display:flex; justify-content:space-between; font-weight:600; font-size:13px; }
        .dashboard-footer { background:#0b2b4a; color:white; padding:8px 18px; display:flex; justify-content:space-between; font-size:11px; border-top:2px solid #1f4a7a; }
    </style>
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- FileSaver.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>
<div class="dashboard">
    <div class="main-header">
        <span>Business Dash Board <small id="cacheBadge" style="display:none;">üì¶ cached</small></span>
        <div class="weather"><span>24¬∞C Sunny</span><span class="last-update" id="lastUpdate">LAST UPDATE: --</span></div>
    </div>

    <div class="tabs" id="tabContainer"></div>

    <!-- FILTERS with search inside each multi-select -->
    <div class="filter-bar">
        <div class="filter-group">
            <label>Location</label>
            <div class="multi-select-container" id="locationContainer">
                <div class="multi-select-box" onclick="toggleDropdown('location')">All Locations</div>
                <div class="multi-select-dropdown" id="locationDropdown">
                    <input type="text" class="multi-select-search" placeholder="Search..." onkeyup="filterDropdown('location', this.value)">
                    <div class="multi-select-options" id="locationOptions"></div>
                </div>
            </div>
        </div>
        
        <div class="filter-group">
            <label>Mkt By</label>
            <div class="multi-select-container" id="mktByContainer">
                <div class="multi-select-box" onclick="toggleDropdown('mktBy')">All</div>
                <div class="multi-select-dropdown" id="mktByDropdown">
                    <input type="text" class="multi-select-search" placeholder="Search..." onkeyup="filterDropdown('mktBy', this.value)">
                    <div class="multi-select-options" id="mktByOptions"></div>
                </div>
            </div>
        </div>
        
        <div class="filter-group">
            <label>Product Type</label>
            <div class="multi-select-container" id="productTypeContainer">
                <div class="multi-select-box" onclick="toggleDropdown('productType')">All Types</div>
                <div class="multi-select-dropdown" id="productTypeDropdown">
                    <input type="text" class="multi-select-search" placeholder="Search..." onkeyup="filterDropdown('productType', this.value)">
                    <div class="multi-select-options" id="productTypeOptions"></div>
                </div>
            </div>
        </div>
        
        <div class="filter-group"><label>From</label><input type="month" id="dateFrom" onchange="filterChanged()" placeholder="YYYY-MM"></div>
        <div class="filter-group"><label>To</label><input type="month" id="dateTo" onchange="filterChanged()" placeholder="YYYY-MM"></div>
        
        <!-- Global search box -->
        <div class="search-wrapper">
            <input type="text" id="globalSearch" placeholder="Search product, SF, code..." onkeyup="filterChanged()">
            <button onclick="filterChanged()">üîç</button>
        </div>
        
        <button class="action-btn refresh-btn" onclick="refreshData()"><span>üîÑ</span> Refresh</button>
        <button class="action-btn reset-btn" onclick="clearAllFilters()">Reset</button>
        <button class="action-btn export-btn" onclick="exportCurrentTab()"><span>üì•</span> Export Tab</button>
    </div>
    
    <div class="active-filters-bar" id="activeFiltersBar">
        <span style="font-weight:600;">Active:</span>
        <span id="activeFilters"></span>
        <button onclick="clearAllFilters()" style="margin-left:auto; background:none; border:none; color:#856404; font-size:11px; font-weight:bold;">‚úï CLEAR ALL</button>
    </div>

    <div id="loading" class="loading" style="display:none; text-align:center; padding:40px;">‚¨áÔ∏è Loading ...</div>
    <div id="error" style="display:none; background:#ffebee; padding:30px; text-align:center;"></div>

    <div class="content" id="tabPanes"></div>

    <div class="grand-footer"><span>Overall Grand Total (filtered)</span><span id="grandTotalValue">0</span></div>
    <div class="dashboard-footer"><span>üèÖ 29¬∞C ¬∑ today's updates</span><span id="footerWeather">ENG | IN</span></div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
    // Firebase config
    const firebaseConfig = {
        apiKey: "AIzaSyBzZtL5I4UoQ3v7R2xX9wL8mN4kP6rS2tY",
        authDomain: "salesdata-30dcb.firebaseapp.com",
        projectId: "salesdata-30dcb",
        storageBucket: "salesdata-30dcb.appspot.com",
        messagingSenderId: "109295402367",
        appId: "1:109295402367:web:8f7d6e5c4b3a2f1e0d9c8b"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ---------- GLOBALS ----------
    let allData = [];
    let filteredData = [];
    let uniqueValues = { locations: [], mktBy: [], productTypes: [] };
    let selectedFilters = { locations: [], mktBy: [], productTypes: [] };
    let globalLastUpdate = '';
    let availableYears = [];

    // Dropdown state
    let activeDropdown = null;

    // Sorting state
    let sortState = {
        fy: { col: 0, dir: 'asc' },
        cat: { col: 1, dir: 'desc' },
        dosage: { col: 1, dir: 'desc' },
        mktSimple: { col: 1, dir: 'desc' },
        sfWise: { col: 4, dir: 'desc' },
        sfCode: { col: 4, dir: 'desc' },
        prodDetail: { col: 3, dir: 'desc' },
        prodSummary: { col: 2, dir: 'desc' },
        dpr: { col: 0, dir: 'desc' },
        locDispatch: { col: 3, dir: 'desc' }
    };

    // Pagination
    let currentPage = 1;
    const pageSize = 50;

    // Tabs
    const tabs = [
        { id: 'salesBoard', name: 'SALE DASH BOARD' },
        { id: 'mktSf', name: 'Mkt By & SF' },
        { id: 'sfBrand', name: 'SF & Brand' },
        { id: 'prodMonth', name: 'Product Month Wise' },
        { id: 'dispatch', name: 'Daily Dispatch (DPR)' }
    ];

    // ---------- DROPDOWN FUNCTIONS ----------
    window.toggleDropdown = function(type) {
        const dropdown = document.getElementById(type + 'Dropdown');
        if (activeDropdown && activeDropdown !== dropdown) {
            activeDropdown.classList.remove('show');
        }
        dropdown.classList.toggle('show');
        activeDropdown = dropdown.classList.contains('show') ? dropdown : null;
        
        // Focus search input
        setTimeout(() => {
            const searchInput = dropdown.querySelector('.multi-select-search');
            if (searchInput) searchInput.focus();
        }, 100);
    };

    window.filterDropdown = function(type, searchText) {
        const optionsDiv = document.getElementById(type + 'Options');
        const values = uniqueValues[type === 'location' ? 'locations' : (type === 'mktBy' ? 'mktBy' : 'productTypes')];
        const selected = selectedFilters[type === 'location' ? 'locations' : (type === 'mktBy' ? 'mktBy' : 'productTypes')];
        
        const filtered = values.filter(v => v.toLowerCase().includes(searchText.toLowerCase()));
        
        optionsDiv.innerHTML = filtered.map(v => `
            <div class="multi-select-option ${selected.includes(v) ? 'selected' : ''}" 
                 onclick="toggleOption('${type}', '${v}'); event.stopPropagation();">
                ${v} ${selected.includes(v) ? '‚úì' : ''}
            </div>
        `).join('');
    };

    window.toggleOption = function(type, value) {
        const filterType = type === 'location' ? 'locations' : (type === 'mktBy' ? 'mktBy' : 'productTypes');
        const index = selectedFilters[filterType].indexOf(value);
        if (index === -1) {
            selectedFilters[filterType].push(value);
        } else {
            selectedFilters[filterType].splice(index, 1);
        }
        
        // Update box text
        const box = document.querySelector(`#${type}Container .multi-select-box`);
        if (selectedFilters[filterType].length === 0) {
            box.textContent = type === 'location' ? 'All Locations' : (type === 'mktBy' ? 'All' : 'All Types');
        } else if (selectedFilters[filterType].length <= 2) {
            box.textContent = selectedFilters[filterType].join(', ');
        } else {
            box.textContent = `${selectedFilters[filterType].length} selected`;
        }
        
        // Update options highlighting
        filterDropdown(type, document.querySelector(`#${type}Dropdown .multi-select-search`).value);
        
        filterChanged();
    };

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.multi-select-container') && activeDropdown) {
            activeDropdown.classList.remove('show');
            activeDropdown = null;
        }
    });

    // ---------- INIT ----------
    window.onload = function() {
        createTabs();
        createPanes();
        loadData();
    };

    function createTabs() {
        const container = document.getElementById('tabContainer');
        container.innerHTML = '';
        tabs.forEach((tab, i) => {
            const btn = document.createElement('button');
            btn.className = `tab-btn ${i === 0 ? 'active' : ''}`;
            btn.dataset.tab = tab.id;
            btn.textContent = tab.name;
            btn.onclick = switchTab;
            container.appendChild(btn);
        });
    }

    function createPanes() {
        const panes = document.getElementById('tabPanes');
        panes.innerHTML = '';
        tabs.forEach(tab => {
            const pane = document.createElement('div');
            pane.className = 'tab-pane';
            pane.id = `pane-${tab.id}`;
            panes.appendChild(pane);
        });
        document.getElementById('pane-salesBoard').classList.add('active');
    }

    function buildPaneContentsWithYears(years) {
        const sortedYears = years.sort((a,b) => b - a);
        const yearHeaders = sortedYears.map(y => `<th onclick="sortTable('fy',${sortedYears.indexOf(y)+1})">${y}</th>`).join('');
        
        document.getElementById('pane-salesBoard').innerHTML = `
            <div class="section-title">Financial Year / Basic_Value <span class="total-badge" id="fyTotal"></span></div>
            <div class="table-wrapper"><table id="fyTable"><thead><tr><th onclick="sortTable('fy',0)">Mkt_By</th>${yearHeaders}<th onclick="sortTable('fy',${sortedYears.length+1})">Grand total</th></tr></thead><tbody id="fyBody"></tbody><tfoot id="fyFoot"></tfoot></table></div>
            <div class="section-title">Product Type <span class="total-badge" id="catTotal"></span></div>
            <div class="table-wrapper"><table id="catTable"><thead><tr><th onclick="sortTable('cat',0)">Product_Type</th><th onclick="sortTable('cat',1)">Basic_Value</th><th onclick="sortTable('cat',2)">%</th></tr></thead><tbody id="catBody"></tbody><tfoot id="catFoot"></tfoot></table></div>
            <div class="section-title">Dosage_Form / Sale Qty <span class="total-badge" id="dosageTotal"></span></div>
            <div class="table-wrapper"><table id="dosageTable"><thead><tr><th onclick="sortTable('dosage',0)">Dosage_Form</th><th onclick="sortTable('dosage',1)">Sale Qty</th><th onclick="sortTable('dosage',2)">%</th></tr></thead><tbody id="dosageBody"></tbody><tfoot id="dosageFoot"></tfoot></table></div>
        `;
        
        document.getElementById('pane-mktSf').innerHTML = `
            <div class="section-title">Mkt_By / Basic_Value & %</div>
            <div class="table-wrapper"><table id="mktByTable"><thead><tr><th onclick="sortTable('mktSimple',0)">Mkt_By</th><th onclick="sortTable('mktSimple',1)">Basic_Value</th><th onclick="sortTable('mktSimple',2)">%</th></tr></thead><tbody id="mktByBody"></tbody><tfoot id="mktByFoot"></tfoot></table></div>
            <div class="section-title">SF_Name / Sale_Qty / Basic_Value / %</div>
            <div class="table-wrapper"><table id="sfWiseTable"><thead><tr><th onclick="sortTable('sfWise',0)">SF_Name</th><th onclick="sortTable('sfWise',1)">Product_Name</th><th onclick="sortTable('sfWise',2)">Mkt_By</th><th onclick="sortTable('sfWise',3)">Sale_Qty</th><th onclick="sortTable('sfWise',4)">Basic_Value</th><th onclick="sortTable('sfWise',5)">%</th></tr></thead><tbody id="sfWiseBody"></tbody><tfoot id="sfWiseFoot"></tfoot></table></div>
        `;
        
        document.getElementById('pane-sfBrand').innerHTML = `
            <div class="section-title">SF Code / SF Name / Product / Sale Qty / Basic Value</div>
            <div class="table-wrapper"><table id="sfCodeTable"><thead><tr><th onclick="sortTable('sfCode',0)">SF_Code</th><th onclick="sortTable('sfCode',1)">SF_Name</th><th onclick="sortTable('sfCode',2)">Product</th><th onclick="sortTable('sfCode',3)">Sale_Qty</th><th onclick="sortTable('sfCode',4)">Basic_Value</th><th onclick="sortTable('sfCode',5)">%</th></tr></thead><tbody id="sfCodeBody"></tbody><tfoot id="sfCodeFoot"></tfoot></table></div>
        `;
        
        document.getElementById('pane-prodMonth').innerHTML = `
            <div class="section-title">Product Month Wise (detailed)</div>
            <div class="table-wrapper"><table id="prodMonthDetail"><thead><tr><th onclick="sortTable('prodDetail',0)">Product</th><th onclick="sortTable('prodDetail',1)">Month</th><th onclick="sortTable('prodDetail',2)">Sale Qty</th><th onclick="sortTable('prodDetail',3)">Basic Value</th></tr></thead><tbody id="prodMonthDetailBody"></tbody><tfoot id="prodMonthDetailFoot"></tfoot></table></div>
            <div class="section-title">Product Summary <span class="pagination"><span id="prodRange"></span> <button id="prevBtn" onclick="prevPage()">‚Üê</button><button id="nextBtn" onclick="nextPage()">‚Üí</button></span></div>
            <div class="table-wrapper"><table id="prodSummary"><thead><tr><th onclick="sortTable('prodSummary',0)">Product Name</th><th onclick="sortTable('prodSummary',1)">Sale Qty</th><th onclick="sortTable('prodSummary',2)">Basic Value</th><th onclick="sortTable('prodSummary',3)">%</th></tr></thead><tbody id="prodSummaryBody"></tbody><tfoot id="prodSummaryFoot"></tfoot></table></div>
        `;
        
        document.getElementById('pane-dispatch').innerHTML = `
            <div class="section-title">Daily Dispatch Details (DPR)</div>
            <div class="table-wrapper"><table id="dprTable"><thead><tr><th onclick="sortTable('dpr',0)">Bill_Date</th><th onclick="sortTable('dpr',1)">Bill_No</th><th onclick="sortTable('dpr',2)">Location</th><th onclick="sortTable('dpr',3)">Mkt_By</th><th onclick="sortTable('dpr',4)">Product</th><th onclick="sortTable('dpr',5)">Batch_No</th><th onclick="sortTable('dpr',6)">SF_Name</th><th onclick="sortTable('dpr',7)">Sale_Qty</th><th onclick="sortTable('dpr',8)">Basic_Value</th></tr></thead><tbody id="dprBody"></tbody><tfoot id="dprFoot"></tfoot></table></div>
            <div class="section-title">Dispatch by Location</div>
            <div class="table-wrapper"><table id="locDispatchTable"><thead><tr><th onclick="sortTable('locDispatch',0)">Location</th><th onclick="sortTable('locDispatch',1)">Dispatches</th><th onclick="sortTable('locDispatch',2)">Total Qty</th><th onclick="sortTable('locDispatch',3)">Total Value</th><th onclick="sortTable('locDispatch',4)">%</th></tr></thead><tbody id="locDispatchBody"></tbody><tfoot id="locDispatchFoot"></tfoot></table></div>
        `;
    }

    function switchTab(e) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
        document.getElementById(`pane-${e.target.dataset.tab}`).classList.add('active');
    }

    // ---------- DATA LOAD ----------
    async function loadData() {
        document.getElementById('loading').style.display = 'block';
        try {
            const snapshot = await db.collection('sales_data').get();
            if (snapshot.empty) throw new Error('No data');
            allData = [];
            const locSet = new Set(), mktSet = new Set(), typeSet = new Set();
            const yearSet = new Set();

            snapshot.forEach(doc => {
                const d = doc.data();
                if (d.update_datetime && !d.product_name) globalLastUpdate = d.update_datetime;
                const rec = {
                    mkt_by: d.mkt_by || d.Mkt_By || '',
                    location: d.location || d.Location || '',
                    basic_value: parseFloat(d.basic_value || d.Basic_Value || 0),
                    percentage: parseFloat(d.percentage || 0),
                    difference: parseFloat(d.difference || 0),
                    sf_code: d.sf_code || d.SF_Code || '',
                    sf_name: d.sf_name || d.SF_Name || '',
                    product_name: d.product_name || d.Product_Name || '',
                    product_type: d.product_type || d.Product_Type || '',
                    sale_qty: parseFloat(d.sale_qty || d.Sale_Qty || 0),
                    bill_date: d.bill_date || d.Bill_Date || '',
                    bill_no: d.bill_no || d.Bill_No || '',
                    batch_no: d.batch_no || d.Batch_No || '',
                    dosage_form: d.dosage_form || d.Dosage_Form || ''
                };
                
                if (rec.bill_date && rec.bill_date.length >= 4) {
                    const year = rec.bill_date.substring(0, 4);
                    if (year.match(/^\d{4}$/)) yearSet.add(parseInt(year));
                }
                
                if (rec.basic_value > 0 || rec.sale_qty > 0) {
                    allData.push(rec);
                    if (rec.location) locSet.add(rec.location);
                    if (rec.mkt_by) mktSet.add(rec.mkt_by);
                    if (rec.product_type) typeSet.add(rec.product_type);
                }
            });

            uniqueValues.locations = Array.from(locSet).sort();
            uniqueValues.mktBy = Array.from(mktSet).sort();
            uniqueValues.productTypes = Array.from(typeSet).sort();
            
            availableYears = Array.from(yearSet).sort((a,b) => b - a);
            if (availableYears.length === 0) availableYears = [2024, 2025, 2026];
            
            buildPaneContentsWithYears(availableYears);
            populateDropdowns();
            
            filteredData = [...allData];
            document.getElementById('loading').style.display = 'none';
            document.getElementById('lastUpdate').textContent = globalLastUpdate ? `LAST UPDATE: ${globalLastUpdate}` : 'LAST UPDATE: 27/02/2026 09:20:45';
            
            filterChanged();
        } catch (err) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').innerHTML = 'Error: ' + err.message;
        }
    }

    function populateDropdowns() {
        // Location options
        const locOptions = document.getElementById('locationOptions');
        locOptions.innerHTML = uniqueValues.locations.map(v => 
            `<div class="multi-select-option" onclick="toggleOption('location', '${v}'); event.stopPropagation();">${v}</div>`
        ).join('');
        
        // MktBy options
        const mktOptions = document.getElementById('mktByOptions');
        mktOptions.innerHTML = uniqueValues.mktBy.map(v => 
            `<div class="multi-select-option" onclick="toggleOption('mktBy', '${v}'); event.stopPropagation();">${v}</div>`
        ).join('');
        
        // Product Type options
        const typeOptions = document.getElementById('productTypeOptions');
        typeOptions.innerHTML = uniqueValues.productTypes.map(v => 
            `<div class="multi-select-option" onclick="toggleOption('productType', '${v}'); event.stopPropagation();">${v}</div>`
        ).join('');
    }

    // ---------- FILTER ----------
    window.filterChanged = function() {
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        const search = document.getElementById('globalSearch').value.toLowerCase();

        filteredData = allData.filter(item => {
            if (selectedFilters.locations.length && !selectedFilters.locations.includes(item.location)) return false;
            if (selectedFilters.mktBy.length && !selectedFilters.mktBy.includes(item.mkt_by)) return false;
            if (selectedFilters.productTypes.length && !selectedFilters.productTypes.includes(item.product_type)) return false;
            if (dateFrom && item.bill_date && item.bill_date.substring(0,7) < dateFrom) return false;
            if (dateTo && item.bill_date && item.bill_date.substring(0,7) > dateTo) return false;
            if (search) {
                return (item.product_name && item.product_name.toLowerCase().includes(search)) ||
                       (item.sf_name && item.sf_name.toLowerCase().includes(search)) ||
                       (item.sf_code && item.sf_code.toLowerCase().includes(search)) ||
                       (item.batch_no && item.batch_no.toLowerCase().includes(search));
            }
            return true;
        });

        currentPage = 1;
        renderAllTables();
        updateActiveFilters();
    };

    function updateActiveFilters() {
        const tags = [];
        if (selectedFilters.locations.length) tags.push(`Location: ${selectedFilters.locations.join(', ')}`);
        if (selectedFilters.mktBy.length) tags.push(`Mkt: ${selectedFilters.mktBy.join(', ')}`);
        if (selectedFilters.productTypes.length) tags.push(`Type: ${selectedFilters.productTypes.join(', ')}`);
        if (document.getElementById('dateFrom').value) tags.push(`From: ${document.getElementById('dateFrom').value}`);
        if (document.getElementById('dateTo').value) tags.push(`To: ${document.getElementById('dateTo').value}`);
        if (document.getElementById('globalSearch').value) tags.push(`Search: ${document.getElementById('globalSearch').value}`);

        const bar = document.getElementById('activeFiltersBar');
        const container = document.getElementById('activeFilters');
        
        if (tags.length) {
            bar.style.display = 'flex';
            container.innerHTML = tags.map(t => 
                `<span class="filter-tag">${t} <button onclick="removeFilterTag('${t.split(':')[0].trim()}')">‚úï</button></span>`
            ).join(' ');
        } else {
            bar.style.display = 'none';
        }
    }

    window.removeFilterTag = function(type) {
        if (type === 'Location') {
            selectedFilters.locations = [];
            document.querySelector('#locationContainer .multi-select-box').textContent = 'All Locations';
        } else if (type === 'Mkt') {
            selectedFilters.mktBy = [];
            document.querySelector('#mktByContainer .multi-select-box').textContent = 'All';
        } else if (type === 'Type') {
            selectedFilters.productTypes = [];
            document.querySelector('#productTypeContainer .multi-select-box').textContent = 'All Types';
        } else if (type === 'From') {
            document.getElementById('dateFrom').value = '';
        } else if (type === 'To') {
            document.getElementById('dateTo').value = '';
        } else if (type === 'Search') {
            document.getElementById('globalSearch').value = '';
        }
        filterChanged();
    };

    window.clearAllFilters = function() {
        selectedFilters.locations = [];
        selectedFilters.mktBy = [];
        selectedFilters.productTypes = [];
        document.querySelector('#locationContainer .multi-select-box').textContent = 'All Locations';
        document.querySelector('#mktByContainer .multi-select-box').textContent = 'All';
        document.querySelector('#productTypeContainer .multi-select-box').textContent = 'All Types';
        document.getElementById('dateFrom').value = '';
        document.getElementById('dateTo').value = '';
        document.getElementById('globalSearch').value = '';
        filterChanged();
    };

    // Drilldown
    window.drilldown = function(type, value) {
        if (type === 'mktBy') {
            selectedFilters.mktBy = [value];
            document.querySelector('#mktByContainer .multi-select-box').textContent = value;
        } else if (type === 'location') {
            selectedFilters.locations = [value];
            document.querySelector('#locationContainer .multi-select-box').textContent = value;
        } else if (type === 'productType') {
            selectedFilters.productTypes = [value];
            document.querySelector('#productTypeContainer .multi-select-box').textContent = value;
        } else if (type === 'sfName' || type === 'product') {
            document.getElementById('globalSearch').value = value;
        } else if (type === 'month') {
            document.getElementById('dateFrom').value = value;
            document.getElementById('dateTo').value = value;
        }
        filterChanged();
    };

    // Sorting
    window.sortTable = function(tableId, colIndex) {
        if (!sortState[tableId]) sortState[tableId] = { col: colIndex, dir: 'asc' };
        let state = sortState[tableId];
        if (state.col === colIndex) {
            state.dir = state.dir === 'asc' ? 'desc' : 'asc';
        } else {
            state.col = colIndex;
            state.dir = 'asc';
        }
        document.querySelectorAll(`#${tableId} thead th`).forEach((th, idx) => {
            th.classList.remove('sort-asc', 'sort-desc');
            if (idx === state.col) th.classList.add(`sort-${state.dir}`);
        });
        renderAllTables();
    };

    // Pagination
    window.prevPage = function() { if (currentPage > 1) { currentPage--; renderProdSummary(); } };
    window.nextPage = function() { currentPage++; renderProdSummary(); };
    window.refreshData = function() { loadData(); };

    // ---------- RENDER ALL TABLES ----------
    function renderAllTables() {
        renderFyBoard();
        renderCategory();
        renderDosageForm();
        renderMktBySimple();
        renderSfWise();
        renderSfCode();
        renderProdMonthDetail();
        renderProdSummary();
        renderDpr();
        renderLocDispatch();
        updateGrandTotal();
    }

    function formatNumber(num) { return (num || 0).toLocaleString('en-IN', { maximumFractionDigits: 2, minimumFractionDigits: 2 }); }
    function formatPercentage(num) { return (num || 0).toFixed(2) + '%'; }

    function renderFyBoard() {
        let map = new Map();
        filteredData.forEach(r => {
            if (!r.mkt_by || !r.bill_date) return;
            const year = r.bill_date.substring(0, 4);
            if (!year.match(/^\d{4}$/)) return;
            
            if (!map.has(r.mkt_by)) map.set(r.mkt_by, new Map());
            const yearMap = map.get(r.mkt_by);
            yearMap.set(year, (yearMap.get(year) || 0) + r.basic_value);
        });

        let rows = [];
        const years = availableYears;
        
        for (let [mkt, yearMap] of map.entries()) {
            let row = { mkt };
            let total = 0;
            years.forEach(y => {
                row[y] = yearMap.get(y.toString()) || 0;
                total += row[y];
            });
            row.total = total;
            rows.push(row);
        }

        const state = sortState.fy || { col: 0, dir: 'asc' };
        rows.sort((a, b) => {
            let fieldA, fieldB;
            if (state.col === 0) {
                fieldA = a.mkt;
                fieldB = b.mkt;
            } else if (state.col <= years.length) {
                const year = years[state.col - 1];
                fieldA = a[year] || 0;
                fieldB = b[year] || 0;
            } else {
                fieldA = a.total;
                fieldB = b.total;
            }
            
            if (typeof fieldA === 'string') {
                return state.dir === 'asc' ? fieldA.localeCompare(fieldB) : fieldB.localeCompare(fieldA);
            } else {
                return state.dir === 'asc' ? fieldA - fieldB : fieldB - fieldA;
            }
        });

        let yearTotals = {};
        years.forEach(y => yearTotals[y] = 0);
        let grandTotal = 0;
        
        let tbody = '';
        rows.forEach(row => {
            tbody += '<tr>';
            tbody += `<td class="clickable" onclick="drilldown('mktBy','${row.mkt}')">${row.mkt}</td>`;
            years.forEach(y => {
                const val = row[y] || 0;
                yearTotals[y] += val;
                grandTotal += val;
                tbody += `<td class="text-right clickable" onclick="drilldown('mktBy','${row.mkt}')">${formatNumber(val)}</td>`;
            });
            tbody += `<td class="text-right clickable" onclick="drilldown('mktBy','${row.mkt}')">${formatNumber(row.total)}</td>`;
            tbody += '</tr>';
        });

        document.getElementById('fyBody').innerHTML = tbody;
        
        let footer = '<tr><td>Grand total</td>';
        years.forEach(y => footer += `<td class="text-right">${formatNumber(yearTotals[y])}</td>`);
        footer += `<td class="text-right">${formatNumber(grandTotal)}</td></tr>`;
        document.getElementById('fyFoot').innerHTML = footer;
        document.getElementById('fyTotal').textContent = `Total: ${formatNumber(grandTotal)}`;
    }

    function renderCategory() {
        let map = new Map();
        filteredData.forEach(r => { if (r.product_type) map.set(r.product_type, (map.get(r.product_type)||0) + r.basic_value); });
        let total = Array.from(map.values()).reduce((a,b)=>a+b,0);
        let arr = Array.from(map.entries()).map(([type,val])=>({type,val}));
        let state = sortState.cat || {col:1, dir:'desc'};
        arr.sort((a,b) => {
            if (state.col===0) return state.dir==='asc' ? a.type.localeCompare(b.type) : b.type.localeCompare(a.type);
            else return state.dir==='asc' ? a.val - b.val : b.val - a.val;
        });
        let rows = arr.map(i => `<tr><td class="clickable" onclick="drilldown('productType','${i.type}')">${i.type}</td><td class="text-right clickable" onclick="drilldown('productType','${i.type}')">${formatNumber(i.val)}</td><td class="text-right">${formatPercentage(i.val/total*100)}</td></tr>`).join('');
        document.getElementById('catBody').innerHTML = rows;
        document.getElementById('catFoot').innerHTML = `<tr><td>Grand total</td><td class="text-right">${formatNumber(total)}</td><td></td></tr>`;
        document.getElementById('catTotal').innerText = 'Total: '+formatNumber(total);
    }

    function renderDosageForm() {
        let map = new Map();
        filteredData.forEach(r => { if (r.dosage_form) map.set(r.dosage_form, (map.get(r.dosage_form)||0) + (r.sale_qty||0)); });
        let total = Array.from(map.values()).reduce((a,b)=>a+b,0);
        let arr = Array.from(map.entries()).map(([form,qty])=>({form,qty}));
        let state = sortState.dosage || {col:1, dir:'desc'};
        arr.sort((a,b) => {
            if (state.col===0) return state.dir==='asc' ? a.form.localeCompare(b.form) : b.form.localeCompare(a.form);
            else return state.dir==='asc' ? a.qty - b.qty : b.qty - a.qty;
        });
        let rows = arr.map(i => `<tr><td>${i.form}</td><td class="text-right">${formatNumber(i.qty)}</td><td class="text-right">${formatPercentage(i.qty/total*100)}</td></tr>`).join('');
        document.getElementById('dosageBody').innerHTML = rows;
        document.getElementById('dosageFoot').innerHTML = `<tr><td>Grand total</td><td class="text-right">${formatNumber(total)}</td><td></td></tr>`;
        document.getElementById('dosageTotal').innerText = 'Total: '+formatNumber(total);
    }

    function renderMktBySimple() {
        let map = new Map();
        filteredData.forEach(r => { if (r.mkt_by) map.set(r.mkt_by, (map.get(r.mkt_by)||0) + r.basic_value); });
        let total = Array.from(map.values()).reduce((a,b)=>a+b,0);
        let arr = Array.from(map.entries()).map(([m,val])=>({m,val}));
        let state = sortState.mktSimple || {col:1, dir:'desc'};
        arr.sort((a,b) => {
            if (state.col===0) return state.dir==='asc' ? a.m.localeCompare(b.m) : b.m.localeCompare(a.m);
            else return state.dir==='asc' ? a.val - b.val : b.val - a.val;
        });
        let rows = arr.map(i => `<tr><td class="clickable" onclick="drilldown('mktBy','${i.m}')">${i.m}</td><td class="text-right clickable" onclick="drilldown('mktBy','${i.m}')">${formatNumber(i.val)}</td><td class="text-right">${formatPercentage(i.val/total*100)}</td></tr>`).join('');
        document.getElementById('mktByBody').innerHTML = rows;
        document.getElementById('mktByFoot').innerHTML = `<tr><td>Grand total</td><td class="text-right">${formatNumber(total)}</td><td>100%</td></tr>`;
    }

    function renderSfWise() {
        let map = new Map();
        filteredData.forEach(r => {
            if (!r.sf_name) return;
            let key = r.sf_name+'|'+r.product_name;
            let cur = map.get(key) || {sf:r.sf_name, prod:r.product_name, mkt:r.mkt_by, qty:0, val:0};
            cur.qty += r.sale_qty||0; cur.val += r.basic_value||0;
            map.set(key, cur);
        });
        let arr = Array.from(map.values());
        let total = arr.reduce((a,b)=>a+b.val,0);
        let state = sortState.sfWise || {col:4, dir:'desc'};
        arr.sort((a,b) => {
            let fields = [a.sf, a.prod, a.mkt, a.qty, a.val, (a.val/total*100)];
            let fa = fields[state.col], fb = fields[state.col];
            if (typeof fa === 'string') return state.dir==='asc' ? fa.localeCompare(fb) : fb.localeCompare(fa);
            else return state.dir==='asc' ? fa - fb : fb - fa;
        });
        let rows = arr.map(i => `<tr><td class="clickable" onclick="drilldown('sfName','${i.sf}')">${i.sf}</td><td class="clickable" onclick="drilldown('product','${i.prod}')">${i.prod||'-'}</td><td class="clickable" onclick="drilldown('mktBy','${i.mkt}')">${i.mkt||'-'}</td><td class="text-right">${formatNumber(i.qty)}</td><td class="text-right clickable" onclick="drilldown('sfName','${i.sf}')">${formatNumber(i.val)}</td><td class="text-right">${formatPercentage(i.val/total*100)}</td></tr>`).join('');
        document.getElementById('sfWiseBody').innerHTML = rows;
        document.getElementById('sfWiseFoot').innerHTML = `<tr><td colspan="4">Grand total</td><td class="text-right">${formatNumber(total)}</td><td>100%</td></tr>`;
    }

    function renderSfCode() {
        let map = new Map();
        filteredData.forEach(r => {
            if (!r.sf_code) return;
            let key = r.sf_code+'|'+r.sf_name+'|'+r.product_name;
            let cur = map.get(key) || {code:r.sf_code, sf:r.sf_name, prod:r.product_name, qty:0, val:0};
            cur.qty += r.sale_qty||0; cur.val += r.basic_value||0;
            map.set(key, cur);
        });
        let arr = Array.from(map.values());
        let total = arr.reduce((a,b)=>a+b.val,0);
        let state = sortState.sfCode || {col:4, dir:'desc'};
        arr.sort((a,b) => {
            let fields = [a.code, a.sf, a.prod, a.qty, a.val, (a.val/total*100)];
            let fa = fields[state.col], fb = fields[state.col];
            if (typeof fa === 'string') return state.dir==='asc' ? fa.localeCompare(fb) : fb.localeCompare(fa);
            else return state.dir==='asc' ? fa - fb : fb - fa;
        });
        let rows = arr.map(i => `<tr><td>${i.code}</td><td class="clickable" onclick="drilldown('sfName','${i.sf}')">${i.sf||''}</td><td class="clickable" onclick="drilldown('product','${i.prod}')">${i.prod||''}</td><td class="text-right">${formatNumber(i.qty)}</td><td class="text-right clickable" onclick="drilldown('sfName','${i.sf}')">${formatNumber(i.val)}</td><td class="text-right">${formatPercentage(i.val/total*100)}</td></tr>`).join('');
        document.getElementById('sfCodeBody').innerHTML = rows;
        document.getElementById('sfCodeFoot').innerHTML = `<tr><td colspan="4">Grand total</td><td class="text-right">${formatNumber(total)}</td><td>100%</td></tr>`;
    }

    function renderProdMonthDetail() {
        let arr = filteredData.filter(r=>r.product_name && r.bill_date).map(r=>({prod:r.product_name, month:r.bill_date.substring(0,7), qty:r.sale_qty||0, val:r.basic_value||0}));
        let state = sortState.prodDetail || {col:3, dir:'desc'};
        arr.sort((a,b) => {
            let fields = [a.prod, a.month, a.qty, a.val];
            let fa = fields[state.col], fb = fields[state.col];
            if (typeof fa === 'string') return state.dir==='asc' ? fa.localeCompare(fb) : fb.localeCompare(fa);
            else return state.dir==='asc' ? fa - fb : fb - fa;
        });
        let total = arr.reduce((a,b)=>a+b.val,0);
        let rows = arr.slice(0,50).map(i => `<tr><td class="clickable" onclick="drilldown('product','${i.prod}')">${i.prod}</td><td class="clickable" onclick="drilldown('month','${i.month}')">${i.month}</td><td class="text-right">${formatNumber(i.qty)}</td><td class="text-right clickable" onclick="drilldown('product','${i.prod}')">${formatNumber(i.val)}</td></tr>`).join('');
        document.getElementById('prodMonthDetailBody').innerHTML = rows;
        document.getElementById('prodMonthDetailFoot').innerHTML = `<tr><td colspan="3">Grand total</td><td class="text-right">${formatNumber(total)}</td></tr>`;
    }

    function renderProdSummary() {
        let map = new Map();
        filteredData.forEach(r => { if (r.product_name) map.set(r.product_name, {val:(map.get(r.product_name)?.val||0)+r.basic_value, qty:(map.get(r.product_name)?.qty||0)+(r.sale_qty||0)}); });
        let arr = Array.from(map.entries()).map(([name, d]) => ({ name, val: d.val, qty: d.qty }));
        let total = arr.reduce((a,b)=>a+b.val,0);
        let state = sortState.prodSummary || {col:2, dir:'desc'};
        arr.sort((a,b) => {
            let fields = [a.name, a.qty, a.val, (a.val/total*100)];
            let fa = fields[state.col], fb = fields[state.col];
            if (typeof fa === 'string') return state.dir==='asc' ? fa.localeCompare(fb) : fb.localeCompare(fa);
            else return state.dir==='asc' ? fa - fb : fb - fa;
        });
        let start = (currentPage-1)*pageSize, end = Math.min(start+pageSize, arr.length);
        let page = arr.slice(start,end);
        let rows = page.map(i => `<tr><td class="clickable" onclick="drilldown('product','${i.name}')">${i.name}</td><td class="text-right">${formatNumber(i.qty)}</td><td class="text-right clickable" onclick="drilldown('product','${i.name}')">${formatNumber(i.val)}</td><td class="text-right">${formatPercentage(i.val/total*100)}</td></tr>`).join('');
        document.getElementById('prodSummaryBody').innerHTML = rows;
        document.getElementById('prodSummaryFoot').innerHTML = `<tr><td colspan="3">Grand total</td><td class="text-right">${formatNumber(total)}</td></tr>`;
        document.getElementById('prodRange').innerText = `${start+1}-${end} / ${arr.length}`;
        document.getElementById('prevBtn').disabled = currentPage===1;
        document.getElementById('nextBtn').disabled = end>=arr.length;
    }

    function renderDpr() {
        let arr = filteredData.filter(r=>r.bill_date && r.bill_no).map(r=>r);
        let state = sortState.dpr || {col:0, dir:'desc'};
        arr.sort((a,b) => {
            let fields = [a.bill_date, a.bill_no, a.location, a.mkt_by, a.product_name, a.batch_no, a.sf_name, a.sale_qty, a.basic_value];
            let fa = fields[state.col] || '', fb = fields[state.col] || '';
            if (typeof fa === 'string') return state.dir==='asc' ? fa.localeCompare(fb) : fb.localeCompare(fa);
            else return state.dir==='asc' ? fa - fb : fb - fa;
        });
        let total = arr.reduce((a,b)=>a+(b.basic_value||0),0);
        let rows = arr.slice(0,100).map(r => `<tr><td class="clickable" onclick="drilldown('month','${r.bill_date.substring(0,7)}')">${r.bill_date||''}</td><td>${r.bill_no||''}</td><td class="clickable" onclick="drilldown('location','${r.location}')">${r.location||''}</td><td class="clickable" onclick="drilldown('mktBy','${r.mkt_by}')">${r.mkt_by||''}</td><td class="clickable" onclick="drilldown('product','${r.product_name}')">${r.product_name||''}</td><td>${r.batch_no||''}</td><td class="clickable" onclick="drilldown('sfName','${r.sf_name}')">${r.sf_name||''}</td><td class="text-right">${formatNumber(r.sale_qty)}</td><td class="text-right clickable" onclick="drilldown('month','${r.bill_date.substring(0,7)}')">${formatNumber(r.basic_value)}</td></tr>`).join('');
        document.getElementById('dprBody').innerHTML = rows;
        document.getElementById('dprFoot').innerHTML = `<tr><td colspan="8">Grand total</td><td class="text-right">${formatNumber(total)}</td></tr>`;
    }

    function renderLocDispatch() {
        let map = new Map();
        filteredData.forEach(r => {
            if (!r.location) return;
            let cur = map.get(r.location) || {loc:r.location, cnt:0, qty:0, val:0};
            cur.cnt++; cur.qty += r.sale_qty||0; cur.val += r.basic_value||0;
            map.set(r.location, cur);
        });
        let arr = Array.from(map.values());
        let total = arr.reduce((a,b)=>a+b.val,0);
        let state = sortState.locDispatch || {col:3, dir:'desc'};
        arr.sort((a,b) => {
            let fields = [a.loc, a.cnt, a.qty, a.val, (a.val/total*100)];
            let fa = fields[state.col], fb = fields[state.col];
            if (typeof fa === 'string') return state.dir==='asc' ? fa.localeCompare(fb) : fb.localeCompare(fa);
            else return state.dir==='asc' ? fa - fb : fb - fa;
        });
        let rows = arr.map(i => `<tr><td class="clickable" onclick="drilldown('location','${i.loc}')">${i.loc}</td><td class="text-right">${i.cnt}</td><td class="text-right">${formatNumber(i.qty)}</td><td class="text-right clickable" onclick="drilldown('location','${i.loc}')">${formatNumber(i.val)}</td><td class="text-right">${formatPercentage(i.val/total*100)}</td></tr>`).join('');
        document.getElementById('locDispatchBody').innerHTML = rows;
        document.getElementById('locDispatchFoot').innerHTML = `<tr><td colspan="3">Grand total</td><td class="text-right">${formatNumber(total)}</td><td>100%</td></tr>`;
    }

    function updateGrandTotal() {
        let total = filteredData.reduce((s,r)=>s+(r.basic_value||0),0);
        document.getElementById('grandTotalValue').innerText = formatNumber(total);
    }

    // ---------- EXPORT CURRENT TAB WITH PASSWORD PROMPT ----------
    window.exportCurrentTab = function() {
        const password = prompt("Enter password to export Excel file:", "criusexcel");
        if (password !== "criusexcel") {
            alert("Incorrect password. Export cancelled.");
            return;
        }
        
        // Get active tab
        const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
        const wb = XLSX.utils.book_new();
        
        function addTableToWorkbook(tableId, sheetName) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const rows = [];
            // Headers
            const headerRow = [];
            table.querySelectorAll('thead th').forEach(th => headerRow.push(th.innerText));
            rows.push(headerRow);
            
            // Body
            table.querySelectorAll('tbody tr').forEach(tr => {
                const row = [];
                tr.querySelectorAll('td').forEach(td => row.push(td.innerText));
                rows.push(row);
            });
            
            // Footer
            const footerRow = [];
            table.querySelectorAll('tfoot td').forEach(td => footerRow.push(td.innerText));
            if (footerRow.length) rows.push(footerRow);
            
            const ws = XLSX.utils.aoa_to_sheet(rows);
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
        }
        
        // Add tables based on active tab
        switch(activeTab) {
            case 'salesBoard':
                addTableToWorkbook('fyTable', 'Financial Year');
                addTableToWorkbook('catTable', 'Product Type');
                addTableToWorkbook('dosageTable', 'Dosage Form');
                break;
            case 'mktSf':
                addTableToWorkbook('mktByTable', 'Mkt By');
                addTableToWorkbook('sfWiseTable', 'SF Wise');
                break;
            case 'sfBrand':
                addTableToWorkbook('sfCodeTable', 'SF Code');
                break;
            case 'prodMonth':
                addTableToWorkbook('prodMonthDetail', 'Product Month Detail');
                addTableToWorkbook('prodSummary', 'Product Summary');
                break;
            case 'dispatch':
                addTableToWorkbook('dprTable', 'DPR');
                addTableToWorkbook('locDispatchTable', 'Dispatch Location');
                break;
        }
        
        // Generate file
        const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });
        const blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' });
        const fileName = `Business_DashBoard_${activeTab}_${password}.xlsx`;
        saveAs(blob, fileName);
    };
    
    function s2ab(s) {
        const buf = new ArrayBuffer(s.length);
        const view = new Uint8Array(buf);
        for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
        return buf;
    }
</script>
</body>
</html>
