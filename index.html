<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRIUS Business Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
        }

        body {
            background: #e9ecf1;
            padding: 20px;
        }

        .dashboard {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 4px;
            overflow: hidden;
        }

        .main-header {
            background: #1e3a5f;
            color: white;
            padding: 16px 24px;
            font-size: 26px;
            font-weight: 600;
            border-bottom: 3px solid #0f2a44;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .api-badge {
            background: #4a6fa5;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin-left: 15px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .weather-info {
            display: flex;
            align-items: center;
            gap: 20px;
            color: #ffd700;
            font-size: 14px;
        }

        .company-header {
            background: linear-gradient(135deg, #2c3e50, #1e3a5f);
            color: white;
            padding: 20px 24px;
            font-size: 28px;
            font-weight: 700;
            border-bottom: 3px solid #ffd700;
            text-align: center;
        }

        .company-subheader {
            color: #ffd700;
            font-size: 14px;
            margin-top: 8px;
            font-weight: normal;
        }

        .nav-menu {
            display: flex;
            background: #f0f2f5;
            padding: 10px 24px;
            gap: 25px;
            flex-wrap: wrap;
            border-bottom: 2px solid #ccd1d9;
        }

        .nav-menu a {
            color: #2c3e50;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            padding: 4px 8px;
        }

        .nav-menu a:hover {
            background: #1e3a5f;
            color: white;
            border-radius: 4px;
        }

        .connection-status-bar {
            background: #e8f0fe;
            padding: 10px 24px;
            border-bottom: 2px solid #b8d1f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-connected {
            background: #d4edda;
            color: #155724;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .status-connecting {
            background: #fff3cd;
            color: #856404;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .refresh-btn-small {
            background: #4a6fa5;
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
        }

        .refresh-btn-small:hover {
            background: #1e3a5f;
        }

        .nav-sidebar {
            display: flex;
            background: #f0f2f5;
            border-bottom: 2px solid #ccd1d9;
            overflow-x: auto;
            white-space: nowrap;
        }

        .nav-item {
            padding: 14px 28px;
            font-size: 14px;
            color: #2c3e50;
            border-right: 1px solid #ccd1d9;
            font-weight: 600;
            cursor: pointer;
        }

        .nav-item:hover {
            background: #e4e7eb;
            color: #1e3a5f;
        }

        .nav-item.active {
            background: #1e3a5f;
            color: white;
            font-weight: 700;
        }

        .filter-bar {
            background: #f8fafc;
            padding: 15px 24px;
            display: flex;
            gap: 20px;
            border-bottom: 2px solid #dee2e9;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .filter-group label {
            font-weight: 700;
            color: #1e3a5f;
            min-width: 70px;
        }

        .filter-group select, .filter-group input {
            padding: 8px 12px;
            border: 1px solid #9aa6b5;
            border-radius: 6px;
            min-width: 150px;
            background: white;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: white;
            border: 1px solid #9aa6b5;
            border-radius: 6px;
            padding: 4px 12px;
            min-width: 280px;
        }

        .search-box input {
            border: none;
            padding: 8px 0;
            width: 100%;
            outline: none;
        }

        .search-box button {
            background: #1e3a5f;
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }

        .refresh-btn {
            background: #4a6fa5;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .reset-btn {
            background: #d6562b;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

        .content {
            padding: 24px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e3a5f;
            margin: 25px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #d0d7e5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-wrapper {
            border: 1px solid #b7bfcc;
            border-radius: 8px;
            margin-bottom: 30px;
            overflow: auto;
            max-height: 500px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        thead th {
            background: #2b5797;
            color: white;
            padding: 12px;
            font-weight: 600;
            border: 1px solid #1e3a5f;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
        }

        thead th:hover {
            background: #1e3a5f;
        }

        thead th.sort-asc::after {
            content: " ‚Üë";
            color: #ffd700;
        }

        thead th.sort-desc::after {
            content: " ‚Üì";
            color: #ffd700;
        }

        tbody td {
            padding: 10px 12px;
            border: 1px solid #b7bfcc;
            white-space: nowrap;
        }

        tbody td.clickable {
            cursor: pointer;
            color: #1e3a5f;
            font-weight: 500;
        }

        tbody td.clickable:hover {
            background: #e3f2fd;
            font-weight: 700;
        }

        tbody tr:hover {
            background: #f5f7fa;
        }

        tfoot td {
            background: #d6562b;
            color: white;
            font-weight: 700;
            padding: 12px;
            border: 1px solid #b13e1f;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }

        .grand-footer {
            background: #1e3a5f;
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            font-weight: 700;
            font-size: 16px;
            border-top: 3px solid #ffd700;
        }

        .dashboard-footer {
            background: #1e3a5f;
            color: white;
            padding: 14px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            border-top: 2px solid #0f2a44;
        }

        .percentage-positive {
            color: #4caf50;
            font-weight: 700;
        }

        .percentage-negative {
            color: #f44336;
            font-weight: 700;
        }

        .text-right {
            text-align: right;
        }

        .loading {
            text-align: center;
            padding: 80px;
            font-size: 18px;
            color: #1e3a5f;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #c00000;
            background: #ffebee;
            margin: 30px;
            border-radius: 8px;
            white-space: pre-line;
        }

        .active-filters-bar {
            background: #fff3cd;
            padding: 12px 24px;
            display: none;
            align-items: center;
            gap: 15px;
            border-bottom: 2px solid #ffe69c;
        }

        .filter-tag {
            background: #ffd700;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #1e3a5f;
        }

        .filter-tag button {
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 700;
            color: #1e3a5f;
            font-size: 14px;
        }

        .pagination {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .pagination button {
            padding: 6px 12px;
            background: white;
            border: 1px solid #9aa6b5;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .connection-panel {
            display: none; /* Hidden by default */
        }

        .config-data {
            display: none; /* Hidden configuration data */
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="main-header">
            <div>
                CRIUS Business Dashboard
                <span class="api-badge" id="apiBadge" style="display: none;">
                    <span>‚úÖ</span> Connected
                </span>
            </div>
            <div class="weather-info">
                <span>üå§Ô∏è 27¬∞C Sunny</span>
                <span class="last-update" id="lastUpdate"></span>
            </div>
        </div>

        <div class="company-header">
            CRIUS GROUP OF COMPANIES
            <div class="company-subheader">Enterprise Business Intelligence Dashboard</div>
        </div>

        <div class="nav-menu">
            <a href="#">Home</a>
            <a href="#">Ceoitbox</a>
            <a href="#">Training Videos</a>
            <a href="#">Management</a>
            <a href="#">Head Office</a>
            <a href="#">CRIUS</a>
            <a href="#">CHIROS/SIGNOVA</a>
            <a href="#">CHIMAK/SYSKEM/MARSK</a>
            <a href="#">WELZO</a>
            <a href="#">CRIUS HEALTHCARE</a>
        </div>

        <!-- Simple Status Bar (Only visible after connection) -->
        <div class="connection-status-bar" id="statusBar" style="display: none;">
            <div id="connectionStatus" class="status-connected">
                <span>‚úÖ</span> Connected via CORS Anywhere
            </div>
            <button class="refresh-btn-small" onclick="refreshData()">
                <span>üîÑ</span> Refresh Data
            </button>
        </div>

        <!-- Hidden Configuration (never visible to users) -->
        <div class="config-data">
            <input type="text" id="apiUsername" value="SOURAV">
            <input type="password" id="apiPassword" value="KUMAR@1308">
            <input type="text" id="reportId" value="r17d84895210.rpt">
            <input type="text" id="serverUrl" value="http://43.246.140.102:6060/smarten/">
            <input type="text" id="proxyUrl" value="https://cors-anywhere.herokuapp.com/">
        </div>

        <div class="nav-sidebar" id="tabNav"></div>

        <div class="filter-bar">
            <div class="filter-group">
                <label>Location:</label>
                <select id="locationFilter" onchange="applyFilters()">
                    <option value="all">All Locations</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Mkt By:</label>
                <select id="mktByFilter" onchange="applyFilters()">
                    <option value="all">All</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Product Type:</label>
                <select id="productTypeFilter" onchange="applyFilters()">
                    <option value="all">All Types</option>
                </select>
            </div>
            <div class="filter-group">
                <label>From:</label>
                <input type="month" id="dateFrom" onchange="applyFilters()" value="2025-02">
            </div>
            <div class="filter-group">
                <label>To:</label>
                <input type="month" id="dateTo" onchange="applyFilters()" value="2026-02">
            </div>
            <div class="search-box">
                <input type="text" placeholder="üîç Search products, SF names..." id="globalSearch" onkeyup="applyFilters()">
                <button onclick="applyFilters()">Search</button>
            </div>
            <button class="refresh-btn" onclick="refreshData()">
                <span>üîÑ</span> Refresh
            </button>
            <button class="reset-btn" onclick="resetFilters()">Reset</button>
        </div>

        <div class="active-filters-bar" id="activeFiltersBar">
            <span style="font-weight: 700;">Active Filters:</span>
            <div id="activeFilters"></div>
            <button onclick="clearAllFilters()" style="margin-left: auto; background: none; border: none; color: #856404; cursor: pointer; font-weight: 600;">Clear All ‚úï</button>
        </div>

        <div id="loading" class="loading">Connecting to CORS Anywhere... Please wait.</div>
        <div id="error" class="error" style="display: none;"></div>

        <div id="tabContainers" style="display: none;"></div>

        <div class="grand-footer" style="display: none;" id="grandFooter">
            <span>üìä Overall Grand Total</span>
            <span id="grandTotalValue"></span>
        </div>

        <div class="dashboard-footer">
            <div class="footer-left">
                <span>¬© 2026 CRIUS Group</span>
            </div>
            <div class="footer-right">
                <span>üåê v2.0</span>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const CONFIG = {
            serverUrl: 'http://43.246.140.102:6060/smarten/',
            username: 'SOURAV',
            password: 'KUMAR@1308',
            reportId: 'r17d84895210.rpt',
            proxyUrl: 'https://cors-anywhere.herokuapp.com/'
        };

        let allData = [];
        let filteredData = [];
        let headers = [];
        let currentPage = 1;
        const pageSize = 50;
        
        let activeFilters = {
            location: null,
            mktBy: null,
            productType: null,
            dateFrom: '2025-02',
            dateTo: '2026-02',
            search: null
        };

        let sortStates = {
            mktBy: { column: 1, direction: 'desc' },
            location: { column: 1, direction: 'desc' },
            sfWise: { column: 2, direction: 'desc' },
            brand: { column: 4, direction: 'desc' },
            productMonth: { column: 3, direction: 'desc' },
            dpr: { column: 6, direction: 'desc' }
        };

        let uniqueLocations = new Set();
        let uniqueMktBy = new Set();
        let uniqueProductTypes = new Set();

        const tabs = [
            { id: 'summary', name: 'üìä Summary View' },
            { id: 'customer-sf', name: 'üë• Customer & SF Wise' },
            { id: 'sf-brand', name: 'üè∑Ô∏è SF Wise Brand Details' },
            { id: 'sf-product', name: 'üì¶ SF & Product Month Wise' },
            { id: 'dpr', name: 'üìã Daily Dispatch Details (DPR)' }
        ];

        // ==================== AUTO CONNECT ON PAGE LOAD ====================
        window.onload = function() {
            initializeUI();
            // Auto-connect after a short delay
            setTimeout(() => {
                autoConnect();
            }, 1000);
        };

        function initializeUI() {
            updateLastUpdateTime(new Date());
            createTabs();
            createTabContainers();
        }

        function updateLastUpdateTime(date) {
            const options = { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            document.getElementById('lastUpdate').textContent = 'LAST UPDATE: ' + date.toLocaleDateString('en-GB', options);
        }

        // ==================== AUTO CONNECT FUNCTION ====================
        async function autoConnect() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loading').textContent = 'Connecting to CORS Anywhere... Please wait.';
            document.getElementById('error').style.display = 'none';

            try {
                // Open CORS Anywhere demo page in new tab
                window.open('https://cors-anywhere.herokuapp.com/corsdemo', '_blank');
                
                // Wait for user to click the button (3 seconds)
                document.getElementById('loading').textContent = 'Waiting for CORS Anywhere access... Click the button in the new tab.';
                
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // Connect using CORS Anywhere
                await connectWithCorsAnywhere();
                
            } catch (error) {
                console.error('Auto-connect error:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').innerHTML = `
                    <strong>Connection Error:</strong><br>
                    ${error.message}<br><br>
                    <button onclick="autoConnect()" style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Try Again</button>
                `;
            }
        }

        // ==================== CONNECT WITH CORS ANYWHERE ====================
        async function connectWithCorsAnywhere() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loading').textContent = 'Fetching data via CORS Anywhere...';
            
            try {
                const baseUrl = CONFIG.serverUrl.endsWith('/') ? CONFIG.serverUrl : CONFIG.serverUrl + '/';
                const proxyUrl = CONFIG.proxyUrl;

                // Step 1: Get Token
                const tokenUrl = proxyUrl + baseUrl + 'API/getToken';
                
                const tokenResponse = await fetch(tokenUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Origin': window.location.origin,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: new URLSearchParams({
                        username: CONFIG.username,
                        password: CONFIG.password,
                        objectid: CONFIG.reportId,
                        type: 'data'
                    })
                });

                if (!tokenResponse.ok) {
                    if (tokenResponse.status === 403) {
                        throw new Error('CORS Anywhere needs temporary access. Please click the button in the new tab and try again.');
                    }
                    throw new Error(`Token fetch failed: ${tokenResponse.status}`);
                }

                const token = await tokenResponse.text();

                if (!token || token.trim() === '') {
                    throw new Error('Empty token response');
                }

                // Step 2: Get Data
                const dataUrl = proxyUrl + baseUrl + 'API/getObject?tokenid=' + encodeURIComponent(token);
                
                const dataResponse = await fetch(dataUrl, {
                    headers: {
                        'Origin': window.location.origin,
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (!dataResponse.ok) {
                    throw new Error(`Data fetch failed: ${dataResponse.status}`);
                }

                const responseText = await dataResponse.text();

                // Parse the data
                let reportData = parseXmlData(responseText);

                if (!reportData || reportData.length === 0) {
                    throw new Error('No data found in response');
                }

                // Store headers and data
                headers = reportData[0] || [];
                reportData = reportData.slice(1);

                // Transform data
                allData = transformData(reportData);

                if (allData.length === 0) {
                    throw new Error('No valid data after transformation');
                }

                filteredData = [...allData];
                
                rebuildUniqueSets();
                
                // Update UI
                document.getElementById('loading').style.display = 'none';
                document.getElementById('tabContainers').style.display = 'block';
                document.getElementById('grandFooter').style.display = 'flex';
                document.getElementById('apiBadge').style.display = 'inline-block';
                document.getElementById('statusBar').style.display = 'flex';
                
                updateLastUpdateTime(new Date());
                updateFilterOptions();
                renderAllTables();

            } catch (error) {
                console.error('Connection error:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').innerHTML = `
                    <strong>Error:</strong><br>
                    ${error.message}<br><br>
                    <button onclick="autoConnect()" style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Try Again</button>
                `;
            }
        }

        // ==================== XML PARSING ====================
        function parseXmlData(xmlString) {
            if (!xmlString || xmlString.trim() === '') {
                console.error('XML data is null or empty');
                return [];
            }

            console.log('Parsing XML data...');
            
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlString, 'text/xml');
                
                const parseError = xmlDoc.getElementsByTagName('parsererror');
                if (parseError.length > 0) {
                    console.error('XML parse error');
                    return fallbackParse(xmlString);
                }
                
                const rows = xmlDoc.getElementsByTagName('Row');
                
                if (rows.length === 0) {
                    return fallbackParse(xmlString);
                }
                
                const data = [];
                
                // Extract headers
                const firstRow = rows[0];
                const headers = [];
                const columns = firstRow.getElementsByTagName('Column');
                
                for (let col of columns) {
                    headers.push(col.textContent || '');
                }
                
                if (headers.length > 0) {
                    data.push(headers);
                }
                
                // Extract data rows
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    const rowData = [];
                    const cols = row.getElementsByTagName('Column');
                    
                    for (let col of cols) {
                        let value = col.textContent || '';
                        value = value.replace(/&amp;/g, '&')
                                     .replace(/&lt;/g, '<')
                                     .replace(/&gt;/g, '>')
                                     .replace(/&quot;/g, '"')
                                     .replace(/&#39;/g, "'")
                                     .trim();
                        rowData.push(value);
                    }
                    
                    if (rowData.length > 0) {
                        data.push(rowData);
                    }
                }
                
                return data;
                
            } catch (e) {
                console.error('XML parsing error:', e);
                return fallbackParse(xmlString);
            }
        }

        function fallbackParse(xmlString) {
            console.log('Using fallback parser...');
            const data = [];
            const rows = xmlString.split('</Row>');
            
            for (const row of rows) {
                if (!row.includes('<Row>')) continue;
                
                const cols = row.match(/<Column[^>]*>(.*?)<\/Column>/g);
                if (cols) {
                    const rowData = cols.map(col => {
                        let value = col.replace(/<\/?Column[^>]*>/g, '');
                        value = value.replace(/&amp;/g, '&')
                                     .replace(/&lt;/g, '<')
                                     .replace(/&gt;/g, '>')
                                     .replace(/&quot;/g, '"')
                                     .replace(/&#39;/g, "'");
                        return value.trim();
                    });
                    data.push(rowData);
                }
            }
            
            return data;
        }

        // ==================== DATA TRANSFORMATION ====================
        function transformData(rows) {
            if (rows.length === 0) return [];
            
            // Create header mapping
            const headerMap = {};
            headers.forEach((header, index) => {
                const headerStr = (header || '').toString().toLowerCase().trim();
                
                if (headerStr.includes('location') || headerStr.includes('godown')) headerMap.location = index;
                else if (headerStr.includes('billno') || headerStr.includes('bill_no')) headerMap.bill_no = index;
                else if (headerStr.includes('date') || headerStr.includes('txndocdt')) headerMap.bill_date = index;
                else if (headerStr.includes('product') || headerStr.includes('itemname')) {
                    if (headerStr.includes('type')) headerMap.product_type = index;
                    else headerMap.product_name = index;
                }
                else if (headerStr.includes('batch')) headerMap.batch_no = index;
                else if (headerStr.includes('qty') || headerStr.includes('saleqty')) headerMap.sale_qty = index;
                else if (headerStr.includes('value') || headerStr.includes('basic')) headerMap.basic_value = index;
                else if (headerStr.includes('sfcode')) headerMap.sf_code = index;
                else if (headerStr.includes('sfname')) headerMap.sf_name = index;
                else if (headerStr.includes('mktby')) headerMap.mkt_by = index;
                else if (headerStr.includes('city')) headerMap.city = index;
                else if (headerStr.includes('state')) headerMap.state = index;
            });

            // Default mapping if no headers found
            if (Object.keys(headerMap).length === 0) {
                headerMap.location = 0;
                headerMap.bill_no = 1;
                headerMap.bill_date = 2;
                headerMap.product_name = 3;
                headerMap.product_type = 4;
                headerMap.batch_no = 5;
                headerMap.sale_qty = 6;
                headerMap.basic_value = 7;
                headerMap.sf_code = 8;
                headerMap.sf_name = 9;
                headerMap.mkt_by = 10;
                headerMap.city = 11;
                headerMap.state = 12;
            }

            // Transform rows
            return rows.map((row, idx) => ({
                id: `row_${idx}`,
                location: row[headerMap.location] || '',
                bill_no: row[headerMap.bill_no] || '',
                bill_date: row[headerMap.bill_date] || '',
                product_name: row[headerMap.product_name] || '',
                product_type: row[headerMap.product_type] || '',
                batch_no: row[headerMap.batch_no] || '',
                sale_qty: parseFloat((row[headerMap.sale_qty] || '0').replace(/[^0-9.-]/g, '')) || 0,
                basic_value: parseFloat((row[headerMap.basic_value] || '0').replace(/[^0-9.-]/g, '')) || 0,
                sf_code: row[headerMap.sf_code] || '',
                sf_name: row[headerMap.sf_name] || '',
                mkt_by: row[headerMap.mkt_by] || '',
                city: row[headerMap.city] || '',
                state: row[headerMap.state] || ''
            }));
        }

        function rebuildUniqueSets() {
            uniqueLocations.clear();
            uniqueMktBy.clear();
            uniqueProductTypes.clear();
            
            allData.forEach(item => {
                if (item.location) uniqueLocations.add(item.location);
                if (item.mkt_by) uniqueMktBy.add(item.mkt_by);
                if (item.product_type) uniqueProductTypes.add(item.product_type);
            });
        }

        function refreshData() {
            connectWithCorsAnywhere();
        }

        // ==================== TAB FUNCTIONS ====================
        function createTabs() {
            const tabNav = document.getElementById('tabNav');
            tabNav.innerHTML = '';
            
            tabs.forEach((tab, index) => {
                const tabElement = document.createElement('div');
                tabElement.className = `nav-item ${index === 0 ? 'active' : ''}`;
                tabElement.setAttribute('data-tab', tab.id);
                tabElement.textContent = tab.name;
                tabElement.onclick = () => switchTab(tab.id);
                tabNav.appendChild(tabElement);
            });
        }

        function createTabContainers() {
            const containers = document.getElementById('tabContainers');
            containers.innerHTML = '';
            
            tabs.forEach((tab, index) => {
                const container = document.createElement('div');
                container.id = `tab-${tab.id}`;
                container.className = `tab-content ${index === 0 ? 'active' : ''}`;
                container.innerHTML = getTabHTML(tab.id);
                containers.appendChild(container);
            });
        }

        function getTabHTML(tabId) {
            switch(tabId) {
                case 'summary':
                    return `
                        <div class="section-title">
                            üìà Mkt_By Analysis
                            <span class="total-info" id="mktByTotal"></span>
                        </div>
                        <div class="table-wrapper">
                            <table id="mktByTable">
                                <thead><tr id="mktByHeader"></tr></thead>
                                <tbody id="mktByBody"></tbody>
                                <tfoot id="mktByFooter"></tfoot>
                            </table>
                        </div>

                        <div class="section-title">
                            üìç Location Wise Analysis
                            <span class="total-info" id="locationTotal"></span>
                        </div>
                        <div class="table-wrapper">
                            <table id="locationTable">
                                <thead><tr id="locationHeader"></tr></thead>
                                <tbody id="locationBody"></tbody>
                                <tfoot id="locationFooter"></tfoot>
                            </table>
                        </div>

                        <div class="section-title">
                            üè∑Ô∏è Product Type Analysis
                            <span class="total-info" id="productTypeTotal"></span>
                        </div>
                        <div class="table-wrapper">
                            <table id="productTypeTable">
                                <thead><tr id="productTypeHeader"></tr></thead>
                                <tbody id="productTypeBody"></tbody>
                                <tfoot id="productTypeFooter"></tfoot>
                            </table>
                        </div>
                    `;
                case 'customer-sf':
                    return `
                        <div class="section-title">
                            üë• SF Wise Product Details
                            <span class="total-info" id="sfWiseTotal"></span>
                        </div>
                        <div class="table-wrapper">
                            <table id="sfWiseTable">
                                <thead><tr id="sfWiseHeader"></tr></thead>
                                <tbody id="sfWiseBody"></tbody>
                                <tfoot id="sfWiseFooter"></tfoot>
                            </table>
                        </div>

                        <div class="section-title">
                            üî¢ SF Code Details
                            <span class="total-info" id="sfCodeTotal"></span>
                        </div>
                        <div class="table-wrapper">
                            <table id="sfCodeTable">
                                <thead><tr id="sfCodeHeader"></tr></thead>
                                <tbody id="sfCodeBody"></tbody>
                                <tfoot id="sfCodeFooter"></tfoot>
                            </table>
                        </div>
                    `;
                case 'sf-brand':
                    return `
                        <div class="section-title">
                            üìÖ Brand Details by SF (Monthly)
                            <span class="total-info" id="brandMonthlyTotal"></span>
                        </div>
                        <div class="table-wrapper">
                            <table id="brandMonthlyTable">
                                <thead><tr id="brandMonthlyHeader"></tr></thead>
                                <tbody id="brandMonthlyBody"></tbody>
                                <tfoot id="brandMonthlyFooter"></tfoot>
                            </table>
                        </div>

                        <div class="section-title">
                            üìä Brand Details by SF (Summary)
                            <span class="total-info" id="brandSummaryTotal"></span>
                        </div>
                        <div class="table-wrapper">
                            <table id="brandSummaryTable">
                                <thead><tr id="brandSummaryHeader"></tr></thead>
                                <tbody id="brandSummaryBody"></tbody>
                                <tfoot id="brandSummaryFooter"></tfoot>
                            </table>
                        </div>
                    `;
                case 'sf-product':
                    return `
                        <div class="section-title">
                            üì¶ Product Month Wise (Detailed)
                            <span class="total-info" id="productMonthDetailTotal"></span>
                        </div>
                        <div class="table-wrapper">
                            <table id="productMonthDetailTable">
                                <thead><tr id="productMonthDetailHeader"></tr></thead>
                                <tbody id="productMonthDetailBody"></tbody>
                                <tfoot id="productMonthDetailFooter"></tfoot>
                            </table>
                        </div>

                        <div class="section-title">
                            üìä Product Month Wise (Summary)
                            <div class="pagination">
                                <span id="productRange">1-50</span>
                                <span>/ <span id="totalProducts">0</span></span>
                                <button onclick="prevPage()" id="prevBtn" disabled>‚Üê</button>
                                <button onclick="nextPage()" id="nextBtn">‚Üí</button>
                            </div>
                        </div>
                        <div class="table-wrapper">
                            <table id="productMonthSummaryTable">
                                <thead><tr id="productMonthSummaryHeader"></tr></thead>
                                <tbody id="productMonthSummaryBody"></tbody>
                                <tfoot id="productMonthSummaryFooter"></tfoot>
                            </table>
                        </div>
                    `;
                case 'dpr':
                    return `
                        <div class="section-title">
                            üìã Daily Dispatch Details (DPR)
                            <span class="total-info" id="dprTotal"></span>
                        </div>
                        <div class="table-wrapper">
                            <table id="dprTable">
                                <thead><tr id="dprHeader"></tr></thead>
                                <tbody id="dprBody"></tbody>
                                <tfoot id="dprFooter"></tfoot>
                            </table>
                        </div>

                        <div class="section-title">
                            üìç Dispatch Summary by Location
                            <span class="total-info" id="dispatchLocationTotal"></span>
                        </div>
                        <div class="table-wrapper">
                            <table id="dispatchLocationTable">
                                <thead><tr id="dispatchLocationHeader"></tr></thead>
                                <tbody id="dispatchLocationBody"></tbody>
                                <tfoot id="dispatchLocationFooter"></tfoot>
                            </table>
                        </div>
                    `;
                default:
                    return '';
            }
        }

        function switchTab(tabId) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if(item.getAttribute('data-tab') === tabId) {
                    item.classList.add('active');
                }
            });
            
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        // ==================== FILTER FUNCTIONS ====================
        function updateFilterOptions() {
            const locationSelect = document.getElementById('locationFilter');
            const mktBySelect = document.getElementById('mktByFilter');
            const productTypeSelect = document.getElementById('productTypeFilter');
            
            locationSelect.innerHTML = '<option value="all">All Locations</option>';
            mktBySelect.innerHTML = '<option value="all">All</option>';
            productTypeSelect.innerHTML = '<option value="all">All Types</option>';
            
            Array.from(uniqueLocations).sort().forEach(loc => {
                if (loc) {
                    const option = document.createElement('option');
                    option.value = loc;
                    option.textContent = loc;
                    locationSelect.appendChild(option);
                }
            });

            Array.from(uniqueMktBy).sort().forEach(mkt => {
                if (mkt) {
                    const option = document.createElement('option');
                    option.value = mkt;
                    option.textContent = mkt;
                    mktBySelect.appendChild(option);
                }
            });

            Array.from(uniqueProductTypes).sort().forEach(type => {
                if (type) {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    productTypeSelect.appendChild(option);
                }
            });
        }

        function applyFilters() {
            activeFilters.location = document.getElementById('locationFilter').value !== 'all' ? document.getElementById('locationFilter').value : null;
            activeFilters.mktBy = document.getElementById('mktByFilter').value !== 'all' ? document.getElementById('mktByFilter').value : null;
            activeFilters.productType = document.getElementById('productTypeFilter').value !== 'all' ? document.getElementById('productTypeFilter').value : null;
            activeFilters.dateFrom = document.getElementById('dateFrom').value;
            activeFilters.dateTo = document.getElementById('dateTo').value;
            activeFilters.search = document.getElementById('globalSearch').value || null;

            filteredData = allData.filter(item => {
                if (activeFilters.location && item.location !== activeFilters.location) return false;
                if (activeFilters.mktBy && item.mkt_by !== activeFilters.mktBy) return false;
                if (activeFilters.productType && item.product_type !== activeFilters.productType) return false;
                
                if (activeFilters.dateFrom && item.bill_date) {
                    const itemDate = item.bill_date.substring(0, 7);
                    if (itemDate < activeFilters.dateFrom) return false;
                }
                if (activeFilters.dateTo && item.bill_date) {
                    const itemDate = item.bill_date.substring(0, 7);
                    if (itemDate > activeFilters.dateTo) return false;
                }
                
                if (activeFilters.search) {
                    const searchTerm = activeFilters.search.toLowerCase();
                    const searchableFields = [
                        item.product_name,
                        item.sf_name,
                        item.mkt_by,
                        item.location,
                        item.batch_no,
                        item.sf_code
                    ].map(f => (f || '').toLowerCase());
                    
                    if (!searchableFields.some(field => field.includes(searchTerm))) {
                        return false;
                    }
                }
                
                return true;
            });

            updateActiveFiltersDisplay();
            currentPage = 1;
            renderAllTables();
        }

        function updateActiveFiltersDisplay() {
            const bar = document.getElementById('activeFiltersBar');
            const container = document.getElementById('activeFilters');
            
            const activeFilterList = [];
            
            if (activeFilters.location) activeFilterList.push(`Location: ${activeFilters.location}`);
            if (activeFilters.mktBy) activeFilterList.push(`Mkt By: ${activeFilters.mktBy}`);
            if (activeFilters.productType) activeFilterList.push(`Product Type: ${activeFilters.productType}`);
            if (activeFilters.dateFrom) activeFilterList.push(`From: ${activeFilters.dateFrom}`);
            if (activeFilters.dateTo) activeFilterList.push(`To: ${activeFilters.dateTo}`);
            if (activeFilters.search) activeFilterList.push(`Search: "${activeFilters.search}"`);
            
            if (activeFilterList.length > 0) {
                bar.style.display = 'flex';
                container.innerHTML = activeFilterList.map(filter => 
                    `<span class="filter-tag">${filter} <button onclick="removeFilter('${filter.split(':')[0].trim().toLowerCase()}')">‚úï</button></span>`
                ).join(' ');
            } else {
                bar.style.display = 'none';
            }
        }

        function removeFilter(filterType) {
            switch(filterType) {
                case 'location':
                    document.getElementById('locationFilter').value = 'all';
                    activeFilters.location = null;
                    break;
                case 'mkt':
                    document.getElementById('mktByFilter').value = 'all';
                    activeFilters.mktBy = null;
                    break;
                case 'product':
                    document.getElementById('productTypeFilter').value = 'all';
                    activeFilters.productType = null;
                    break;
                case 'from':
                    document.getElementById('dateFrom').value = '';
                    activeFilters.dateFrom = null;
                    break;
                case 'to':
                    document.getElementById('dateTo').value = '';
                    activeFilters.dateTo = null;
                    break;
                case 'search':
                    document.getElementById('globalSearch').value = '';
                    activeFilters.search = null;
                    break;
            }
            applyFilters();
        }

        function clearAllFilters() {
            document.getElementById('locationFilter').value = 'all';
            document.getElementById('mktByFilter').value = 'all';
            document.getElementById('productTypeFilter').value = 'all';
            document.getElementById('dateFrom').value = '2025-02';
            document.getElementById('dateTo').value = '2026-02';
            document.getElementById('globalSearch').value = '';
            
            activeFilters = {
                location: null,
                mktBy: null,
                productType: null,
                dateFrom: '2025-02',
                dateTo: '2026-02',
                search: null
            };
            
            filteredData = [...allData];
            updateActiveFiltersDisplay();
            renderAllTables();
        }

        function resetFilters() {
            clearAllFilters();
        }

        // ==================== SORT FUNCTIONS ====================
        function sortTable(tableType, columnIndex) {
            const state = sortStates[tableType];
            if (!state) return;
            
            if (state.column === columnIndex) {
                state.direction = state.direction === 'asc' ? 'desc' : 'asc';
            } else {
                state.column = columnIndex;
                state.direction = 'desc';
            }

            document.querySelectorAll(`#${tableType}Header th`).forEach((th, idx) => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            const headerCell = document.querySelector(`#${tableType}Header th:nth-child(${columnIndex + 1})`);
            if (headerCell) {
                headerCell.classList.add(`sort-${state.direction}`);
            }

            renderAllTables();
        }

        // ==================== PAGINATION FUNCTIONS ====================
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderAllTables();
            }
        }

        function nextPage() {
            currentPage++;
            renderAllTables();
        }

        // ==================== UTILITY FUNCTIONS ====================
        function formatNumber(num) {
            if (!num || isNaN(num)) return '-';
            return num.toLocaleString('en-IN', {
                maximumFractionDigits: 2,
                minimumFractionDigits: 2
            });
        }

        function formatPercentage(num) {
            if (!num || isNaN(num)) return '-';
            return num.toFixed(2) + '%';
        }

        function getPercentageClass(value) {
            if (value > 0) return 'percentage-positive';
            if (value < 0) return 'percentage-negative';
            return '';
        }

        // ==================== TABLE RENDERING FUNCTIONS ====================
        function renderAllTables() {
            if (filteredData.length === 0) {
                document.querySelectorAll('tbody').forEach(body => {
                    body.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px;">No data available.</td></tr>';
                });
                return;
            }

            renderMktByTable();
            renderLocationTable();
            renderProductTypeTable();
            renderSfWiseTable();
            renderSfCodeTable();
            renderBrandMonthlyTable();
            renderBrandSummaryTable();
            renderProductMonthDetailTable();
            renderProductMonthSummaryTable();
            renderDprTable();
            renderDispatchLocationTable();
            updateGrandTotal();
        }

        function renderMktByTable() {
            const data = filteredData.reduce((acc, item) => {
                if (!item.mkt_by) return acc;
                if (!acc[item.mkt_by]) {
                    acc[item.mkt_by] = { name: item.mkt_by, total: 0 };
                }
                acc[item.mkt_by].total += item.basic_value || 0;
                return acc;
            }, {});

            const sortedData = Object.values(data).sort((a, b) => b.total - a.total);
            const total = sortedData.reduce((sum, item) => sum + item.total, 0);

            document.getElementById('mktByHeader').innerHTML = `
                <th onclick="sortTable('mktBy', 0)">Mkt By</th>
                <th onclick="sortTable('mktBy', 1)" class="text-right">Total Value</th>
                <th onclick="sortTable('mktBy', 2)" class="text-right">Percentage</th>
            `;

            document.getElementById('mktByBody').innerHTML = sortedData.map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('mktBy', '${item.name}')">${item.name}</td>
                    <td class="text-right">${formatNumber(item.total)}</td>
                    <td class="text-right ${getPercentageClass((item.total/total)*100)}">${formatPercentage((item.total/total)*100)}</td>
                </tr>
            `).join('');

            document.getElementById('mktByFooter').innerHTML = `
                <td><strong>Total (${sortedData.length} items)</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td class="text-right"><strong>100%</strong></td>
            `;

            document.getElementById('mktByTotal').textContent = `Total: ${formatNumber(total)}`;
        }

        function renderLocationTable() {
            const data = filteredData.reduce((acc, item) => {
                if (!item.location) return acc;
                if (!acc[item.location]) {
                    acc[item.location] = { name: item.location, total: 0 };
                }
                acc[item.location].total += item.basic_value || 0;
                return acc;
            }, {});

            const sortedData = Object.values(data).sort((a, b) => b.total - a.total);
            const total = sortedData.reduce((sum, item) => sum + item.total, 0);

            document.getElementById('locationHeader').innerHTML = `
                <th onclick="sortTable('location', 0)">Location</th>
                <th onclick="sortTable('location', 1)" class="text-right">Total Value</th>
                <th onclick="sortTable('location', 2)" class="text-right">Percentage</th>
            `;

            document.getElementById('locationBody').innerHTML = sortedData.map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('location', '${item.name}')">${item.name}</td>
                    <td class="text-right">${formatNumber(item.total)}</td>
                    <td class="text-right ${getPercentageClass((item.total/total)*100)}">${formatPercentage((item.total/total)*100)}</td>
                </tr>
            `).join('');

            document.getElementById('locationFooter').innerHTML = `
                <td><strong>Total (${sortedData.length} locations)</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td class="text-right"><strong>100%</strong></td>
            `;

            document.getElementById('locationTotal').textContent = `Total: ${formatNumber(total)}`;
        }

        function renderProductTypeTable() {
            const data = filteredData.reduce((acc, item) => {
                if (!item.product_type) return acc;
                if (!acc[item.product_type]) {
                    acc[item.product_type] = { name: item.product_type, total: 0 };
                }
                acc[item.product_type].total += item.basic_value || 0;
                return acc;
            }, {});

            const sortedData = Object.values(data).sort((a, b) => b.total - a.total);
            const total = sortedData.reduce((sum, item) => sum + item.total, 0);

            document.getElementById('productTypeHeader').innerHTML = `
                <th onclick="sortTable('productType', 0)">Product Type</th>
                <th onclick="sortTable('productType', 1)" class="text-right">Total Value</th>
                <th onclick="sortTable('productType', 2)" class="text-right">Percentage</th>
            `;

            document.getElementById('productTypeBody').innerHTML = sortedData.map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('productType', '${item.name}')">${item.name}</td>
                    <td class="text-right">${formatNumber(item.total)}</td>
                    <td class="text-right ${getPercentageClass((item.total/total)*100)}">${formatPercentage((item.total/total)*100)}</td>
                </tr>
            `).join('');

            document.getElementById('productTypeFooter').innerHTML = `
                <td><strong>Total (${sortedData.length} types)</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td class="text-right"><strong>100%</strong></td>
            `;

            document.getElementById('productTypeTotal').textContent = `Total: ${formatNumber(total)}`;
        }

        function renderSfWiseTable() {
            const data = filteredData.reduce((acc, item) => {
                if (!item.sf_name) return acc;
                const key = item.sf_name;
                if (!acc[key]) {
                    acc[key] = { 
                        sf_name: item.sf_name,
                        sf_code: item.sf_code,
                        total: 0,
                        qty: 0,
                        locations: new Set(),
                        products: new Set()
                    };
                }
                acc[key].total += item.basic_value || 0;
                acc[key].qty += item.sale_qty || 0;
                if (item.location) acc[key].locations.add(item.location);
                if (item.product_name) acc[key].products.add(item.product_name);
                return acc;
            }, {});

            const sortedData = Object.values(data).sort((a, b) => b.total - a.total);
            const total = sortedData.reduce((sum, item) => sum + item.total, 0);

            document.getElementById('sfWiseHeader').innerHTML = `
                <th onclick="sortTable('sfWise', 0)">SF Name</th>
                <th onclick="sortTable('sfWise', 1)">SF Code</th>
                <th onclick="sortTable('sfWise', 2)" class="text-right">Total Value</th>
                <th onclick="sortTable('sfWise', 3)" class="text-right">Quantity</th>
                <th onclick="sortTable('sfWise', 4)" class="text-right">% of Total</th>
                <th>Locations</th>
                <th>Products</th>
            `;

            document.getElementById('sfWiseBody').innerHTML = sortedData.map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('sfName', '${item.sf_name}')">${item.sf_name || '-'}</td>
                    <td class="clickable" onclick="applyDrilldown('sfCode', '${item.sf_code}')">${item.sf_code || '-'}</td>
                    <td class="text-right">${formatNumber(item.total)}</td>
                    <td class="text-right">${formatNumber(item.qty)}</td>
                    <td class="text-right ${getPercentageClass((item.total/total)*100)}">${formatPercentage((item.total/total)*100)}</td>
                    <td>${item.locations.size}</td>
                    <td>${item.products.size}</td>
                </tr>
            `).join('');

            document.getElementById('sfWiseFooter').innerHTML = `
                <td colspan="2"><strong>Total (${sortedData.length} SFs)</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td class="text-right"><strong>${formatNumber(sortedData.reduce((sum, i) => sum + i.qty, 0))}</strong></td>
                <td class="text-right"><strong>100%</strong></td>
                <td colspan="2"></td>
            `;

            document.getElementById('sfWiseTotal').textContent = `Total: ${formatNumber(total)}`;
        }

        function renderSfCodeTable() {
            const data = filteredData.reduce((acc, item) => {
                if (!item.sf_code) return acc;
                const key = item.sf_code;
                if (!acc[key]) {
                    acc[key] = { 
                        sf_code: item.sf_code,
                        sf_name: item.sf_name,
                        total: 0
                    };
                }
                acc[key].total += item.basic_value || 0;
                return acc;
            }, {});

            const sortedData = Object.values(data).sort((a, b) => b.total - a.total);
            const total = sortedData.reduce((sum, item) => sum + item.total, 0);

            document.getElementById('sfCodeHeader').innerHTML = `
                <th onclick="sortTable('sfCode', 0)">SF Code</th>
                <th onclick="sortTable('sfCode', 1)">SF Name</th>
                <th onclick="sortTable('sfCode', 2)" class="text-right">Total Value</th>
                <th onclick="sortTable('sfCode', 3)" class="text-right">Percentage</th>
            `;

            document.getElementById('sfCodeBody').innerHTML = sortedData.map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('sfCode', '${item.sf_code}')">${item.sf_code}</td>
                    <td>${item.sf_name || '-'}</td>
                    <td class="text-right">${formatNumber(item.total)}</td>
                    <td class="text-right ${getPercentageClass((item.total/total)*100)}">${formatPercentage((item.total/total)*100)}</td>
                </tr>
            `).join('');

            document.getElementById('sfCodeFooter').innerHTML = `
                <td colspan="2"><strong>Total (${sortedData.length} codes)</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td class="text-right"><strong>100%</strong></td>
            `;

            document.getElementById('sfCodeTotal').textContent = `Total: ${formatNumber(total)}`;
        }

        function renderBrandMonthlyTable() {
            const data = filteredData.reduce((acc, item) => {
                if (!item.sf_name || !item.product_name || !item.bill_date) return acc;
                const month = item.bill_date.substring(0, 7);
                const key = `${item.sf_name}|${item.product_name}|${month}`;
                
                if (!acc[key]) {
                    acc[key] = {
                        sf_name: item.sf_name,
                        sf_code: item.sf_code,
                        product: item.product_name,
                        month: month,
                        total: 0,
                        qty: 0
                    };
                }
                acc[key].total += item.basic_value || 0;
                acc[key].qty += item.sale_qty || 0;
                return acc;
            }, {});

            const sortedData = Object.values(data).sort((a, b) => b.total - a.total);
            const total = sortedData.reduce((sum, item) => sum + item.total, 0);

            document.getElementById('brandMonthlyHeader').innerHTML = `
                <th onclick="sortTable('brand', 0)">SF Name</th>
                <th onclick="sortTable('brand', 1)">SF Code</th>
                <th onclick="sortTable('brand', 2)">Product</th>
                <th onclick="sortTable('brand', 3)">Month</th>
                <th onclick="sortTable('brand', 4)" class="text-right">Value</th>
                <th onclick="sortTable('brand', 5)" class="text-right">Quantity</th>
            `;

            document.getElementById('brandMonthlyBody').innerHTML = sortedData.slice(0, 100).map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('sfName', '${item.sf_name}')">${item.sf_name}</td>
                    <td>${item.sf_code || '-'}</td>
                    <td class="clickable" onclick="applyDrilldown('product', '${item.product}')">${item.product}</td>
                    <td class="clickable" onclick="applyDrilldown('month', '${item.month}')">${item.month}</td>
                    <td class="text-right">${formatNumber(item.total)}</td>
                    <td class="text-right">${formatNumber(item.qty)}</td>
                </tr>
            `).join('');

            document.getElementById('brandMonthlyFooter').innerHTML = `
                <td colspan="4"><strong>Total (${sortedData.length} entries)</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td class="text-right"><strong>${formatNumber(sortedData.reduce((sum, i) => sum + i.qty, 0))}</strong></td>
            `;

            document.getElementById('brandMonthlyTotal').textContent = `Total: ${formatNumber(total)}`;
        }

        function renderBrandSummaryTable() {
            const data = filteredData.reduce((acc, item) => {
                if (!item.sf_name || !item.product_name) return acc;
                const key = `${item.sf_name}|${item.product_name}`;
                
                if (!acc[key]) {
                    acc[key] = {
                        sf_name: item.sf_name,
                        sf_code: item.sf_code,
                        product: item.product_name,
                        total: 0,
                        qty: 0,
                        months: new Set()
                    };
                }
                acc[key].total += item.basic_value || 0;
                acc[key].qty += item.sale_qty || 0;
                if (item.bill_date) acc[key].months.add(item.bill_date.substring(0, 7));
                return acc;
            }, {});

            const sortedData = Object.values(data).sort((a, b) => b.total - a.total);
            const total = sortedData.reduce((sum, item) => sum + item.total, 0);

            document.getElementById('brandSummaryHeader').innerHTML = `
                <th onclick="sortTable('brand', 0)">SF Name</th>
                <th onclick="sortTable('brand', 1)">SF Code</th>
                <th onclick="sortTable('brand', 2)">Product</th>
                <th onclick="sortTable('brand', 3)" class="text-right">Total Value</th>
                <th onclick="sortTable('brand', 4)" class="text-right">Total Qty</th>
                <th onclick="sortTable('brand', 5)" class="text-right">Months</th>
            `;

            document.getElementById('brandSummaryBody').innerHTML = sortedData.slice(0, 100).map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('sfName', '${item.sf_name}')">${item.sf_name}</td>
                    <td>${item.sf_code || '-'}</td>
                    <td class="clickable" onclick="applyDrilldown('product', '${item.product}')">${item.product}</td>
                    <td class="text-right">${formatNumber(item.total)}</td>
                    <td class="text-right">${formatNumber(item.qty)}</td>
                    <td class="text-right">${item.months.size}</td>
                </tr>
            `).join('');

            document.getElementById('brandSummaryFooter').innerHTML = `
                <td colspan="3"><strong>Total (${sortedData.length} entries)</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td class="text-right"><strong>${formatNumber(sortedData.reduce((sum, i) => sum + i.qty, 0))}</strong></td>
                <td></td>
            `;

            document.getElementById('brandSummaryTotal').textContent = `Total: ${formatNumber(total)}`;
        }

        function renderProductMonthDetailTable() {
            const data = filteredData.reduce((acc, item) => {
                if (!item.product_name || !item.bill_date) return acc;
                const month = item.bill_date.substring(0, 7);
                const key = `${item.product_name}|${month}`;
                
                if (!acc[key]) {
                    acc[key] = {
                        product: item.product_name,
                        product_type: item.product_type,
                        month: month,
                        total: 0,
                        qty: 0,
                        sf_count: new Set()
                    };
                }
                acc[key].total += item.basic_value || 0;
                acc[key].qty += item.sale_qty || 0;
                if (item.sf_name) acc[key].sf_count.add(item.sf_name);
                return acc;
            }, {});

            const sortedData = Object.values(data).sort((a, b) => b.total - a.total);
            const total = sortedData.reduce((sum, item) => sum + item.total, 0);

            document.getElementById('productMonthDetailHeader').innerHTML = `
                <th onclick="sortTable('productMonth', 0)">Product</th>
                <th onclick="sortTable('productMonth', 1)">Product Type</th>
                <th onclick="sortTable('productMonth', 2)">Month</th>
                <th onclick="sortTable('productMonth', 3)" class="text-right">Total Value</th>
                <th onclick="sortTable('productMonth', 4)" class="text-right">Total Qty</th>
                <th onclick="sortTable('productMonth', 5)" class="text-right"># of SFs</th>
            `;

            document.getElementById('productMonthDetailBody').innerHTML = sortedData.slice(0, 100).map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('product', '${item.product}')">${item.product}</td>
                    <td>${item.product_type || '-'}</td>
                    <td class="clickable" onclick="applyDrilldown('month', '${item.month}')">${item.month}</td>
                    <td class="text-right">${formatNumber(item.total)}</td>
                    <td class="text-right">${formatNumber(item.qty)}</td>
                    <td class="text-right">${item.sf_count.size}</td>
                </tr>
            `).join('');

            document.getElementById('productMonthDetailFooter').innerHTML = `
                <td colspan="3"><strong>Total (${sortedData.length} entries)</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td class="text-right"><strong>${formatNumber(sortedData.reduce((sum, i) => sum + i.qty, 0))}</strong></td>
                <td></td>
            `;

            document.getElementById('productMonthDetailTotal').textContent = `Total: ${formatNumber(total)}`;
        }

        function renderProductMonthSummaryTable() {
            const data = filteredData.reduce((acc, item) => {
                if (!item.product_name) return acc;
                const key = item.product_name;
                
                if (!acc[key]) {
                    acc[key] = {
                        product: item.product_name,
                        product_type: item.product_type,
                        total: 0,
                        qty: 0,
                        months: new Set(),
                        sf_count: new Set()
                    };
                }
                acc[key].total += item.basic_value || 0;
                acc[key].qty += item.sale_qty || 0;
                if (item.bill_date) acc[key].months.add(item.bill_date.substring(0, 7));
                if (item.sf_name) acc[key].sf_count.add(item.sf_name);
                return acc;
            }, {});

            const sortedData = Object.values(data).sort((a, b) => b.total - a.total);
            const total = sortedData.reduce((sum, item) => sum + item.total, 0);

            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, sortedData.length);
            const pageData = sortedData.slice(startIndex, endIndex);

            document.getElementById('productMonthSummaryHeader').innerHTML = `
                <th onclick="sortTable('productMonth', 0)">Product</th>
                <th onclick="sortTable('productMonth', 1)">Product Type</th>
                <th onclick="sortTable('productMonth', 2)" class="text-right">Total Value</th>
                <th onclick="sortTable('productMonth', 3)" class="text-right">Total Qty</th>
                <th onclick="sortTable('productMonth', 4)" class="text-right"># of Months</th>
                <th onclick="sortTable('productMonth', 5)" class="text-right"># of SFs</th>
            `;

            document.getElementById('productMonthSummaryBody').innerHTML = pageData.map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('product', '${item.product}')">${item.product}</td>
                    <td>${item.product_type || '-'}</td>
                    <td class="text-right">${formatNumber(item.total)}</td>
                    <td class="text-right">${formatNumber(item.qty)}</td>
                    <td class="text-right">${item.months.size}</td>
                    <td class="text-right">${item.sf_count.size}</td>
                </tr>
            `).join('');

            document.getElementById('productMonthSummaryFooter').innerHTML = `
                <td colspan="2"><strong>Total (${sortedData.length} products)</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td class="text-right"><strong>${formatNumber(sortedData.reduce((sum, i) => sum + i.qty, 0))}</strong></td>
                <td colspan="2"></td>
            `;

            document.getElementById('totalProducts').textContent = sortedData.length;
            document.getElementById('productRange').textContent = `${startIndex + 1}-${endIndex}`;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = endIndex >= sortedData.length;
        }

        function renderDprTable() {
            const sortedData = [...filteredData].sort((a, b) => (b.basic_value || 0) - (a.basic_value || 0));
            const total = sortedData.reduce((sum, item) => sum + (item.basic_value || 0), 0);

            document.getElementById('dprHeader').innerHTML = `
                <th onclick="sortTable('dpr', 0)">Bill Date</th>
                <th onclick="sortTable('dpr', 1)">Bill No</th>
                <th onclick="sortTable('dpr', 2)">SF Name</th>
                <th onclick="sortTable('dpr', 3)">Product</th>
                <th onclick="sortTable('dpr', 4)">Batch No</th>
                <th onclick="sortTable('dpr', 5)" class="text-right">Qty</th>
                <th onclick="sortTable('dpr', 6)" class="text-right">Value</th>
                <th onclick="sortTable('dpr', 7)">Location</th>
            `;

            document.getElementById('dprBody').innerHTML = sortedData.slice(0, 100).map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('date', '${item.bill_date}')">${item.bill_date || '-'}</td>
                    <td>${item.bill_no || '-'}</td>
                    <td class="clickable" onclick="applyDrilldown('sfName', '${item.sf_name}')">${item.sf_name || '-'}</td>
                    <td class="clickable" onclick="applyDrilldown('product', '${item.product_name}')">${item.product_name || '-'}</td>
                    <td>${item.batch_no || '-'}</td>
                    <td class="text-right">${formatNumber(item.sale_qty)}</td>
                    <td class="text-right">${formatNumber(item.basic_value)}</td>
                    <td class="clickable" onclick="applyDrilldown('location', '${item.location}')">${item.location || '-'}</td>
                </tr>
            `).join('');

            document.getElementById('dprFooter').innerHTML = `
                <td colspan="5"><strong>Total (${sortedData.length} entries)</strong></td>
                <td class="text-right"><strong>${formatNumber(sortedData.reduce((sum, i) => sum + (i.sale_qty || 0), 0))}</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td></td>
            `;

            document.getElementById('dprTotal').textContent = `Total: ${formatNumber(total)}`;
        }

        function renderDispatchLocationTable() {
            const data = filteredData.reduce((acc, item) => {
                if (!item.location) return acc;
                if (!acc[item.location]) {
                    acc[item.location] = {
                        location: item.location,
                        total: 0,
                        qty: 0,
                        entries: 0
                    };
                }
                acc[item.location].total += item.basic_value || 0;
                acc[item.location].qty += item.sale_qty || 0;
                acc[item.location].entries++;
                return acc;
            }, {});

            const sortedData = Object.values(data).sort((a, b) => b.total - a.total);
            const total = sortedData.reduce((sum, item) => sum + item.total, 0);

            document.getElementById('dispatchLocationHeader').innerHTML = `
                <th onclick="sortTable('dpr', 0)">Location</th>
                <th onclick="sortTable('dpr', 1)" class="text-right">Total Value</th>
                <th onclick="sortTable('dpr', 2)" class="text-right">Total Qty</th>
                <th onclick="sortTable('dpr', 3)" class="text-right"># of Entries</th>
                <th onclick="sortTable('dpr', 4)" class="text-right">Percentage</th>
            `;

            document.getElementById('dispatchLocationBody').innerHTML = sortedData.map(item => `
                <tr>
                    <td class="clickable" onclick="applyDrilldown('location', '${item.location}')">${item.location}</td>
                    <td class="text-right">${formatNumber(item.total)}</td>
                    <td class="text-right">${formatNumber(item.qty)}</td>
                    <td class="text-right">${item.entries}</td>
                    <td class="text-right ${getPercentageClass((item.total/total)*100)}">${formatPercentage((item.total/total)*100)}</td>
                </tr>
            `).join('');

            document.getElementById('dispatchLocationFooter').innerHTML = `
                <td><strong>Total (${sortedData.length} locations)</strong></td>
                <td class="text-right"><strong>${formatNumber(total)}</strong></td>
                <td class="text-right"><strong>${formatNumber(sortedData.reduce((sum, i) => sum + i.qty, 0))}</strong></td>
                <td class="text-right"><strong>${sortedData.reduce((sum, i) => sum + i.entries, 0)}</strong></td>
                <td class="text-right"><strong>100%</strong></td>
            `;

            document.getElementById('dispatchLocationTotal').textContent = `Total: ${formatNumber(total)}`;
        }

        function updateGrandTotal() {
            const grandTotal = filteredData.reduce((sum, item) => sum + (item.basic_value || 0), 0);
            document.getElementById('grandTotalValue').textContent = formatNumber(grandTotal);
        }

        function applyDrilldown(type, value) {
            switch(type) {
                case 'location':
                    document.getElementById('locationFilter').value = value;
                    break;
                case 'mktBy':
                    document.getElementById('mktByFilter').value = value;
                    break;
                case 'productType':
                    document.getElementById('productTypeFilter').value = value;
                    break;
                case 'sfName':
                case 'sfCode':
                    document.getElementById('globalSearch').value = value;
                    break;
                case 'product':
                    document.getElementById('globalSearch').value = value;
                    break;
                case 'month':
                case 'date':
                    if (value && value.length >= 7) {
                        const yearMonth = value.substring(0, 7);
                        document.getElementById('dateFrom').value = yearMonth;
                        document.getElementById('dateTo').value = yearMonth;
                    }
                    break;
            }
            applyFilters();
        }

        // Expose functions to window
        window.applyFilters = applyFilters;
        window.sortTable = sortTable;
        window.prevPage = prevPage;
        window.nextPage = nextPage;
        window.resetFilters = resetFilters;
        window.clearAllFilters = clearAllFilters;
        window.removeFilter = removeFilter;
        window.applyDrilldown = applyDrilldown;
        window.refreshData = refreshData;
    </script>
</body>
</html>
