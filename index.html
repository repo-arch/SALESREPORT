<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>CRIUS Business Dashboard - Auto-Connect</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
        }

        body {
            background: #e9ecf1;
            padding: 20px;
        }

        .dashboard {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 4px;
            overflow: hidden;
        }

        .main-header {
            background: #1e3a5f;
            color: white;
            padding: 16px 24px;
            font-size: 26px;
            font-weight: 600;
            border-bottom: 3px solid #0f2a44;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .api-badge {
            background: #4a6fa5;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin-left: 15px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .weather-info {
            display: flex;
            align-items: center;
            gap: 20px;
            color: #ffd700;
            font-size: 14px;
        }

        .company-header {
            background: linear-gradient(135deg, #2c3e50, #1e3a5f);
            color: white;
            padding: 20px 24px;
            font-size: 28px;
            font-weight: 700;
            border-bottom: 3px solid #ffd700;
            text-align: center;
        }

        .company-subheader {
            color: #ffd700;
            font-size: 14px;
            margin-top: 8px;
            font-weight: normal;
        }

        .nav-menu {
            display: flex;
            background: #f0f2f5;
            padding: 10px 24px;
            gap: 25px;
            flex-wrap: wrap;
            border-bottom: 2px solid #ccd1d9;
        }

        .nav-menu a {
            color: #2c3e50;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            padding: 4px 8px;
        }

        .nav-menu a:hover {
            background: #1e3a5f;
            color: white;
            border-radius: 4px;
        }

        .api-config-panel {
            background: #e8f0fe;
            padding: 20px 24px;
            border-bottom: 2px solid #b8d1f0;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .server-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            background: white;
            padding: 5px 15px;
            border-radius: 8px;
            border: 1px solid #4a6fa5;
            min-width: 350px;
        }

        .server-selector select {
            padding: 8px;
            border: none;
            width: 100%;
            background: transparent;
            font-size: 14px;
        }

        .server-selector select:focus {
            outline: none;
        }

        .api-config-panel input, .api-config-panel select {
            padding: 8px 12px;
            border: 1px solid #9aa6b5;
            border-radius: 6px;
            min-width: 140px;
            font-size: 13px;
        }

        .api-config-panel button {
            background: #1e3a5f;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
        }

        .api-config-panel button:hover {
            background: #0f2a44;
            transform: translateY(-1px);
        }

        .api-config-panel button.test-btn {
            background: #4CAF50;
        }

        .api-config-panel button.test-btn:hover {
            background: #45a049;
        }

        .api-config-panel button.proxy-btn {
            background: #ff9800;
        }

        .connection-status {
            font-size: 13px;
            padding: 8px 16px;
            border-radius: 20px;
            background: #fff3cd;
            display: inline-block;
            font-weight: 500;
        }

        .nav-sidebar {
            display: flex;
            background: #f0f2f5;
            border-bottom: 2px solid #ccd1d9;
            overflow-x: auto;
            white-space: nowrap;
        }

        .nav-item {
            padding: 14px 28px;
            font-size: 14px;
            color: #2c3e50;
            border-right: 1px solid #ccd1d9;
            font-weight: 600;
            cursor: pointer;
        }

        .nav-item:hover {
            background: #e4e7eb;
            color: #1e3a5f;
        }

        .nav-item.active {
            background: #1e3a5f;
            color: white;
            font-weight: 700;
        }

        .filter-bar {
            background: #f8fafc;
            padding: 15px 24px;
            display: flex;
            gap: 20px;
            border-bottom: 2px solid #dee2e9;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .filter-group label {
            font-weight: 700;
            color: #1e3a5f;
            min-width: 70px;
        }

        .filter-group select, .filter-group input {
            padding: 8px 12px;
            border: 1px solid #9aa6b5;
            border-radius: 6px;
            min-width: 150px;
            background: white;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: white;
            border: 1px solid #9aa6b5;
            border-radius: 6px;
            padding: 4px 12px;
            min-width: 280px;
        }

        .search-box input {
            border: none;
            padding: 8px 0;
            width: 100%;
            outline: none;
        }

        .search-box button {
            background: #1e3a5f;
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }

        .refresh-btn {
            background: #4a6fa5;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .reset-btn {
            background: #d6562b;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

        .content {
            padding: 24px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e3a5f;
            margin: 25px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #d0d7e5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-wrapper {
            border: 1px solid #b7bfcc;
            border-radius: 8px;
            margin-bottom: 30px;
            overflow: auto;
            max-height: 500px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        thead th {
            background: #2b5797;
            color: white;
            padding: 12px;
            font-weight: 600;
            border: 1px solid #1e3a5f;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
        }

        thead th:hover {
            background: #1e3a5f;
        }

        thead th.sort-asc::after {
            content: " ‚Üë";
            color: #ffd700;
        }

        thead th.sort-desc::after {
            content: " ‚Üì";
            color: #ffd700;
        }

        tbody td {
            padding: 10px 12px;
            border: 1px solid #b7bfcc;
            white-space: nowrap;
        }

        tbody td.clickable {
            cursor: pointer;
            color: #1e3a5f;
            font-weight: 500;
        }

        tbody td.clickable:hover {
            background: #e3f2fd;
            font-weight: 700;
        }

        tbody tr:hover {
            background: #f5f7fa;
        }

        tfoot td {
            background: #d6562b;
            color: white;
            font-weight: 700;
            padding: 12px;
            border: 1px solid #b13e1f;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }

        .grand-footer {
            background: #1e3a5f;
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            font-weight: 700;
            font-size: 16px;
            border-top: 3px solid #ffd700;
        }

        .dashboard-footer {
            background: #1e3a5f;
            color: white;
            padding: 14px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            border-top: 2px solid #0f2a44;
        }

        .percentage-positive {
            color: #4caf50;
            font-weight: 700;
        }

        .percentage-negative {
            color: #f44336;
            font-weight: 700;
        }

        .text-right {
            text-align: right;
        }

        .loading {
            text-align: center;
            padding: 80px;
            font-size: 18px;
            color: #1e3a5f;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #c00000;
            background: #ffebee;
            margin: 30px;
            border-radius: 8px;
            white-space: pre-line;
        }

        .active-filters-bar {
            background: #fff3cd;
            padding: 12px 24px;
            display: none;
            align-items: center;
            gap: 15px;
            border-bottom: 2px solid #ffe69c;
        }

        .filter-tag {
            background: #ffd700;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #1e3a5f;
        }

        .filter-tag button {
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 700;
            color: #1e3a5f;
            font-size: 14px;
        }

        .pagination {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .pagination button {
            padding: 6px 12px;
            background: white;
            border: 1px solid #9aa6b5;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .proxy-panel {
            background: #f8f9fa;
            padding: 15px 24px;
            border-bottom: 2px solid #dee2e9;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .proxy-panel select {
            padding: 8px 12px;
            border: 1px solid #9aa6b5;
            border-radius: 6px;
            min-width: 250px;
        }

        .proxy-panel button {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .proxy-panel button:hover {
            background: #138496;
        }

        .proxy-status {
            font-size: 13px;
            color: #1e3a5f;
            font-weight: 500;
        }

        .working-proxy-note {
            background: #d4edda;
            padding: 10px 24px;
            border-left: 4px solid #28a745;
            font-size: 13px;
            display: none;
            align-items: center;
            gap: 15px;
        }
        
        .working-proxy-note button {
            background: #28a745;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }

        .it-team-panel {
            background: #e8eaf6;
            padding: 15px 24px;
            border-bottom: 2px solid #3f51b5;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .it-team-panel button {
            background: #3f51b5;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
        }

        .it-team-panel button:hover {
            background: #303f9f;
        }

        .it-team-status {
            background: #c5cae9;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            color: #1a237e;
        }

        /* Auto-connect status bar */
        .auto-connect-bar {
            background: #e3f2fd;
            padding: 8px 24px;
            border-bottom: 2px solid #2196f3;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 13px;
        }
        
        .auto-connect-bar .status {
            color: #0d47a1;
            font-weight: 600;
        }
        
        .reset-connection {
            margin-left: auto;
            background: #ff9800;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="main-header">
            <div>
                CRIUS Business Dashboard - Auto-Connect
                <span class="api-badge" id="apiBadge" style="display: none;">
                    <span>‚úÖ</span> Connected
                </span>
            </div>
            <div class="weather-info">
                <span>üå§Ô∏è 27¬∞C Sunny</span>
                <span class="last-update" id="lastUpdate"></span>
            </div>
        </div>

        <div class="company-header">
            CRIUS GROUP OF COMPANIES
            <div class="company-subheader">Enterprise Business Intelligence Dashboard - Auto-Connect Edition</div>
        </div>

        <!-- Auto-Connect Status Bar -->
        <div class="auto-connect-bar" id="autoConnectBar">
            <span class="status" id="autoConnectStatus">üîÑ Auto-connect enabled</span>
            <span id="savedProxyInfo"></span>
            <button class="reset-connection" onclick="resetConnection()">Reset Connection</button>
        </div>

        <!-- Working Proxy Found Note -->
        <div class="working-proxy-note" id="workingProxyNote">
            <span>‚úÖ <strong>Working Proxy Found!</strong></span>
            <button onclick="useWorkingProxy()">Connect with Working Proxy</button>
            <span id="workingProxyUrl" style="font-weight: bold; color: #155724;"></span>
        </div>

        <!-- Server Selection -->
        <div class="api-config-panel">
            <div class="server-selector">
                <select id="serverSelect" onchange="onServerChange()">
                    <option value="http://43.246.140.102:6060/smarten/">üåê Public Server 1 (43.246.140.102:6060)</option>
                    <option value="http://43.246.140.102:6060/smarten/">üè† Local Server (43.246.140.102:6060)</option>
                    <option value="http://103.54.103.91:6060/smarten/">üåç Public Server 2 (103.54.103.91:6060)</option>
                    <option value="http://43.246.140.102:6060/smarten/" selected>üè¢ IT TEAM SERVER - RECOMMENDED</option>
                    <option value="custom">‚úèÔ∏è Custom URL</option>
                </select>
            </div>
            
            <div class="filter-group" id="customUrlGroup" style="display: none;">
                <input type="text" id="customUrl" placeholder="http://your-server:6060/smarten" style="width: 250px;">
            </div>

            <input type="text" id="apiUsername" value="SOURAV" placeholder="Username">
            <input type="password" id="apiPassword" value="KUMAR@1308" placeholder="Password">
            <input type="text" id="reportId" value="r17d84895210.rpt" placeholder="Report ID">
            
            <button onclick="saveConfig()" class="proxy-btn">üíæ Save Config</button>
            <span id="connectionStatus" class="connection-status">Ready</span>
        </div>

        <!-- Proxy Selection Panel -->
        <div class="proxy-panel">
            <span style="font-weight: 700; color: #1e3a5f;">üåê Proxy Selection (Auto-connect enabled):</span>
            <select id="proxySelect">
                <option value="https://cors-anywhere.azm.workers.dev/?" selected>‚úÖ CORS Bypass (Worker) - Best</option>
                <option value="https://cors-proxy.spaceinbox.workers.dev/?url=">‚úÖ CORS Proxy Worker - Fast</option>
                <option value="https://cors-anywhere.herokuapp.com/">‚ö†Ô∏è CORS Anywhere (Needs Demo)</option>
                <option value="https://thingproxy.freeboard.io/fetch/">üîÑ ThingProxy</option>
            </select>
            <button onclick="testSelectedProxy()" class="test-btn">‚úì Test Selected</button>
            <button onclick="findWorkingProxy()" class="proxy-btn">üîç Find Working Proxy</button>
            <button onclick="connectWithProxy()" class="refresh-btn">üöÄ Connect via Proxy</button>
            <span id="proxyTestResult" class="proxy-status"></span>
        </div>

        <!-- Action Buttons -->
        <div style="padding: 10px 24px; display: flex; gap: 15px; background: #f8f9fa; border-bottom: 2px solid #dee2e9; flex-wrap: wrap;">
            <button onclick="testDirectConnection()" class="test-btn">Test Direct Connection</button>
            <button onclick="loadSavedConfig()" class="proxy-btn">Load Saved Config</button>
            <span id="globalConnectionStatus" class="connection-status">Ready</span>
        </div>

        <div class="nav-sidebar" id="tabNav"></div>

        <div class="filter-bar">
            <div class="filter-group">
                <label>Location:</label>
                <select id="locationFilter" onchange="applyFilters()">
                    <option value="all">All Locations</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Mkt By:</label>
                <select id="mktByFilter" onchange="applyFilters()">
                    <option value="all">All</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Product Type:</label>
                <select id="productTypeFilter" onchange="applyFilters()">
                    <option value="all">All Types</option>
                </select>
            </div>
            <div class="filter-group">
                <label>From:</label>
                <input type="month" id="dateFrom" onchange="applyFilters()" value="2025-02">
            </div>
            <div class="filter-group">
                <label>To:</label>
                <input type="month" id="dateTo" onchange="applyFilters()" value="2026-02">
            </div>
            <div class="search-box">
                <input type="text" placeholder="üîç Search products, SF names..." id="globalSearch" onkeyup="applyFilters()">
                <button onclick="applyFilters()">Search</button>
            </div>
            <button class="refresh-btn" onclick="refreshData()">
                <span>üîÑ</span> Refresh
            </button>
            <button class="reset-btn" onclick="resetFilters()">Reset</button>
        </div>

        <div class="active-filters-bar" id="activeFiltersBar">
            <span style="font-weight: 700;">Active Filters:</span>
            <div id="activeFilters"></div>
            <button onclick="clearAllFilters()" style="margin-left: auto; background: none; border: none; color: #856404; cursor: pointer; font-weight: 600;">Clear All ‚úï</button>
        </div>

        <div id="loading" class="loading">Initializing auto-connect...</div>
        <div id="error" class="error" style="display: none;"></div>

        <div id="tabContainers" style="display: none;"></div>

        <div class="grand-footer" style="display: none;" id="grandFooter">
            <span>üìä Overall Grand Total</span>
            <span id="grandTotalValue"></span>
        </div>

        <div class="dashboard-footer">
            <div class="footer-left">
                <span>¬© 2026 CRIUS Group - Auto-Connect Edition</span>
            </div>
            <div class="footer-right">
                <span>üåê v3.0 | AUTO-CONNECT</span>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        let CONFIG = {
            serverUrl: 'http://43.246.140.102:6060/smarten/',
            username: 'SOURAV',
            password: 'KUMAR@1308',
            reportId: 'r17d84895210.rpt'
        };

        const PROXIES = [
            { name: 'CORS Bypass (Worker) - Best', url: 'https://cors-anywhere.azm.workers.dev/?' },
            { name: 'CORS Proxy Worker - Fast', url: 'https://cors-proxy.spaceinbox.workers.dev/?url=' },
            { name: 'CORS Anywhere (Heroku) - Needs Demo', url: 'https://cors-anywhere.herokuapp.com/' },
            { name: 'ThingProxy', url: 'https://thingproxy.freeboard.io/fetch/' }
        ];

        // ==================== AUTO-CONNECT VARIABLES ====================
        let workingProxyUrl = localStorage.getItem('workingProxy') || null;
        let keepAliveInterval = null;
        let allData = [];
        let filteredData = [];
        let headers = [];
        let currentPage = 1;
        const pageSize = 50;
        
        let activeFilters = {
            location: null,
            mktBy: null,
            productType: null,
            dateFrom: '2025-02',
            dateTo: '2026-02',
            search: null
        };

        let sortStates = {
            mktBy: { column: 1, direction: 'desc' },
            location: { column: 1, direction: 'desc' },
            sfWise: { column: 5, direction: 'desc' },
            brand: { column: 9, direction: 'desc' },
            productMonth: { column: 3, direction: 'desc' },
            dpr: { column: 0, direction: 'desc' }
        };

        let uniqueLocations = new Set();
        let uniqueMktBy = new Set();
        let uniqueProductTypes = new Set();

        const tabs = [
            { id: 'summary', name: 'üìä Summary View' },
            { id: 'customer-sf', name: 'üë• Customer & SF Wise' },
            { id: 'sf-brand', name: 'üè∑Ô∏è SF Wise Brand Details' },
            { id: 'sf-product', name: 'üì¶ SF & Product Month Wise' },
            { id: 'dpr', name: 'üìã Daily Dispatch Details (DPR)' }
        ];

        // ==================== AUTO-CONNECT FUNCTIONS ====================
        window.onload = function() {
            initializeUI();
            loadSavedConfig();
            loadSavedProxy();
            
            // Show auto-connect status
            updateAutoConnectStatus();
            
            // Start auto-connect process
            setTimeout(() => {
                autoConnect();
            }, 1500);
        };

        function loadSavedProxy() {
            const savedProxy = localStorage.getItem('workingProxy');
            if (savedProxy) {
                const select = document.getElementById('proxySelect');
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value === savedProxy) {
                        select.selectedIndex = i;
                        document.getElementById('savedProxyInfo').innerHTML = ` | Saved: ${getProxyName(savedProxy)}`;
                        break;
                    }
                }
            }
        }

        function updateAutoConnectStatus() {
            const statusEl = document.getElementById('autoConnectStatus');
            if (workingProxyUrl) {
                statusEl.innerHTML = `‚úÖ Auto-connect ready (using saved proxy)`;
            } else {
                statusEl.innerHTML = `üîÑ Auto-connect will find best proxy`;
            }
        }

        function getProxyName(proxyUrl) {
            if (proxyUrl.includes('azm.workers.dev')) return 'CORS Bypass';
            if (proxyUrl.includes('spaceinbox.workers.dev')) return 'CORS Proxy Worker';
            if (proxyUrl.includes('herokuapp.com')) return 'CORS Anywhere';
            if (proxyUrl.includes('thingproxy')) return 'ThingProxy';
            return 'Proxy';
        }

        async function autoConnect() {
            document.getElementById('loading').style.display = 'block';
            
            // Try saved proxy first
            if (workingProxyUrl) {
                document.getElementById('loading').textContent = `Auto-connecting with saved proxy (${getProxyName(workingProxyUrl)})...`;
                try {
                    await connectWithProxy(workingProxyUrl);
                    return;
                } catch (e) {
                    console.log('Saved proxy failed, finding new one...');
                    localStorage.removeItem('workingProxy');
                    workingProxyUrl = null;
                }
            }
            
            // Find best proxy
            await autoFindAndConnect();
        }

        async function autoFindAndConnect() {
            document.getElementById('loading').textContent = 'Finding best proxy automatically...';
            
            const proxies = [
                { name: 'CORS Bypass', url: 'https://cors-anywhere.azm.workers.dev/?' },
                { name: 'CORS Proxy Worker', url: 'https://cors-proxy.spaceinbox.workers.dev/?url=' },
                { name: 'CORS Anywhere', url: 'https://cors-anywhere.herokuapp.com/' }
            ];
            
            const testUrl = 'http://43.246.140.102:6060/smarten/API/getToken';
            const params = new URLSearchParams({
                username: 'SOURAV',
                password: 'KUMAR@1308',
                objectid: 'r17d84895210.rpt',
                type: 'data'
            });
            
            for (const proxy of proxies) {
                try {
                    document.getElementById('loading').textContent = `Testing ${proxy.name}...`;
                    
                    const response = await fetch(proxy.url + encodeURIComponent(testUrl + '?' + params.toString()), {
                        method: 'GET',
                        headers: { 'Origin': window.location.origin }
                    });
                    
                    if (response.ok) {
                        // Save working proxy
                        localStorage.setItem('workingProxy', proxy.url);
                        workingProxyUrl = proxy.url;
                        
                        // Select in dropdown
                        const select = document.getElementById('proxySelect');
                        for (let i = 0; i < select.options.length; i++) {
                            if (select.options[i].value === proxy.url) {
                                select.selectedIndex = i;
                                break;
                            }
                        }
                        
                        document.getElementById('savedProxyInfo').innerHTML = ` | Saved: ${proxy.name}`;
                        
                        // Connect
                        await connectWithProxy(proxy.url);
                        return;
                    }
                } catch (e) {
                    console.log(`${proxy.name} failed:`, e.message);
                }
            }
            
            // If all fail, show manual option
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').innerHTML = `
                <strong>Auto-connect failed.</strong><br>
                Please click "Find Working Proxy" to connect manually.
            `;
        }

        function startKeepAlive() {
            if (keepAliveInterval) {
                clearInterval(keepAliveInterval);
            }
            
            // Ping every 5 minutes to keep connection alive
            keepAliveInterval = setInterval(async () => {
                console.log('Keep-alive ping...');
                if (allData.length > 0 && workingProxyUrl) {
                    await refreshData();
                }
            }, 5 * 60 * 1000);
        }

        function resetConnection() {
            if (confirm('Reset connection settings? This will clear saved proxy.')) {
                localStorage.removeItem('workingProxy');
                workingProxyUrl = null;
                if (keepAliveInterval) {
                    clearInterval(keepAliveInterval);
                }
                document.getElementById('savedProxyInfo').innerHTML = '';
                document.getElementById('autoConnectStatus').innerHTML = 'üîÑ Auto-connect enabled';
                location.reload();
            }
        }

        // ==================== EXISTING FUNCTIONS (Keep all your existing functions below) ====================
        // [All your existing functions: onServerChange, initializeUI, saveConfig, loadSavedConfig, 
        //  getServerUrl, showStatus, updateLastUpdateTime, testProxy, testSelectedProxy, 
        //  findWorkingProxy, useWorkingProxy, parseXmlData, fallbackParse, connectWithProxy,
        //  transformData, rebuildUniqueSets, refreshData, createTabs, createTabContainers,
        //  getTabHTML, switchTab, updateFilterOptions, applyFilters, updateActiveFiltersDisplay,
        //  removeFilter, clearAllFilters, resetFilters, sortTable, prevPage, nextPage,
        //  formatNumber, formatPercentage, getPercentageClass, renderAllTables, 
        //  renderMktByTable, renderLocationTable, renderProductTypeTable, renderSfWiseTable,
        //  renderSfCodeTable, renderBrandMonthlyTable, renderBrandSummaryTable,
        //  renderProductMonthDetailTable, renderProductMonthSummaryTable, renderDprTable,
        //  renderDispatchLocationTable, updateGrandTotal, applyDrilldown]
        
        // [PASTE ALL YOUR EXISTING FUNCTIONS HERE - they remain exactly the same]
        // For brevity, I'm not repeating them here, but you need to keep ALL your existing
        // functions from your original code. The key additions are the auto-connect functions above.
        
        // Make sure to expose all functions to window
        window.testDirectConnection = testDirectConnection;
        window.testSelectedProxy = testSelectedProxy;
        window.findWorkingProxy = findWorkingProxy;
        window.connectWithProxy = connectWithProxy;
        window.useWorkingProxy = useWorkingProxy;
        window.refreshData = refreshData;
        window.saveConfig = saveConfig;
        window.loadSavedConfig = loadSavedConfig;
        window.onServerChange = onServerChange;
        window.applyFilters = applyFilters;
        window.sortTable = sortTable;
        window.prevPage = prevPage;
        window.nextPage = nextPage;
        window.resetFilters = resetFilters;
        window.clearAllFilters = clearAllFilters;
        window.removeFilter = removeFilter;
        window.applyDrilldown = applyDrilldown;
        window.requestCorsAnywhereAccess = requestCorsAnywhereAccess;
        window.resetConnection = resetConnection;
    </script>
</body>
</html>
