<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>CRIUS Business Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
        }

        body {
            background: #e9ecf1;
            padding: 20px;
        }

        .dashboard {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 4px;
            overflow: hidden;
        }

        .main-header {
            background: #1e3a5f;
            color: white;
            padding: 16px 24px;
            font-size: 26px;
            font-weight: 600;
            border-bottom: 3px solid #0f2a44;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .api-badge {
            background: #4a6fa5;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            margin-left: 15px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .weather-info {
            display: flex;
            align-items: center;
            gap: 20px;
            color: #ffd700;
            font-size: 14px;
        }

        .company-header {
            background: linear-gradient(135deg, #2c3e50, #1e3a5f);
            color: white;
            padding: 20px 24px;
            font-size: 28px;
            font-weight: 700;
            border-bottom: 3px solid #ffd700;
            text-align: center;
        }

        .company-subheader {
            color: #ffd700;
            font-size: 14px;
            margin-top: 8px;
            font-weight: normal;
        }

        .nav-menu {
            display: flex;
            background: #f0f2f5;
            padding: 10px 24px;
            gap: 25px;
            flex-wrap: wrap;
            border-bottom: 2px solid #ccd1d9;
        }

        .nav-menu a {
            color: #2c3e50;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            padding: 4px 8px;
        }

        .nav-menu a:hover {
            background: #1e3a5f;
            color: white;
            border-radius: 4px;
        }

        /* Hidden Panels */
        .it-team-panel, 
        .api-config-panel .server-selector,
        .api-config-panel input,
        .api-config-panel button,
        .api-config-panel span,
        .proxy-panel,
        .action-buttons,
        .reset-connection {
            display: none !important;
        }

        /* Show only essential */
        .auto-connect-bar {
            background: #e3f2fd;
            padding: 8px 24px;
            border-bottom: 2px solid #2196f3;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 13px;
        }
        
        .auto-connect-bar .status {
            color: #0d47a1;
            font-weight: 600;
        }

        .nav-sidebar {
            display: flex;
            background: #f0f2f5;
            border-bottom: 2px solid #ccd1d9;
            overflow-x: auto;
            white-space: nowrap;
        }

        .nav-item {
            padding: 14px 28px;
            font-size: 14px;
            color: #2c3e50;
            border-right: 1px solid #ccd1d9;
            font-weight: 600;
            cursor: pointer;
        }

        .nav-item:hover {
            background: #e4e7eb;
            color: #1e3a5f;
        }

        .nav-item.active {
            background: #1e3a5f;
            color: white;
            font-weight: 700;
        }

        .filter-bar {
            background: #f8fafc;
            padding: 15px 24px;
            display: flex;
            gap: 20px;
            border-bottom: 2px solid #dee2e9;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .filter-group label {
            font-weight: 700;
            color: #1e3a5f;
            min-width: 70px;
        }

        .filter-group select, .filter-group input {
            padding: 8px 12px;
            border: 1px solid #9aa6b5;
            border-radius: 6px;
            min-width: 150px;
            background: white;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: white;
            border: 1px solid #9aa6b5;
            border-radius: 6px;
            padding: 4px 12px;
            min-width: 280px;
        }

        .search-box input {
            border: none;
            padding: 8px 0;
            width: 100%;
            outline: none;
        }

        .search-box button {
            background: #1e3a5f;
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }

        .refresh-btn {
            background: #4a6fa5;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .reset-btn {
            background: #d6562b;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

        .content {
            padding: 24px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e3a5f;
            margin: 25px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #d0d7e5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-wrapper {
            border: 1px solid #b7bfcc;
            border-radius: 8px;
            margin-bottom: 30px;
            overflow: auto;
            max-height: 500px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        thead th {
            background: #2b5797;
            color: white;
            padding: 12px;
            font-weight: 600;
            border: 1px solid #1e3a5f;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
        }

        thead th:hover {
            background: #1e3a5f;
        }

        thead th.sort-asc::after {
            content: " ‚Üë";
            color: #ffd700;
        }

        thead th.sort-desc::after {
            content: " ‚Üì";
            color: #ffd700;
        }

        tbody td {
            padding: 10px 12px;
            border: 1px solid #b7bfcc;
            white-space: nowrap;
        }

        tbody td.clickable {
            cursor: pointer;
            color: #1e3a5f;
            font-weight: 500;
        }

        tbody td.clickable:hover {
            background: #e3f2fd;
            font-weight: 700;
        }

        tbody tr:hover {
            background: #f5f7fa;
        }

        tfoot td {
            background: #d6562b;
            color: white;
            font-weight: 700;
            padding: 12px;
            border: 1px solid #b13e1f;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }

        .grand-footer {
            background: #1e3a5f;
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            font-weight: 700;
            font-size: 16px;
            border-top: 3px solid #ffd700;
        }

        .dashboard-footer {
            background: #1e3a5f;
            color: white;
            padding: 14px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            border-top: 2px solid #0f2a44;
        }

        .percentage-positive {
            color: #4caf50;
            font-weight: 700;
        }

        .percentage-negative {
            color: #f44336;
            font-weight: 700;
        }

        .text-right {
            text-align: right;
        }

        .loading {
            text-align: center;
            padding: 80px;
            font-size: 18px;
            color: #1e3a5f;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #c00000;
            background: #ffebee;
            margin: 30px;
            border-radius: 8px;
            white-space: pre-line;
        }

        .active-filters-bar {
            background: #fff3cd;
            padding: 12px 24px;
            display: none;
            align-items: center;
            gap: 15px;
            border-bottom: 2px solid #ffe69c;
        }

        .filter-tag {
            background: #ffd700;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #1e3a5f;
        }

        .filter-tag button {
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 700;
            color: #1e3a5f;
            font-size: 14px;
        }

        .pagination {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .pagination button {
            padding: 6px 12px;
            background: white;
            border: 1px solid #9aa6b5;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="main-header">
            <div>
                CRIUS Business Dashboard
                <span class="api-badge" id="apiBadge" style="display: none;">
                    <span>‚úÖ</span> Connected
                </span>
            </div>
            <div class="weather-info">
                <span>üå§Ô∏è 27¬∞C Sunny</span>
                <span class="last-update" id="lastUpdate"></span>
            </div>
        </div>

        <div class="company-header">
            CRIUS GROUP OF COMPANIES
            <div class="company-subheader">Enterprise Business Intelligence Dashboard</div>
        </div>

        <!-- Auto-Connect Status Bar (Only visible element) -->
        <div class="auto-connect-bar" id="autoConnectBar">
            <span class="status" id="autoConnectStatus">üîÑ Auto-connect enabled - connecting...</span>
        </div>

        <!-- Hidden configuration (kept for functionality) -->
        <select id="proxySelect" style="display: none;">
            <option value="https://cors-anywhere.azm.workers.dev/?" selected>CORS Bypass</option>
            <option value="https://cors-proxy.spaceinbox.workers.dev/?url=">CORS Proxy Worker</option>
            <option value="https://cors-anywhere.herokuapp.com/">CORS Anywhere</option>
        </select>

        <input type="text" id="apiUsername" value="SOURAV" style="display: none;">
        <input type="password" id="apiPassword" value="KUMAR@1308" style="display: none;">
        <input type="text" id="reportId" value="r17d84895210.rpt" style="display: none;">

        <div class="nav-sidebar" id="tabNav"></div>

        <div class="filter-bar">
            <div class="filter-group">
                <label>Location:</label>
                <select id="locationFilter" onchange="applyFilters()">
                    <option value="all">All Locations</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Mkt By:</label>
                <select id="mktByFilter" onchange="applyFilters()">
                    <option value="all">All</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Product Type:</label>
                <select id="productTypeFilter" onchange="applyFilters()">
                    <option value="all">All Types</option>
                </select>
            </div>
            <div class="filter-group">
                <label>From:</label>
                <input type="month" id="dateFrom" onchange="applyFilters()" value="2025-02">
            </div>
            <div class="filter-group">
                <label>To:</label>
                <input type="month" id="dateTo" onchange="applyFilters()" value="2026-02">
            </div>
            <div class="search-box">
                <input type="text" placeholder="üîç Search products, SF names..." id="globalSearch" onkeyup="applyFilters()">
                <button onclick="applyFilters()">Search</button>
            </div>
            <button class="refresh-btn" onclick="refreshData()">
                <span>üîÑ</span> Refresh
            </button>
            <button class="reset-btn" onclick="resetFilters()">Reset</button>
        </div>

        <div class="active-filters-bar" id="activeFiltersBar">
            <span style="font-weight: 700;">Active Filters:</span>
            <div id="activeFilters"></div>
            <button onclick="clearAllFilters()" style="margin-left: auto; background: none; border: none; color: #856404; cursor: pointer; font-weight: 600;">Clear All ‚úï</button>
        </div>

        <div id="loading" class="loading">Initializing auto-connect...</div>
        <div id="error" class="error" style="display: none;"></div>

        <div id="tabContainers" style="display: none;"></div>

        <div class="grand-footer" style="display: none;" id="grandFooter">
            <span>üìä Overall Grand Total</span>
            <span id="grandTotalValue"></span>
        </div>

        <div class="dashboard-footer">
            <div class="footer-left">
                <span>¬© 2026 CRIUS Group</span>
            </div>
            <div class="footer-right">
                <span>üåê v3.0 | AUTO-CONNECT</span>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        let CONFIG = {
            serverUrl: 'http://43.246.140.102:6060/smarten/',
            username: 'SOURAV',
            password: 'KUMAR@1308',
            reportId: 'r17d84895210.rpt'
        };

        const PROXIES = [
            { name: 'CORS Bypass', url: 'https://cors-anywhere.azm.workers.dev/?' },
            { name: 'CORS Proxy Worker', url: 'https://cors-proxy.spaceinbox.workers.dev/?url=' },
            { name: 'CORS Anywhere', url: 'https://cors-anywhere.herokuapp.com/' }
        ];

        // ==================== AUTO-CONNECT VARIABLES ====================
        let workingProxyUrl = localStorage.getItem('workingProxy') || null;
        let keepAliveInterval = null;
        let allData = [];
        let filteredData = [];
        let headers = [];
        let currentPage = 1;
        const pageSize = 50;
        
        let activeFilters = {
            location: null,
            mktBy: null,
            productType: null,
            dateFrom: '2025-02',
            dateTo: '2026-02',
            search: null
        };

        let sortStates = {
            mktBy: { column: 1, direction: 'desc' },
            location: { column: 1, direction: 'desc' },
            sfWise: { column: 5, direction: 'desc' },
            brand: { column: 9, direction: 'desc' },
            productMonth: { column: 3, direction: 'desc' },
            dpr: { column: 0, direction: 'desc' }
        };

        let uniqueLocations = new Set();
        let uniqueMktBy = new Set();
        let uniqueProductTypes = new Set();

        const tabs = [
            { id: 'summary', name: 'üìä Summary View' },
            { id: 'customer-sf', name: 'üë• Customer & SF Wise' },
            { id: 'sf-brand', name: 'üè∑Ô∏è SF Wise Brand Details' },
            { id: 'sf-product', name: 'üì¶ SF & Product Month Wise' },
            { id: 'dpr', name: 'üìã Daily Dispatch Details (DPR)' }
        ];

        // ==================== INITIALIZATION ====================
        window.onload = function() {
            initializeUI();
            loadSavedConfig();
            loadSavedProxy();
            
            // Start auto-connect
            setTimeout(() => {
                autoConnect();
            }, 1000);
        };

        function loadSavedProxy() {
            const savedProxy = localStorage.getItem('workingProxy');
            if (savedProxy) {
                workingProxyUrl = savedProxy;
                const select = document.getElementById('proxySelect');
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value === savedProxy) {
                        select.selectedIndex = i;
                        break;
                    }
                }
            }
        }

        function initializeUI() {
            updateLastUpdateTime(new Date());
            createTabs();
            createTabContainers();
        }

        function updateLastUpdateTime(date) {
            const options = { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            document.getElementById('lastUpdate').textContent = 'LAST UPDATE: ' + date.toLocaleDateString('en-GB', options);
        }

        function loadSavedConfig() {
            const saved = localStorage.getItem('smartenConfig');
            if (saved) {
                try {
                    CONFIG = JSON.parse(saved);
                } catch (e) {}
            }
        }

        function getServerUrl() {
            return 'http://43.246.140.102:6060/smarten/';
        }

        function showStatus(message, color) {
            document.getElementById('autoConnectStatus').innerHTML = message;
        }

        // ==================== AUTO-CONNECT FUNCTIONS ====================
        async function autoConnect() {
            document.getElementById('loading').style.display = 'block';
            
            if (workingProxyUrl) {
                document.getElementById('loading').textContent = 'Connecting with saved proxy...';
                try {
                    await connectWithProxy(workingProxyUrl);
                    return;
                } catch (e) {
                    localStorage.removeItem('workingProxy');
                    workingProxyUrl = null;
                }
            }
            
            await autoFindAndConnect();
        }

async function autoFindAndConnect() {
    document.getElementById('loading').textContent = 'Finding best proxy...';
    
    // Expanded proxy list with more reliable options
    const proxies = [
        { name: 'CORS Bypass', url: 'https://cors-anywhere.azm.workers.dev/?' },
        { name: 'CORS Proxy Worker', url: 'https://cors-proxy.spaceinbox.workers.dev/?url=' },
        { name: 'CORS Anywhere', url: 'https://cors-anywhere.herokuapp.com/' },
        { name: 'All Origins', url: 'https://api.allorigins.win/raw?url=' },
        { name: 'CORS Proxy 2', url: 'https://crossorigin.me/' },
        { name: 'CORS Proxy 3', url: 'https://cors.io/?' }
    ];
    
    const baseUrl = 'http://43.246.140.102:6060/smarten/';
    const params = new URLSearchParams({
        username: 'SOURAV',
        password: 'KUMAR@1308',
        objectid: 'r17d84895210.rpt',
        type: 'data'
    });
    
    const testUrl = baseUrl + 'API/getToken?' + params.toString();
    
    for (const proxy of proxies) {
        try {
            document.getElementById('loading').textContent = `Testing ${proxy.name}...`;
            
            // Construct proxy URL properly
            let fullUrl;
            if (proxy.url.includes('allorigins')) {
                fullUrl = proxy.url + encodeURIComponent(testUrl);
            } else {
                fullUrl = proxy.url + encodeURIComponent(testUrl);
            }
            
            console.log(`Testing ${proxy.name}:`, fullUrl);
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 8000);
            
            const response = await fetch(fullUrl, {
                method: 'GET',
                headers: {
                    'Origin': window.location.origin,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            
            if (response.ok) {
                const text = await response.text();
                // Check if we got a valid token (not HTML error page)
                if (text && text.length > 10 && !text.toLowerCase().includes('html')) {
                    console.log(`‚úÖ ${proxy.name} works!`);
                    localStorage.setItem('workingProxy', proxy.url);
                    workingProxyUrl = proxy.url;
                    
                    await connectWithProxy(proxy.url);
                    return;
                }
            }
        } catch (e) {
            console.log(`${proxy.name} failed:`, e.message);
        }
    }
    
    // If all proxies fail, try direct connection with CORS Anywhere demo
    document.getElementById('loading').textContent = 'Trying CORS Anywhere demo...';
    try {
        window.open('https://cors-anywhere.herokuapp.com/corsdemo', '_blank');
        document.getElementById('error').innerHTML = `
            <strong>All proxies failed.</strong><br><br>
            Please try:<br>
            1. Click "Request temporary access" in the new tab<br>
            2. Wait 2 seconds<br>
            3. Click the button below<br><br>
            <button onclick="retryCorsAnywhere()" style="background: #4caf50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Retry CORS Anywhere</button>
        `;
        document.getElementById('error').style.display = 'block';
        document.getElementById('loading').style.display = 'none';
    } catch (e) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('error').innerHTML = 'All proxies failed. Please try again later.';
    }
}

        // Add this retry function
window.retryCorsAnywhere = async function() {
    document.getElementById('error').style.display = 'none';
    document.getElementById('loading').style.display = 'block';
    document.getElementById('loading').textContent = 'Retrying CORS Anywhere...';
    
    const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
    const baseUrl = 'http://43.246.140.102:6060/smarten/';
    const params = new URLSearchParams({
        username: 'SOURAV',
        password: 'KUMAR@1308',
        objectid: 'r17d84895210.rpt',
        type: 'data'
    });
    
    try {
        const response = await fetch(proxyUrl + baseUrl + 'API/getToken?' + params.toString(), {
            method: 'GET',
            headers: {
                'Origin': window.location.origin,
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        if (response.ok) {
            const text = await response.text();
            if (text && text.length > 10) {
                localStorage.setItem('workingProxy', proxyUrl);
                workingProxyUrl = proxyUrl;
                await connectWithProxy(proxyUrl);
            }
        } else {
            throw new Error('Failed');
        }
    } catch (e) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('error').innerHTML = 'Still failed. Please try manual connection.';
    }
};


        function startKeepAlive() {
            if (keepAliveInterval) clearInterval(keepAliveInterval);
            keepAliveInterval = setInterval(() => {
                if (allData.length > 0 && workingProxyUrl) {
                    refreshData();
                }
            }, 5 * 60 * 1000);
        }

// Update your connectWithProxy function to handle different proxy types better
async function connectWithProxy(proxyUrl) {
    try {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('loading').textContent = 'Loading data...';
        document.getElementById('error').style.display = 'none';

        const baseUrl = 'http://43.246.140.102:6060/smarten/';
        const params = new URLSearchParams({
            username: 'SOURAV',
            password: 'KUMAR@1308',
            objectid: 'r17d84895210.rpt',
            type: 'data'
        });

        // Get token with proper encoding
        let tokenUrl;
        if (proxyUrl.includes('allorigins')) {
            tokenUrl = proxyUrl + encodeURIComponent(baseUrl + 'API/getToken?' + params.toString());
        } else {
            tokenUrl = proxyUrl + baseUrl + 'API/getToken?' + params.toString();
        }

        console.log('Fetching token from:', tokenUrl);

        const tokenResponse = await fetch(tokenUrl, {
            method: 'GET',
            headers: {
                'Origin': window.location.origin,
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        if (!tokenResponse.ok) {
            throw new Error(`Token fetch failed: ${tokenResponse.status}`);
        }

        const token = await tokenResponse.text();
        console.log('Token received, length:', token.length);

        if (!token || token.length < 10) {
            throw new Error('Invalid token');
        }

        // Get data
        let dataUrl;
        if (proxyUrl.includes('allorigins')) {
            dataUrl = proxyUrl + encodeURIComponent(baseUrl + 'API/getObject?tokenid=' + encodeURIComponent(token));
        } else {
            dataUrl = proxyUrl + baseUrl + 'API/getObject?tokenid=' + encodeURIComponent(token);
        }

        console.log('Fetching data from:', dataUrl);

        const dataResponse = await fetch(dataUrl, {
            headers: {
                'Origin': window.location.origin,
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const responseText = await dataResponse.text();
        console.log('Data received, length:', responseText.length);

        // Parse XML
        let reportData = parseXmlData(responseText);

        if (!reportData || reportData.length === 0) {
            throw new Error('No data found');
        }

        headers = reportData[0] || [];
        reportData = reportData.slice(1);

        allData = transformData(reportData);

        if (allData.length === 0) {
            throw new Error('No valid data');
        }

        filteredData = [...allData];

        rebuildUniqueSets();

        document.getElementById('loading').style.display = 'none';
        document.getElementById('tabContainers').style.display = 'block';
        document.getElementById('grandFooter').style.display = 'flex';
        document.getElementById('apiBadge').style.display = 'inline-block';
        document.getElementById('autoConnectStatus').innerHTML = '‚úÖ Connected';

        updateLastUpdateTime(new Date());
        updateFilterOptions();
        renderAllTables();

        startKeepAlive();

    } catch (error) {
        console.error('Connection error:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('error').innerHTML = 'Connection error: ' + error.message + '<br><br><button onclick="location.reload()" style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Retry</button>';
    }
}

        // ==================== XML PARSING ====================
        function parseXmlData(xmlString) {
            try {
                const fullXml = xmlString.split('\n').join('');
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(fullXml, 'text/xml');
                
                const rows = xmlDoc.getElementsByTagName('Row');
                if (rows.length === 0) return [];
                
                const data = [];
                
                // Get headers from first row
                const firstRow = rows[0];
                const headers = [];
                const cols = firstRow.getElementsByTagName('Column');
                for (let col of cols) {
                    headers.push(col.textContent || '');
                }
                if (headers.length > 0) data.push(headers);
                
                // Get data rows
                for (let i = 0; i < rows.length; i++) {
                    const rowData = [];
                    const cols = rows[i].getElementsByTagName('Column');
                    for (let col of cols) {
                        rowData.push((col.textContent || '').trim());
                    }
                    if (rowData.length > 0) data.push(rowData);
                }
                
                return data;
                
            } catch (e) {
                return [];
            }
        }

        function transformData(rows) {
            if (rows.length === 0) return [];
            
            return rows.map((row, idx) => ({
                id: `row_${idx}`,
                location: row[0] || '',
                bill_no: row[1] || '',
                bill_date: row[2] || '',
                product_name: row[3] || '',
                product_type: row[4] || '',
                batch_no: row[5] || '',
                sale_qty: parseFloat(row[6]) || 0,
                basic_value: parseFloat(row[7]) || 0,
                sf_code: row[8] || '',
                sf_name: row[9] || '',
                mkt_by: row[10] || '',
                city: row[11] || '',
                state: row[12] || ''
            }));
        }

        function rebuildUniqueSets() {
            uniqueLocations.clear();
            uniqueMktBy.clear();
            uniqueProductTypes.clear();
            
            allData.forEach(item => {
                if (item.location) uniqueLocations.add(item.location);
                if (item.mkt_by) uniqueMktBy.add(item.mkt_by);
                if (item.product_type) uniqueProductTypes.add(item.product_type);
            });
        }

        function refreshData() {
            if (workingProxyUrl) {
                connectWithProxy(workingProxyUrl);
            }
        }

        // ==================== TAB FUNCTIONS ====================
        function createTabs() {
            const tabNav = document.getElementById('tabNav');
            tabNav.innerHTML = '';
            
            tabs.forEach((tab, index) => {
                const tabElement = document.createElement('div');
                tabElement.className = `nav-item ${index === 0 ? 'active' : ''}`;
                tabElement.setAttribute('data-tab', tab.id);
                tabElement.textContent = tab.name;
                tabElement.onclick = () => switchTab(tab.id);
                tabNav.appendChild(tabElement);
            });
        }

        function createTabContainers() {
            const containers = document.getElementById('tabContainers');
            containers.innerHTML = '';
            
            tabs.forEach((tab, index) => {
                const container = document.createElement('div');
                container.id = `tab-${tab.id}`;
                container.className = `tab-content ${index === 0 ? 'active' : ''}`;
                container.innerHTML = getTabHTML(tab.id);
                containers.appendChild(container);
            });
        }

        function getTabHTML(tabId) {
            // [Keep your existing getTabHTML function - it's long so I'm not repeating it]
            // You need to keep ALL your table rendering HTML here
            return ''; // Placeholder - use your original getTabHTML
        }

        function switchTab(tabId) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if(item.getAttribute('data-tab') === tabId) {
                    item.classList.add('active');
                }
            });
            
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        // ==================== FILTER FUNCTIONS ====================
        function updateFilterOptions() {
            const locationSelect = document.getElementById('locationFilter');
            const mktBySelect = document.getElementById('mktByFilter');
            const productTypeSelect = document.getElementById('productTypeFilter');
            
            locationSelect.innerHTML = '<option value="all">All Locations</option>';
            mktBySelect.innerHTML = '<option value="all">All</option>';
            productTypeSelect.innerHTML = '<option value="all">All Types</option>';
            
            Array.from(uniqueLocations).sort().forEach(loc => {
                if (loc) {
                    const option = document.createElement('option');
                    option.value = loc;
                    option.textContent = loc;
                    locationSelect.appendChild(option);
                }
            });

            Array.from(uniqueMktBy).sort().forEach(mkt => {
                if (mkt) {
                    const option = document.createElement('option');
                    option.value = mkt;
                    option.textContent = mkt;
                    mktBySelect.appendChild(option);
                }
            });

            Array.from(uniqueProductTypes).sort().forEach(type => {
                if (type) {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    productTypeSelect.appendChild(option);
                }
            });
        }

        function applyFilters() {
            activeFilters.location = document.getElementById('locationFilter').value !== 'all' ? document.getElementById('locationFilter').value : null;
            activeFilters.mktBy = document.getElementById('mktByFilter').value !== 'all' ? document.getElementById('mktByFilter').value : null;
            activeFilters.productType = document.getElementById('productTypeFilter').value !== 'all' ? document.getElementById('productTypeFilter').value : null;
            activeFilters.dateFrom = document.getElementById('dateFrom').value;
            activeFilters.dateTo = document.getElementById('dateTo').value;
            activeFilters.search = document.getElementById('globalSearch').value || null;

            filteredData = allData.filter(item => {
                if (activeFilters.location && item.location !== activeFilters.location) return false;
                if (activeFilters.mktBy && item.mkt_by !== activeFilters.mktBy) return false;
                if (activeFilters.productType && item.product_type !== activeFilters.productType) return false;
                
                if (activeFilters.dateFrom && item.bill_date) {
                    const itemDate = item.bill_date.substring(0, 7);
                    if (itemDate < activeFilters.dateFrom) return false;
                }
                if (activeFilters.dateTo && item.bill_date) {
                    const itemDate = item.bill_date.substring(0, 7);
                    if (itemDate > activeFilters.dateTo) return false;
                }
                
                if (activeFilters.search) {
                    const searchTerm = activeFilters.search.toLowerCase();
                    const searchableFields = [
                        item.product_name,
                        item.sf_name,
                        item.mkt_by,
                        item.location,
                        item.batch_no,
                        item.sf_code
                    ].map(f => (f || '').toLowerCase());
                    
                    if (!searchableFields.some(field => field.includes(searchTerm))) {
                        return false;
                    }
                }
                
                return true;
            });

            updateActiveFiltersDisplay();
            currentPage = 1;
            renderAllTables();
        }

        function updateActiveFiltersDisplay() {
            const bar = document.getElementById('activeFiltersBar');
            const container = document.getElementById('activeFilters');
            
            const activeFilterList = [];
            
            if (activeFilters.location) activeFilterList.push(`Location: ${activeFilters.location}`);
            if (activeFilters.mktBy) activeFilterList.push(`Mkt By: ${activeFilters.mktBy}`);
            if (activeFilters.productType) activeFilterList.push(`Product Type: ${activeFilters.productType}`);
            if (activeFilters.dateFrom) activeFilterList.push(`From: ${activeFilters.dateFrom}`);
            if (activeFilters.dateTo) activeFilterList.push(`To: ${activeFilters.dateTo}`);
            if (activeFilters.search) activeFilterList.push(`Search: "${activeFilters.search}"`);
            
            if (activeFilterList.length > 0) {
                bar.style.display = 'flex';
                container.innerHTML = activeFilterList.map(filter => 
                    `<span class="filter-tag">${filter} <button onclick="removeFilter('${filter.split(':')[0].trim().toLowerCase()}')">‚úï</button></span>`
                ).join(' ');
            } else {
                bar.style.display = 'none';
            }
        }

        function removeFilter(filterType) {
            switch(filterType) {
                case 'location':
                    document.getElementById('locationFilter').value = 'all';
                    activeFilters.location = null;
                    break;
                case 'mkt':
                    document.getElementById('mktByFilter').value = 'all';
                    activeFilters.mktBy = null;
                    break;
                case 'product':
                    document.getElementById('productTypeFilter').value = 'all';
                    activeFilters.productType = null;
                    break;
                case 'from':
                    document.getElementById('dateFrom').value = '';
                    activeFilters.dateFrom = null;
                    break;
                case 'to':
                    document.getElementById('dateTo').value = '';
                    activeFilters.dateTo = null;
                    break;
                case 'search':
                    document.getElementById('globalSearch').value = '';
                    activeFilters.search = null;
                    break;
            }
            applyFilters();
        }

        function clearAllFilters() {
            document.getElementById('locationFilter').value = 'all';
            document.getElementById('mktByFilter').value = 'all';
            document.getElementById('productTypeFilter').value = 'all';
            document.getElementById('dateFrom').value = '2025-02';
            document.getElementById('dateTo').value = '2026-02';
            document.getElementById('globalSearch').value = '';
            
            activeFilters = {
                location: null,
                mktBy: null,
                productType: null,
                dateFrom: '2025-02',
                dateTo: '2026-02',
                search: null
            };
            
            filteredData = [...allData];
            updateActiveFiltersDisplay();
            renderAllTables();
        }

        function resetFilters() {
            clearAllFilters();
        }

        // ==================== SORT FUNCTIONS ====================
        function sortTable(tableType, columnIndex) {
            const state = sortStates[tableType];
            if (!state) return;
            
            if (state.column === columnIndex) {
                state.direction = state.direction === 'asc' ? 'desc' : 'asc';
            } else {
                state.column = columnIndex;
                state.direction = 'desc';
            }

            document.querySelectorAll(`#${tableType}Header th`).forEach((th, idx) => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            const headerCell = document.querySelector(`#${tableType}Header th:nth-child(${columnIndex + 1})`);
            if (headerCell) {
                headerCell.classList.add(`sort-${state.direction}`);
            }

            renderAllTables();
        }

        // ==================== PAGINATION FUNCTIONS ====================
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderAllTables();
            }
        }

        function nextPage() {
            currentPage++;
            renderAllTables();
        }

        // ==================== UTILITY FUNCTIONS ====================
        function formatNumber(num) {
            if (!num || isNaN(num)) return '-';
            return num.toLocaleString('en-IN', {
                maximumFractionDigits: 2,
                minimumFractionDigits: 2
            });
        }

        function formatPercentage(num) {
            if (!num || isNaN(num)) return '-';
            return num.toFixed(2) + '%';
        }

        function getPercentageClass(value) {
            if (value > 0) return 'percentage-positive';
            if (value < 0) return 'percentage-negative';
            return '';
        }

        // ==================== TABLE RENDERING FUNCTIONS ====================
        function renderAllTables() {
            if (filteredData.length === 0) {
                document.querySelectorAll('tbody').forEach(body => {
                    body.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px;">No data available.</td></tr>';
                });
                return;
            }

            renderMktByTable();
            renderLocationTable();
            renderProductTypeTable();
            renderSfWiseTable();
            renderSfCodeTable();
            renderBrandMonthlyTable();
            renderBrandSummaryTable();
            renderProductMonthDetailTable();
            renderProductMonthSummaryTable();
            renderDprTable();
            renderDispatchLocationTable();
            updateGrandTotal();
        }

        // [Add all your render functions here - mktBy, location, productType, sfWise, etc.]
        // Keep all your existing render functions from your original code
        
        function updateGrandTotal() {
            const grandTotal = filteredData.reduce((sum, item) => sum + (item.basic_value || 0), 0);
            document.getElementById('grandTotalValue').textContent = formatNumber(grandTotal);
        }

        function applyDrilldown(type, value) {
            switch(type) {
                case 'location':
                    document.getElementById('locationFilter').value = value;
                    break;
                case 'mktBy':
                    document.getElementById('mktByFilter').value = value;
                    break;
                case 'productType':
                    document.getElementById('productTypeFilter').value = value;
                    break;
                case 'sfName':
                case 'sfCode':
                case 'product':
                    document.getElementById('globalSearch').value = value;
                    break;
                case 'month':
                case 'date':
                    if (value && value.length >= 7) {
                        const yearMonth = value.substring(0, 7);
                        document.getElementById('dateFrom').value = yearMonth;
                        document.getElementById('dateTo').value = yearMonth;
                    }
                    break;
            }
            applyFilters();
        }

        // ==================== EXPOSE FUNCTIONS ====================
        window.applyFilters = applyFilters;
        window.sortTable = sortTable;
        window.prevPage = prevPage;
        window.nextPage = nextPage;
        window.resetFilters = resetFilters;
        window.clearAllFilters = clearAllFilters;
        window.removeFilter = removeFilter;
        window.applyDrilldown = applyDrilldown;
        window.refreshData = refreshData;
    </script>
</body>
</html>
